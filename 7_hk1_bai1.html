<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p chinh ph·ª•c To√°n 7 HK1 - B√†i 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar {
            width: 8px;
        }
        #steps-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .input-group:focus-within label {
            color: #4f46e5;
        }

        /* --- STYLES FOR STATS --- */
        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box {
            transition: all 0.3s ease;
        }
        .stats-box:hover {
            transform: translateY(-2px);
        }
        
        .highlight-digit {
            color: #ef4444; 
            text-decoration: underline;
            text-decoration-color: #ef4444;
            text-decoration-thickness: 3px;
            text-underline-offset: 3px;
            font-weight: 800;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-calculator mr-2"></i>√în t·∫≠p chinh ph·ª•c To√°n 7 HK1 - B√†i 1
            </h1>
            <p class="text-white font-medium">Ch·ªß ƒë·ªÅ: S·ªë v√¥ t·ªâ, L√†m tr√≤n s·ªë & ∆Ø·ªõc l∆∞·ª£ng</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[450px] relative">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        
                        <div class="space-y-6 font-mono text-lg md:text-xl w-full px-2">
                            <!-- C√¢u a -->
                            <div>
                                <div class="flex items-center mb-1">
                                    <span class="text-yellow-400 font-bold mr-2">a)</span>
                                    <span class="text-blue-200 text-base font-sans">T√≠nh (l√†m tr√≤n ƒë·∫øn <span id="q-a-round-text" class="text-yellow-300 font-bold underline">...</span>):</span>
                                </div>
                                <div class="pl-8 text-white tracking-wider">
                                    <span id="q-a1-disp">...</span> &approx; ? <br> <span id="q-a2-disp">...</span> &approx; ?
                                </div>
                            </div>

                            <!-- C√¢u b -->
                            <div class="border-t border-gray-600 pt-4">
                                <div class="flex mb-1">
                                    <span class="text-yellow-400 font-bold mr-2 whitespace-nowrap">b)</span>
                                    <span class="text-blue-200 text-base font-sans" id="q-b-text">
                                        L√†m tr√≤n <span id="q-b-num">...</span> v·ªõi ƒë·ªô ch√≠nh x√°c d = <span id="q-b-d">...</span>:
                                    </span>
                                </div>
                                <div class="pl-8 text-white">
                                    K·∫øt qu·∫£ &approx; ?
                                </div>
                            </div>

                            <!-- C√¢u c -->
                            <div class="border-t border-gray-600 pt-4">
                                <div class="flex items-center mb-1">
                                    <span class="text-yellow-400 font-bold mr-2">c)</span>
                                    <span class="text-blue-200 text-sm font-sans">L√†m tr√≤n m·ªói s·ªë ƒë·∫øn h√†ng cao nh·∫•t ƒë·ªÉ ∆∞·ªõc l∆∞·ª£ng:</span>
                                </div>
                                <div class="pl-8 text-white tracking-wider">
                                    <span id="q-c-expr">...</span> &approx; ?
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NH·∫¨P ƒê√ÅP √ÅN -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        <div class="space-y-4">
                            <!-- Input A -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="input-group">
                                    <label id="lbl-a1" class="block text-gray-500 font-bold text-[11px] uppercase mb-1 truncate">...</label>
                                    <input type="text" id="ans-a1" placeholder="-7,68" class="w-full text-center font-bold p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                                </div>
                                <div class="input-group">
                                    <label id="lbl-a2" class="block text-gray-500 font-bold text-[11px] uppercase mb-1 truncate">...</label>
                                    <input type="text" id="ans-a2" placeholder="38,14" class="w-full text-center font-bold p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                                </div>
                            </div>
                            <!-- Input B -->
                            <div class="input-group">
                                <label id="lbl-b" class="block text-gray-500 font-bold text-[11px] uppercase mb-1 truncate">...</label>
                                <input type="text" id="ans-b" placeholder="20 940 000" class="w-full text-center font-bold p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                            </div>
                            <!-- Input C -->
                            <div class="bg-white p-3 rounded-lg border border-gray-200">
                                <span class="block text-gray-400 font-bold text-[10px] uppercase mb-2">∆Ø·ªõc l∆∞·ª£ng: Nh·∫≠p s·ªë ƒë√£ l√†m tr√≤n v√†o 2 √¥ ƒë·∫ßu</span>
                                <div class="grid grid-cols-7 gap-1 items-center">
                                    <input type="text" id="ans-c-p1" class="col-span-3 text-center font-bold p-2 border rounded-lg text-sm" placeholder="-60">
                                    <div class="col-span-1 flex justify-center font-bold text-gray-400" id="c-op-icon">...</div>
                                    <input type="text" id="ans-c-p2" class="col-span-3 text-center font-bold p-2 border rounded-lg text-sm" placeholder="90">
                                </div>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="text-xs font-bold text-gray-400 whitespace-nowrap">KQ = </span>
                                    <input type="text" id="ans-c-final" placeholder="?" class="flex-grow text-center font-bold p-2 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Difficulty Toggle -->
                        <div class="flex items-center justify-end mt-4 mb-2">
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-sm font-bold text-gray-600 peer-checked:text-red-600 transition-colors flex items-center">
                                    <i class="fas fa-skull-crossbones mr-1"></i>Ch·∫ø ƒë·ªô kh√≥
                                </span>
                            </label>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>
                        <div id="feedback" class="hidden mt-3 text-center p-2 rounded-lg text-sm font-bold"></div>
                        <div id="hint-warning" class="hidden mt-2 text-center text-xs text-amber-600 font-semibold bg-amber-50 p-1 rounded border border-amber-200">
                            <i class="fas fa-lock mr-1"></i>ƒê√£ xem g·ª£i √Ω: Th√†nh t√≠ch c√¢u n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh.
                        </div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[600px] lg:h-[750px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <!-- Button -->
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Rule Hint Area -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>
                    
                    <!-- Scrollable Steps -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- State ---
        let currentData = {};
        let stepIndex = 0;
        let isAnswered = false;
        
        // Stats
        let streak = 0;
        let correctTotal = 0;
        let wrongTotal = 0;
        let skippedTotal = 0;
        let statsEnabled = true; // True = c√≥ t√≠nh ƒëi·ªÉm, False = ƒë√£ d√πng g·ª£i √Ω, kh√¥ng t√≠nh

        // --- Utils Format ---
        function fmt(num, decimals = null) {
            let str = decimals !== null ? num.toFixed(decimals) : num.toString();
            str = str.replace('.', ',');
            let parts = str.split(',');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            return parts.join(',');
        }

        function updateStatsUI() {
            const streakEl = document.getElementById('stat-streak');
            
            // Update Text
            streakEl.textContent = streak;
            document.getElementById('stat-correct').textContent = correctTotal;
            document.getElementById('stat-wrong').textContent = wrongTotal;
            document.getElementById('stat-skipped').textContent = skippedTotal;

            // Visual State for Disabled
            if (!statsEnabled) {
                document.getElementById('hint-warning').classList.remove('hidden');
            } else {
                document.getElementById('hint-warning').classList.add('hidden');
            }

            // Streak Animation
            if (streak > 2) {
                streakEl.classList.add('streak-fire');
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${streak}`;
            } else {
                streakEl.classList.remove('streak-fire');
                streakEl.textContent = streak;
            }
        }

        function disableStats() {
            if (statsEnabled) {
                statsEnabled = false;
                updateStatsUI();
            }
        }

        // --- Generator Logic ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function roundToHighest(num) {
            const abs = Math.abs(num);
            if (abs === 0) return 0;
            const sign = num < 0 ? -1 : 1;
            const power = Math.floor(Math.log10(abs));
            const unit = Math.pow(10, power);
            const roundedAbs = Math.round(abs / unit) * unit;
            return roundedAbs * sign;
        }

        // Highlight Logic
        function getHighlightedNumber(num, roundUnit) {
            let absNum = Math.abs(num);
            let sign = num < 0 ? '-' : '';
            let power = Math.round(Math.log10(roundUnit)); 
            let strVal = absNum.toString(); 

            if (power < 0) {
                let requiredDecimals = Math.abs(power) + 1;
                let currentDecimals = (strVal.split('.')[1] || '').length;
                if (currentDecimals < requiredDecimals) strVal = absNum.toFixed(requiredDecimals);
            }

            let parts = strVal.split('.');
            let intPart = parts[0];
            let decPart = parts[1] || '';
            let hInt = "", hDec = "";
            
            if (power >= 0) {
                let digitIndexFromRight = power;
                let arr = intPart.split('').reverse();
                if (digitIndexFromRight < arr.length) {
                    arr[digitIndexFromRight] = `<span class="highlight-digit">${arr[digitIndexFromRight]}</span>`;
                }
                let res = "";
                for (let i = 0; i < arr.length; i++) {
                    if (i > 0 && i % 3 === 0) res = " " + res;
                    res = arr[i] + res;
                }
                hInt = res;
                if (decPart) hDec = "," + decPart;
            } else {
                let idx = Math.abs(power) - 1; 
                hInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                let arr = decPart.split('');
                if (idx < arr.length) {
                    arr[idx] = `<span class="highlight-digit">${arr[idx]}</span>`;
                    hDec = "," + arr.join('');
                } else {
                    hDec = decPart ? "," + decPart : "";
                }
            }
            return sign + hInt + hDec;
        }

        function getHighlighedDecimal(val, places) {
             return getHighlightedNumber(val, Math.pow(10, -places));
        }

        function highlightFirstSignificantDigit(displayStr) {
            return displayStr.replace(/([1-9])/, '<span class="highlight-digit">$1</span>');
        }

        function generateProblem() {
            const isHard = document.getElementById('mode-hard').checked;

            // --- C√¢u A ---
            // Normal: 0.4 neg prob, 1-2 decimals
            // Hard: 0.6 neg prob, 3-4 decimals, sometimes sqrt of decimal
            const isNegA = Math.random() < (isHard ? 0.6 : 0.4);
            const randA = Math.random();
            let a_places, a_text;
            
            if (isHard) {
                 if (randA < 0.5) {
                    a_places = 3; a_text = "h√†ng ph·∫ßn ngh√¨n";
                 } else {
                    a_places = 4; a_text = "h√†ng ph·∫ßn ch·ª•c ngh√¨n";
                 }
            } else {
                if (randA < 0.7) {
                    const type = getRandomInt(0, 1);
                    a_places = type === 0 ? 1 : 2;
                    a_text = type === 0 ? "h√†ng ph·∫ßn m∆∞·ªùi" : "h√†ng ph·∫ßn trƒÉm";
                } else {
                    const type = getRandomInt(0, 1);
                    a_places = type === 0 ? 3 : 4;
                    a_text = type === 0 ? "h√†ng ph·∫ßn ngh√¨n" : "h√†ng ph·∫ßn ch·ª•c ngh√¨n";
                }
            }
            
            // In hard mode, occasionally use decimal radicand (e.g. sqrt(12.5))
            let a1_raw, a2_raw;
            if (isHard && Math.random() < 0.3) {
                 a1_raw = parseFloat((getRandomInt(100, 2000)/10).toFixed(1)); // 10.0 - 200.0
            } else {
                 a1_raw = getRandomInt(10, 150); 
            }
            a2_raw = getRandomInt(100, isHard ? 9999 : 5000);

            const vA1 = Math.sqrt(a1_raw) * (isNegA ? -1 : 1);
            const vA2 = Math.sqrt(a2_raw); 
            const ansA1 = fmt(vA1, a_places);
            const ansA2 = fmt(vA2, a_places);
            const vA1_disp_val = parseFloat(vA1.toFixed(a_places + 2)); 
            const vA2_disp_val = parseFloat(vA2.toFixed(a_places + 2));
            const displayA1 = getHighlighedDecimal(vA1_disp_val, a_places) + "...";
            const displayA2 = getHighlighedDecimal(vA2_disp_val, a_places) + "...";

            // --- C√¢u B ---
            // Hard: More negative context, tricky d (0.005, 5000)
            const isNegB = Math.random() < (isHard ? 0.5 : 0.2);
            let d, b_round_unit, b_num;
            
            const contexts = [
                { name: null, unit: '' },
                { name: 'd√¢n s·ªë', unit: 'ng∆∞·ªùi' },
                { name: 'di·ªán t√≠ch', unit: 'km¬≤' },
                { name: 's·∫£n l∆∞·ª£ng', unit: 't·∫•n' },
                { name: 't·ªïng doanh thu', unit: 'ƒë·ªìng' }
            ];
            const ctxIdx = Math.random() < 0.5 ? 0 : getRandomInt(1, contexts.length - 1);
            const b_ctx = contexts[ctxIdx];

            const randD = Math.random();
            if ((randD < 0.2 || (isHard && randD < 0.5)) && !b_ctx.unit) {
                // Decimal d
                const d_opts = isHard ? [0.005, 0.5, 0.05] : [0.05, 0.5];
                d = d_opts[getRandomInt(0, d_opts.length - 1)];
                b_round_unit = d * 2;
                
                let base = getRandomInt(10, 9999);
                let frac = getRandomInt(100, 9999);
                b_num = parseFloat(`${base}.${frac}`);
                if (isNegB) b_num *= -1;
            } else {
                // Integer d
                let d_opts = [50, 500, 5000, 50000];
                if (isHard) d_opts.push(5, 500000);
                d = d_opts[getRandomInt(0, d_opts.length - 1)];
                b_round_unit = d * 2;
                
                const minVal = b_round_unit * 10;
                const maxVal = b_round_unit * 1000;
                b_num = getRandomInt(minVal, maxVal) * (isNegB ? -1 : 1);
            }
            
            let ansB_val = Math.round(b_num / b_round_unit) * b_round_unit;
            if (b_round_unit < 1) {
                const decimalPoints = b_round_unit.toString().split('.')[1]?.length || 0;
                ansB_val = parseFloat(ansB_val.toFixed(decimalPoints));
            }
            const ansB = fmt(ansB_val);
            const displayB_Question = fmt(b_num);
            const displayB_Step = getHighlightedNumber(b_num, b_round_unit);
            
            const questionB_Html = `L√†m tr√≤n ${b_ctx.name ? b_ctx.name + ' ' : ''}<span id="q-b-num">${displayB_Question}</span>${b_ctx.unit ? ' ' + b_ctx.unit : ''} v·ªõi ƒë·ªô ch√≠nh x√°c d = <span id="q-b-d">${d}</span>`;

            let unitName = "";
            if (b_round_unit >= 1) {
                if (b_round_unit === 1) unitName = "h√†ng ƒë∆°n v·ªã";
                else if (b_round_unit === 10) unitName = "h√†ng ch·ª•c";
                else if (b_round_unit === 100) unitName = "h√†ng trƒÉm";
                else if (b_round_unit === 1000) unitName = "h√†ng ngh√¨n";
                else if (b_round_unit === 10000) unitName = "h√†ng ch·ª•c ngh√¨n";
                else unitName = `h√†ng ${fmt(b_round_unit)}`;
            } else {
                if (b_round_unit === 0.1) unitName = "h√†ng ph·∫ßn m∆∞·ªùi";
                else if (b_round_unit === 0.01) unitName = "h√†ng ph·∫ßn trƒÉm";
                else if (b_round_unit === 0.001) unitName = "h√†ng ph·∫ßn ngh√¨n";
                else unitName = `v·ªã tr√≠ ${fmt(b_round_unit)}`;
            }

            // --- C√¢u C ---
            // Hard: Prefer Multiplication, mixed signs
            const isAddSub = Math.random() < (isHard ? 0.3 : 0.4);
            const op = isAddSub ? (Math.random() < 0.5 ? '+' : '-') : '.';
            const opCode = op === '.' ? '*' : op;
            
            let minC, maxC, divC;
            if (isHard) {
                 minC = 1000; maxC = 99999; divC = 10; // Bigger/more complex numbers
            } else {
                 const magRand = Math.random();
                 if (magRand < 0.1) { minC = 10000; maxC = 999999; divC = 100; } 
                 else if (magRand < 0.4) { minC = 1000; maxC = 9999; divC = 10; } 
                 else { minC = 100; maxC = 999; divC = 10; }
            }

            let c1_obj, c2_obj;
            // For hard mode, generate numbers that are good for multiplication but require distinct rounding
            let val1 = getRandomInt(minC, maxC) / divC;
            if (Math.random() < 0.5) val1 *= -1;
            c1_obj = { display: fmt(val1), value: val1 };

            let val2 = getRandomInt(Math.max(10, minC/10), maxC) / divC;
            if (Math.random() < 0.5) val2 *= -1;
            c2_obj = { display: fmt(val2), value: val2 };

            if (Math.abs(c1_obj.value) < 1) c1_obj.value = (c1_obj.value < 0 ? -1.5 : 1.5);
            if (Math.abs(c2_obj.value) < 1) c2_obj.value = (c2_obj.value < 0 ? -2.5 : 2.5);

            const c1_round_val = roundToHighest(c1_obj.value);
            const c2_round_val = roundToHighest(c2_obj.value);
            const c1_disp_hl = highlightFirstSignificantDigit(c1_obj.display);
            const c2_disp_hl = highlightFirstSignificantDigit(c2_obj.display);
            
            let ansC_val;
            if (opCode === '+') ansC_val = c1_round_val + c2_round_val;
            else if (opCode === '-') ansC_val = c1_round_val - c2_round_val;
            else ansC_val = c1_round_val * c2_round_val;
            
            const c1_round_str = fmt(c1_round_val);
            const c2_round_str = fmt(c2_round_val);
            const ansC_str = fmt(ansC_val);

            // Steps
            const steps = [
                { type: 'header', text: 'a) CƒÉn b·∫≠c hai & L√†m tr√≤n', rule: `L√†m tr√≤n ƒë·∫øn ${a_text}: Quan s√°t ch·ªØ s·ªë ngay sau h√†ng l√†m tr√≤n (ƒë∆∞·ª£c g·∫°ch ch√¢n).` },
                { type: 'step', text: `a) ${isNegA?'-':''}‚àö${a1_raw} = ${displayA1} ‚âà <b>${ansA1}</b>` },
                { type: 'step', text: `‚àö${a2_raw} = ${displayA2} ‚âà <b>${ansA2}</b>` },

                { type: 'header', text: 'b) ƒê·ªô ch√≠nh x√°c d', rule: `<b>B∆∞·ªõc 1:</b> X√°c ƒë·ªãnh h√†ng l√†m tr√≤n. V√¨ d = ${d} n√™n ta l√†m tr√≤n ƒë·∫øn <b>${unitName}</b> (g·∫•p ƒë√¥i d).<br><b>B∆∞·ªõc 2:</b> Quan s√°t ch·ªØ s·ªë ·ªü <b>${unitName}</b> (ƒë∆∞·ª£c g·∫°ch ch√¢n m√†u ƒë·ªè) v√† ch·ªØ s·ªë ngay b√™n ph·∫£i n√≥ ƒë·ªÉ quy·∫øt ƒë·ªãnh l√†m tr√≤n l√™n hay gi·ªØ nguy√™n.` },
                { type: 'step', text: `b) V·ªõi d=${d}, s·ªë ${displayB_Step} ‚âà <b>${ansB}</b>` },
            ];

            if (b_ctx.name) {
                steps.push({ type: 'step', text: `V·∫≠y ${b_ctx.name} x·∫•p x·ªâ <b>${ansB} ${b_ctx.unit}</b>` });
            }

            steps.push({ type: 'header', text: 'c) ∆Ø·ªõc l∆∞·ª£ng ph√©p t√≠nh', rule: 'L√†m tr√≤n m·ªói s·ªë v·ªÅ h√†ng cao nh·∫•t. Quan s√°t ch·ªØ s·ªë ƒë·∫ßu ti√™n kh√°c 0 (ƒë∆∞·ª£c g·∫°ch ch√¢n ƒë·ªè).' });
            steps.push({ type: 'step', text: `${c1_disp_hl} ‚âà ${c1_round_str}` });
            steps.push({ type: 'step', text: `${c2_disp_hl} ‚âà ${c2_round_str}` });
            steps.push({ type: 'step', text: `${c1_obj.display} ${op} ${c2_obj.display} ‚âà ${c1_round_str} ${op} ${c2_round_str} = <b>${ansC_str}</b>` });
            steps.push({ type: 'step', text: `V·∫≠y ∆∞·ªõc l∆∞·ª£ng k·∫øt qu·∫£ c·ªßa ph√©p t√≠nh kho·∫£ng <b>${ansC_str}</b>`, isLast: true });

            return {
                a_text, a1_raw, a2_raw, isNegA, ansA1, ansA2,
                b_num, d, ansB, questionB_Html, displayB_Question, b_ctx,
                c_disp: `${c1_obj.display} ${op} ${c2_obj.display}`,
                op, c1_round: c1_round_str, c2_round: c2_round_str, ansC: ansC_str,
                steps
            };
        }

        // --- Core Interaction ---
        function nextQuestion() {
            if (!isAnswered && document.getElementById('q-a-round-text').innerText !== '...') {
                skippedTotal++;
                streak = 0;
                updateStatsUI();
            }

            currentData = generateProblem();
            stepIndex = 0;
            isAnswered = false;
            
            // Reset Stats Lock
            statsEnabled = true;
            updateStatsUI();

            // Reset UI
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            
            const inputs = ['ans-a1', 'ans-a2', 'ans-b', 'ans-c-p1', 'ans-c-p2', 'ans-c-final'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.disabled = false;
                el.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50', 'bg-emerald-50', 'border-emerald-500');
                if (id === 'ans-c-final') el.classList.add('border-indigo-100');
                else el.classList.add('border-gray-300');
            });

            // Display Chalkboard
            document.getElementById('q-a-round-text').textContent = currentData.a_text;
            document.getElementById('q-a1-disp').textContent = `${currentData.isNegA ? '-' : ''}‚àö${currentData.a1_raw}`;
            document.getElementById('q-a2-disp').textContent = `‚àö${currentData.a2_raw}`;
            
            // Render HTML c√¢u B
            document.getElementById('q-b-text').innerHTML = currentData.questionB_Html + ":";
            
            document.getElementById('q-c-expr').textContent = currentData.c_disp;

            document.getElementById('lbl-a1').textContent = `${currentData.isNegA ? '-' : ''}‚àö${currentData.a1_raw} ‚âà`;
            document.getElementById('lbl-a2').textContent = `‚àö${currentData.a2_raw} ‚âà`;
            
            // Label input B
            const ctxLabel = currentData.b_ctx.name ? ` (${currentData.b_ctx.name})` : '';
            document.getElementById('lbl-b').textContent = `${currentData.displayB_Question} (d=${currentData.d})${ctxLabel} ‚âà`;
            
            document.getElementById('c-op-icon').innerHTML = currentData.op === '.' ? '<i class="fas fa-times"></i>' : `<i class="fas fa-${currentData.op === '+' ? 'plus' : 'minus'}"></i>`;

            document.getElementById('steps-container').innerHTML = '<div class="text-gray-400 italic text-sm text-center mt-20">B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem h∆∞·ªõng d·∫´n chi ti·∫øt t·ª´ng b∆∞·ªõc</div>';
            document.getElementById('btn-show-step').disabled = false;
            document.getElementById('btn-show-step').innerHTML = 'G·ª£i √Ω ti·∫øp <i class="fas fa-arrow-right ml-1"></i>';
            updateStepCounter();
        }

        function updateStepCounter() {
            document.getElementById('step-counter').textContent = `B∆∞·ªõc: ${stepIndex}/${currentData.steps.length}`;
        }

        function showNextStep() {
            // TRIGGER DISABLE STATS
            disableStats();

            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            const ruleContent = document.getElementById('rule-content');

            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentData.steps.length) {
                const step = currentData.steps[stepIndex];
                if (step.type === 'header') {
                    const h = document.createElement('div');
                    h.className = "mt-4 mb-2 text-xs font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 flex items-center";
                    h.innerHTML = `<i class="fas fa-caret-right mr-1"></i> ${step.text}`;
                    container.appendChild(h);

                    if (step.rule) {
                        ruleContent.innerHTML = `<i class="fas fa-lightbulb mr-1 text-amber-600"></i> <b>L∆∞u √Ω:</b> ${step.rule}`;
                        ruleArea.classList.remove('hidden');
                        ruleArea.classList.remove('animate-pulse');
                        void ruleArea.offsetWidth; 
                        ruleArea.classList.add('animate-pulse');
                    }
                } else {
                    const s = document.createElement('div');
                    s.className = `step-item p-3 rounded-lg shadow-sm text-sm border-l-4 font-medium mb-2 ${step.isLast ? 'bg-emerald-50 border-emerald-500 text-emerald-900' : 'bg-gray-50 border-indigo-400 text-gray-700'}`;
                    s.innerHTML = step.text;
                    container.appendChild(s);
                }
                stepIndex++;
                updateStepCounter();
                container.scrollTop = container.scrollHeight;
            }

            if (stepIndex >= currentData.steps.length) {
                document.getElementById('btn-show-step').disabled = true;
                document.getElementById('btn-show-step').innerHTML = '<i class="fas fa-check-circle"></i> <span>H·∫øt</span>';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;

            const vA1 = document.getElementById('ans-a1').value.trim().replace(/\s/g, '');
            const vA2 = document.getElementById('ans-a2').value.trim().replace(/\s/g, '');
            const vB = document.getElementById('ans-b').value.trim().replace(/\s/g, '');
            const vCP1 = document.getElementById('ans-c-p1').value.trim().replace(/\s/g, '');
            const vCP2 = document.getElementById('ans-c-p2').value.trim().replace(/\s/g, '');
            const vCF = document.getElementById('ans-c-final').value.trim().replace(/\s/g, '');

            let correct = 0;
            
            if (vA1 === currentData.ansA1.replace(/\s/g, '')) { mark('ans-a1', true); correct++; } else mark('ans-a1', false);
            if (vA2 === currentData.ansA2.replace(/\s/g, '')) { mark('ans-a2', true); correct++; } else mark('ans-a2', false);
            if (vB === currentData.ansB.replace(/\s/g, '')) { mark('ans-b', true); correct++; } else mark('ans-b', false);

            const c1Ok = vCP1 === currentData.c1_round.replace(/\s/g, '');
            const c2Ok = vCP2 === currentData.c2_round.replace(/\s/g, '');
            const cFOk = vCF === currentData.ansC.replace(/\s/g, '');
            
            mark('ans-c-p1', c1Ok);
            mark('ans-c-p2', c2Ok);
            mark('ans-c-final', cFOk);

            if (c1Ok && c2Ok && cFOk) correct++;

            const fb = document.getElementById('feedback');
            fb.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-emerald-100', 'text-emerald-700', 'bg-gray-100', 'text-gray-700', 'bg-blue-100', 'text-blue-800');
            
            // LOGIC T√çNH ƒêI·ªÇM
            if (correct === 4) {
                if (statsEnabled) {
                    streak++;
                    correctTotal++;
                    fb.innerHTML = '<i class="fas fa-crown"></i> Xu·∫•t s·∫Øc! B·∫°n l√†m ƒë√∫ng h·∫øt r·ªìi.';
                    fb.classList.add('bg-green-100', 'text-green-800');
                    updateStatsUI();
                } else {
                    fb.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem g·ª£i √Ω)';
                    fb.classList.add('bg-blue-100', 'text-blue-800');
                }

                isAnswered = true;
                const timer = setInterval(() => {
                    if (stepIndex < currentData.steps.length) showNextStep();
                    else clearInterval(timer);
                }, 100);
            } else {
                fb.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> B·∫°n ƒë√∫ng ${correct}/4 c√¢u. H√£y ki·ªÉm tra l·∫°i nh√©!`;
                fb.classList.add('bg-red-100', 'text-red-700');
                
                // Sai th√¨ reset chu·ªói (n·∫øu ƒëang trong ch·∫ø ƒë·ªô t√≠nh ƒëi·ªÉm)
                if (statsEnabled) {
                    streak = 0;
                    wrongTotal++;
                    updateStatsUI();
                }
            }
        }

        function mark(id, isCorrect) {
            const el = document.getElementById(id);
            if (isCorrect) {
                el.classList.remove('border-gray-300', 'border-red-500', 'bg-red-50');
                el.classList.add('border-emerald-500', 'bg-emerald-50');
            } else {
                el.classList.remove('border-gray-300', 'border-emerald-500', 'bg-emerald-50', 'border-indigo-100');
                el.classList.add('border-red-500', 'bg-red-50');
            }
        }

        window.onload = nextQuestion;
    </script>
</body>
</html>