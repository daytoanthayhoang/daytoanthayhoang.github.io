<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To√°n 7 - B√†i 1: L√†m tr√≤n & ∆Ø·ªõc l∆∞·ª£ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f4f8;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #1e293b;
            color: #f8fafc;
            border: 10px solid #78350f;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        .highlight-digit {
            color: #ef4444; /* red-500 */
            text-decoration: underline;
            text-decoration-color: #ef4444;
            text-decoration-thickness: 3px;
            text-underline-offset: 3px;
            font-weight: 800;
            font-size: 1.1em;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=text] { -moz-appearance: textfield; }
        
        /* Animation cho Streak */
        @keyframes fire-pulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(255, 165, 0, 0)); }
            50% { transform: scale(1.2); filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(255, 165, 0, 0)); }
        }
        .streak-active {
            animation: fire-pulse 1s infinite;
        }
        .stats-disabled {
            opacity: 0.5;
            filter: grayscale(100%);
            position: relative;
        }
        .stats-disabled::after {
            content: '\f023'; /* FontAwesome Lock icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-indigo-100">
        <!-- Header -->
        <div class="bg-indigo-700 p-3 md:p-4 relative shadow-lg flex flex-col md:flex-row items-center justify-between gap-4">
            <h1 class="text-lg md:text-xl font-extrabold text-white uppercase tracking-wider flex items-center">
                <i class="fas fa-microchip mr-2 text-indigo-300"></i>
                <span class="hidden md:inline">√îN T·∫¨P: </span>L√ÄM TR√íN & ∆Ø·ªöC L∆Ø·ª¢NG
            </h1>
            
            <!-- Stats Bar -->
            <div id="stats-bar" class="flex items-center gap-3 bg-indigo-800/50 p-2 rounded-xl backdrop-blur-sm border border-indigo-500/30 transition-all duration-300">
                <!-- Streak -->
                <div class="flex items-center gap-1 bg-orange-500/20 px-3 py-1 rounded-lg border border-orange-500/30 group relative">
                    <i class="fas fa-fire text-orange-400 text-xl transition-all" id="streak-icon"></i>
                    <div class="flex flex-col items-center leading-none">
                        <span class="text-[10px] text-orange-200 uppercase font-bold">Chu·ªói</span>
                        <span id="streak-count" class="text-orange-300 font-black text-lg">0</span>
                    </div>
                    <!-- Share Button (Hover/Click) -->
                    <button onclick="shareStreak()" class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 bg-white text-indigo-600 text-xs font-bold px-2 py-1 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 hover:bg-gray-100">
                        <i class="fas fa-share-alt mr-1"></i>Share
                    </button>
                </div>

                <!-- Correct -->
                <div class="flex items-center gap-2 px-3 border-r border-indigo-500/30">
                    <i class="fas fa-check-circle text-emerald-400 text-lg"></i>
                    <span id="correct-count" class="text-white font-bold text-lg">0</span>
                </div>

                <!-- Wrong -->
                <div class="flex items-center gap-2 px-2">
                    <i class="fas fa-times-circle text-rose-400 text-lg"></i>
                    <span id="wrong-count" class="text-white font-bold text-lg">0</span>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-6 space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- C·ªòT TR√ÅI: ƒê·ªÄ B√ÄI & NH·∫¨P LI·ªÜU -->
                <div class="flex flex-col gap-4">
                    <div class="chalkboard p-6 min-h-[450px]">
                        <div class="space-y-6 font-mono text-lg md:text-xl">
                            <!-- C√¢u a -->
                            <div>
                                <div class="flex items-center mb-1">
                                    <span class="text-yellow-400 font-bold mr-2">a)</span>
                                    <span class="text-blue-200 text-base font-sans">T√≠nh (l√†m tr√≤n ƒë·∫øn <span id="q-a-round-text" class="underline decoration-yellow-400">...</span>):</span>
                                </div>
                                <div class="pl-8 text-white tracking-wider">
                                    <span id="q-a1-disp">...</span> &approx; ? <br> <span id="q-a2-disp">...</span> &approx; ?
                                </div>
                            </div>

                            <!-- C√¢u b -->
                            <div class="border-t border-slate-600 pt-4">
                                <div class="flex mb-1">
                                    <span class="text-yellow-400 font-bold mr-2 whitespace-nowrap">b)</span>
                                    <span class="text-blue-200 text-base font-sans" id="q-b-text">
                                        L√†m tr√≤n <span id="q-b-num">...</span> v·ªõi ƒë·ªô ch√≠nh x√°c d = <span id="q-b-d">...</span>:
                                    </span>
                                </div>
                                <div class="pl-8 text-white">
                                    K·∫øt qu·∫£ &approx; ?
                                </div>
                            </div>

                            <!-- C√¢u c -->
                            <div class="border-t border-slate-600 pt-4">
                                <div class="flex items-center mb-1">
                                    <span class="text-yellow-400 font-bold mr-2">c)</span>
                                    <span class="text-blue-200 text-sm font-sans">L√†m tr√≤n m·ªói s·ªë ƒë·∫øn h√†ng cao nh·∫•t ƒë·ªÉ ∆∞·ªõc l∆∞·ª£ng:</span>
                                </div>
                                <div class="pl-8 text-white tracking-wider">
                                    <span id="q-c-expr">...</span> &approx; ?
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NH·∫¨P ƒê√ÅP √ÅN -->
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-inner">
                        <div class="space-y-4">
                            <!-- Input A -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="input-group">
                                    <label id="lbl-a1" class="block text-gray-500 font-bold text-[11px] uppercase mb-1 truncate">...</label>
                                    <input type="text" id="ans-a1" placeholder="-7,68" class="w-full text-center font-bold p-2 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                </div>
                                <div class="input-group">
                                    <label id="lbl-a2" class="block text-gray-500 font-bold text-[11px] uppercase mb-1 truncate">...</label>
                                    <input type="text" id="ans-a2" placeholder="38,14" class="w-full text-center font-bold p-2 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                </div>
                            </div>
                            <!-- Input B -->
                            <div class="input-group">
                                <label id="lbl-b" class="block text-gray-500 font-bold text-[11px] uppercase mb-1 truncate">...</label>
                                <input type="text" id="ans-b" placeholder="20 940 000" class="w-full text-center font-bold p-2 border-2 rounded-lg focus:border-indigo-500 outline-none">
                            </div>
                            <!-- Input C -->
                            <div class="bg-white p-3 rounded-lg border border-slate-200">
                                <span class="block text-gray-400 font-bold text-[10px] uppercase mb-2">∆Ø·ªõc l∆∞·ª£ng: Nh·∫≠p s·ªë ƒë√£ l√†m tr√≤n v√†o 2 √¥ ƒë·∫ßu</span>
                                <div class="grid grid-cols-7 gap-1 items-center">
                                    <input type="text" id="ans-c-p1" class="col-span-3 text-center font-bold p-2 border rounded-lg text-sm" placeholder="-60">
                                    <div class="col-span-1 flex justify-center font-bold text-gray-400" id="c-op-icon">...</div>
                                    <input type="text" id="ans-c-p2" class="col-span-3 text-center font-bold p-2 border rounded-lg text-sm" placeholder="90">
                                </div>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="text-xs font-bold text-gray-400 whitespace-nowrap">KQ = </span>
                                    <input type="text" id="ans-c-final" placeholder="?" class="flex-grow text-center font-bold p-2 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-4">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg transition-all text-gray-700">
                                <i class="fas fa-sync-alt mr-1"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg shadow-lg transition-all transform active:scale-95">
                                <i class="fas fa-check mr-1"></i> Ki·ªÉm tra
                            </button>
                        </div>
                        <div id="feedback" class="hidden mt-3 text-center p-2 rounded-lg text-sm font-bold"></div>
                        <div id="hint-warning" class="hidden mt-2 text-center text-xs text-amber-600 font-semibold bg-amber-50 p-1 rounded border border-amber-200">
                            <i class="fas fa-lock mr-1"></i>ƒê√£ xem g·ª£i √Ω: Th√†nh t√≠ch c√¢u n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh.
                        </div>
                    </div>
                </div>

                <!-- C·ªòT PH·∫¢I: H∆Ø·ªöNG D·∫™N GI·∫¢I & TR√åNH B√ÄY -->
                <div class="flex flex-col h-[550px] lg:h-[750px] bg-white rounded-xl border-2 border-dashed border-slate-300 p-4">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b">
                        <h3 class="font-bold text-slate-700 text-sm uppercase">
                            <i class="fas fa-chalkboard-teacher text-indigo-500 mr-1"></i>H∆∞·ªõng d·∫´n gi·∫£i
                        </h3>
                        <button onclick="showNextStep()" id="btn-show-step" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all">
                            G·ª£i √Ω ti·∫øp <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>

                    <div id="rule-area" class="hidden mb-3 bg-amber-50 text-amber-900 text-xs p-3 rounded-lg border-l-4 border-amber-500 shadow-sm transition-all">
                        <span id="rule-content"></span>
                    </div>
                    
                    <div id="steps-container" class="flex-grow overflow-y-auto space-y-4 p-1 pr-2">
                        <div class="text-gray-400 italic text-sm text-center mt-20">B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem h∆∞·ªõng d·∫´n chi ti·∫øt t·ª´ng b∆∞·ªõc</div>
                    </div>
                    <div id="step-counter" class="text-center text-[10px] text-gray-400 mt-2 font-bold uppercase tracking-widest">B∆∞·ªõc: 0/0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-50 text-sm font-bold">
        Copied!
    </div>

    <script>
        // --- State ---
        let currentData = {};
        let stepIndex = 0;
        let isAnswered = false;
        
        // Stats
        let streak = 0;
        let correctTotal = 0;
        let wrongTotal = 0;
        let statsEnabled = true; // True = c√≥ t√≠nh ƒëi·ªÉm, False = ƒë√£ d√πng g·ª£i √Ω, kh√¥ng t√≠nh

        // --- Utils Format ---
        function fmt(num, decimals = null) {
            let str = decimals !== null ? num.toFixed(decimals) : num.toString();
            str = str.replace('.', ',');
            let parts = str.split(',');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            return parts.join(',');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => { toast.classList.add('opacity-0'); }, 2000);
        }

        function shareStreak() {
            const msg = `üî• T√¥i ƒëang c√≥ chu·ªói ${streak} c√¢u ƒë√∫ng li√™n ti·∫øp m√¥n To√°n 7! ƒê·ªë b·∫°n v∆∞·ª£t qua ƒë∆∞·ª£c ƒë·∫•y! üöÄ #Toan7 #ThuThachHocTap`;
            navigator.clipboard.writeText(msg).then(() => {
                showToast("ƒê√£ copy chu·ªói th√†nh t√≠ch!");
            }).catch(err => {
                showToast("L·ªói copy!");
            });
        }

        function updateStatsUI() {
            const streakEl = document.getElementById('streak-count');
            const streakIcon = document.getElementById('streak-icon');
            const statsBar = document.getElementById('stats-bar');
            
            // Update Text
            streakEl.textContent = streak;
            document.getElementById('correct-count').textContent = correctTotal;
            document.getElementById('wrong-count').textContent = wrongTotal;

            // Visual State for Disabled
            if (!statsEnabled) {
                statsBar.classList.add('stats-disabled');
                document.getElementById('hint-warning').classList.remove('hidden');
            } else {
                statsBar.classList.remove('stats-disabled');
                document.getElementById('hint-warning').classList.add('hidden');
            }

            // Streak Animation
            if (streak > 2) {
                streakIcon.classList.add('streak-active');
                streakIcon.style.color = '#ff4500'; // ƒê·ªè cam ƒë·∫≠m
            } else {
                streakIcon.classList.remove('streak-active');
                streakIcon.style.color = ''; // Reset
            }
        }

        function disableStats() {
            if (statsEnabled) {
                statsEnabled = false;
                updateStatsUI();
            }
        }

        // --- Generator Logic ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateRepeatingDec(isNegative) {
            const int = getRandomInt(1, 100) * (isNegative ? -1 : 1);
            const cycle = getRandomInt(1, 99);
            const display = `${int},(${cycle})`;
            const valStr = `${int}.${cycle}${cycle}${cycle}${cycle}`;
            return { display, value: parseFloat(valStr) };
        }

        function roundToHighest(num) {
            const abs = Math.abs(num);
            if (abs === 0) return 0;
            const sign = num < 0 ? -1 : 1;
            const power = Math.floor(Math.log10(abs));
            const unit = Math.pow(10, power);
            const roundedAbs = Math.round(abs / unit) * unit;
            return roundedAbs * sign;
        }

        // Highlight Logic
        function getHighlightedNumber(num, roundUnit) {
            let absNum = Math.abs(num);
            let sign = num < 0 ? '-' : '';
            let power = Math.round(Math.log10(roundUnit)); 
            let strVal = absNum.toString(); 

            if (power < 0) {
                let requiredDecimals = Math.abs(power) + 1;
                let currentDecimals = (strVal.split('.')[1] || '').length;
                if (currentDecimals < requiredDecimals) strVal = absNum.toFixed(requiredDecimals);
            }

            let parts = strVal.split('.');
            let intPart = parts[0];
            let decPart = parts[1] || '';
            let hInt = "", hDec = "";
            
            if (power >= 0) {
                let digitIndexFromRight = power;
                let arr = intPart.split('').reverse();
                if (digitIndexFromRight < arr.length) {
                    arr[digitIndexFromRight] = `<span class="highlight-digit">${arr[digitIndexFromRight]}</span>`;
                }
                let res = "";
                for (let i = 0; i < arr.length; i++) {
                    if (i > 0 && i % 3 === 0) res = " " + res;
                    res = arr[i] + res;
                }
                hInt = res;
                if (decPart) hDec = "," + decPart;
            } else {
                let idx = Math.abs(power) - 1; 
                hInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                let arr = decPart.split('');
                if (idx < arr.length) {
                    arr[idx] = `<span class="highlight-digit">${arr[idx]}</span>`;
                    hDec = "," + arr.join('');
                } else {
                    hDec = decPart ? "," + decPart : "";
                }
            }
            return sign + hInt + hDec;
        }

        function getHighlighedDecimal(val, places) {
             return getHighlightedNumber(val, Math.pow(10, -places));
        }

        function highlightFirstSignificantDigit(displayStr) {
            return displayStr.replace(/([1-9])/, '<span class="highlight-digit">$1</span>');
        }

        function generateProblem() {
            // --- C√¢u A ---
            const isNegA = Math.random() < 0.4;
            const randA = Math.random();
            let a_places, a_text;
            
            if (randA < 0.7) {
                const type = getRandomInt(0, 1);
                a_places = type === 0 ? 1 : 2;
                a_text = type === 0 ? "h√†ng ph·∫ßn m∆∞·ªùi" : "h√†ng ph·∫ßn trƒÉm";
            } else {
                const type = getRandomInt(0, 1);
                a_places = type === 0 ? 3 : 4;
                a_text = type === 0 ? "h√†ng ph·∫ßn ngh√¨n" : "h√†ng ph·∫ßn ch·ª•c ngh√¨n";
            }
            
            const a1_raw = getRandomInt(10, 150); 
            const a2_raw = getRandomInt(100, 5000);
            const vA1 = Math.sqrt(a1_raw) * (isNegA ? -1 : 1);
            const vA2 = Math.sqrt(a2_raw); 
            const ansA1 = fmt(vA1, a_places);
            const ansA2 = fmt(vA2, a_places);
            const vA1_disp_val = parseFloat(vA1.toFixed(a_places + 2)); 
            const vA2_disp_val = parseFloat(vA2.toFixed(a_places + 2));
            const displayA1 = getHighlighedDecimal(vA1_disp_val, a_places) + "...";
            const displayA2 = getHighlighedDecimal(vA2_disp_val, a_places) + "...";

            // --- C√¢u B ---
            const isNegB = Math.random() < 0.2;
            let d, b_round_unit, b_num;
            
            // Random Context
            const contexts = [
                { name: null, unit: '' },
                { name: 'd√¢n s·ªë', unit: 'ng∆∞·ªùi' },
                { name: 'di·ªán t√≠ch', unit: 'km¬≤' },
                { name: 's·∫£n l∆∞·ª£ng', unit: 't·∫•n' },
                { name: 't·ªïng doanh thu', unit: 'ƒë·ªìng' }
            ];
            // 50% c√≥ context
            const ctxIdx = Math.random() < 0.5 ? 0 : getRandomInt(1, contexts.length - 1);
            const b_ctx = contexts[ctxIdx];

            const randD = Math.random();
            if (randD < 0.2 && !b_ctx.unit) { // Ch·ªâ s·ªë th·∫≠p ph√¢n n·∫øu kh√¥ng c√≥ context (ƒë·ªÉ h·ª£p l√Ω h∆°n)
                const d_opts = [0.05, 0.5, 0.005];
                d = d_opts[getRandomInt(0, 2)];
                b_round_unit = d * 2;
                let decimals = Math.abs(Math.log10(b_round_unit)) + 2; 
                let base = getRandomInt(10, 9999);
                let frac = getRandomInt(100, 9999);
                b_num = parseFloat(`${base}.${frac}`);
                if (isNegB) b_num *= -1;
            } else {
                const d_opts = [50, 500, 5000, 50000, 500000];
                d = d_opts[getRandomInt(0, d_opts.length - 1)];
                b_round_unit = d * 2;
                const minVal = b_round_unit * 10;
                const maxVal = b_round_unit * 1000;
                b_num = getRandomInt(minVal, maxVal) * (isNegB ? -1 : 1);
            }
            let ansB_val = Math.round(b_num / b_round_unit) * b_round_unit;
            if (b_round_unit < 1) {
                const decimalPoints = b_round_unit.toString().split('.')[1]?.length || 0;
                ansB_val = parseFloat(ansB_val.toFixed(decimalPoints));
            }
            const ansB = fmt(ansB_val);
            const displayB_Question = fmt(b_num);
            const displayB_Step = getHighlightedNumber(b_num, b_round_unit);
            
            // Text hi·ªÉn th·ªã ƒë·ªÅ b√†i B
            const questionB_Text = `L√†m tr√≤n ${b_ctx.name ? b_ctx.name + ' ' : ''}${displayB_Question}${b_ctx.unit ? ' ' + b_ctx.unit : ''} v·ªõi ƒë·ªô ch√≠nh x√°c d = ${d}`;
            const questionB_Html = `L√†m tr√≤n ${b_ctx.name ? b_ctx.name + ' ' : ''}<span id="q-b-num">${displayB_Question}</span>${b_ctx.unit ? ' ' + b_ctx.unit : ''} v·ªõi ƒë·ªô ch√≠nh x√°c d = <span id="q-b-d">${d}</span>`;

            let unitName = "";
            if (b_round_unit >= 1) {
                if (b_round_unit === 1) unitName = "h√†ng ƒë∆°n v·ªã";
                else if (b_round_unit === 10) unitName = "h√†ng ch·ª•c";
                else if (b_round_unit === 100) unitName = "h√†ng trƒÉm";
                else if (b_round_unit === 1000) unitName = "h√†ng ngh√¨n";
                else if (b_round_unit === 10000) unitName = "h√†ng ch·ª•c ngh√¨n";
                else unitName = `h√†ng ${fmt(b_round_unit)}`;
            } else {
                if (b_round_unit === 0.1) unitName = "h√†ng ph·∫ßn m∆∞·ªùi";
                else if (b_round_unit === 0.01) unitName = "h√†ng ph·∫ßn trƒÉm";
                else if (b_round_unit === 0.001) unitName = "h√†ng ph·∫ßn ngh√¨n";
                else unitName = `v·ªã tr√≠ ${fmt(b_round_unit)}`;
            }

            // --- C√¢u C ---
            const isComplex = Math.random() < 0.5; 
            const isAddSub = Math.random() < 0.4;
            const op = isAddSub ? (Math.random() < 0.5 ? '+' : '-') : '.';
            const magRand = Math.random();
            let minC, maxC, divC;
            if (magRand < 0.1) { minC = 10000; maxC = 999999; divC = 100; } 
            else if (magRand < 0.4) { minC = 1000; maxC = 9999; divC = 10; } 
            else { minC = 100; maxC = 999; divC = 10; }

            let c1_obj, c2_obj;
            if (isComplex) {
                c1_obj = generateRepeatingDec(Math.random() < 0.5); 
                let val2 = getRandomInt(minC, maxC) / divC;
                if (Math.random() < 0.5) val2 *= -1;
                c2_obj = { display: fmt(val2), value: val2 };
            } else {
                let val1 = getRandomInt(minC, maxC) / divC;
                if (Math.random() < 0.5) val1 *= -1;
                c1_obj = { display: fmt(val1), value: val1 };
                let val2 = getRandomInt(Math.max(10, minC/10), maxC) / divC;
                if (Math.random() < 0.5) val2 *= -1;
                c2_obj = { display: fmt(val2), value: val2 };
            }
            if (Math.abs(c1_obj.value) < 1) c1_obj.value = (c1_obj.value < 0 ? -1.5 : 1.5);
            if (Math.abs(c2_obj.value) < 1) c2_obj.value = (c2_obj.value < 0 ? -2.5 : 2.5);

            const c1_round_val = roundToHighest(c1_obj.value);
            const c2_round_val = roundToHighest(c2_obj.value);
            const c1_disp_hl = highlightFirstSignificantDigit(c1_obj.display);
            const c2_disp_hl = highlightFirstSignificantDigit(c2_obj.display);
            let ansC_val;
            if (op === '+') ansC_val = c1_round_val + c2_round_val;
            else if (op === '-') ansC_val = c1_round_val - c2_round_val;
            else ansC_val = c1_round_val * c2_round_val;
            const c1_round_str = fmt(c1_round_val);
            const c2_round_str = fmt(c2_round_val);
            const ansC_str = fmt(ansC_val);

            // Steps
            const steps = [
                { type: 'header', text: 'a) CƒÉn b·∫≠c hai & L√†m tr√≤n', rule: `L√†m tr√≤n ƒë·∫øn ${a_text}: Quan s√°t ch·ªØ s·ªë ngay sau h√†ng l√†m tr√≤n (ƒë∆∞·ª£c g·∫°ch ch√¢n).` },
                { type: 'step', text: `a) ${isNegA?'-':''}‚àö${a1_raw} = ${displayA1} ‚âà <b>${ansA1}</b>` },
                { type: 'step', text: `‚àö${a2_raw} = ${displayA2} ‚âà <b>${ansA2}</b>` },

                { type: 'header', text: 'b) ƒê·ªô ch√≠nh x√°c d', rule: `<b>B∆∞·ªõc 1:</b> X√°c ƒë·ªãnh h√†ng l√†m tr√≤n. V√¨ d = ${d} n√™n ta l√†m tr√≤n ƒë·∫øn <b>${unitName}</b> (g·∫•p ƒë√¥i d).<br><b>B∆∞·ªõc 2:</b> Quan s√°t ch·ªØ s·ªë ·ªü <b>${unitName}</b> (ƒë∆∞·ª£c g·∫°ch ch√¢n m√†u ƒë·ªè) v√† ch·ªØ s·ªë ngay b√™n ph·∫£i n√≥ ƒë·ªÉ quy·∫øt ƒë·ªãnh l√†m tr√≤n l√™n hay gi·ªØ nguy√™n.` },
                { type: 'step', text: `b) V·ªõi d=${d}, s·ªë ${displayB_Step} ‚âà <b>${ansB}</b>` },
            ];

            // Th√™m k·∫øt lu·∫≠n th·ª±c t·∫ø n·∫øu c√≥ ng·ªØ c·∫£nh
            if (b_ctx.name) {
                steps.push({ type: 'step', text: `V·∫≠y ${b_ctx.name} x·∫•p x·ªâ <b>${ansB} ${b_ctx.unit}</b>` });
            }

            // Steps c√¢u C
            steps.push({ type: 'header', text: 'c) ∆Ø·ªõc l∆∞·ª£ng ph√©p t√≠nh', rule: 'L√†m tr√≤n m·ªói s·ªë v·ªÅ h√†ng cao nh·∫•t. Quan s√°t ch·ªØ s·ªë ƒë·∫ßu ti√™n kh√°c 0 (ƒë∆∞·ª£c g·∫°ch ch√¢n ƒë·ªè).' });
            steps.push({ type: 'step', text: `${c1_disp_hl} ‚âà ${c1_round_str}` });
            steps.push({ type: 'step', text: `${c2_disp_hl} ‚âà ${c2_round_str}` });
            steps.push({ type: 'step', text: `${c1_obj.display} ${op} ${c2_obj.display} ‚âà ${c1_round_str} ${op} ${c2_round_str} = <b>${ansC_str}</b>` });
            steps.push({ type: 'step', text: `V·∫≠y ∆∞·ªõc l∆∞·ª£ng k·∫øt qu·∫£ c·ªßa ph√©p t√≠nh kho·∫£ng <b>${ansC_str}</b>`, isLast: true });

            return {
                a_text, a1_raw, a2_raw, isNegA, ansA1, ansA2,
                b_num, d, ansB, questionB_Html, displayB_Question, b_ctx,
                c_disp: `${c1_obj.display} ${op} ${c2_obj.display}`,
                op, c1_round: c1_round_str, c2_round: c2_round_str, ansC: ansC_str,
                steps
            };
        }

        // --- Core Interaction ---
        function nextQuestion() {
            currentData = generateProblem();
            stepIndex = 0;
            isAnswered = false;
            
            // Reset Stats Lock
            statsEnabled = true;
            updateStatsUI();

            document.getElementById('q-a-round-text').textContent = currentData.a_text;
            document.getElementById('q-a1-disp').textContent = `${currentData.isNegA ? '-' : ''}‚àö${currentData.a1_raw}`;
            document.getElementById('q-a2-disp').textContent = `‚àö${currentData.a2_raw}`;
            
            // Render HTML c√¢u B
            document.getElementById('q-b-text').innerHTML = currentData.questionB_Html + ":";
            
            document.getElementById('q-c-expr').textContent = currentData.c_disp;

            document.getElementById('lbl-a1').textContent = `${currentData.isNegA ? '-' : ''}‚àö${currentData.a1_raw} ‚âà`;
            document.getElementById('lbl-a2').textContent = `‚àö${currentData.a2_raw} ‚âà`;
            
            // Label input B
            const ctxLabel = currentData.b_ctx.name ? ` (${currentData.b_ctx.name})` : '';
            document.getElementById('lbl-b').textContent = `${currentData.displayB_Question} (d=${currentData.d})${ctxLabel} ‚âà`;
            
            document.getElementById('c-op-icon').innerHTML = currentData.op === '.' ? '<i class="fas fa-times"></i>' : `<i class="fas fa-${currentData.op === '+' ? 'plus' : 'minus'}"></i>`;

            // Reset Input
            ['ans-a1', 'ans-a2', 'ans-b', 'ans-c-p1', 'ans-c-p2', 'ans-c-final'].forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.className = el.id.includes('ans-c-') && id !== 'ans-c-final' 
                    ? "col-span-3 text-center font-bold p-2 border rounded-lg text-sm bg-white border-gray-300" 
                    : "w-full text-center font-bold p-2 border-2 rounded-lg focus:border-indigo-500 outline-none border-gray-300 bg-white";
                if(id === 'ans-c-final') el.className = "flex-grow text-center font-bold p-2 border-2 rounded-lg focus:border-indigo-500 outline-none border-gray-300 bg-white";
            });

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('steps-container').innerHTML = '<div class="text-gray-400 italic text-sm text-center mt-20">B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem h∆∞·ªõng d·∫´n chi ti·∫øt t·ª´ng b∆∞·ªõc</div>';
            document.getElementById('rule-area').classList.add('hidden');
            document.getElementById('btn-show-step').disabled = false;
            document.getElementById('btn-show-step').innerHTML = 'G·ª£i √Ω ti·∫øp <i class="fas fa-arrow-right ml-1"></i>';
            updateStepCounter();
        }

        function updateStepCounter() {
            document.getElementById('step-counter').textContent = `B∆∞·ªõc: ${stepIndex}/${currentData.steps.length}`;
        }

        function showNextStep() {
            // TRIGGER DISABLE STATS
            disableStats();

            const container = document.getElementById('steps-container');
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentData.steps.length) {
                const step = currentData.steps[stepIndex];
                if (step.type === 'header') {
                    const h = document.createElement('div');
                    h.className = "font-extrabold text-indigo-700 text-xs uppercase mt-5 mb-2 flex items-center gap-2 border-b-2 border-indigo-100 pb-1";
                    h.innerHTML = `<i class="fas fa-terminal"></i> ${step.text}`;
                    container.appendChild(h);

                    if (step.rule) {
                        document.getElementById('rule-content').innerHTML = `<i class="fas fa-lightbulb mr-1 text-amber-600"></i> <b>L∆∞u √Ω:</b> ${step.rule}`;
                        document.getElementById('rule-area').classList.remove('hidden');
                    }
                } else {
                    const s = document.createElement('div');
                    s.className = `step-item p-3 rounded-lg shadow-sm text-sm border-l-4 font-medium ${step.isLast ? 'bg-emerald-50 border-emerald-500 text-emerald-900' : 'bg-slate-50 border-slate-400 text-slate-700'}`;
                    s.innerHTML = step.text;
                    container.appendChild(s);
                }
                stepIndex++;
                updateStepCounter();
                container.scrollTop = container.scrollHeight;
            }

            if (stepIndex >= currentData.steps.length) {
                document.getElementById('btn-show-step').disabled = true;
                document.getElementById('btn-show-step').textContent = "Ho√†n th√†nh";
            }
        }

        function checkAnswer() {
            if (isAnswered) return;

            const vA1 = document.getElementById('ans-a1').value.trim().replace(/\s/g, '');
            const vA2 = document.getElementById('ans-a2').value.trim().replace(/\s/g, '');
            const vB = document.getElementById('ans-b').value.trim().replace(/\s/g, '');
            const vCP1 = document.getElementById('ans-c-p1').value.trim().replace(/\s/g, '');
            const vCP2 = document.getElementById('ans-c-p2').value.trim().replace(/\s/g, '');
            const vCF = document.getElementById('ans-c-final').value.trim().replace(/\s/g, '');

            let correct = 0;
            
            if (vA1 === currentData.ansA1.replace(/\s/g, '')) { mark('ans-a1', true); correct++; } else mark('ans-a1', false);
            if (vA2 === currentData.ansA2.replace(/\s/g, '')) { mark('ans-a2', true); correct++; } else mark('ans-a2', false);
            if (vB === currentData.ansB.replace(/\s/g, '')) { mark('ans-b', true); correct++; } else mark('ans-b', false);

            const c1Ok = vCP1 === currentData.c1_round.replace(/\s/g, '');
            const c2Ok = vCP2 === currentData.c2_round.replace(/\s/g, '');
            const cFOk = vCF === currentData.ansC.replace(/\s/g, '');
            
            mark('ans-c-p1', c1Ok);
            mark('ans-c-p2', c2Ok);
            mark('ans-c-final', cFOk);

            if (c1Ok && c2Ok && cFOk) correct++;

            const fb = document.getElementById('feedback');
            fb.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-emerald-100', 'text-emerald-700', 'bg-gray-100', 'text-gray-700');
            
            // LOGIC T√çNH ƒêI·ªÇM
            if (correct === 4) {
                fb.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Xu·∫•t s·∫Øc! B·∫°n l√†m ƒë√∫ng h·∫øt r·ªìi.';
                fb.classList.add('bg-emerald-100', 'text-emerald-700');
                
                // Ch·ªâ t√≠nh ƒëi·ªÉm n·∫øu ch∆∞a d√πng g·ª£i √Ω
                if (statsEnabled) {
                    streak++;
                    correctTotal++;
                    updateStatsUI();
                } else {
                    fb.innerHTML += ' (Kh√¥ng t√≠nh chu·ªói v√¨ ƒë√£ xem g·ª£i √Ω)';
                }

                isAnswered = true;
                const timer = setInterval(() => {
                    if (stepIndex < currentData.steps.length) showNextStep();
                    else clearInterval(timer);
                }, 100);
            } else {
                fb.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> B·∫°n ƒë√∫ng ${correct}/4 c√¢u. H√£y ki·ªÉm tra l·∫°i nh√©!`;
                fb.classList.add('bg-red-100', 'text-red-700');
                
                // Sai th√¨ reset chu·ªói (n·∫øu ƒëang trong ch·∫ø ƒë·ªô t√≠nh ƒëi·ªÉm)
                if (statsEnabled) {
                    streak = 0;
                    wrongTotal++;
                    updateStatsUI();
                }
            }
        }

        function mark(id, isCorrect) {
            const el = document.getElementById(id);
            if (isCorrect) {
                el.classList.remove('border-gray-300', 'border-red-500');
                el.classList.add('border-emerald-500', 'bg-emerald-50');
            } else {
                el.classList.remove('border-gray-300', 'border-emerald-500');
                el.classList.add('border-red-500', 'bg-red-50');
            }
        }

        window.onload = nextQuestion;
    </script>
</body>
</html>