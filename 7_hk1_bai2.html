<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p chinh ph·ª•c To√°n 7 HK1 - B√†i 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- MathJax for rendering LaTeX -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
      };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Fraction Style for Chalkboard (CSS only, faster update) */
        .frac {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 0.2rem;
            font-size: 1.2em;
        }
        .frac .num {
            border-bottom: 2px solid white;
            padding-bottom: 2px;
            width: 100%;
            text-align: center;
        }
        .frac .den {
            padding-top: 2px;
            width: 100%;
            text-align: center;
        }
        
        /* Stats Animation */
        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        
        .highlight-var {
            color: #fbbf24; /* Amber 400 */
            font-weight: bold;
        }
        
        /* Input Focus Ring Customization */
        .custom-input:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-calculator mr-2"></i>√în t·∫≠p chinh ph·ª•c To√°n 7 HK1 - B√†i 2
            </h1>
            <p class="text-white font-medium">Ch·ªß ƒë·ªÅ: T·ªâ l·ªá th·ª©c & T√¨m x</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 h-[350px] md:h-[400px] relative">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        
                        <div class="w-full h-full flex flex-col items-center justify-center">
                            <div class="text-blue-200 text-lg mb-6 font-sans">T√¨m <span class="text-yellow-400 font-bold italic">x</span> trong t·ªâ l·ªá th·ª©c:</div>
                            
                            <!-- Math Display -->
                            <div class="flex items-center gap-4 text-4xl md:text-5xl font-mono" id="problem-display">
                                <!-- Dynamic Content -->
                            </div>
                        </div>
                    </div>

                    <!-- NH·∫¨P ƒê√ÅP √ÅN -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        <div class="space-y-4">
                            <div class="flex flex-col items-center justify-center py-2">
                                <label class="block text-gray-500 font-bold text-xs uppercase mb-2">Nh·∫≠p gi√° tr·ªã x t√¨m ƒë∆∞·ª£c</label>
                                <div class="relative w-full max-w-xs">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-400 font-bold italic">x =</span>
                                    </div>
                                    <input type="text" id="ans-input" placeholder="-3,75 ho·∫∑c -15/4" 
                                        class="custom-input w-full pl-10 pr-4 py-3 text-center font-bold text-xl border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors"
                                        autocomplete="off">
                                </div>
                                <p class="text-xs text-gray-400 mt-2 italic">* Nh·∫≠p s·ªë th·∫≠p ph√¢n (d·∫•u ph·∫©y ho·∫∑c ch·∫•m) ho·∫∑c ph√¢n s·ªë (a/b)</p>
                            </div>
                        </div>

                        <!-- Difficulty Toggle -->
                        <div class="flex items-center justify-end mt-4 mb-2">
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-sm font-bold text-gray-600 peer-checked:text-red-600 transition-colors flex items-center">
                                    <i class="fas fa-skull-crossbones mr-1"></i>N√¢ng cao (20%)
                                </span>
                            </label>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>
                        <div id="feedback" class="hidden mt-3 text-center p-3 rounded-lg text-sm font-bold animate-pulse"></div>
                        <div id="hint-warning" class="hidden mt-2 text-center text-xs text-amber-600 font-semibold bg-amber-50 p-1 rounded border border-amber-200">
                            <i class="fas fa-lock mr-1"></i>ƒê√£ xem b√†i gi·∫£i: Th√†nh t√≠ch c√¢u n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh.
                        </div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[600px] lg:h-auto bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <!-- Button -->
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Rule Hint Area -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <div class="font-bold mb-1 text-xs uppercase text-yellow-700">M·∫πo ghi nh·ªõ:</div>
                        <div id="rule-content" class="font-medium text-sm"></div>
                    </div>
                    
                    <!-- Scrollable Steps -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-4 rounded-lg shadow-inner border border-gray-100 scroll-smooth font-serif text-lg leading-relaxed">
                        <div class="text-gray-400 italic text-sm text-center mt-20 flex flex-col items-center">
                            <i class="fas fa-pen-fancy text-3xl mb-3 opacity-30"></i>
                            <span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem m·∫´u tr√¨nh b√†y</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- State ---
        let currentData = {};
        let stepIndex = 0;
        let isAnswered = false;
        
        // Stats
        let streak = 0;
        let correctTotal = 0;
        let wrongTotal = 0;
        let skippedTotal = 0;
        let statsEnabled = true;

        // --- Formatting Utils ---
        function formatNumber(num) {
            // Handle integers
            if (Number.isInteger(num)) return num.toString();
            // Handle decimals: replace dot with comma
            return num.toString().replace('.', ',');
        }

        // Helper to display a fraction or number in HTML
        function renderValue(val) {
            // If it contains a slash, render as fraction
            if (val.toString().includes('/')) {
                const parts = val.toString().split('/');
                return `<div class="frac"><span class="num">${parts[0]}</span><span class="den">${parts[1]}</span></div>`;
            }
            return formatNumber(val);
        }

        function updateStatsUI() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = streak;
            document.getElementById('stat-correct').textContent = correctTotal;
            document.getElementById('stat-wrong').textContent = wrongTotal;
            document.getElementById('stat-skipped').textContent = skippedTotal;

            if (!statsEnabled) {
                document.getElementById('hint-warning').classList.remove('hidden');
            } else {
                document.getElementById('hint-warning').classList.add('hidden');
            }

            if (streak > 2) {
                streakEl.classList.add('streak-fire');
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${streak}`;
            } else {
                streakEl.classList.remove('streak-fire');
                streakEl.textContent = streak;
            }
        }

        function disableStats() {
            if (statsEnabled) {
                statsEnabled = false;
                updateStatsUI();
            }
        }

        // --- Math Logic ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function round2(num) {
            return Math.round((num + Number.EPSILON) * 100) / 100;
        }

        function generateProblem() {
            // Check difficulty/mode toggle
            const isHardMode = document.getElementById('mode-hard').checked;
            
            // Probability: 80% Standard (Decimals/Integers), 20% Extended (Harder)
            const isExtended = isHardMode ? true : (Math.random() < 0.2);
            
            let a, b, c, x_val;
            
            // Positions: 0: top-left (x), 1: bottom-left (x), 2: top-right (x), 3: bottom-right (x)
            // Layout:  Pos0 / Pos1 = Pos2 / Pos3
            let xPos = getRandomInt(0, 3);
            
            if (!isExtended) {
                // --- STANDARD (80%) ---
                // Types: Decimals (like 0,3; 1,2) or Integers/Simple Fractions
                const type = Math.random();
                
                if (type < 0.6) { // Decimal heavy (as per reference list)
                    
                    let ratio = getRandomInt(2, 20) / (Math.random() < 0.5 ? 1 : 10); // e.g. 2, 1.5, 0.4...
                    if (Math.random() < 0.5) ratio *= -1;
                    
                    // Let the known side be C/D = ratio
                    let D = getRandomInt(1, 100) / (Math.random() < 0.5 ? 1 : 10); // Denom
                    let C = D * ratio; 
                    
                    // Round to avoid float errors
                    C = parseFloat(C.toFixed(2));
                    D = parseFloat(D.toFixed(2));
                    
                    // Unknown side A/B. One is x, one is known.
                    let B_val = getRandomInt(1, 50) / (Math.random() < 0.5 ? 1 : 10);
                    B_val = parseFloat(B_val.toFixed(1));
                    
                    let A_val = B_val * ratio;
                    A_val = parseFloat(A_val.toFixed(3));
                    
                    // Assign to layout
                    if (xPos === 0) { // x / B = C / D
                        x_val = A_val; a = "x"; b = B_val; c = C; d = D;
                    } else if (xPos === 1) { // A / x = C / D
                        x_val = B_val; a = A_val; b = "x"; c = C; d = D;
                    } else if (xPos === 2) { // A / B = x / D
                        x_val = C; a = A_val; b = B_val; c = "x"; d = D;
                    } else { // A / B = C / x
                        x_val = D; a = A_val; b = B_val; c = C; d = "x";
                    }
                } else {
                    // Integer/Fraction Simple
                    // e.g. x/5 = -8/20
                    let denom1 = getRandomInt(2, 25);
                    let num1 = getRandomInt(1, 50) * (Math.random()<0.5?-1:1);
                    
                    if (xPos === 0 || xPos === 2) { // x is Numerator
                         let knownNum = num1;
                         let knownDenom = denom1;
                         let targetDenom = getRandomInt(2, 20);
                         
                         while ((targetDenom * knownNum) % knownDenom !== 0 && (targetDenom * knownNum * 10) % knownDenom !== 0) {
                             targetDenom = getRandomInt(2, 20);
                         }
                         
                         x_val = (targetDenom * knownNum) / knownDenom;
                         
                         if (xPos === 0) { // x / targetDenom = knownNum / knownDenom
                             a = "x"; b = targetDenom; c = knownNum; d = knownDenom;
                         } else { // knownNum / knownDenom = x / targetDenom
                             a = knownNum; b = knownDenom; c = "x"; d = targetDenom;
                         }
                    } else { // x is Denominator
                         let knownNum = num1; if(knownNum===0) knownNum=1;
                         let knownDenom = denom1;
                         let targetNum = getRandomInt(2, 50);
                         
                         while ((targetNum * knownDenom) % knownNum !== 0 && (targetNum * knownDenom * 10) % knownNum !== 0) {
                             targetNum = getRandomInt(2, 50);
                         }
                         x_val = (targetNum * knownDenom) / knownNum;

                         if (xPos === 1) { // targetNum / x = knownNum / knownDenom
                             a = targetNum; b = "x"; c = knownNum; d = knownDenom;
                         } else { // knownNum / knownDenom = targetNum / x
                             a = knownNum; b = knownDenom; c = targetNum; d = "x";
                         }
                    }
                }
            } else {
                // --- EXTENDED (20%) ---
                let val1 = parseFloat((Math.random() * 20 - 10).toFixed(1)); // -10.0 to 10.0
                let val2 = parseFloat((Math.random() * 20 - 10).toFixed(1));
                let val3 = parseFloat((Math.random() * 20 - 10).toFixed(1));
                if (val2 === 0) val2 = 2;
                if (val3 === 0) val3 = 5;
                
                let knownDiag1 = val1;
                let knownDiag2 = val2;
                let xPartner = val3;
                x_val = (knownDiag1 * knownDiag2) / xPartner;
                x_val = parseFloat(x_val.toFixed(4));
                
                if (xPos === 0) { // x is a. Pair (x, d). Known Pair (b, c)
                    a="x"; d=xPartner; b=knownDiag1; c=knownDiag2;
                } else if (xPos === 1) { // x is b
                    b="x"; c=xPartner; a=knownDiag1; d=knownDiag2;
                } else if (xPos === 2) { // x is c
                    c="x"; b=xPartner; a=knownDiag1; d=knownDiag2;
                } else { // x is d
                    d="x"; a=xPartner; b=knownDiag1; c=knownDiag2;
                }
            }

            // Generate Steps with LaTeX syntax
            let step1 = `V√¨ $\\frac{${a}}{${b}} = \\frac{${c}}{${d}}$`;
            let leftSide, rightSide;
            let coeff, prodStr, prodVal;
            
            // Determine pairs
            let isXInAD = (a === "x" || d === "x");
            
            if (isXInAD) {
                // x is in a or d. Equation: a*d = b*c
                let xTerm = (a === "x") ? d : a;
                let known1 = b;
                let known2 = c;
                
                if (a === "x") leftSide = `${formatNumber(d)}.x`;
                else leftSide = `${formatNumber(a)}.x`;
                
                if (d < 0 && a === "x") leftSide = `(${formatNumber(d)}).x`;
                if (a < 0 && d === "x") leftSide = `(${formatNumber(a)}).x`;
                
                rightSide = `${formatNumber(known1)}.${formatNumber(known2)}`;
                if (known2 < 0) rightSide = `${formatNumber(known1)}.(${formatNumber(known2)})`;
                
                coeff = (a === "x") ? d : a;
                prodVal = b * c;
                prodStr = formatNumber(parseFloat(prodVal.toFixed(5)));
            } else {
                // x is in b or c. Equation: b*c = a*d
                let xTerm = (b === "x") ? c : b;
                let known1 = a;
                let known2 = d;
                
                if (b === "x") leftSide = `${formatNumber(c)}.x`;
                else leftSide = `${formatNumber(b)}.x`;
                
                if (c < 0 && b === "x") leftSide = `(${formatNumber(c)}).x`;
                if (b < 0 && c === "x") leftSide = `(${formatNumber(b)}).x`;
                
                rightSide = `${formatNumber(known1)}.${formatNumber(known2)}`;
                if (known2 < 0) rightSide = `${formatNumber(known1)}.(${formatNumber(known2)})`;

                coeff = (b === "x") ? c : b;
                prodVal = a * d;
                prodStr = formatNumber(parseFloat(prodVal.toFixed(5)));
            }

            let step2 = `n√™n $${leftSide} = ${rightSide}$`;
            let step3 = `Do ƒë√≥ $x = \\frac{${prodStr}}{${formatNumber(coeff)}}$`;
            let step4 = `$x = ${formatNumber(x_val)}$`;
            let step5 = `V·∫≠y $x = ${formatNumber(x_val)}$`;

            const steps = [
                { text: step1 },
                { text: step2 },
                { text: step3 },
                { text: step4 },
                { text: step5, isLast: true }
            ];

            return {
                a, b, c, d, x_val, steps
            };
        }

        // --- View & Control ---
        function nextQuestion() {
            if (!isAnswered && document.getElementById('step-counter').textContent !== '0/0') {
                skippedTotal++;
                streak = 0;
                updateStatsUI();
            }

            currentData = generateProblem();
            stepIndex = 0;
            isAnswered = false;
            
            // Reset UI
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            document.getElementById('ans-input').value = '';
            document.getElementById('ans-input').disabled = false;
            document.getElementById('ans-input').classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700', 'border-red-500', 'bg-red-50', 'text-red-700');
            document.getElementById('ans-input').classList.add('border-gray-300');
            
            // Display Problem (Uses CSS/HTML for fractions to avoid MathJax flickering on main board)
            const p = currentData;
            document.getElementById('problem-display').innerHTML = `
                <div class="frac">
                    <span class="num ${p.a==='x'?'highlight-var':''}">${formatNumber(p.a)}</span>
                    <span class="den ${p.b==='x'?'highlight-var':''}">${formatNumber(p.b)}</span>
                </div>
                <span class="mx-2">=</span>
                <div class="frac">
                    <span class="num ${p.c==='x'?'highlight-var':''}">${formatNumber(p.c)}</span>
                    <span class="den ${p.d==='x'?'highlight-var':''}">${formatNumber(p.d)}</span>
                </div>
            `;
            
            // Reset Steps
            document.getElementById('steps-container').innerHTML = '<div class="text-gray-400 italic text-sm text-center mt-20 flex flex-col items-center"><i class="fas fa-pen-fancy text-3xl mb-3 opacity-30"></i><span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem m·∫´u tr√¨nh b√†y</span></div>';
            document.getElementById('btn-show-step').disabled = false;
            document.getElementById('btn-show-step').innerHTML = 'G·ª£i √Ω ti·∫øp <i class="fas fa-arrow-right ml-1"></i>';
            document.getElementById('step-counter').textContent = `B∆∞·ªõc: 0/${currentData.steps.length}`;
            
            // Enable stats
            statsEnabled = true;
            updateStatsUI();
        }

        function showNextStep() {
            disableStats(); // Use hint => disable stats
            
            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            
            // Show rule on first click
            if (stepIndex === 0) {
                container.innerHTML = '';
                const ruleContent = document.getElementById('rule-content');
                ruleContent.innerHTML = '√Åp d·ª•ng t√≠nh ch·∫•t t·ªâ l·ªá th·ª©c:<br>N·∫øu $\\frac{a}{b} = \\frac{c}{d}$ th√¨ $a.d = b.c$ (T√≠ch ch√©o b·∫±ng nhau)';
                ruleArea.classList.remove('hidden');
                
                // Typeset the rule
                if (window.MathJax) MathJax.typesetPromise([ruleContent]);
            }

            if (stepIndex < currentData.steps.length) {
                const step = currentData.steps[stepIndex];
                const el = document.createElement('div');
                el.className = `step-item p-3 rounded-lg border-l-4 mb-3 shadow-sm ${step.isLast ? 'bg-indigo-50 border-indigo-500 text-indigo-900 font-bold' : 'bg-white border-gray-300 text-gray-700'}`;
                el.innerHTML = step.text; 
                container.appendChild(el);
                
                // Typeset the new step
                if (window.MathJax) {
                    MathJax.typesetPromise([el]).then(() => {
                         container.scrollTop = container.scrollHeight;
                    });
                } else {
                    container.scrollTop = container.scrollHeight;
                }
                
                stepIndex++;
                document.getElementById('step-counter').textContent = `B∆∞·ªõc: ${stepIndex}/${currentData.steps.length}`;
            }

            if (stepIndex >= currentData.steps.length) {
                document.getElementById('btn-show-step').disabled = true;
                document.getElementById('btn-show-step').innerHTML = '<i class="fas fa-check-circle"></i> <span>ƒê√£ xong</span>';
            }
        }

        function parseInput(val) {
            val = val.trim().replace(/\s/g, '').replace(',', '.');
            if (val.includes('/')) {
                const parts = val.split('/');
                if (parts.length === 2) {
                    return parseFloat(parts[0]) / parseFloat(parts[1]);
                }
            }
            return parseFloat(val);
        }

        function checkAnswer() {
            if (isAnswered) return;

            const inputRaw = document.getElementById('ans-input').value;
            if (!inputRaw) return;

            const userVal = parseInput(inputRaw);
            const correctVal = currentData.x_val;
            
            // Compare with tolerance for floating point
            const epsilon = 0.0001;
            const isCorrect = Math.abs(userVal - correctVal) < epsilon;

            const fb = document.getElementById('feedback');
            const inp = document.getElementById('ans-input');
            
            fb.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            inp.classList.remove('border-gray-300');

            if (isCorrect) {
                if (statsEnabled) {
                    streak++;
                    correctTotal++;
                    fb.innerHTML = '<i class="fas fa-crown text-yellow-500"></i> Ch√≠nh x√°c! C√°ch tr√¨nh b√†y ƒë√£ hi·ªán ·ªü b√™n ph·∫£i.';
                    fb.classList.add('bg-green-100', 'text-green-800');
                    updateStatsUI();
                } else {
                    fb.innerHTML = '<i class="fas fa-check"></i> ƒê√∫ng r·ªìi! (Kh√¥ng t√≠nh ƒëi·ªÉm do ƒë√£ xem g·ª£i √Ω)';
                    fb.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                inp.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
                isAnswered = true;
                
                // Auto show steps
                const timer = setInterval(() => {
                    if (stepIndex < currentData.steps.length) showNextStep();
                    else clearInterval(timer);
                }, 200);

            } else {
                fb.innerHTML = `<i class="fas fa-times-circle"></i> Sai r·ªìi. K·∫øt qu·∫£ ƒë√∫ng l√† <b>${formatNumber(correctVal)}</b>`;
                fb.classList.add('bg-red-100', 'text-red-700');
                inp.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                
                if (statsEnabled) {
                    streak = 0;
                    wrongTotal++;
                    updateStatsUI();
                }
            }
        }

        // Init
        window.onload = nextQuestion;

    </script>
</body>
</html>