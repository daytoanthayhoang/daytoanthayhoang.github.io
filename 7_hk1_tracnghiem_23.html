<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p Chinh Ph·ª•c To√°n 7 HK1 - C√¢u 2 & 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            startup: {
                typeset: false // T·∫Øt t·ª± ƒë·ªông render ban ƒë·∫ßu ƒë·ªÉ ki·ªÉm so√°t b·∫±ng code
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0fdf4; /* Green-50 */
        }

        .btn-option {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        
        .btn-option:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-option:active:not(:disabled) {
            transform: scale(0.98);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s ease-in-out;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop {
            animation: pop 0.2s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mode-active {
            background-color: #16a34a; /* green-600 */
            color: white;
            border-color: #16a34a;
        }

        .mode-inactive {
            background-color: white;
            color: #374151;
            border-color: #d1d5db;
        }
        .mode-inactive:hover {
            background-color: #dcfce7; /* green-100 */
        }

        /* Loading Overlay Style */
        #question-loader {
            position: absolute;
            inset: 0;
            background-color: white;
            z-index: 50; /* TƒÉng Z-index cao nh·∫•t */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease-out;
        }
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden-loader {
            opacity: 0;
            pointer-events: none;
        }

        /* Content Visibility Control - S·ª¨A L·ªñI FLASHING */
        #main-content-wrapper {
            opacity: 0;
            /* QUAN TR·ªåNG: Kh√¥ng set transition ·ªü ƒë√¢y ƒë·ªÉ khi ·∫©n n√≥ ·∫©n NGAY L·∫¨P T·ª®C */
        }
        #main-content-wrapper.content-visible {
            opacity: 1;
            transition: opacity 0.3s ease-in; /* Ch·ªâ c√≥ hi·ªáu ·ª©ng khi HI·ªÜN l√™n */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
	<header class="w-full max-w-3xl text-center mb-6">
        <h1 class="text-2xl md:text-3xl font-extrabold text-green-800 mb-2 uppercase drop-shadow-sm">
            <i class="fas fa-infinity mr-2"></i>√în t·∫≠p Chinh Ph·ª•c To√°n 7 HK1 - C√¢u 2,3
        </h1>
        <p class="text-green-600 font-medium">Ch·ªß ƒë·ªÅ: S·ªë th·∫≠p ph√¢n & S·ªë th·ª±c</p>
    </header>

    <!-- Mode Selection -->
    <div class="w-full max-w-3xl grid grid-cols-3 gap-2 mb-6">
        <button onclick="setMode('all')" id="btn-mode-all" class="mode-active py-3 px-2 rounded-lg font-bold border-2 shadow-sm text-sm md:text-base flex flex-col md:flex-row items-center justify-center">
            <i class="fas fa-random md:mr-2 mb-1 md:mb-0"></i> T·ªïng H·ª£p
        </button>
        <button onclick="setMode('q2')" id="btn-mode-q2" class="mode-inactive py-3 px-2 rounded-lg font-bold border-2 shadow-sm text-sm md:text-base flex flex-col md:flex-row items-center justify-center">
            <i class="fas fa-percent md:mr-2 mb-1 md:mb-0"></i> C√¢u 2: S·ªë th·∫≠p ph√¢n
        </button>
        <button onclick="setMode('q3')" id="btn-mode-q3" class="mode-inactive py-3 px-2 rounded-lg font-bold border-2 shadow-sm text-sm md:text-base flex flex-col md:flex-row items-center justify-center">
            <i class="fas fa-square-root-alt md:mr-2 mb-1 md:mb-0"></i> C√¢u 3: S·ªë th·ª±c
        </button>
    </div>

    <!-- Stats Board -->
    <div class="w-full max-w-3xl bg-white rounded-xl shadow-md p-4 mb-6 grid grid-cols-4 gap-2 text-center select-none" id="stats-container">
        <!-- Rendered by JS -->
    </div>

    <!-- Question Card -->
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg border-b-4 border-green-600 p-6 relative overflow-hidden" style="min-height: 400px;">
        
        <!-- Loading Overlay (Che ph·ªß to√†n b·ªô card) -->
        <div id="question-loader">
            <div class="loader-spinner mb-3"></div>
            <span class="text-green-600 font-bold text-sm">ƒêang x·ª≠ l√Ω c√¥ng th·ª©c...</span>
        </div>

        <!-- Question Badge -->
        <div class="absolute top-0 left-0 bg-green-100 text-green-800 px-3 py-1 rounded-br-lg text-xs font-bold uppercase z-10" id="question-type-badge">
            D·∫°ng c√¢u h·ªèi
        </div>

        <!-- WRAPPER CONTENT (·∫®n/Hi·ªán ƒë·ªìng b·ªô) -->
        <div id="main-content-wrapper" class="flex flex-col h-full justify-between pt-6">
            
            <!-- Question Content -->
            <div class="mb-6 fade-in">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 text-left leading-relaxed" id="question-text">
                    <!-- Question goes here -->
                </h2>
            </div>

            <!-- Options Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="options-container">
                <!-- Buttons will be injected here -->
            </div>

            <!-- Explanation Area -->
            <div id="explanation-area" class="hidden mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg text-gray-700 text-sm md:text-base fade-in">
                 <!-- JS will inject content -->
            </div>

            <!-- Feedback & Next -->
            <div class="mt-auto h-12 flex items-center justify-between">
                <div id="feedback-msg" class="text-lg font-bold hidden pl-2"></div>
                <button onclick="handleNextClick()" id="btn-next" class="bg-white border border-gray-300 text-gray-600 px-6 py-2 rounded-full font-bold hover:bg-gray-100 transition flex items-center ml-auto shadow-sm">
                    B·ªè qua <i class="fas fa-forward ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <footer class="mt-auto py-6 text-center text-gray-400 text-xs">
        ¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io
    </footer>

    <!-- Feedback Modal (Overlay) -->
    <div id="feedback-overlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 text-center relative">
            <div id="feedback-icon" class="text-6xl mb-4"></div>
            <h3 id="feedback-title" class="text-2xl font-bold mb-2"></h3>
            <p id="feedback-message" class="text-gray-700 mb-4 text-lg font-medium"></p>
            <div class="bg-blue-50 p-4 rounded-xl text-left mb-6">
                <p class="text-xs text-blue-500 font-bold uppercase mb-1">Gi·∫£i th√≠ch chi ti·∫øt:</p>
                <div id="feedback-detail" class="text-gray-800 text-sm leading-relaxed"></div>
            </div>
            <button onclick="closeModal()" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition transform hover:-translate-y-1">
                ƒê√≥ng ƒë·ªÉ xem l·∫°i <i class="fas fa-times ml-2"></i>
            </button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const state = {
            mode: 'all', // all, q2, q3
            streak: 0,
            correct: 0,
            wrong: 0,
            skipped: 0,
            currentQuestion: null,
            isAnswered: false
        };

        // --- UTILS ---
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);

        const isFinite = (numerator, denominator) => {
            if (numerator === 0) return true;
            let common = gcd(Math.abs(numerator), Math.abs(denominator));
            let b = Math.abs(denominator) / common;
            while (b % 2 === 0) b /= 2;
            while (b % 5 === 0) b /= 5;
            return b === 1;
        };
        
        // Helper t√≠nh gi√° tr·ªã th·∫≠p ph√¢n c·ªßa ph√¢n s·ªë d·∫°ng string "a/b" ho·∫∑c s·ªë
        const getDecimalVal = (valStr) => {
            if (typeof valStr === 'number') return valStr;
            if (valStr.includes('/')) {
                const [n, d] = valStr.split('/').map(Number);
                if (d === 0) return Infinity;
                return n / d;
            }
            // X·ª≠ l√Ω cƒÉn
            if (valStr.startsWith('\\sqrt{')) {
                // R·∫•t c∆° b·∫£n: l·∫•y s·ªë trong {}
                const match = valStr.match(/\\sqrt\{([\d,.]+)\}/);
                if (match) {
                    const num = parseFloat(match[1].replace(',', '.'));
                    return Math.sqrt(num);
                }
            }
            return parseFloat(valStr.replace(',', '.'));
        };
        
        // Format hi·ªÉn th·ªã s·ªë th·∫≠p ph√¢n (thay ch·∫•m b·∫±ng ph·∫©y)
        const formatDecimal = (num) => {
            // L√†m tr√≤n t·ªëi ƒëa 5 ch·ªØ s·ªë th·∫≠p ph√¢n ƒë·ªÉ hi·ªÉn th·ªã g·ªçn
            let s = parseFloat(num.toFixed(5)).toString();
            return s.replace('.', ',');
        }

        // --- GENERATORS ---
        const generateQuestion2 = () => {
            const isReference = Math.random() < 0.7;
            let question, correct, options, explanation, typeLabel;

            if (isReference) {
                const subType = randomInt(1, 4);
                
                if (subType === 1) {
                    typeLabel = "C√¢u 2: Nh·∫≠n bi·∫øt lo·∫°i s·ªë";
                    const samples = [
                        { val: "3,(2)", type: "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n", note: "c√≥ chu k·ª≥ (2) l·∫∑p l·∫°i ngay sau d·∫•u ph·∫©y" },
                        { val: "0,(123)", type: "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n", note: "c√≥ chu k·ª≥ (123) l·∫∑p l·∫°i" },
                        { val: "5,1(6)", type: "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n", note: "c√≥ ph·∫ßn th·∫≠p ph√¢n l·∫∑p l·∫°i l√† (6)" }, 
                        { val: "12,8(91)", type: "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n", note: "c√≥ chu k·ª≥ (91)" },
                        { val: "1,5", type: "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n", note: "ph·∫ßn th·∫≠p ph√¢n d·ª´ng l·∫°i (h·ªØu h·∫°n)" },
                        { val: "-3,14", type: "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n", note: "ph·∫ßn th·∫≠p ph√¢n h·ªØu h·∫°n" },
                        { val: "0,1234...", type: "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n kh√¥ng tu·∫ßn ho√†n", note: "ph·∫ßn th·∫≠p ph√¢n k√©o d√†i m√£i kh√¥ng c√≥ chu k·ª≥" },
                        { val: "\\frac{9}{24}", type: "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n", note: "v√¨ $\\frac{9}{24} = \\frac{3}{8} = 0,375$" }
                    ];
                    
                    const item = samples[randomInt(0, samples.length - 1)]; 
                    
                    question = `S·ªë $${item.val}$ l√†:`;
                    correct = item.type;
                    options = shuffleArray([
                        correct,
                        "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n",
                        "S·ªë nguy√™n",
                        "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n",
                        "S·ªë v√¥ t·ªâ"
                    ]);
                    options = [...new Set(options)]; 
                    if (options.length > 4) options = options.slice(0, 4);

                    explanation = `S·ªë $${item.val}$ l√† <b>${item.type}</b> ${item.note}.`;
                    
                } else if (subType === 2) {
                    typeLabel = "C√¢u 2: T√¨m s·ªë TP h·ªØu h·∫°n";
                    question = "Trong c√°c s·ªë sau, s·ªë n√†o l√† <b>s·ªë th·∫≠p ph√¢n h·ªØu h·∫°n</b>?";
                    
                    // C·∫¨P NH·∫¨T: D√πng object ƒë·ªÉ l∆∞u gi√° tr·ªã t√≠nh to√°n
                    const finiteFracs = [
                        {tex: "\\frac{3}{2}", val: 1.5}, 
                        {tex: "-\\frac{3}{2}", val: -1.5}, 
                        {tex: "-\\frac{4}{25}", val: -0.16}, 
                        {tex: "-\\frac{3}{5}", val: -0.6}, 
                        {tex: "\\frac{4}{5}", val: 0.8}, 
                        {tex: "\\frac{7}{20}", val: 0.35}, 
                        {tex: "\\frac{9}{8}", val: 1.125}, 
                        {tex: "\\frac{11}{40}", val: 0.275}, 
                        {tex: "\\sqrt{0,3025}", val: 0.55}, 
                        {tex: "\\frac{9}{24}", val: 0.375}
                    ];
                    
                    const selectedCorrect = finiteFracs[randomInt(0, finiteFracs.length - 1)];
                    correct = `$${selectedCorrect.tex}$`; // ƒê·∫£m b·∫£o b·ªçc $ ƒë·ªÉ render
                    
                    const infiniteFracs = ["$\\frac{1}{3}$", "$\\frac{2}{3}$", "$\\frac{5}{6}$", "$\\frac{1}{7}$", "$\\frac{2}{9}$", "$\\frac{4}{11}$", "$\\frac{5}{12}$", "$\\frac{7}{15}$", "$\\sqrt{7}$", "$\\frac{5}{12}$"];
                    let distractors = shuffleArray(infiniteFracs).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    // L·ªçc tr√πng
                    options = [...new Set(options)];

                    // Gi·∫£i th√≠ch b·∫±ng k·∫øt qu·∫£ t√≠nh to√°n
                    explanation = `Ta th·ª±c hi·ªán ph√©p t√≠nh (ho·∫∑c b·∫•m m√°y t√≠nh):
                    <br> $${selectedCorrect.tex} = ${formatDecimal(selectedCorrect.val)}$
                    <br> K·∫øt qu·∫£ l√† s·ªë th·∫≠p ph√¢n h·ªØu h·∫°n (ph·∫ßn th·∫≠p ph√¢n d·ª´ng l·∫°i).
                    <br> <small class="text-gray-500">(Gi·∫£i th√≠ch b·ªï sung: M·∫´u s·ªë sau khi t·ªëi gi·∫£n ch·ªâ ch·ª©a th·ª´a s·ªë nguy√™n t·ªë 2 v√† 5)</small>`;
                    
                } else if (subType === 3) {
                    typeLabel = "C√¢u 2: T√¨m s·ªë TP VHTH";
                    question = "Trong c√°c s·ªë sau, s·ªë n√†o vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng <b>s·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n</b>?";
                    
                    // C·∫¨P NH·∫¨T: Object cho gi·∫£i th√≠ch
                    const infiniteFracs = [
                        {tex: "\\frac{1}{9}", val: "0,111..."},
                        {tex: "\\frac{5}{9}", val: "0,555..."},
                        {tex: "\\frac{2}{3}", val: "0,666..."},
                        {tex: "-\\frac{2}{3}", val: "-0,666..."},
                        {tex: "-\\frac{75}{74}", val: "-1,0135..."},
                        {tex: "\\frac{1}{6}", val: "0,1666..."},
                        {tex: "\\frac{5}{11}", val: "0,4545..."},
                        {tex: "\\frac{5}{6}", val: "0,8333..."},
                        {tex: "\\frac{10}{3}", val: "3,333..."}
                    ];
                    
                    const selectedCorrect = infiniteFracs[randomInt(0, infiniteFracs.length - 1)];
                    correct = `$${selectedCorrect.tex}$`;
                    
                    const finiteFracs = ["$\\frac{1}{2}$", "$\\frac{3}{4}$", "0,5", "-1,25", "$\\frac{3}{5}$", "$\\frac{7}{10}$", "$\\frac{15}{4}$", "$\\frac{13}{20}$", "$\\frac{7}{50}$"];
                    let distractors = shuffleArray(finiteFracs).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    options = [...new Set(options)]; // L·ªçc tr√πng

                    explanation = `Ta th·ª±c hi·ªán ph√©p t√≠nh:
                    <br> $${selectedCorrect.tex} = ${selectedCorrect.val}$
                    <br> Ph·∫ßn th·∫≠p ph√¢n k√©o d√†i v√¥ t·∫≠n v√† l·∫∑p l·∫°i, n√™n ƒë√¢y l√† s·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n.
                    <br> <small class="text-gray-500">(Gi·∫£i th√≠ch b·ªï sung: M·∫´u s·ªë sau khi t·ªëi gi·∫£n c√≥ ch·ª©a th·ª´a s·ªë nguy√™n t·ªë kh√°c 2 v√† 5)</small>`;
                    
                } else {
                    typeLabel = "C√¢u 2: Khai tri·ªÉn s·ªë TP";
                    const a = randomInt(1, 9);
                    const b = randomInt(1, 9);
                    // ƒê·∫£m b·∫£o c v√† d kh√°c nhau v√† kh√°c b ƒë·ªÉ t·∫°o ra c√°c ƒë√°p √°n nhi·ªÖu kh√°c bi·ªát r√µ r√†ng
                    let cd, c, d;
                    do {
                        cd = randomInt(10, 99);
                        c = Math.floor(cd / 10);
                        d = cd % 10;
                    } while (c === d || c === b || d === b);
                    
                    const numStr = `${a},${b}(${cd})`;
                    
                    // ƒê√°p √°n ƒë√∫ng: l·∫∑p l·∫°i cd
                    const expanded = `${a},${b}${cd}${cd}...`; 
                    
                    // Nhi·ªÖu 1: L·∫∑p l·∫°i ch·ªØ s·ªë cu·ªëi c·ªßa chu k·ª≥ (sai quy lu·∫≠t)
                    const wrong1 = `${a},${b}${cd}${d}${d}...`; 
                    
                    // Nhi·ªÖu 2: L·∫∑p l·∫°i c·∫£ ph·∫ßn tr∆∞·ªõc chu k·ª≥ (sai chu k·ª≥)
                    const wrong2 = `${a},${b}${cd}${b}${cd}...`;
                    
                    // Nhi·ªÖu 3: S·ªë h·ªØu h·∫°n (sai b·∫£n ch·∫•t v√¥ h·∫°n)
                    const wrong3 = `${a},${b}${cd}${cd}`; 
                    
                    question = `Cho s·ªë th·∫≠p ph√¢n $x=${numStr}$. C√°ch vi·∫øt n√†o sau ƒë√¢y l√† ƒë√∫ng?`;
                    correct = `$x=${expanded}$`;
                    options = shuffleArray([
                        correct,
                        `$x=${wrong1}$`,
                        `$x=${wrong2}$`,
                        `$x=${wrong3}$`
                    ]);
                    options = [...new Set(options)];

                    explanation = `K√Ω hi·ªáu $(${cd})$ nghƒ©a l√† ph·∫ßn s·ªë $${cd}$ ƒë∆∞·ª£c l·∫∑p l·∫°i v√¥ h·∫°n l·∫ßn. <br>V·∫≠y $x = ${a},${b}${cd}${cd}...$`;
                }
            } else {
                // Nh√≥m ph√°t tri·ªÉn (L√Ω thuy·∫øt)
                const subType = randomInt(1, 2);
                if (subType === 1) {
                    typeLabel = "C√¢u 2: L√Ω thuy·∫øt ph√¢n lo·∫°i";
                    question = "Ph√°t bi·ªÉu n√†o sau ƒë√¢y l√† <b>ƒê√öNG</b>?";
                    correct = "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n l√† s·ªë h·ªØu t·ªâ.";
                    options = shuffleArray([
                        correct,
                        "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n l√† s·ªë v√¥ t·ªâ.",
                        "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n l√† s·ªë v√¥ t·ªâ.",
                        "M·ªçi ph√¢n s·ªë ƒë·ªÅu vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng s·ªë th·∫≠p ph√¢n h·ªØu h·∫°n."
                    ]);
                    options = [...new Set(options)];
                    explanation = "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n bi·ªÉu di·ªÖn ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng ph√¢n s·ªë $a/b$, do ƒë√≥ n√≥ l√† s·ªë h·ªØu t·ªâ. S·ªë v√¥ t·ªâ l√† s·ªë th·∫≠p ph√¢n v√¥ h·∫°n <b>kh√¥ng</b> tu·∫ßn ho√†n.";
                } else {
                    typeLabel = "C√¢u 2: Ki·ªÉm tra ƒëi·ªÅu ki·ªán m·∫´u";
                    const num = randomInt(1, 10);
                    const dens = [
                        { d: 30, type: "v√¥ h·∫°n tu·∫ßn ho√†n", reason: "c√≥ ∆∞·ªõc 3" },
                        { d: 21, type: "v√¥ h·∫°n tu·∫ßn ho√†n", reason: "c√≥ ∆∞·ªõc 3, 7" },
                        { d: 50, type: "h·ªØu h·∫°n", reason: "ch·ªâ c√≥ ∆∞·ªõc 2, 5" },
                        { d: 80, type: "h·ªØu h·∫°n", reason: "ch·ªâ c√≥ ∆∞·ªõc 2, 5" },
                        { d: 11, type: "v√¥ h·∫°n tu·∫ßn ho√†n", reason: "c√≥ ∆∞·ªõc 11" }
                    ];
                    const selected = dens[randomInt(0, dens.length - 1)];
                    question = `Ph√¢n s·ªë $\\frac{${num}}{${selected.d}}$ (ƒë√£ t·ªëi gi·∫£n) vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng:`;
                    correct = `S·ªë th·∫≠p ph√¢n ${selected.type}`;
                    options = shuffleArray([
                        `S·ªë th·∫≠p ph√¢n ${selected.type}`,
                        selected.type === "h·ªØu h·∫°n" ? "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n" : "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n",
                        "S·ªë th·∫≠p ph√¢n v√¥ h·∫°n kh√¥ng tu·∫ßn ho√†n",
                        "S·ªë nguy√™n"
                    ]);
                    options = [...new Set(options)];
                    explanation = `M·∫´u s·ªë $${selected.d}$ ${selected.reason} (kh√°c 2 v√† 5) n√™n ph√¢n s·ªë vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng ${selected.type}.`;
                }
            }
            return { typeLabel, text: question, correct, options, explanation };
        };

        const generateQuestion3 = () => {
            const isReference = Math.random() < 0.7;
            let question, correct, options, explanation, typeLabel;

            if (isReference) {
                const subType = randomInt(1, 5);
                if (subType === 1) {
                    typeLabel = "C√¢u 3: ƒê·ªãnh nghƒ©a S·ªë th·ª±c";
                    question = "S·ªë h·ªØu t·ªâ v√† s·ªë v√¥ t·ªâ ƒë∆∞·ª£c g·ªçi chung l√†:";
                    correct = "S·ªë th·ª±c";
                    options = shuffleArray(["S·ªë th·ª±c", "S·ªë nguy√™n", "S·ªë t·ª± nhi√™n", "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n"]);
                    options = [...new Set(options)];
                    explanation = "T·∫≠p h·ª£p c√°c s·ªë th·ª±c ($\\mathbb{R}$) bao g·ªìm t·∫≠p h·ª£p c√°c s·ªë h·ªØu t·ªâ ($\\mathbb{Q}$) v√† t·∫≠p h·ª£p c√°c s·ªë v√¥ t·ªâ ($\\mathbb{I}$).";
                } else if (subType === 2) {
                    typeLabel = "C√¢u 3: Nh·∫≠n bi·∫øt s·ªë v√¥ t·ªâ";
                    question = "Trong c√°c s·ªë sau, s·ªë n√†o l√† <b>s·ªë v√¥ t·ªâ</b>?";
                    const irrationals = ["$\\sqrt{2}$", "$\\sqrt{3}$", "$\\sqrt{5}$", "$\\pi$", "$-\\sqrt{7}$", "1,41421..."];
                    correct = irrationals[randomInt(0, irrationals.length - 1)];
                    const rationals = ["$\\sqrt{4}$", "$\\sqrt{9}$", "$\\frac{2}{3}$", "1,5", "0", "$\\sqrt{16}$", "-3,14", "$\\frac{9}{24}$"];
                    let distractors = shuffleArray(rationals).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    options = [...new Set(options)]; // L·ªçc tr√πng
                    explanation = `S·ªë <b>${correct}</b> l√† s·ªë v√¥ t·ªâ v√¨ n√≥ l√† s·ªë th·∫≠p ph√¢n v√¥ h·∫°n kh√¥ng tu·∫ßn ho√†n (ho·∫∑c cƒÉn b·∫≠c hai c·ªßa s·ªë kh√¥ng ch√≠nh ph∆∞∆°ng). C√°c s·ªë c√≤n l·∫°i ƒë·ªÅu l√† s·ªë h·ªØu t·ªâ.`;
                } else if (subType === 3) {
                    typeLabel = "C√¢u 3: K√Ω hi·ªáu t·∫≠p h·ª£p";
                    question = "Ch·ªçn ph√°t bi·ªÉu ƒë√∫ng v·ªÅ k√Ω hi·ªáu:";
                    const trueStmts = ["$5 \\in \\mathbb{R}$", "$\\sqrt{2} \\in \\mathbb{R}$", "$\\pi \\in \\mathbb{R}$", "$-3,5 \\in \\mathbb{Q}$"];
                    correct = trueStmts[randomInt(0, trueStmts.length - 1)];
                    const falseStmts = ["$3,5 \\notin \\mathbb{R}$", "$\\sqrt{2} \\in \\mathbb{Q}$", "$-5 \\notin \\mathbb{R}$", "$\\pi \\in \\mathbb{Q}$"];
                    let distractors = shuffleArray(falseStmts).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    options = [...new Set(options)];
                    explanation = "T·∫≠p h·ª£p s·ªë th·ª±c $\\mathbb{R}$ ch·ª©a t·∫•t c·∫£ c√°c s·ªë h·ªØu t·ªâ v√† v√¥ t·ªâ. Ta d√πng k√Ω hi·ªáu $\\in$ ƒë·ªÉ ch·ªâ m·ªôt s·ªë thu·ªôc t·∫≠p h·ª£p n√†o ƒë√≥.";
                } else if (subType === 4) {
                    typeLabel = "C√¢u 3: T√¨m kh·∫≥ng ƒë·ªãnh sai";
                    question = "Trong c√°c kh·∫≥ng ƒë·ªãnh sau, kh·∫≥ng ƒë·ªãnh n√†o <b>SAI</b>?";
                    correct = "M·ªçi s·ªë th·ª±c ƒë·ªÅu l√† s·ªë v√¥ t·ªâ.";
                    if (Math.random() < 0.5) correct = "$3,14 \\in \\mathbb{I}$";
                    if (Math.random() < 0.3) correct = "$\\sqrt{4}$ l√† s·ªë v√¥ t·ªâ";
                    const trueOptions = ["S·ªë v√¥ t·ªâ l√† s·ªë th·∫≠p ph√¢n v√¥ h·∫°n kh√¥ng tu·∫ßn ho√†n.", "S·ªë h·ªØu t·ªâ v√† s·ªë v√¥ t·ªâ g·ªçi chung l√† s·ªë th·ª±c.", "$\\sqrt{2}$ l√† s·ªë th·ª±c.", "$0 \\in \\mathbb{R}$"];
                    let distractors = shuffleArray(trueOptions).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    options = [...new Set(options)];
                    explanation = `Kh·∫≥ng ƒë·ªãnh "<b>${correct}</b>" l√† sai. (V√≠ d·ª•: S·ªë h·ªØu t·ªâ c≈©ng l√† s·ªë th·ª±c nh∆∞ng kh√¥ng ph·∫£i s·ªë v√¥ t·ªâ; ho·∫∑c 3,14 l√† s·ªë h·ªØu t·ªâ).`;
                } else {
                    // D·∫°ng m·ªõi: Li·ªát k√™ t·∫≠p h·ª£p con (C√¢u 9, 10)
                    typeLabel = "C√¢u 3: Li·ªát k√™ s·ªë v√¥ t·ªâ";
                    
                    const pool = [
                        {val: "\\sqrt{3}", isIrr: true},
                        {val: "\\pi", isIrr: true},
                        {val: "-\\sqrt{6}", isIrr: true},
                        {val: "\\sqrt{8}", isIrr: true},
                        {val: "3,14", isIrr: false},
                        {val: "\\sqrt{16}", isIrr: false},
                        {val: "\\frac{1}{3}", isIrr: false},
                        {val: "8,(3)", isIrr: false},
                        {val: "-\\sqrt{3,14}", isIrr: true},
                        {val: "\\sqrt{1,44}", isIrr: false}
                    ];
                    
                    const selected = shuffleArray(pool).slice(0, 5);
                    const listStr = selected.map(s => `$${s.val}$`).join("; ");
                    const correctList = selected.filter(s => s.isIrr).map(s => `$${s.val}$`);
                    
                    if (correctList.length === 0) {
                        question = `Trong c√°c s·ªë sau: ${listStr}; $\\sqrt{2}$. C√°c s·ªë v√¥ t·ªâ l√†:`;
                        correct = `$\\sqrt{2}$`;
                    } else {
                        question = `Trong c√°c s·ªë sau: ${listStr}. C√°c s·ªë v√¥ t·ªâ l√†:`;
                        correct = correctList.join("; ");
                    }
                    
                    let distractors = [];
                    // Nhi·ªÖu 1: Th√™m s·ªë h·ªØu t·ªâ
                    const rationals = selected.filter(s => !s.isIrr);
                    if (rationals.length > 0) {
                        distractors.push([...correctList, `$${rationals[0].val}$`].join("; "));
                    } else {
                         distractors.push([...correctList, "$3,5$"].join("; "));
                    }
                    
                    // Nhi·ªÖu 2: B·ªõt s·ªë v√¥ t·ªâ
                    if (correctList.length > 1) {
                        distractors.push(correctList.slice(0, correctList.length-1).join("; "));
                    } else {
                        distractors.push("Kh√¥ng c√≥ s·ªë v√¥ t·ªâ n√†o");
                    }
                    
                    // Nhi·ªÖu 3: Th√™m cƒÉn 4 (l√† 2)
                    distractors.push([...correctList, "$\\sqrt{4}$"].join("; "));

                    options = shuffleArray([correct, ...distractors]);
                    options = [...new Set(options)]; // L·ªçc tr√πng quan tr·ªçng ·ªü ƒë√¢y
                    
                    explanation = `C√°c s·ªë v√¥ t·ªâ l√† s·ªë th·∫≠p ph√¢n v√¥ h·∫°n kh√¥ng tu·∫ßn ho√†n (v√≠ d·ª• $\\pi, \\sqrt{3}, \\sqrt{8} \\dots$). C√°c s·ªë nh∆∞ $3,14; \\sqrt{16}=4; 8,(3)$ ƒë·ªÅu l√† s·ªë h·ªØu t·ªâ.`;
                }
            } else {
                const subType = randomInt(1, 2);
                if (subType === 1) {
                    typeLabel = "C√¢u 3: ƒê·∫øm s·ªë v√¥ t·ªâ";
                    const setNums = [
                        {val: "\\sqrt{3}", isIrr: true}, {val: "\\sqrt{1}", isIrr: false},
                        {val: "0,(3)", isIrr: false}, {val: "\\frac{5}{2}", isIrr: false},
                        {val: "\\pi", isIrr: true}, {val: "2,3543...", isIrr: true},
                        {val: "\\sqrt{9}", isIrr: false}
                    ];
                    const subset = shuffleArray(setNums).slice(0, 4);
                    const listStr = subset.map(s => `$${s.val}$`).join("; ");
                    const count = subset.filter(s => s.isIrr).length;
                    question = `Trong c√°c s·ªë sau: ${listStr}. C√≥ bao nhi√™u <b>s·ªë v√¥ t·ªâ</b>?`;
                    correct = `${count}`;
                    let distractors = [];
                    for(let i=0; i<4; i++) if(i !== count) distractors.push(`${i}`);
                    distractors = shuffleArray(distractors).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    options = [...new Set(options)];
                    const listIrr = subset.filter(s => s.isIrr).map(s => `$${s.val}$`).join(", ");
                    explanation = count > 0 
                        ? `C√≥ ${count} s·ªë v√¥ t·ªâ l√†: ${listIrr}. (L∆∞u √Ω: $\\sqrt{1}, \\sqrt{9}, 0,(3)$ l√† s·ªë h·ªØu t·ªâ).`
                        : "Kh√¥ng c√≥ s·ªë v√¥ t·ªâ n√†o trong danh s√°ch tr√™n.";
                } else {
                    typeLabel = "C√¢u 3: Quan h·ªá t·∫≠p h·ª£p (M√¥ t·∫£)";
                    question = "Ph√°t bi·ªÉu n√†o sau ƒë√¢y m√¥ t·∫£ <b>ƒê√öNG</b> m·ªëi quan h·ªá gi·ªØa c√°c t·∫≠p h·ª£p s·ªë?";
                    correct = "M·ªçi s·ªë h·ªØu t·ªâ ƒë·ªÅu l√† s·ªë th·ª±c.";
                    options = shuffleArray([
                        correct,
                        "M·ªçi s·ªë th·ª±c ƒë·ªÅu l√† s·ªë h·ªØu t·ªâ.", 
                        "S·ªë t·ª± nhi√™n kh√¥ng ph·∫£i l√† s·ªë th·ª±c.", 
                        "S·ªë v√¥ t·ªâ c≈©ng l√† s·ªë h·ªØu t·ªâ."
                    ]);
                    options = [...new Set(options)];
                    explanation = "T·∫≠p h·ª£p s·ªë th·ª±c bao g·ªìm c·∫£ s·ªë h·ªØu t·ªâ v√† s·ªë v√¥ t·ªâ. Do ƒë√≥, b·∫•t k·ª≥ s·ªë h·ªØu t·ªâ n√†o c≈©ng l√† m·ªôt ph·∫ßn c·ªßa s·ªë th·ª±c (nh∆∞ng ng∆∞·ª£c l·∫°i th√¨ ch∆∞a ch·∫Øc ƒë√∫ng).";
                }
            }
            return { typeLabel, text: question, correct, options, explanation };
        };

        // --- CORE FUNCTIONS ---

        const renderStats = () => {
            const container = document.getElementById('stats-container');
            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span class="text-3xl font-extrabold ${state.streak > 2 ? 'text-red-500 animate-pulse' : 'text-gray-800'}">
                        ${state.streak > 2 ? '<i class="fas fa-fire"></i> ' : ''}${state.streak}
                    </span>
                </div>
                <div class="flex flex-col items-center border-l">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span class="text-xl font-bold text-green-600">${state.correct}</span>
                </div>
                <div class="flex flex-col items-center border-l">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span class="text-xl font-bold text-red-500">${state.wrong}</span>
                </div>
                <div class="flex flex-col items-center border-l">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span class="text-xl font-bold text-gray-400">${state.skipped}</span>
                </div>
            `;
        };

        const setMode = (mode) => {
            state.mode = mode;
            ['all', 'q2', 'q3'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if (m == mode) {
                    btn.className = "mode-active py-3 px-2 rounded-lg font-bold border-2 shadow-sm transform scale-105 transition text-sm md:text-base flex flex-col md:flex-row items-center justify-center";
                } else {
                    btn.className = "mode-inactive py-3 px-2 rounded-lg font-bold border-2 shadow-sm transition text-sm md:text-base flex flex-col md:flex-row items-center justify-center";
                }
            });
            handleNextClick(true);
        };

        // UI Helpers
        const showLoading = () => {
            const loader = document.getElementById('question-loader');
            loader.classList.remove('hidden-loader');
        };

        const hideLoading = () => {
            const loader = document.getElementById('question-loader');
            loader.classList.add('hidden-loader');
        };

        // === LOGIC M·ªöI: QU·∫¢N L√ù HI·ªÇN TH·ªä CH·∫∂T CH·∫º ===
        const loadQuestion = () => {
            // 1. Hi·ªán Loader & ·∫®n N·ªôi dung NGAY L·∫¨P T·ª®C
            showLoading();
            const contentWrapper = document.getElementById('main-content-wrapper');
            contentWrapper.classList.remove('content-visible'); // Opacity -> 0
            
            state.isAnswered = false;
            let qData;
            
            let selectedMode = state.mode;
            if (state.mode === 'all') {
                selectedMode = Math.random() < 0.5 ? 'q2' : 'q3'; 
            }

            if (selectedMode == 'q2') qData = generateQuestion2();
            else qData = generateQuestion3();

            state.currentQuestion = qData;

            // 2. Ch√®n n·ªôi dung (l√∫c n√†y ƒëang ·∫©n)
            document.getElementById('question-type-badge').innerText = qData.typeLabel;
            document.getElementById('question-text').innerHTML = qData.text;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            qData.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "btn-option w-full bg-green-50 hover:bg-green-100 text-green-900 border border-green-200 p-4 rounded-xl text-lg font-semibold shadow-sm text-left flex items-center group";
                btn.dataset.value = opt; 

                const labels = ['A', 'B', 'C', 'D'];
                btn.innerHTML = `<span class="inline-block w-8 h-8 rounded-full bg-green-200 text-center leading-8 mr-3 text-green-800 font-bold shadow-sm group-hover:bg-green-600 group-hover:text-white transition flex-shrink-0">${labels[index]}</span> <span>${opt}</span>`;
                btn.onclick = () => checkAnswer(opt, btn);
                optionsContainer.appendChild(btn);
            });

            // Reset Footer
            document.getElementById('feedback-msg').className = "hidden";
            document.getElementById('explanation-area').className = "hidden mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg text-gray-700 text-sm md:text-base fade-in";
            document.getElementById('explanation-area').innerHTML = '';
            
            const btnNext = document.getElementById('btn-next');
            btnNext.innerHTML = 'B·ªè qua <i class="fas fa-forward ml-2"></i>';
            btnNext.className = "bg-white border border-gray-300 text-gray-600 px-6 py-2 rounded-full font-bold hover:bg-gray-100 transition flex items-center ml-auto shadow-sm";

            // 3. Render Math & Ch·ªâ hi·ªán khi XONG
            if (window.MathJax && window.MathJax.typesetPromise) {
                // Ch·ªâ render trong wrapper
                MathJax.typesetPromise([contentWrapper]).then(() => {
                    // ƒê·ª£i th√™m 150ms ƒë·ªÉ tr√¨nh duy·ªát v·∫Ω xong ho√†n to√†n
                    setTimeout(() => {
                        hideLoading();
                        contentWrapper.classList.add('content-visible'); // Opacity -> 1
                    }, 150);
                }).catch(err => {
                    console.error("MathJax Error:", err);
                    // L·ªói th√¨ v·∫´n ph·∫£i hi·ªán n·ªôi dung
                    hideLoading();
                    contentWrapper.classList.add('content-visible');
                });
            } else {
                // Fallback n·∫øu kh√¥ng c√≥ MathJax
                setTimeout(() => {
                    hideLoading();
                    contentWrapper.classList.add('content-visible');
                }, 200);
            }
        };

        const checkAnswer = (selectedVal, btnElement) => {
            if (state.isAnswered) return;
            state.isAnswered = true;

            const isCorrect = selectedVal == state.currentQuestion.correct;
            const feedbackEl = document.getElementById('feedback-msg');
            const explArea = document.getElementById('explanation-area');
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('feedback-icon');
            const title = document.getElementById('feedback-title');
            const msg = document.getElementById('feedback-message');
            const detail = document.getElementById('feedback-detail');

            const allBtns = document.querySelectorAll('.btn-option');
            allBtns.forEach(b => {
                b.disabled = true;
                b.classList.add('opacity-70');
            });

            const correctBtn = Array.from(allBtns).find(b => b.dataset.value === state.currentQuestion.correct);
            
            if (correctBtn) {
                correctBtn.classList.remove('bg-green-50', 'text-green-900', 'border-green-200', 'opacity-70');
                correctBtn.classList.add('bg-green-100', 'text-green-800', 'border-green-600', 'border-2', 'opacity-100');
                const span = correctBtn.querySelector('span');
                if(span) {
                    span.classList.remove('bg-green-200', 'text-green-800');
                    span.classList.add('bg-green-600', 'text-white');
                }
            }

            if (isCorrect) {
                btnElement.classList.add('bg-green-500', 'text-white', 'pop', 'opacity-100');
                btnElement.classList.remove('bg-green-100', 'text-green-800'); 
                const span = btnElement.querySelector('span');
                if(span) span.classList.add('bg-white', 'text-green-600');

                feedbackEl.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> Ch√≠nh x√°c!</span>`;
                feedbackEl.className = "text-lg font-bold block pl-2 animate-bounce";
                
                state.streak++;
                state.correct++;
            } else {
                btnElement.classList.add('bg-red-500', 'text-white', 'border-red-600', 'shake', 'opacity-100');
                btnElement.classList.remove('bg-green-50');
                const span = btnElement.querySelector('span');
                if(span) span.classList.add('bg-white', 'text-red-600');
                
                feedbackEl.innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> Ch∆∞a ƒë√∫ng!</span>`;
                feedbackEl.className = "text-lg font-bold block pl-2";

                state.streak = 0;
                state.wrong++;

                icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                title.innerText = "Ti·∫øc qu√°!";
                title.className = "text-2xl font-bold mb-2 text-red-600";
                msg.innerHTML = `ƒê√°p √°n ƒë√∫ng l√†: <br><span class="text-green-600 font-bold text-xl mt-2 block">${state.currentQuestion.correct}</span>`;
                
                // Show modal & render math inside modal
                setTimeout(() => { 
                    overlay.classList.remove('hidden'); 
                    if (window.MathJax) MathJax.typesetPromise([overlay]);
                }, 600);
            }

            renderStats();

            explArea.innerHTML = `<p class="font-bold text-green-800 mb-1"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Gi·∫£i th√≠ch:</p> ${state.currentQuestion.explanation}`;
            explArea.classList.remove('hidden');

            detail.innerHTML = state.currentQuestion.explanation;

            const btnNext = document.getElementById('btn-next');
            btnNext.innerHTML = `C√¢u ti·∫øp theo <i class="fas fa-arrow-right ml-2"></i>`;
            btnNext.className = "bg-green-600 text-white px-6 py-2 rounded-full font-bold hover:bg-green-700 transition flex items-center ml-auto shadow-lg transform scale-105";

            // Render Math for Explanation Area
            if (window.MathJax) {
                MathJax.typesetPromise([explArea]);
            }
        };

        const handleNextClick = (forceSkip = false) => {
            if (!state.isAnswered && !forceSkip) {
                state.streak = 0;
                state.skipped++;
                renderStats();
            }
            loadQuestion();
        };

        const closeModal = () => {
            document.getElementById('feedback-overlay').classList.add('hidden');
        };

        window.onload = () => {
            renderStats();
            loadQuestion();
        }

    </script>
</body>
</html>