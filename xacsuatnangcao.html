<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phòng Thí Nghiệm Xác Suất (Full Option)</title>
    
    <!-- Tải React và ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Tải Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- CSS Animation & 3D -->
    <style>
        body { font-family: 'Noto Sans', sans-serif; background-color: #f1f5f9; }
        
        .perspective-800 { perspective: 800px; }
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* --- 3D Coin --- */
        .coin-wrapper { width: 100px; height: 100px; position: relative; transform-style: preserve-3d; }
        .coin-face { position: absolute; width: 100%; height: 100%; border-radius: 50%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.4); }
        .coin-front { transform: translateZ(5px); background: radial-gradient(circle at 30% 30%, #fde047, #eab308); border: 2px solid #ca8a04; }
        .coin-back { transform: rotateX(180deg) translateZ(5px); background: radial-gradient(circle at 30% 30%, #e0e7ff, #6366f1); border: 2px solid #4338ca; }
        .coin-side { position: absolute; width: 100px; height: 10px; background: #ca8a04; transform: rotateX(90deg) translateZ(50px); border-radius: 50%; }

        /* --- 3D Dice --- */
        .dice-container { width: 80px; height: 80px; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .die-face {
            position: absolute; width: 80px; height: 80px; background: white;
            border: 1px solid #cbd5e1; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1); backface-visibility: hidden;
        }
        .die-face-1 { transform: rotateY(0deg) translateZ(40px); }
        .die-face-2 { transform: rotateY(180deg) translateZ(40px); }
        .die-face-3 { transform: rotateY(90deg) translateZ(40px); }
        .die-face-4 { transform: rotateY(-90deg) translateZ(40px); }
        .die-face-5 { transform: rotateX(90deg) translateZ(40px); }
        .die-face-6 { transform: rotateX(-90deg) translateZ(40px); }
        .dot { width: 16px; height: 16px; background: #334155; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); }
        .dot-red { background: #ef4444; }

        /* --- Spinner --- */
        .spinner-container { transition: transform 3.5s cubic-bezier(0.2, 0.8, 0.1, 1); }
        .stopper { filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3)); }

        /* --- Urn Animation --- */
        @keyframes shake-box {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, memo } = React;

        // --- ICONS ---
        const Icon = ({ d, size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{d}</svg>
        );
        const Icons = {
            Coin: <Icon d={<circle cx="12" cy="12" r="10" />} />,
            Dice: <Icon d={<><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M16 8v8"/><path d="M8 12h8"/><path d="M12 16V8"/></>} />,
            Wheel: <Icon d={<><path d="M21 12a9 9 0 1 1-6.219-8.56"/><path d="M21 12v9"/></>} />,
            Urn: <Icon d={<><path d="M20 12V8H4v4"/><path d="M2 12h20"/><path d="M12 12v9"/><path d="M12 12H4a8 8 0 0 1 8 8 8 8 0 0 1 8-8h-8Z"/></>} />,
            Calculator: <Icon d={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/></>} />,
            Zap: <Icon d={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />,
            Chart: <Icon d={<><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></>} />
        };

        // --- COMPONENTS ---

        const Card = ({ title, children, className = "", tools }) => (
            <div className={`bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-full ${className}`}>
                <div className="bg-slate-50 px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2 uppercase tracking-wide">
                        {title}
                    </h3>
                    {tools}
                </div>
                <div className="flex-1 p-5 relative flex flex-col">
                    {children}
                </div>
            </div>
        );

        // --- Double Bar Chart (Biểu đồ Cột Kép: Thực nghiệm vs Lý thuyết) ---
        const DoubleBarChart = ({ data, total }) => {
            const maxPercent = Math.max(
                ...data.map(d => Math.max(d.theory, total > 0 ? (d.value / total) * 100 : 0))
            ) || 100;
            const scaleMax = maxPercent > 0 ? maxPercent * 1.2 : 100;

            return (
                <div className="w-full mt-2 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-inner">
                    <div className="flex items-end justify-between h-40 gap-2 md:gap-4 pb-2 border-b-2 border-slate-300 relative">
                        {/* Grid Lines */}
                        <div className="absolute inset-0 flex flex-col justify-between pointer-events-none text-[9px] text-slate-400 z-0">
                            {[100, 75, 50, 25].map(p => {
                                const y = 100 - (p / scaleMax * 100);
                                return y > 0 && y < 100 ? (
                                    <div key={p} className="w-full border-t border-dashed border-slate-200 pl-1 pt-0.5" style={{position:'absolute', top:`${y}%`}}>{p}%</div>
                                ) : null;
                            })}
                        </div>

                        {data.map((item, idx) => {
                            const realPercent = total === 0 ? 0 : (item.value / total) * 100;
                            const realHeight = (realPercent / scaleMax) * 100;
                            const theoryHeight = (item.theory / scaleMax) * 100;
                            
                            return (
                                <div key={idx} className="flex flex-col items-center flex-1 h-full justify-end z-10 group min-w-[40px]">
                                    <div className="w-full flex justify-center items-end gap-1 h-full px-1">
                                        <div className="w-1/2 rounded-t-sm transition-all duration-500 relative hover:brightness-110"
                                            style={{ height: `${Math.max(realHeight, 1)}%`, backgroundColor: item.color || '#6366f1' }}>
                                            {realHeight > 10 && (
                                                <span className="absolute bottom-1 w-full text-center text-[9px] font-bold text-white/90 hidden md:block">
                                                    {item.value}
                                                </span>
                                            )}
                                        </div>
                                        <div className="w-1/2 rounded-t-sm relative bg-slate-300 pattern-diagonal-lines opacity-80"
                                            style={{ height: `${Math.max(theoryHeight, 1)}%` }}>
                                        </div>
                                    </div>
                                    
                                    <div className="opacity-0 group-hover:opacity-100 absolute bottom-full mb-1 bg-slate-800 text-white text-[10px] rounded px-2 py-1 pointer-events-none transition-opacity z-50 whitespace-nowrap shadow-xl">
                                        <div className="font-bold border-b border-slate-600 mb-1 pb-0.5">{item.label}</div>
                                        <div>Thực tế: {realPercent.toFixed(1)}% ({item.value} lần)</div>
                                        <div>Lý thuyết: {item.theory}%</div>
                                    </div>

                                    <span className="text-[10px] md:text-xs font-bold mt-2 text-slate-700 text-center leading-tight truncate w-full" title={item.label}>
                                        {item.label}
                                    </span>
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="flex justify-center gap-4 mt-2 text-[10px] text-slate-500 font-medium">
                        <div className="flex items-center gap-1"><span className="w-3 h-3 bg-indigo-500 rounded-sm"></span> Thực nghiệm</div>
                        <div className="flex items-center gap-1"><span className="w-3 h-3 bg-slate-300 rounded-sm"></span> Lý thuyết</div>
                    </div>
                </div>
            );
        };

        const ProbabilityFormulaDisplay = ({ data, total }) => {
            return (
                <div className="mt-4 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100">
                    <h4 className="font-bold text-indigo-900 mb-3 flex items-center gap-2 text-sm uppercase tracking-wide">
                        {Icons.Calculator} So sánh chi tiết
                    </h4>
                    
                    <div className="space-y-1 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                        {data.map((item, idx) => {
                            const percent = total > 0 ? ((item.value/total)*100).toFixed(1) : 0;
                            const diff = Math.abs(percent - item.theory).toFixed(1);
                            return (
                                <div key={idx} className="flex items-center text-xs md:text-sm gap-2 bg-white p-2 rounded shadow-sm border border-transparent hover:border-indigo-100 transition-all">
                                    <div className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: item.color }}></div>
                                    <span className="font-semibold text-slate-700 w-20 truncate">{item.label}</span>
                                    
                                    <div className="flex-1 grid grid-cols-3 gap-2 text-right">
                                        <div className="text-slate-500" title="Lý thuyết">L: {item.theory}%</div>
                                        <div className="text-indigo-600 font-bold" title="Thực nghiệm">T: {percent}%</div>
                                        <div className={`font-mono ${diff < 2 ? 'text-green-500' : 'text-orange-500'}`} title="Sai lệch">±{diff}</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        const FastForwardControls = ({ onBulkRun, disabled }) => (
            <div className="mt-4 pt-4 border-t border-slate-200">
                <div className="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide flex items-center gap-1">
                    {Icons.Zap} Chạy thực nghiệm nhanh:
                </div>
                <div className="grid grid-cols-6 gap-2">
                    {[10, 50, 100, 200, 500, 1000].map(num => (
                        <button
                            key={num}
                            onClick={() => onBulkRun(num)}
                            disabled={disabled}
                            className="px-1 py-2 bg-white border border-slate-300 rounded shadow-sm hover:bg-indigo-50 hover:border-indigo-400 hover:text-indigo-700 text-xs font-bold text-slate-600 transition-all active:scale-95 disabled:opacity-50"
                        >
                            +{num}
                        </button>
                    ))}
                </div>
            </div>
        );

        // --- DICE COMPONENT ---
        const Die = React.forwardRef(({ idx }, ref) => (
            <div className="dice-container" ref={ref}>
                <div className="die-face die-face-1"><div className="dot dot-red"></div></div>
                <div className="die-face die-face-2"><div className="dot" style={{transform:'translate(-20px,-20px)'}}></div><div className="dot" style={{transform:'translate(20px,20px)'}}></div></div>
                <div className="die-face die-face-3"><div className="dot" style={{transform:'translate(-20px,-20px)'}}></div><div className="dot"></div><div className="dot" style={{transform:'translate(20px,20px)'}}></div></div>
                <div className="die-face die-face-4"><div className="dot" style={{transform:'translate(-20px,-20px)'}}></div><div className="dot" style={{transform:'translate(20px,-20px)'}}></div><div className="dot" style={{transform:'translate(-20px,20px)'}}></div><div className="dot" style={{transform:'translate(20px,20px)'}}></div></div>
                <div className="die-face die-face-5"><div className="dot" style={{transform:'translate(-20px,-20px)'}}></div><div className="dot" style={{transform:'translate(20px,-20px)'}}></div><div className="dot"></div><div className="dot" style={{transform:'translate(-20px,20px)'}}></div><div className="dot" style={{transform:'translate(20px,20px)'}}></div></div>
                <div className="die-face die-face-6"><div className="dot" style={{transform:'translate(-20px,-25px)'}}></div><div className="dot" style={{transform:'translate(20px,-25px)'}}></div><div className="dot" style={{transform:'translate(-20px,0)'}}></div><div className="dot" style={{transform:'translate(20px,0)'}}></div><div className="dot" style={{transform:'translate(-20px,25px)'}}></div><div className="dot" style={{transform:'translate(20px,25px)'}}></div></div>
            </div>
        ));

        // --- MODULE 1: TUNG ĐỒNG XU (Sửa lỗi: dùng transition thay vì animation) ---
        const CoinModule = () => {
            const [coins, setCoins] = useState(1);
            const [isFlipping, setIsFlipping] = useState(false);
            const [result, setResult] = useState([]); 
            const [counts, setCounts] = useState({ S: 0, N: 0, SS: 0, SN: 0, NN: 0 });
            const coinRefs = useRef([]);

            useEffect(() => {
                setCounts({ S: 0, N: 0, SS: 0, SN: 0, NN: 0 });
                setResult([]);
            }, [coins]);

            const toss = () => {
                if (isFlipping) return;
                setIsFlipping(true);
                setResult([]);

                // Tính toán kết quả trước
                const outcomes = Array(coins).fill(0).map(() => Math.random() < 0.5 ? 'S' : 'N');
                
                // Thực hiện hiệu ứng quay
                coinRefs.current.forEach((ref, i) => {
                    if(ref) {
                        // Reset style để chuẩn bị quay
                        ref.style.transition = 'none';
                        ref.style.transform = 'rotateX(0deg)';
                        
                        // Force reflow
                        void ref.offsetWidth;

                        // Tính góc quay: thêm 5 vòng (1800 độ) + góc mặt đích (S=0, N=180)
                        const targetRotation = outcomes[i] === 'S' ? 0 : 180;
                        const totalRotation = 1800 + targetRotation;

                        ref.style.transition = 'transform 1.5s cubic-bezier(0.2, 0.8, 0.2, 1)';
                        ref.style.transform = `rotateX(${totalRotation}deg)`;
                    }
                });

                setTimeout(() => {
                    // Reset về góc chuẩn (0 hoặc 180) để không bị tràn số khi quay nhiều lần
                    coinRefs.current.forEach((ref, i) => {
                        if(ref) {
                            const finalRotation = outcomes[i] === 'S' ? 0 : 180;
                            ref.style.transition = 'none';
                            ref.style.transform = `rotateX(${finalRotation}deg)`;
                        }
                    });

                    setResult(outcomes);
                    setCounts(prev => {
                        const next = { ...prev };
                        if (coins === 1) next[outcomes[0]]++;
                        else {
                            const k = outcomes.join('');
                            if (k === 'SS') next.SS++; else if (k === 'NN') next.NN++; else next.SN++;
                        }
                        return next;
                    });
                    setIsFlipping(false);
                }, 1500);
            };

            const runBulk = (n) => {
                const batch = { S:0, N:0, SS:0, SN:0, NN:0 };
                for(let i=0; i<n; i++) {
                    const r1 = Math.random() < 0.5 ? 'S' : 'N';
                    if (coins === 1) batch[r1]++;
                    else {
                        const r2 = Math.random() < 0.5 ? 'S' : 'N';
                        const k = r1 + r2;
                        if (k === 'SS') batch.SS++; else if (k === 'NN') batch.NN++; else batch.SN++;
                    }
                }
                setCounts(prev => ({
                    S: prev.S + batch.S, N: prev.N + batch.N,
                    SS: prev.SS + batch.SS, SN: prev.SN + batch.SN, NN: prev.NN + batch.NN
                }));
            };

            const total = coins === 1 ? counts.S + counts.N : counts.SS + counts.SN + counts.NN;
            
            const data = coins === 1 
                ? [
                    { label: 'Sấp (S)', value: counts.S, theory: 50, color: '#eab308' }, 
                    { label: 'Ngửa (N)', value: counts.N, theory: 50, color: '#6366f1' }
                  ]
                : [
                    { label: '2 Sấp', value: counts.SS, theory: 25, color: '#eab308' }, 
                    { label: '1S 1N', value: counts.SN, theory: 50, color: '#10b981' }, 
                    { label: '2 Ngửa', value: counts.NN, theory: 25, color: '#6366f1' }
                  ];

            return (
                <div className="grid lg:grid-cols-2 gap-6 h-full">
                    <Card title="Thí nghiệm: Tung Đồng Xu" 
                        tools={
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={()=>{setCoins(1)}} className={`px-3 py-1 text-xs font-bold rounded ${coins===1?'bg-white shadow text-indigo-600':'text-slate-500'}`}>1 Xu</button>
                                <button onClick={()=>{setCoins(2)}} className={`px-3 py-1 text-xs font-bold rounded ${coins===2?'bg-white shadow text-indigo-600':'text-slate-500'}`}>2 Xu</button>
                            </div>
                        }>
                        <div className="flex-1 flex flex-col items-center justify-center min-h-[350px]">
                            <div className="perspective-800 flex gap-8 mb-8">
                                {Array(coins).fill(0).map((_, i) => (
                                    <div key={i} className="coin-wrapper" ref={el => coinRefs.current[i] = el}>
                                        <div className="coin-face coin-front"><span className="text-4xl font-black text-yellow-900 opacity-70">S</span></div>
                                        <div className="coin-face coin-back"><span className="text-4xl font-black text-indigo-900 opacity-70">N</span></div>
                                        <div className="coin-side"></div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="h-8 mb-4 font-bold text-xl text-indigo-800">
                                {isFlipping ? "Đang tung..." : result.length > 0 ? `Kết quả: ${result.join(" - ")}` : "Sẵn sàng"}
                            </div>

                            <button onClick={toss} disabled={isFlipping}
                                className="bg-yellow-500 hover:bg-yellow-600 text-yellow-950 font-bold py-3 px-10 rounded-full shadow-lg shadow-yellow-500/30 transition-all active:scale-95 disabled:opacity-50 text-lg">
                                TUNG ĐỒNG XU
                            </button>
                        </div>
                    </Card>

                    <Card title="Thống kê & So sánh">
                        <div className="flex justify-between mb-4 items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <span className="text-sm font-medium text-slate-600">Tổng lần tung: <strong className="text-indigo-700 text-lg">{total}</strong></span>
                            <button onClick={()=>setCounts({S:0,N:0,SS:0,SN:0,NN:0})} className="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200">Làm lại</button>
                        </div>
                        <DoubleBarChart data={data} total={total} />
                        <ProbabilityFormulaDisplay data={data} total={total} />
                        <FastForwardControls onBulkRun={runBulk} disabled={isFlipping} />
                    </Card>
                </div>
            );
        };

        // --- MODULE 2: GIEO XÚC XẮC (Sửa lỗi: dùng bội số 360 độ) ---
        const DiceModule = () => {
            const [mode, setMode] = useState(1);
            const [rolling, setRolling] = useState(false);
            const [vals, setVals] = useState([1]);
            const [stats, setStats] = useState(Array(13).fill(0));
            const diceRefs = useRef([]);

            useEffect(() => { 
                setStats(Array(13).fill(0)); 
                setVals(mode===1?[1]:[1,1]); 
            }, [mode]);

            const roll = () => {
                if(rolling) return;
                setRolling(true);
                const res = mode === 1 ? [Math.ceil(Math.random()*6)] : [Math.ceil(Math.random()*6), Math.ceil(Math.random()*6)];

                // Mapping mặt xúc xắc với góc quay (X, Y)
                const map = {
                    1: [0, 0], 
                    2: [0, 180], 
                    3: [0, -90], 
                    4: [0, 90], 
                    5: [-90, 0], 
                    6: [90, 0]
                };

                // Apply rotation animation
                res.forEach((r, i) => {
                    const el = diceRefs.current[i];
                    if(el) {
                        const target = map[r];
                        // QUAN TRỌNG: Thêm bội số của 360 độ (ví dụ 3 hoặc 4 vòng) để đảm bảo quay về đúng mặt
                        // Thay vì dùng random lẻ, dùng random bội số 360
                        const extraSpinsX = 360 * (Math.floor(Math.random() * 3) + 3); // 3-5 vòng
                        const extraSpinsY = 360 * (Math.floor(Math.random() * 3) + 3); 
                        
                        el.style.transition = 'transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1)';
                        el.style.transform = `rotateX(${target[0] + extraSpinsX}deg) rotateY(${target[1] + extraSpinsY}deg)`;
                    }
                });

                setTimeout(() => {
                    setVals(res);
                    setStats(prev => {
                        const next = [...prev];
                        if(mode===1) next[res[0]]++; else next[res[0]+res[1]]++;
                        return next;
                    });
                    
                    // Reset transform về góc chuẩn (không còn số vòng quay thừa) để clean
                    res.forEach((r, i) => {
                        const el = diceRefs.current[i];
                        if(el) {
                            const target = map[r];
                            el.style.transition = 'none';
                            el.style.transform = `rotateX(${target[0]}deg) rotateY(${target[1]}deg)`;
                        }
                    });
                    setRolling(false);
                }, 1200);
            };

            const runBulk = (n) => {
                const batch = Array(13).fill(0);
                for(let i=0; i<n; i++) {
                    if(mode === 1) batch[Math.ceil(Math.random()*6)]++;
                    else batch[Math.ceil(Math.random()*6) + Math.ceil(Math.random()*6)]++;
                }
                setStats(prev => prev.map((v,k) => v+batch[k]));
            };

            const total = mode===1 ? stats.slice(1,7).reduce((a,b)=>a+b,0) : stats.slice(2,13).reduce((a,b)=>a+b,0);
            
            // Calculate Data with Theory
            let data = [];
            if(mode===1) {
                data = Array(6).fill(0).map((_,i) => ({ 
                    label: `Mặt ${i+1}`, 
                    value: stats[i+1], 
                    theory: 16.7, // 1/6 approx
                    color: '#ef4444' 
                }));
            } else {
                // Pyramid distribution for 2 dice
                const theoryMap = { 2:2.8, 3:5.6, 4:8.3, 5:11.1, 6:13.9, 7:16.7, 8:13.9, 9:11.1, 10:8.3, 11:5.6, 12:2.8 };
                data = Array(11).fill(0).map((_,i) => {
                    const sum = i+2;
                    return { 
                        label: `Tổng ${sum}`, 
                        value: stats[sum], 
                        theory: theoryMap[sum],
                        color: sum===7 ? '#dc2626' : '#f87171' 
                    };
                });
            }

            return (
                <div className="grid lg:grid-cols-2 gap-6 h-full">
                    <Card title="Thí nghiệm: Gieo Xúc Xắc"
                        tools={
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={()=>{setMode(1); setStats(Array(13).fill(0))}} className={`px-3 py-1 text-xs font-bold rounded ${mode===1?'bg-white shadow text-red-600':'text-slate-500'}`}>1 Viên</button>
                                <button onClick={()=>{setMode(2); setStats(Array(13).fill(0))}} className={`px-3 py-1 text-xs font-bold rounded ${mode===2?'bg-white shadow text-red-600':'text-slate-500'}`}>2 Viên</button>
                            </div>
                        }>
                        <div className="flex-1 flex flex-col items-center justify-center min-h-[350px] perspective-1000">
                            <div className={`flex gap-12 mb-10 transition-transform ${mode===2?'scale-90':'scale-100'}`}>
                                <Die ref={el => diceRefs.current[0] = el} />
                                {mode===2 && <Die ref={el => diceRefs.current[1] = el} />}
                            </div>
                            <div className="h-8 mb-4 font-bold text-xl text-red-800">
                                {rolling ? "Đang gieo..." : `Kết quả: ${mode === 1 ? vals[0] : `${vals[0]} + ${vals[1]} = ${vals[0]+vals[1]}`}`}
                            </div>
                            <button onClick={roll} disabled={rolling} 
                                className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-10 rounded-full shadow-lg shadow-red-500/30 active:scale-95 transition-all text-lg">
                                GIEO XÚC XẮC
                            </button>
                        </div>
                    </Card>

                    <Card title="Thống kê & So sánh">
                        <div className="flex justify-between mb-4 items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <span className="text-sm font-medium text-slate-600">Tổng lần gieo: <strong className="text-red-700 text-lg">{total}</strong></span>
                            <button onClick={()=>setStats(Array(13).fill(0))} className="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200">Xóa</button>
                        </div>
                        <DoubleBarChart data={data} total={total} />
                        <ProbabilityFormulaDisplay data={data} total={total} />
                        <FastForwardControls onBulkRun={runBulk} disabled={rolling} />
                    </Card>
                </div>
            );
        };

        // --- MODULE 3: VÒNG QUAY ---
        const WheelModule = () => {
            const [segments, setSegments] = useState(4); 
            const [rotation, setRotation] = useState(0);
            const [spinning, setSpinning] = useState(false);
            const [stats, setStats] = useState({});
            const colors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#a855f7', '#ec4899', '#f97316', '#06b6d4'];

            const spin = () => {
                if(spinning) return;
                setSpinning(true);
                const randomAngle = Math.random() * 360;
                const totalSpin = rotation + 1440 + randomAngle;
                setRotation(totalSpin);

                setTimeout(() => {
                    setSpinning(false);
                    const normalized = totalSpin % 360;
                    const segmentAngle = 360 / segments;
                    const index = Math.floor((360 - normalized) / segmentAngle) % segments;
                    setStats(p => ({...p, [index]: (p[index]||0) + 1}));
                }, 3500);
            };

            const runBulk = (n) => {
                const b = {};
                for(let i=0; i<n; i++) {
                    const r = Math.floor(Math.random() * segments);
                    b[r] = (b[r]||0) + 1;
                }
                setStats(p => {
                    const next = {...p};
                    for(let k in b) next[k] = (next[k]||0) + b[k];
                    return next;
                });
            };

            const total = Object.values(stats).reduce((a,b)=>a+b,0);
            const data = Array(segments).fill(0).map((_,i) => ({
                label: `Ô ${i+1}`,
                value: stats[i]||0,
                theory: parseFloat((100/segments).toFixed(1)),
                color: colors[i % colors.length]
            }));

            // SVG Wheel
            const createWheel = () => {
                const paths = [];
                const r = 100; const c = 100; const step = 360 / segments;
                for(let i=0; i<segments; i++) {
                    const startAngle = (i * step) * Math.PI / 180;
                    const endAngle = ((i + 1) * step) * Math.PI / 180;
                    const x1 = c + r * Math.sin(startAngle); const y1 = c - r * Math.cos(startAngle);
                    const x2 = c + r * Math.sin(endAngle); const y2 = c - r * Math.cos(endAngle);
                    const d = `M ${c} ${c} L ${x1} ${y1} A ${r} ${r} 0 ${step>180?1:0} 1 ${x2} ${y2} Z`;
                    const midAngle = (i*step + step/2) * Math.PI/180;
                    const tx = c + (r*0.65)*Math.sin(midAngle); const ty = c - (r*0.65)*Math.cos(midAngle);
                    
                    paths.push(
                        <g key={i}>
                            <path d={d} fill={colors[i % colors.length]} stroke="white" strokeWidth="2" />
                            <text x={tx} y={ty} fill="white" fontSize="14" fontWeight="bold" textAnchor="middle" alignmentBaseline="middle" transform={`rotate(${(i*step+step/2)}, ${tx}, ${ty})`}>{i+1}</text>
                        </g>
                    );
                }
                return paths;
            };

            return (
                <div className="grid lg:grid-cols-2 gap-6 h-full">
                    <Card title="Thí nghiệm: Vòng Quay"
                        tools={
                            <div className="flex items-center gap-2 bg-slate-100 p-1 px-2 rounded-lg">
                                <span className="text-xs font-bold text-slate-500">Số ô:</span>
                                <input type="number" min="2" max="8" value={segments} 
                                    onChange={(e) => {
                                        const v = Math.min(8, Math.max(2, parseInt(e.target.value)||4));
                                        setSegments(v); setStats({}); setRotation(0);
                                    }}
                                    className="w-10 border rounded text-center text-xs font-bold" />
                            </div>
                        }>
                        <div className="flex-1 flex flex-col items-center justify-center min-h-[350px]">
                            <div className="relative mb-8 scale-110">
                                <div className="absolute -top-4 left-1/2 -translate-x-1/2 z-20 stopper drop-shadow-md">
                                    <div className="w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[20px] border-t-slate-800"></div>
                                </div>
                                <div className="spinner-container" style={{transform: `rotate(${rotation}deg)`}}>
                                    <svg width="240" height="240" viewBox="0 0 200 200" className="drop-shadow-xl">
                                        {createWheel()}
                                        <circle cx="100" cy="100" r="10" fill="white" />
                                    </svg>
                                </div>
                            </div>
                            <button onClick={spin} disabled={spinning} 
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-12 rounded-full shadow-lg shadow-green-500/30 active:scale-95 transition-all text-lg">
                                {spinning ? 'Đang quay...' : 'QUAY'}
                            </button>
                        </div>
                    </Card>

                    <Card title="Thống kê & So sánh">
                        <div className="flex justify-between mb-4 items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <span className="text-sm font-medium text-slate-600">Lượt quay: <strong className="text-green-700 text-lg">{total}</strong></span>
                            <button onClick={()=>setStats({})} className="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200">Làm lại</button>
                        </div>
                        <DoubleBarChart data={data} total={total} />
                        <ProbabilityFormulaDisplay data={data} total={total} />
                        <FastForwardControls onBulkRun={runBulk} disabled={spinning} />
                    </Card>
                </div>
            );
        };

        // --- MODULE 4: HỘP BI ---
        const UrnModule = () => {
            const [config, setConfig] = useState({ red: 3, blue: 2, yellow: 0 });
            const [picking, setPicking] = useState(false);
            const [lastPick, setLastPick] = useState(null);
            const [stats, setStats] = useState({ red: 0, blue: 0, yellow: 0 });

            const ballList = useMemo(() => {
                const arr = [];
                for(let i=0; i<config.red; i++) arr.push({c:'red', h:'#ef4444', label:'Đỏ'});
                for(let i=0; i<config.blue; i++) arr.push({c:'blue', h:'#3b82f6', label:'Xanh'});
                for(let i=0; i<config.yellow; i++) arr.push({c:'yellow', h:'#eab308', label:'Vàng'});
                return arr;
            }, [config]);

            const pick = () => {
                if(ballList.length===0 || picking) return;
                setPicking(true); setLastPick(null);
                setTimeout(() => {
                    const rand = ballList[Math.floor(Math.random() * ballList.length)];
                    setLastPick(rand);
                    setStats(p => ({...p, [rand.c]: p[rand.c]+1}));
                    setPicking(false);
                }, 800);
            };

            const runBulk = (n) => {
                if(ballList.length===0) return;
                const b = {red:0, blue:0, yellow:0};
                for(let i=0; i<n; i++) {
                    const rand = ballList[Math.floor(Math.random() * ballList.length)];
                    b[rand.c]++;
                }
                setStats(p => ({red: p.red+b.red, blue: p.blue+b.blue, yellow: p.yellow+b.yellow}));
            };

            const total = stats.red + stats.blue + stats.yellow;
            const totalBalls = config.red + config.blue + config.yellow;
            
            const data = [
                {label: 'Bi Đỏ', value: stats.red, theory: totalBalls ? (config.red/totalBalls*100).toFixed(1) : 0, color: '#ef4444'},
                {label: 'Bi Xanh', value: stats.blue, theory: totalBalls ? (config.blue/totalBalls*100).toFixed(1) : 0, color: '#3b82f6'},
                {label: 'Bi Vàng', value: stats.yellow, theory: totalBalls ? (config.yellow/totalBalls*100).toFixed(1) : 0, color: '#eab308'},
            ].filter(d => config[d.label === 'Bi Đỏ' ? 'red' : d.label === 'Bi Xanh' ? 'blue' : 'yellow'] > 0 || d.value > 0);

            const Ball = ({color, style}) => (
                <div className="w-8 h-8 rounded-full border border-black/10 shadow-[inset_-3px_-3px_5px_rgba(0,0,0,0.3)] transition-transform"
                    style={{backgroundColor: color, ...style}}></div>
            );

            return (
                <div className="grid lg:grid-cols-2 gap-6 h-full">
                    <Card title="Thí nghiệm: Hộp Bi Ngẫu Nhiên"
                        tools={
                            <div className="flex gap-2 bg-slate-100 p-1 px-2 rounded-lg">
                                {['red', 'blue', 'yellow'].map(c => (
                                    <div key={c} className="flex items-center gap-1">
                                        <div className={`w-3 h-3 rounded-full bg-${c==='red'?'red-500':c==='blue'?'blue-500':'yellow-500'}`}></div>
                                        <input type="number" min="0" max="10" className="w-8 border rounded text-center text-xs" 
                                            value={config[c]} onChange={(e) => {
                                                setConfig(p => ({...p, [c]: Math.max(0, parseInt(e.target.value)||0)}));
                                                setStats({red:0,blue:0,yellow:0}); setLastPick(null);
                                            }} />
                                    </div>
                                ))}
                            </div>
                        }>
                        <div className="flex-1 flex flex-col items-center justify-center min-h-[350px]">
                            <div className="relative w-56 h-48 mb-6 flex items-end justify-center">
                                <div className="absolute w-full h-40 border-4 border-slate-300 border-t-0 rounded-b-3xl bg-white/50 overflow-hidden flex flex-wrap content-end p-2 gap-1 justify-center z-10"
                                     style={{animation: picking ? 'shake-box 0.5s infinite' : 'none'}}>
                                    {ballList.map((b, i) => (
                                        <Ball key={i} color={b.h} />
                                    ))}
                                </div>
                                {lastPick && !picking && (
                                    <div className="absolute -top-10 z-20 animate-[bounce_1s_infinite] flex flex-col items-center">
                                        <div className="bg-white px-3 py-1 rounded shadow text-xs font-bold mb-1 border border-slate-200">Đã bốc: {lastPick.label}</div>
                                        <Ball color={lastPick.h} style={{width:'48px', height:'48px', boxShadow: '0 10px 15px rgba(0,0,0,0.2)'}} />
                                    </div>
                                )}
                            </div>
                            <button onClick={pick} disabled={picking || ballList.length===0} 
                                className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-10 rounded-full shadow-lg shadow-indigo-500/30 active:scale-95 transition-all text-lg disabled:opacity-50">
                                {picking ? 'Đang bốc...' : 'BỐC 1 BI'}
                            </button>
                        </div>
                    </Card>

                    <Card title="Thống kê & So sánh">
                        <div className="flex justify-between mb-4 items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <span className="text-sm font-medium text-slate-600">Tổng lần bốc: <strong className="text-indigo-700 text-lg">{total}</strong></span>
                            <button onClick={()=>setStats({red:0,blue:0,yellow:0})} className="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200">Làm lại</button>
                        </div>
                        <DoubleBarChart data={data} total={total} />
                        <ProbabilityFormulaDisplay data={data} total={total} />
                        <FastForwardControls onBulkRun={runBulk} disabled={picking || ballList.length===0} />
                    </Card>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('coin');
            
            const tabs = [
                { id: 'coin', label: 'Tung Đồng Xu', icon: Icons.Coin },
                { id: 'dice', label: 'Gieo Xúc Xắc', icon: Icons.Dice },
                { id: 'wheel', label: 'Vòng Quay', icon: Icons.Wheel },
                { id: 'urn', label: 'Hộp Bi', icon: Icons.Urn },
            ];

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <header className="mb-8 text-center">
                            <h1 className="text-3xl md:text-5xl font-black text-indigo-900 mb-3 tracking-tight flex items-center justify-center gap-3">
                                <span className="text-yellow-500">{Icons.Zap}</span>
                                LAB XÁC SUẤT 3D
                            </h1>
                            <p className="text-slate-500 font-medium text-lg">Mô phỏng trực quan & Thống kê chi tiết</p>
                        </header>

                        {/* Navigation */}
                        <div className="flex flex-wrap justify-center gap-2 md:gap-4 mb-8">
                            {tabs.map((tab) => {
                                const isActive = activeTab === tab.id;
                                return (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                        className={`flex items-center gap-2 px-5 py-3 rounded-xl transition-all font-bold text-sm md:text-base border-2 shadow-sm
                                            ${isActive ? 'bg-indigo-600 border-indigo-600 text-white transform scale-105 shadow-indigo-200' 
                                                       : 'bg-white border-white text-slate-500 hover:border-indigo-100 hover:text-indigo-600'}`}>
                                        <span className={isActive?"text-yellow-300":""}>{tab.icon}</span>
                                        {tab.label}
                                    </button>
                                );
                            })}
                        </div>

                        {/* Content */}
                        <main className="animate-in fade-in duration-500 slide-in-from-bottom-6 min-h-[600px]">
                            {activeTab === 'coin' && <CoinModule />}
                            {activeTab === 'dice' && <DiceModule />}
                            {activeTab === 'wheel' && <WheelModule />}
                            {activeTab === 'urn' && <UrnModule />}
                        </main>

                        <footer className="mt-16 text-center text-slate-400 text-sm pb-8">
                            © Thầy Nguyễn Việt Hoàng - Trường THCS Nguyễn An Khương
                        </footer>
                    </div>
                </div>
            )
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>