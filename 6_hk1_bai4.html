<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toán 6 - Bài 4: Tìm x, y & Biểu thức</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar {
            width: 8px;
        }
        #steps-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .input-group:focus-within label {
            color: #4f46e5;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-shapes mr-2"></i>ÔN TẬP BÀI 4: CỘNG TRỪ SỐ NGUYÊN
            </h1>
            <div class="absolute top-4 right-4 bg-white/20 backdrop-blur-sm px-4 py-1 rounded-full text-white font-bold text-sm border border-white/30">
                Điểm: <span id="score" class="text-yellow-300 text-lg">0</span>
            </div>
        </div>

        <div class="p-4 md:p-6 space-y-6">
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[350px] relative">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            Đề bài
                        </div>
                        
                        <div class="space-y-6 font-mono text-xl md:text-2xl w-full px-4">
                            <!-- Question A: Find x, y -->
                            <div class="flex flex-col">
                                <div class="flex items-center mb-2">
                                    <span class="text-yellow-400 font-bold mr-2 w-6">a)</span>
                                    <span class="text-blue-200 text-lg font-sans">Tìm x, y biết:</span>
                                </div>
                                <div class="pl-8 space-y-3">
                                    <div id="q-x-text" class="text-white tracking-wider">Loading...</div>
                                    <div id="q-y-text" class="text-white tracking-wider">Loading...</div>
                                </div>
                            </div>

                            <!-- Question B: Expression -->
                            <div class="flex flex-col border-t border-gray-600 pt-4">
                                <div class="flex items-center mb-2">
                                    <span class="text-yellow-400 font-bold mr-2 w-6">b)</span>
                                    <span class="text-blue-200 text-lg font-sans">Tính giá trị biểu thức:</span>
                                </div>
                                <div class="pl-8">
                                    <div id="q-expr-text" class="text-white font-bold tracking-wide">Loading...</div>
                                    <div class="text-gray-400 text-sm italic mt-2 font-sans">(Với x, y tìm được ở câu a)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        <div class="grid grid-cols-3 gap-4">
                            <!-- Input X -->
                            <div class="input-group">
                                <label class="block text-gray-500 font-bold text-xs uppercase mb-1 text-center">x =</label>
                                <input type="number" id="ans-x" placeholder="?" 
                                    class="w-full text-center font-bold p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                            </div>
                            <!-- Input Y -->
                            <div class="input-group">
                                <label class="block text-gray-500 font-bold text-xs uppercase mb-1 text-center">y =</label>
                                <input type="number" id="ans-y" placeholder="?" 
                                    class="w-full text-center font-bold p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                            </div>
                            <!-- Input Expr -->
                            <div class="input-group">
                                <label id="label-expr" class="block text-gray-500 font-bold text-xs uppercase mb-1 text-center">KQ =</label>
                                <input type="number" id="ans-expr" placeholder="?" 
                                    class="w-full text-center font-bold p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                            </div>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3 mt-4">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> Bài mới
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Kiểm tra
                            </button>
                        </div>

                        <!-- Feedback Area -->
                        <div id="feedback" class="hidden mt-3 text-center p-2 rounded-lg text-sm font-bold"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <!-- FIX: Added fixed height (h-[550px]) to ensure internal scrolling works correctly -->
                <div class="flex flex-col h-[500px] lg:h-[550px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>Hướng dẫn
                            </h3>
                            <!-- Button -->
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>Gợi ý tiếp</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Rule Hint Area -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <i class="fas fa-info-circle mr-2 text-yellow-600"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>
                    
                    <!-- Scrollable Steps -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-chalkboard-teacher text-3xl mb-2 opacity-30"></i>
                            <span>Bấm "Gợi ý tiếp" để xem hướng dẫn</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Configuration & Utils ---
        let currentData = {
            ansX: 0,
            ansY: 0,
            ansExpr: 0,
            allSteps: []
        };
        let score = 0;
        let isAnswered = false;
        let stepIndex = 0;

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function fmt(num) {
            return num < 0 ? `(${num})` : `${num}`;
        }

        // --- Core Logic ---

        function generateProblem() {
            const findX = generateFindVar('x');
            const findY = generateFindVar('y');
            const expr = generateExpression(findX.answer, findY.answer);

            return {
                findX: findX,
                findY: findY,
                expr: expr,
                allSteps: buildSteps(findX, findY, expr)
            };
        }

        function generateFindVar(varName) {
            const type = getRandomInt(1, 3);
            const a = getRandomInt(-20, 20);
            const b = getRandomInt(-30, 30);
            
            let displayStr = "";
            let steps = [];
            let ans = 0;
            let rule = "";

            if (type === 1) { // v + a = b
                displayStr = `${varName} + ${fmt(a)} = ${b}`;
                ans = b - a;
                rule = "Muốn tìm số hạng chưa biết, lấy Tổng trừ đi số hạng đã biết.";
                steps = [
                    displayStr,
                    `${varName} = ${b} - ${fmt(a)}`,
                    a < 0 ? `${varName} = ${b} + ${Math.abs(a)}` : null, 
                    `${varName} = ${ans}`
                ].filter(s => s);
            } else if (type === 2) { // v - a = b
                displayStr = `${varName} - ${fmt(a)} = ${b}`;
                ans = b + a;
                rule = "Muốn tìm Số Bị Trừ, lấy Hiệu cộng với Số Trừ.";
                steps = [
                    displayStr,
                    `${varName} = ${b} + ${fmt(a)}`,
                    `${varName} = ${ans}`
                ];
            } else { // a - v = b
                displayStr = `${a} - ${varName} = ${b}`;
                ans = a - b;
                rule = "Muốn tìm Số Trừ, lấy Số Bị Trừ trừ đi Hiệu.";
                steps = [
                    displayStr,
                    `${varName} = ${a} - ${fmt(b)}`,
                    b < 0 ? `${varName} = ${a} + ${Math.abs(b)}` : null,
                    `${varName} = ${ans}`
                ].filter(s => s);
            }

            return {
                display: displayStr,
                answer: ans,
                rule: rule,
                steps: steps
            };
        }

        function generateExpression(xVal, yVal) {
            const names = ['A', 'B', 'C', 'H', 'K', 'M', 'N', 'P', 'Q'];
            const name = names[getRandomInt(0, names.length - 1)];
            
            let a = getRandomInt(-9, 9);
            while(a === 0) a = getRandomInt(-9, 9);
            let b = getRandomInt(-9, 9);
            while(b === 0) b = getRandomInt(-9, 9);
            let c = getRandomInt(-15, 15);

            const term1 = `${a === 1 ? '' : (a === -1 ? '-' : a)}x`;
            const term2 = `${b < 0 ? '-' : '+'} ${Math.abs(b) === 1 ? '' : Math.abs(b)}y`;
            const term3 = c !== 0 ? `${c < 0 ? '-' : '+'} ${Math.abs(c)}` : '';
            
            const exprDisplay = `${term1} ${term2} ${term3}`;
            const fullExprName = `${name} = ${exprDisplay}`;

            const total = (a * xVal) + (b * yVal) + c;

            let sub1 = `${a}.(${xVal})`;
            let sub2 = `${b < 0 ? '-' : '+'} ${Math.abs(b)}.(${yVal})`;
            let sub3 = c !== 0 ? `${c < 0 ? '-' : '+'} ${Math.abs(c)}` : '';

            const subStep = `${name} = ${sub1} ${sub2} ${sub3}`;
            const val1 = a * xVal;
            const val2 = b * yVal;
            const calcStep = `${name} = ${val1} ${val2 < 0 ? '- ' + Math.abs(val2) : '+ ' + val2} ${c !== 0 ? (c < 0 ? '- ' + Math.abs(c) : '+ ' + c) : ''}`;

            const steps = [
                `Với x = ${xVal}, y = ${yVal}, biểu thức:`,
                fullExprName,
                subStep,
                calcStep,
                `${name} = ${total}`
            ];

            return {
                name: name,
                display: fullExprName,
                answer: total,
                rule: "Thay giá trị x, y vào biểu thức. Giữ nguyên dấu, đặt số vào ngoặc.",
                steps: steps
            };
        }

        function buildSteps(xData, yData, exprData) {
            return [
                { type: 'header', text: 'Tìm x', rule: xData.rule },
                ...xData.steps.map(s => ({ type: 'step', text: s, isLast: s === xData.steps[xData.steps.length-1] })),
                
                { type: 'header', text: 'Tìm y', rule: yData.rule },
                ...yData.steps.map(s => ({ type: 'step', text: s, isLast: s === yData.steps[yData.steps.length-1] })),
                
                { type: 'header', text: 'Tính giá trị biểu thức', rule: exprData.rule },
                ...exprData.steps.map(s => ({ type: 'step', text: s, isLast: s === exprData.steps[exprData.steps.length-1] }))
            ];
        }

        // --- Main UI Functions ---

        function nextQuestion() {
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            
            ['ans-x', 'ans-y', 'ans-expr'].forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.disabled = false;
                el.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');
            });
            
            isAnswered = false;
            stepIndex = 0;
            
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center"><i class="fas fa-chalkboard-teacher text-3xl mb-2 opacity-30"></i><span>Bấm "Gợi ý tiếp" để xem hướng dẫn</span></div>`;
            
            const btnStep = document.getElementById('btn-show-step');
            btnStep.innerHTML = '<span>Gợi ý tiếp</span> <i class="fas fa-arrow-right text-[10px]"></i>';
            btnStep.disabled = false;

            const data = generateProblem();
            currentData = {
                ansX: data.findX.answer,
                ansY: data.findY.answer,
                ansExpr: data.expr.answer,
                allSteps: data.allSteps
            };

            document.getElementById('q-x-text').textContent = data.findX.display;
            document.getElementById('q-y-text').textContent = data.findY.display;
            document.getElementById('q-expr-text').textContent = data.expr.display;
            document.getElementById('label-expr').textContent = `${data.expr.name} =`;
            
            document.getElementById('step-counter').textContent = `0/${currentData.allSteps.length}`;
        }

        function showNextStep() {
            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            const ruleContent = document.getElementById('rule-content');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentData.allSteps.length) {
                const item = currentData.allSteps[stepIndex];
                let newElement = null; // To track what we added
                
                if (item.type === 'header') {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "mt-4 mb-2 text-xs font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 flex items-center";
                    headerDiv.innerHTML = `<i class="fas fa-caret-right mr-1"></i> ${item.text}`;
                    container.appendChild(headerDiv);
                    newElement = headerDiv;

                    if (item.rule) {
                        ruleContent.textContent = item.rule;
                        ruleArea.classList.remove('hidden');
                        ruleArea.classList.remove('animate-pulse');
                        void ruleArea.offsetWidth;
                        ruleArea.classList.add('animate-pulse');
                    }
                } else {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-item bg-white p-2 rounded border-l-4 shadow-sm mb-2 text-sm md:text-base font-mono';
                    
                    if (item.isLast) {
                        stepDiv.classList.add('border-green-500', 'bg-green-50');
                        stepDiv.innerHTML = `<span class="text-green-700 font-bold">${item.text}</span>`;
                    } else {
                        stepDiv.classList.add('border-indigo-400');
                        stepDiv.textContent = item.text;
                    }
                    container.appendChild(stepDiv);
                    newElement = stepDiv;
                }

                // Auto Scroll to the new element
                if (newElement) {
                    newElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }

                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentData.allSteps.length}`;
            }

            if (stepIndex >= currentData.allSteps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>Hết</span>';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const iX = document.getElementById('ans-x');
            const iY = document.getElementById('ans-y');
            const iExpr = document.getElementById('ans-expr');
            
            const vX = parseInt(iX.value);
            const vY = parseInt(iY.value);
            const vExpr = parseInt(iExpr.value);
            
            let correctCount = 0;

            if (vX === currentData.ansX) {
                correctCount++;
                iX.classList.add('border-green-500', 'bg-green-50');
                iX.classList.remove('border-gray-300');
            } else {
                iX.classList.add('border-red-500', 'bg-red-50');
            }

            if (vY === currentData.ansY) {
                correctCount++;
                iY.classList.add('border-green-500', 'bg-green-50');
                iY.classList.remove('border-gray-300');
            } else {
                iY.classList.add('border-red-500', 'bg-red-50');
            }

            if (vExpr === currentData.ansExpr) {
                correctCount++;
                iExpr.classList.add('border-green-500', 'bg-green-50');
                iExpr.classList.remove('border-gray-300');
            } else {
                iExpr.classList.add('border-red-500', 'bg-red-50');
            }

            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');

            if (correctCount === 3) {
                score += 10;
                document.getElementById('score').textContent = score;
                feedback.innerHTML = '<i class="fas fa-crown"></i> Xuất sắc! Bạn đúng cả 3 câu.';
                feedback.classList.add('bg-green-100', 'text-green-800');
                
                const reveal = setInterval(() => {
                    if(stepIndex < currentData.allSteps.length) showNextStep();
                    else clearInterval(reveal);
                }, 100);
                isAnswered = true;
            } else {
                feedback.textContent = `Bạn đúng ${correctCount}/3 câu. Kiểm tra lại nhé!`;
                feedback.classList.add(correctCount === 0 ? 'bg-red-100' : 'bg-yellow-100', correctCount === 0 ? 'text-red-800' : 'text-yellow-800');
            }
        }

        window.onload = nextQuestion;

    </script>
</body>
</html>