<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mô phỏng Thể Tích Hình Hộp Chữ Nhật (Three.js)</title>
<style>
    /* Kiểu dáng chung cho trang */
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        margin: 0; 
        background-color: #f0f4f8;
        color: #333;
        /* overflow: hidden; /* Tránh thanh cuộn không cần thiết */
    }
    /* Vùng chứa chính */
    .container { 
        display: flex; 
        flex-wrap: wrap;
        gap: 30px; 
        align-items: flex-start; 
        background: #ffffff; 
        padding: 25px; 
        border-radius: 15px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        max-width: 95%;
        width: 950px; /* Tăng chiều rộng để có không gian cho 2 khối */
    }
    /* Vùng chứa mô phỏng 3D */
    .simulation-container {
        flex: 1;
        min-width: 500px; /* Tăng chiều rộng tối thiểu */
        height: 450px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #canvas-container {
        width: 100%;
        height: 100%;
        cursor: grab;
        border-radius: 8px;
        background-color: #e9ecef;
    }
    #canvas-container:active {
        cursor: grabbing;
    }
    /* Bảng điều khiển */
    .controls { 
        width: 300px;
        padding-top: 10px;
    }
    h2 {
        margin-top: 0;
        color: #0056b3;
        text-align: center;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    /* Công thức */
    .formula { 
        font-size: 1.25em; 
        font-weight: 500; 
        margin: 20px 0; 
        text-align: center; 
        padding: 12px;
        background-color: #e7f5ff;
        border-left: 5px solid #007bff;
        border-radius: 8px;
    }
    .formula .term { 
        color: #d9534f;
        font-weight: bold;
    }
    /* Thanh trượt */
    .slider-group {
        margin-bottom: 15px;
    }
    .slider-group label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-weight: 500;
    }
    .slider-group input[type="range"] {
        width: 100%;
        cursor: pointer;
    }
    /* Kết quả */
    .output p {
        margin: 10px 0;
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
    }
    .output span {
        font-weight: bold;
        color: #0056b3;
    }
</style>
</head>
<body>

<div class="container">
    <div class="simulation-container">
        <!-- Vùng canvas cho Three.js -->
        <div id="canvas-container"></div>
    </div>
    <div class="controls">
        <h2>Thể Tích</h2>
        
        <div class="slider-group">
            <label for="length-slider">Dài (a): <span id="length-val">2</span></label>
            <input type="range" id="length-slider" min="0.5" max="4" value="2" step="0.1">
        </div>
        <div class="slider-group">
            <label for="width-slider">Rộng (b): <span id="width-val">1.5</span></label>
            <input type="range" id="width-slider" min="0.5" max="3" value="1.5" step="0.1">
        </div>
        <div class="slider-group">
            <label for="max-height-slider">Cao (c): <span id="max-height-val">3</span></label>
            <input type="range" id="max-height-slider" min="0.5" max="5" value="3" step="0.1">
        </div>
        <div class="slider-group">
            <label for="height-slider">Quét chiều cao: <span id="scan-percentage">0%</span></label>
            <input type="range" id="height-slider" min="0" max="100" value="0" step="1">
        </div>

        <div class="formula">V = <span class="term">Sđáy</span> × <span class="term">Cao</span> = (<span class="term">a</span> × <span class="term">b</span>) × <span class="term">c</span></div>
        
        <div class="output">
            <p>Diện tích đáy: <span id="base-area-val">0</span></p>
            <p>Chiều cao quét: <span id="height-val">0</span></p>
            <p>Thể tích đã tạo: <span id="volume-val">0</span></p>
        </div>
    </div>
</div>

<!-- Tải thư viện Three.js và OrbitControls -->
<script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- CÁC BIẾN TOÀN CỤC ---
    let scene, camera, renderer, controls;
    let mainBox, baseSlice, volumeBlock;

    // --- DOM ELEMENTS ---
    const canvasContainer = document.getElementById('canvas-container');
    const lengthSlider = document.getElementById('length-slider');
    const widthSlider = document.getElementById('width-slider');
    const maxHeightSlider = document.getElementById('max-height-slider');
    const heightSlider = document.getElementById('height-slider');
    
    const lengthVal = document.getElementById('length-val');
    const widthVal = document.getElementById('width-val');
    const maxHeightVal = document.getElementById('max-height-val');
    const scanPercentage = document.getElementById('scan-percentage');
    const baseAreaVal = document.getElementById('base-area-val');
    const heightVal = document.getElementById('height-val');
    const volumeVal = document.getElementById('volume-val');

    // --- KHỞI TẠO CẢNH 3D ---
    function init() {
        // 1. Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe9ecef);

        // 2. Camera
        camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, 4, 8); // Điều chỉnh vị trí camera để thấy rõ 2 khối

        // 3. Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        canvasContainer.appendChild(renderer.domElement);

        // 4. Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        // 5. Controls
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        // 6. Grid Helper
        const gridHelper = new THREE.GridHelper(20, 20, 0xadb5bd, 0xced4da);
        scene.add(gridHelper);

        // --- TẠO CÁC ĐỐI TƯỢNG HÌNH HỌC ---
        const boxGeometry = new THREE.BoxGeometry(1, 1, 1);

        // Hộp chính (trong suốt với đường viền)
        const mainMaterial = new THREE.MeshStandardMaterial({
            color: 0x007bff,
            transparent: true,
            opacity: 0.1,
        });
        mainBox = new THREE.Mesh(boxGeometry, mainMaterial);
        const edges = new THREE.EdgesGeometry(boxGeometry);
        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x0056b3 });
        const wireframe = new THREE.LineSegments(edges, lineMaterial);
        mainBox.add(wireframe);

        // Lát cắt diện tích đáy
        const sliceGeometry = new THREE.PlaneGeometry(1, 1);
        const sliceMaterial = new THREE.MeshStandardMaterial({
            color: 0x17a2b8,
            side: THREE.DoubleSide,
        });
        baseSlice = new THREE.Mesh(sliceGeometry, sliceMaterial);
        baseSlice.rotation.x = -Math.PI / 2; // Xoay mặt phẳng nằm ngang

        // Khối thể tích được tạo ra
        const volumeMaterial = new THREE.MeshStandardMaterial({
            color: 0xd9534f,
        });
        volumeBlock = new THREE.Mesh(boxGeometry, volumeMaterial);
        
        scene.add(mainBox, baseSlice, volumeBlock);

        // --- GÁN SỰ KIỆN ---
        [lengthSlider, widthSlider, maxHeightSlider, heightSlider].forEach(slider => {
            slider.addEventListener('input', updateAll);
        });
        window.addEventListener('resize', onWindowResize);
        
        updateAll();
        animate();
    }

    // --- CẬP NHẬT TRẠNG THÁI MÔ PHỎNG ---
    function updateAll() {
        // 1. Lấy giá trị từ sliders
        const a = parseFloat(lengthSlider.value);
        const b = parseFloat(widthSlider.value);
        const c = parseFloat(maxHeightSlider.value);
        const percentage = parseInt(heightSlider.value) / 100;

        // 2. Cập nhật hiển thị text
        lengthVal.textContent = a.toFixed(1);
        widthVal.textContent = b.toFixed(1);
        maxHeightVal.textContent = c.toFixed(1);
        scanPercentage.textContent = `${Math.round(percentage * 100)}%`;

        // 3. Tính toán các giá trị
        const baseArea = a * b;
        const currentHeight = c * percentage;
        const currentVolume = baseArea * currentHeight;

        baseAreaVal.textContent = baseArea.toFixed(2);
        heightVal.textContent = currentHeight.toFixed(2);
        volumeVal.textContent = currentVolume.toFixed(2);

        // 4. Cập nhật các đối tượng 3D
        const gap = 1.5;
        const mainBoxX = -(a / 2 + gap / 2);
        const volumeBlockX = (a / 2 + gap / 2);

        // Cập nhật hộp chính
        mainBox.scale.set(a, c, b);
        mainBox.position.set(mainBoxX, c / 2, 0);

        // Cập nhật lát cắt
        baseSlice.scale.set(a, b, 1);
        baseSlice.position.set(mainBoxX, currentHeight, 0);

        // Cập nhật khối thể tích
        const generatedHeight = Math.max(0.001, currentHeight); // Tránh chiều cao bằng 0
        volumeBlock.scale.set(a, generatedHeight, b);
        volumeBlock.position.set(volumeBlockX, generatedHeight / 2, 0);
        
        // Ẩn/Hiện các đối tượng nếu cần
        volumeBlock.visible = percentage > 0;
    }

    // --- XỬ LÝ THAY ĐỔI KÍCH THƯỚC CỬA SỔ ---
    function onWindowResize() {
        camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
    }

    // --- VÒNG LẶP ANIMATION ---
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    
    // --- BẮT ĐẦU ---
    init();

</script>
</body>
</html>

