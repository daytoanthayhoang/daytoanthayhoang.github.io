<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p To√°n 6 Th·ª±c T·∫ø (CTST) - Ch·∫ø ƒê·ªô Si√™u Kh√≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0fdf4;
            background-image: radial-gradient(#86efac 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .chalkboard {
            background-color: #14532d;
            color: #dcfce7;
            border: 8px solid #713f12;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow: hidden;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar { width: 6px; }
        #steps-container::-webkit-scrollbar-track { background: #f3f4f6; }
        #steps-container::-webkit-scrollbar-thumb { background: #10b981; border-radius: 3px; }
        
        /* SVG Styles */
        .shape-svg {
            max-height: 180px;
            max-width: 100%;
            filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.25));
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        .shape-path { fill: #d6d3d1; stroke: #fff; stroke-width: 1.5; } 
        .shape-garden { fill: #4ade80; stroke: #fff; stroke-width: 1.5; } 
        .shape-house { fill: #fde047; stroke: #fff; stroke-width: 1.5; } 
        .shape-window { fill: #60a5fa; stroke: #fff; stroke-width: 1; }
        .shape-water { fill: #3b82f6; stroke: #fff; stroke-width: 1.5; }
        .shape-brick { fill: #f87171; stroke: #fff; stroke-width: 1; }
        .dim-text { fill: white; font-size: 11px; font-family: monospace; font-weight: bold; text-shadow: 1px 1px 2px black; }

        /* Loading */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0fdf4;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #bbf7d0;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        window.MathJax = {
            startup: {
                pageReady: () => {
                    if (window.nextQuestion) window.nextQuestion();
                    return MathJax.startup.defaultPageReady().then(() => {
                        const overlay = document.getElementById('loading-overlay');
                        if (overlay) { overlay.style.opacity = '0'; setTimeout(() => overlay.remove(), 500); }
                    });
                }
            }
        };
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay && document.body.contains(overlay)) {
                if (window.nextQuestion) window.nextQuestion();
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 500);
            }
        }, 3000);
    </script>
    <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <div class="text-emerald-800 font-bold text-lg animate-pulse text-center px-4">
            ƒêang kh·ªüi t·∫°o c√°c b√†i to√°n th√°ch th·ª©c...
        </div>
    </div>

    <div class="max-w-7xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-emerald-600">
        <!-- Header -->
        <div class="bg-emerald-700 p-4 text-center relative shadow-lg">
            <h1 class="text-xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-calculator mr-2"></i>√în t·∫≠p To√°n 6 Th·ª±c T·∫ø (Advanced)
            </h1>
            <p class="text-emerald-100 font-medium text-xs md:text-sm mt-1">Ch·ªß ƒë·ªÅ: B√†i to√°n ng∆∞·ª£c ƒëa b∆∞·ªõc (Chi ph√≠ &rarr; Di·ªán t√≠ch)</p>
        </div>

        <div class="p-3 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-emerald-50 rounded-xl shadow-inner p-2 md:p-3 grid grid-cols-4 gap-2 text-center select-none border border-emerald-100" id="stats-container">
                <div class="flex flex-col items-center">
                    <span class="text-[10px] md:text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-xl md:text-3xl font-extrabold text-orange-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-emerald-200">
                    <span class="text-[10px] md:text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-lg md:text-2xl font-bold text-emerald-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-emerald-200">
                    <span class="text-[10px] md:text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-lg md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-emerald-200">
                    <span class="text-[10px] md:text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-lg md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 md:gap-6">
                
                <!-- Left Column: Chalkboard & Inputs (3/5 width) -->
                <div class="lg:col-span-3 flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-4 min-h-[300px]">
                        <div class="w-full flex justify-center mt-2 mb-2" id="svg-container">
                            <!-- SVG will be injected here -->
                        </div>
                        <div id="problem-text" class="font-serif text-lg md:text-xl w-full text-center leading-relaxed px-2 pb-4 mt-auto">
                            ƒêang t·∫£i ƒë·ªÅ b√†i...
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white p-4 md:p-6 rounded-xl border-2 border-emerald-100 shadow-lg relative">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-emerald-800 font-bold text-xs uppercase mb-1">D·∫°ng b√†i:</label>
                                <select id="problem-type" class="w-full p-2 text-sm font-bold text-gray-700 bg-emerald-50 border border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition-colors cursor-pointer" onchange="nextQuestion()">
                                    <option value="mix">üé≤ T·ªïng h·ª£p c√°c d·∫°ng</option>
                                    <option value="path">üöß L·ªëi ƒëi (B√†i to√°n ng∆∞·ª£c S)</option>
                                    <option value="rect_square">üß± H√¨nh Vu√¥ng/HCN (Li√™n ho√†n)</option>
                                    <option value="rhombus_para">üåæ N√¥ng nghi·ªáp & L·ª£i nhu·∫≠n</option>
                                    <option value="trapezoid">üèûÔ∏è ƒê√†o ao & Th·ªÉ t√≠ch</option>
                                    <option value="paint">üñåÔ∏è S∆°n t∆∞·ªùng & Th√πng s∆°n</option>
                                </select>
                            </div>
                            <div class="flex items-end justify-between pb-1">
                                <label class="inline-flex items-center cursor-pointer select-none bg-red-50 px-3 py-2 rounded-lg w-full justify-between border border-red-100 hover:bg-red-100 transition">
                                    <span class="text-sm font-bold text-red-800 mr-2 flex flex-col leading-tight">
                                        <span><i class="fas fa-brain text-red-600 mr-1"></i>Ch·∫ø ƒë·ªô SI√äU KH√ì</span>
                                        <span class="text-[10px] text-red-500 font-normal">8-10 b∆∞·ªõc (Tr·ª´ chi ph√≠ ph·ª•)</span>
                                    </span>
                                    <div class="relative">
                                        <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                        <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-gray-600 font-bold text-sm uppercase mb-2 text-center">Nh·∫≠p ƒë√°p √°n (S·ªë t·ª± nhi√™n):</label>
                            <div class="relative max-w-sm mx-auto group">
                                <input type="text" id="user-ans" placeholder="..." 
                                    class="w-full text-center font-bold text-2xl md:text-3xl p-3 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 focus:outline-none transition-all"
                                    onkeydown="if(event.key === 'Enter') checkAnswer()">
                                <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold text-sm pointer-events-none" id="unit-label"></div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-random"></i> B√†i kh√°c
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-lg">
                                <i class="fas fa-check-circle"></i> Ki·ªÉm tra
                            </button>
                        </div>
                        <div id="feedback" class="hidden mt-4 text-center p-4 rounded-lg text-sm font-bold animate-pulse"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="lg:col-span-2 flex flex-col h-[400px] md:h-[600px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide"><i class="fas fa-file-signature text-emerald-600 mr-1"></i>Ph√¢n t√≠ch & L·ªùi gi·∫£i</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="step-counter" class="text-xs font-bold text-gray-500 bg-gray-200 px-2 py-1 rounded">0/0</span>
                            <button onclick="showNextStep()" id="btn-show-step" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span>Ti·∫øp</span> <i class="fas fa-chevron-right text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-xs p-2 rounded-lg border-l-4 border-yellow-400 shadow-sm shrink-0">
                        <i class="fas fa-lightbulb mr-1 text-yellow-600"></i> <span id="rule-content" class="font-medium"></span>
                    </div>
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth space-y-3">
                        <div class="text-gray-400 italic text-sm text-center mt-20 flex flex-col items-center select-none">
                            <i class="fas fa-pencil-alt text-4xl mb-3 opacity-20"></i>
                            <span>B·∫•m "Ki·ªÉm tra" ho·∫∑c "Ti·∫øp" ƒë·ªÉ xem l·ªùi gi·∫£i.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>
    <script>
        const formatMoney = (n) => {
            if (isNaN(n)) return "0";
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        const state = { streak: 0, correct: 0, wrong: 0, skipped: 0 };
        let currentData = { answer: 0, steps: [], unit: "", svg: "" };
        let isAnswered = false;
        let stepIndex = 0;
        let usedHint = false;

        // --- SVG HELPER FUNCTIONS ---
        function createSVG(width, height, content) {
            return `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" class="shape-svg"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="white" /></marker></defs>${content}</svg>`;
        }
        function rect(x, y, w, h, cls) { return `<rect x="${x}" y="${y}" width="${w}" height="${h}" class="${cls}" />`; }
        function poly(points, cls) { return `<polygon points="${points}" class="${cls}" />`; }
        function text(x, y, txt) { return `<text x="${x}" y="${y}" class="dim-text" text-anchor="middle" dominant-baseline="middle">${txt}</text>`; }
        
        // --- VISUALIZATION LOGIC ---
        function getVisualization(type, params) {
            const w_box = 300, h_box = 180;
            const cx = w_box/2, cy = h_box/2;
            let svgContent = '';

            if (type === 'rect_square') {
                const aspect = params.l / params.w;
                let drawW = 140 * (aspect >= 1 ? 1 : aspect);
                let drawH = 140 * (aspect >= 1 ? 1/aspect : 1);
                svgContent = rect(cx - drawW/2, cy - drawH/2, drawW, drawH, 'shape-brick') + 
                             text(cx, cy - drawH/2 - 10, `${params.l}m`) + 
                             text(cx + drawW/2 + 15, cy, `${params.w}m`);
            } 
            else if (type === 'rhombus') {
                let dx = 80, dy = 50; 
                svgContent = poly(`${cx},${cy-dy} ${cx+dx},${cy} ${cx},${cy+dy} ${cx-dx},${cy}`, 'shape-garden') +
                             `<line x1="${cx}" y1="${cy-dy}" x2="${cx}" y2="${cy+dy}" stroke="white" stroke-dasharray="4" />` +
                             `<line x1="${cx-dx}" y1="${cy}" x2="${cx+dx}" y2="${cy}" stroke="white" stroke-dasharray="4" />` +
                             text(cx+40, cy-10, `d1=${params.d1}`) + text(cx-10, cy+30, `d2=${params.d2}`);
            }
            else if (type === 'para') {
                let w = 120, h = 80, s = 30;
                svgContent = poly(`${cx-w/2+s},${cy-h/2} ${cx+w/2+s},${cy-h/2} ${cx+w/2-s},${cy+h/2} ${cx-w/2-s},${cy+h/2}`, 'shape-garden') +
                             `<line x1="${cx-w/2-s}" y1="${cy-h/2}" x2="${cx-w/2-s}" y2="${cy+h/2}" stroke="white" stroke-dasharray="4" />` +
                             text(cx, cy+h/2+15, `ƒê√°y ${params.b}m`) + text(cx-w/2-s-10, cy, `Cao ${params.h}m`);
            }
            else if (type === 'trapezoid') {
                let wb = 140, wa = 80, h = 80;
                svgContent = poly(`${cx-wa/2},${cy-h/2} ${cx+wa/2},${cy-h/2} ${cx+wb/2},${cy+h/2} ${cx-wb/2},${cy+h/2}`, 'shape-garden') +
                             `<line x1="${cx}" y1="${cy-h/2}" x2="${cx}" y2="${cy+h/2}" stroke="white" stroke-dasharray="4" />` +
                             text(cx, cy-h/2-10, `ƒê√°y b√© ${params.a}`) + text(cx, cy+h/2+15, `ƒê√°y l·ªõn ${params.b}`) + text(cx+5, cy, `h=${params.h}`);
            }
            else if (type === 'paint') {
                let w = 160, h = 100;
                let ww = 40, wh = 40;
                svgContent = rect(cx-w/2, cy-h/2, w, h, 'shape-house') + 
                             rect(cx-ww/2, cy-h/2+20, ww, wh, 'shape-window') +
                             text(cx, cy+h/2+15, `T∆∞·ªùng ${params.w}m`) + text(cx-w/2-15, cy, `${params.h}m`) +
                             text(cx, cy-h/2+40, `C·ª≠a s·ªï`);
            }
            else if (type === 'path') {
                let w = 180, h = 120;
                let pw = 20; 
                let x = cx - w/2, y = cy - h/2;
                if (params.subtype === 1) { // 1 Side
                    svgContent = rect(x, y, w, h, 'shape-garden') + rect(x + w - pw, y, pw, h, 'shape-path') +
                                 text(cx, cy, "S√¢n") + text(x + w - pw/2, cy, "L·ªëi ƒëi");
                } else if (params.subtype === 2) { // L-Shape
                    svgContent = rect(x, y, w, h, 'shape-garden') + 
                                 `<path d="M${x+w},${y} V${y+h} H${x} v${-pw} H${x+w-pw} V${y} z" class="shape-path" />` +
                                 text(cx-10, cy-10, "S√¢n");
                } else if (params.subtype === 3) { // 2 Opposite
                    svgContent = rect(x, y, w, h, 'shape-garden') + 
                                 rect(x, y, pw, h, 'shape-path') + rect(x+w-pw, y, pw, h, 'shape-path') +
                                 text(cx, cy, "S√¢n");
                } else if (params.subtype === 4) { // U-Shape
                    svgContent = rect(x, y, w, h, 'shape-garden') +
                                 `<path d="M${x},${y} H${x+w} V${y+h} H${x} v${-pw} H${x+w-pw} V${y+pw} H${x} z" class="shape-path" />` +
                                 text(cx+10, cy, "S√¢n");
                } else if (params.subtype === 5) { // O-Shape
                    svgContent = rect(x, y, w, h, 'shape-path') + rect(x+pw, y+pw, w-2*pw, h-2*pw, 'shape-water') +
                                 text(cx, cy, "H·ªì/V∆∞·ªùn");
                }
            }
            return createSVG(w_box, h_box, svgContent);
        }

        // --- GENERATORS ---
        function generateProblem() {
            const isHard = document.getElementById('mode-hard').checked;
            let type = document.getElementById('problem-type').value;

            if (type === 'mix') {
                const types = ['rect_square', 'rhombus_para', 'trapezoid', 'paint', 'path'];
                type = types[getRandomInt(0, types.length - 1)];
            }

            if (type === 'path') return generateProblem_Path(isHard);
            if (type === 'rect_square') return generateProblem_RectSquare(isHard);
            if (type === 'rhombus_para') return generateProblem_RhombusPara(isHard);
            if (type === 'trapezoid') return generateProblem_Trapezoid(isHard);
            if (type === 'paint') return generateProblem_Paint(isHard);
            
            return generateProblem_RectSquare(isHard);
        }

        // --- 1. PATHWAY (L·ªêI ƒêI - TI·ªÄN & DI·ªÜN T√çCH) ---
        function generateProblem_Path(isHard) {
            const subtype = getRandomInt(1, 5);
            // Ensure integer divisions
            const path = getRandomInt(1, 3);
            const W_in = getRandomInt(8, 15);
            const H_in = getRandomInt(8, 15);
            let W_out, H_out, shapeName = "";

            switch(subtype) {
                case 1: W_out = W_in + path; H_out = H_in; shapeName = "m·ªôt c·∫°nh (theo chi·ªÅu d·ªçc)"; break;
                case 2: W_out = W_in + path; H_out = H_in + path; shapeName = "hai c·∫°nh k·ªÅ nhau (g√≥c)"; break;
                case 3: W_out = W_in + 2*path; H_out = H_in; shapeName = "hai c·∫°nh ƒë·ªëi di·ªán (d·ªçc)"; break;
                case 4: W_out = W_in + 2*path; H_out = H_in + path; shapeName = "ba c·∫°nh (h√¨nh ch·ªØ U, d·ªçc-ngang-d·ªçc)"; break;
                case 5: W_out = W_in + 2*path; H_out = H_in + 2*path; shapeName = "xung quanh (bao b·ªën ph√≠a)"; break;
            }
            
            const S_in = W_in * H_in;
            const S_out = W_out * H_out;
            const S_path = S_out - S_in;
            const svgData = { subtype: subtype, w: W_out, h: H_out, p: path };

            // Material Costs
            const tileSideCm = 50; 
            const tileAreaCm2 = 2500; 
            const tilesNeeded = (S_path * 10000) / tileAreaCm2; 
            const tilePrice = 25000; 
            const materialCost = tilesNeeded * tilePrice;
            const laborCost = getRandomInt(5, 10) * 100000; // Fixed labor
            const transportCost = getRandomInt(2, 5) * 50000; // Transport
            const lunchCost = 150000; // Lunch for workers
            const totalCost = materialCost + laborCost + transportCost + lunchCost;

            if (!isHard) {
                return {
                    question: `V∆∞·ªùn HCN ${W_out}m x ${H_out}m. L√†m l·ªëi ƒëi r·ªông ${path}m d·ªçc theo ${shapeName}. L√°t g·∫°ch vu√¥ng 50cm (gi√° ${formatMoney(tilePrice)}ƒë/vi√™n). Ti·ªÅn c√¥ng th·ª£ l√† ${formatMoney(laborCost)}ƒë. T√≠nh t·ªïng chi ph√≠?`,
                    answer: totalCost, unit: "ƒë·ªìng", svg: getVisualization('path', svgData),
                    steps: [
                        {type:'header', text:'B∆∞·ªõc 1: T√≠nh di·ªán t√≠ch l·ªëi ƒëi'},
                        {type:'step', text:`S t·ªïng: ${W_out} . ${H_out} = ${S_out} (m¬≤)`},
                        {type:'step', text:`S ph·∫ßn trong: ${W_in} . ${H_in} = ${S_in} (m¬≤)`},
                        {type:'step', text:`S l·ªëi ƒëi: ${S_out} - ${S_in} = ${S_path} (m¬≤)`},
                        {type:'header', text:'B∆∞·ªõc 2: T√≠nh v·∫≠t t∆∞'},
                        {type:'step', text:`ƒê·ªïi: ${S_path} m¬≤ = ${formatMoney(S_path * 10000)} cm¬≤`},
                        {type:'step', text:`S 1 vi√™n: 50 . 50 = ${tileAreaCm2} (cm¬≤)`},
                        {type:'step', text:`S·ªë vi√™n: ${formatMoney(S_path * 10000)} : ${tileAreaCm2} = ${tilesNeeded} (vi√™n)`},
                        {type:'header', text:'B∆∞·ªõc 3: T√≠nh t·ªïng ti·ªÅn'},
                        {type:'step', text:`Ti·ªÅn g·∫°ch: ${tilesNeeded} . ${formatMoney(tilePrice)} = ${formatMoney(materialCost)} (ƒë)`},
                        {type:'step', text:`T·ªïng c·ªông: ${formatMoney(materialCost)} + ${formatMoney(laborCost)} = ${formatMoney(totalCost-transportCost-lunchCost)}... (B√†i n√†y ƒë∆°n gi·∫£n h√≥a)`},
                        {type:'step', text:`(·ªû ch·∫ø ƒë·ªô th∆∞·ªùng ta b·ªè qua ph·ª• ph√≠ v·∫≠n chuy·ªÉn/c∆°m tr∆∞a)`, isLast:true}
                    ]
                };
            } else {
                // HARD MODE: 8-10 STEPS - TARGETING AREA S_in (NOT dimensions)
                // Given Total Cost, labor, extras -> Find Area S_in
                return {
                    question: `Ng∆∞·ªùi ta l√†m l·ªëi ƒëi r·ªông ${path}m d·ªçc theo ${shapeName} c·ªßa m·ªôt m·∫£nh ƒë·∫•t h√¨nh ch·ªØ nh·∫≠t ${W_out}m x ${H_out}m. T·ªïng chi ph√≠ ho√†n thi·ªán l√† ${formatMoney(totalCost)}ƒë. Trong ƒë√≥ bao g·ªìm: ti·ªÅn c√¥ng th·ª£ ${formatMoney(laborCost)}ƒë, ti·ªÅn v·∫≠n chuy·ªÉn v·∫≠t li·ªáu ${formatMoney(transportCost)}ƒë, ti·ªÅn c∆°m tr∆∞a cho th·ª£ ${formatMoney(lunchCost)}ƒë, c√≤n l·∫°i l√† ti·ªÅn mua g·∫°ch l√°t. Bi·∫øt g·∫°ch l√°t h√¨nh vu√¥ng 50cm c√≥ gi√° ${formatMoney(tilePrice)}ƒë/vi√™n. H√£y t√≠nh di·ªán t√≠ch ph·∫ßn ƒë·∫•t c√≤n l·∫°i (s√¢n trong) ƒë·ªÉ tr·ªìng c√¢y?`,
                    answer: S_in, unit: "m¬≤", svg: getVisualization('path', svgData),
                    steps: [
                        {type:'header', text:'Giai ƒëo·∫°n 1: B√≥c t√°ch chi ph√≠ g·∫°ch'},
                        {type:'step', text:`1. T·ªïng ph·ª• ph√≠ (c√¥ng + v·∫≠n chuy·ªÉn + c∆°m) =`},
                        {type:'step', text:`   ${formatMoney(laborCost)} + ${formatMoney(transportCost)} + ${formatMoney(lunchCost)} = ${formatMoney(laborCost+transportCost+lunchCost)} (ƒë)`},
                        {type:'step', text:`2. Ti·ªÅn mua g·∫°ch = T·ªïng chi ph√≠ - Ph·ª• ph√≠`},
                        {type:'step', text:`   = ${formatMoney(totalCost)} - ${formatMoney(laborCost+transportCost+lunchCost)} = ${formatMoney(materialCost)} (ƒë)`},
                        {type:'header', text:'Giai ƒëo·∫°n 2: T√≠nh s·ªë l∆∞·ª£ng g·∫°ch'},
                        {type:'step', text:`3. S·ªë vi√™n g·∫°ch = Ti·ªÅn g·∫°ch : Gi√° 1 vi√™n`},
                        {type:'step', text:`   = ${formatMoney(materialCost)} : ${formatMoney(tilePrice)} = ${tilesNeeded} (vi√™n)`},
                        {type:'header', text:'Giai ƒëo·∫°n 3: T√≠nh di·ªán t√≠ch l·ªëi ƒëi'},
                        {type:'step', text:`4. Di·ªán t√≠ch 1 vi√™n g·∫°ch (cm¬≤) = 50 . 50 = ${tileAreaCm2} (cm¬≤)`},
                        {type:'step', text:`5. Di·ªán t√≠ch l·ªëi ƒëi (cm¬≤) = S·ªë vi√™n . S_1_vi√™n`},
                        {type:'step', text:`   = ${tilesNeeded} . ${tileAreaCm2} = ${formatMoney(S_path*10000)} (cm¬≤)`},
                        {type:'step', text:`6. ƒê·ªïi sang m¬≤: ${S_path} (m¬≤)`},
                        {type:'header', text:'Giai ƒëo·∫°n 4: T√≠nh di·ªán t√≠ch s√¢n trong'},
                        {type:'step', text:`7. Di·ªán t√≠ch to√†n b·ªô m·∫£nh ƒë·∫•t = D√†i . R·ªông`},
                        {type:'step', text:`   = ${W_out} . ${H_out} = ${S_out} (m¬≤)`},
                        {type:'step', text:`8. Di·ªán t√≠ch s√¢n trong = S_to√†n_b·ªô - S_l·ªëi_ƒëi`},
                        {type:'step', text:`   = ${S_out} - ${S_path} = ${S_in} (m¬≤)`, isLast:true}
                    ]
                };
            }
        }

        // --- 2. RECT/SQUARE (LI√äN HO√ÄN CHU VI <-> DI·ªÜN T√çCH) ---
        function generateProblem_RectSquare(isHard) {
            const subType = Math.random() < 0.5 ? 'square' : 'rect'; 
            let L, W, P, S, svg;

            if (subType === 'square') {
                const side = getRandomInt(6, 12) * 2; 
                L = W = side; P = side*4; S = side*side;
                svg = getVisualization('rect_square', {l: side, w: side});
            } else {
                W = getRandomInt(4, 8) * 2; 
                L = W + getRandomInt(2, 6) * 2; 
                P = (L+W)*2; S = L*W;
                svg = getVisualization('rect_square', {l: L, w: W});
            }

            if (!isHard) {
                // Keep normal mode simple
                const wallHeight = 2; 
                const bricksPerM2 = 60; 
                const brickPrice = 1500;
                const S_wall = P * wallHeight;
                const totalBricks = S_wall * bricksPerM2;
                const totalCost = totalBricks * brickPrice;
                return {
                    question: `X√¢y t∆∞·ªùng cao ${wallHeight}m bao quanh khu ƒë·∫•t ${subType==='square'?`HV c·∫°nh ${L}m`:`HCN ${L}m x ${W}m`}. Trung b√¨nh 1m¬≤ t∆∞·ªùng c·∫ßn ${bricksPerM2} vi√™n g·∫°ch (gi√° ${formatMoney(brickPrice)}ƒë/vi√™n). T√≠nh ti·ªÅn g·∫°ch?`,
                    answer: totalCost, unit: "ƒë·ªìng", svg: svg,
                    steps: [
                        {type:'step', text:`Chu vi: ${P} (m)`},
                        {type:'step', text:`S t∆∞·ªùng: ${P} . ${wallHeight} = ${S_wall} (m¬≤)`},
                        {type:'step', text:`S·ªë g·∫°ch: ${S_wall} . ${bricksPerM2} = ${totalBricks} (vi√™n)`},
                        {type:'step', text:`Ti·ªÅn g·∫°ch: ${totalBricks} . ${formatMoney(brickPrice)} = ${formatMoney(totalCost)} (ƒë·ªìng)`, isLast:true}
                    ]
                };
            } else {
                // HARD MODE: CROSS CALCULATION (S <-> P)
                const fencePrice = 50000; // per m (Cost related to Perimeter)
                const pavePrice = 200000; // per m2 (Cost related to Area)
                
                // Scenario 1: Given Fence Cost -> Find Pave Cost
                // Logic: Cost Fence -> Perimeter -> Side -> Area -> Cost Pave
                const totalFence = P * fencePrice;
                const totalPave = S * pavePrice;

                // Scenario 2: Given Pave Cost -> Find Fence Cost
                // Logic: Cost Pave -> Area -> Side -> Perimeter -> Cost Fence
                
                const type = getRandomInt(1, 2);

                if (type === 1) { // Fence -> Pave
                    return {
                        question: `ƒê·ªÉ r√†o bao quanh m·ªôt khu ƒë·∫•t ${subType==='square'?'h√¨nh vu√¥ng':'HCN'} t·ªën h·∫øt ${formatMoney(totalFence)}ƒë ti·ªÅn d√¢y th√©p (gi√° ${formatMoney(fencePrice)}ƒë/m chi·ªÅu d√†i r√†o). ${subType==='rect'?`Bi·∫øt chi·ªÅu r·ªông khu ƒë·∫•t l√† ${W}m.`:''} H·ªèi n·∫øu mu·ªën l√°t g·∫°ch k√≠n khu ƒë·∫•t ƒë√≥ th√¨ t·ªën bao nhi√™u ti·ªÅn (bi·∫øt gi√° l√°t ${formatMoney(pavePrice)}ƒë/m¬≤)?`,
                        answer: totalPave, unit: "ƒë·ªìng", svg: svg,
                        steps: [
                            {type:'header', text:'Giai ƒëo·∫°n 1: T√≠nh Chu vi t·ª´ Ti·ªÅn r√†o'},
                            {type:'step', text:`1. Chu vi khu ƒë·∫•t = T·ªïng ti·ªÅn r√†o : Gi√° 1m`},
                            {type:'step', text:`   = ${formatMoney(totalFence)} : ${formatMoney(fencePrice)} = ${P} (m)`},
                            {type:'header', text:'Giai ƒëo·∫°n 2: T√≠nh C·∫°nh t·ª´ Chu vi'},
                            {type:'step', text: subType==='square' ? `2. C·∫°nh h√¨nh vu√¥ng = Chu vi : 4` : `2. N·ª≠a chu vi = Chu vi : 2 = ${P/2} (m)`},
                            {type:'step', text: subType==='square' ? `   = ${P} : 4 = ${L} (m)` : `3. Chi·ªÅu d√†i = N·ª≠a CV - R·ªông = ${P/2} - ${W} = ${L} (m)`},
                            {type:'header', text:'Giai ƒëo·∫°n 3: T√≠nh Di·ªán t√≠ch'},
                            {type:'step', text:`${subType==='square'?'3':'4'}. Di·ªán t√≠ch = D√†i . R·ªông`},
                            {type:'step', text:`   = ${L} . ${W} = ${S} (m¬≤)`},
                            {type:'header', text:'Giai ƒëo·∫°n 4: T√≠nh Ti·ªÅn l√°t'},
                            {type:'step', text:`${subType==='square'?'4':'5'}. Ti·ªÅn l√°t = Di·ªán t√≠ch . Gi√° l√°t`},
                            {type:'step', text:`   = ${S} . ${formatMoney(pavePrice)} = ${formatMoney(totalPave)} (ƒë)`, isLast:true}
                        ]
                    };
                } else { // Pave -> Fence
                    return {
                        question: `Chi ph√≠ l√°t n·ªÅn m·ªôt s√¢n ${subType==='square'?'h√¨nh vu√¥ng':'HCN'} h·∫øt ${formatMoney(totalPave)}ƒë (ƒë∆°n gi√° ${formatMoney(pavePrice)}ƒë/m¬≤). ${subType==='rect'?`Bi·∫øt chi·ªÅu r·ªông s√¢n l√† ${W}m.`:''} Nay b√°c ch·ªß mu·ªën r√†o l·∫°i xung quanh s√¢n. T√≠nh chi ph√≠ l√†m r√†o bi·∫øt gi√° r√†o l√† ${formatMoney(fencePrice)}ƒë/m?`,
                        answer: totalFence, unit: "ƒë·ªìng", svg: svg,
                        steps: [
                            {type:'header', text:'Giai ƒëo·∫°n 1: T√≠nh Di·ªán t√≠ch t·ª´ Ti·ªÅn l√°t'},
                            {type:'step', text:`1. Di·ªán t√≠ch s√¢n = T·ªïng ti·ªÅn l√°t : Gi√° l√°t`},
                            {type:'step', text:`   = ${formatMoney(totalPave)} : ${formatMoney(pavePrice)} = ${S} (m¬≤)`},
                            {type:'header', text:'Giai ƒëo·∫°n 2: T√≠nh C·∫°nh t·ª´ Di·ªán t√≠ch'},
                            {type:'step', text: subType==='square' ? `2. T√¨m c·∫°nh HV: V√¨ ${L} . ${L} = ${S} n√™n c·∫°nh = ${L} (m)` : `2. Chi·ªÅu d√†i = Di·ªán t√≠ch : R·ªông = ${S} : ${W} = ${L} (m)`},
                            {type:'header', text:'Giai ƒëo·∫°n 3: T√≠nh Chu vi'},
                            {type:'step', text:`3. Chu vi = (D√†i + R·ªông) . 2`},
                            {type:'step', text:`   = (${L} + ${W}) . 2 = ${P} (m)`},
                            {type:'header', text:'Giai ƒëo·∫°n 4: T√≠nh Ti·ªÅn r√†o'},
                            {type:'step', text:`4. Ti·ªÅn r√†o = Chu vi . Gi√° r√†o`},
                            {type:'step', text:`   = ${P} . ${formatMoney(fencePrice)} = ${formatMoney(totalFence)} (ƒë)`, isLast:true}
                        ]
                    };
                }
            }
        }

        // --- 3. RHOMBUS/PARA (N√îNG NGHI·ªÜP) ---
        function generateProblem_RhombusPara(isHard) {
            const isRhombus = Math.random() < 0.5;
            let S, svg, qText, missingVal;
            
            if (isRhombus) {
                const d1 = getRandomInt(10, 20) * 2;
                const d2 = getRandomInt(10, 20) * 2;
                S = (d1*d2)/2;
                svg = getVisualization('rhombus', {d1: d1, d2: isHard ? "?" : d2});
                qText = `Ru·ªông hoa h√¨nh thoi (d1=${d1}m${isHard ? "" : `, d2=${d2}m`})`;
                missingVal = d2;
            } else {
                const b = getRandomInt(20, 30); 
                const h = getRandomInt(10, 20);
                S = b*h;
                svg = getVisualization('para', {b: b, h: isHard ? "?" : h});
                qText = `Ru·ªông ng√¥ HBH (ƒë√°y ${b}m${isHard ? "" : `, cao ${h}m`})`;
                missingVal = h;
            }

            if (S % 10 !== 0) S = Math.round(S/10)*10; // Ensure div 10

            const unitArea = 10; 
            const yieldPerUnit = getRandomInt(5, 8); 
            const pricePerKg = 15000; 
            const seedCost = 500000; 
            const fertilizerCost = 300000;
            const otherCost = 200000;
            
            const totalYield = (S / unitArea) * yieldPerUnit;
            const revenue = totalYield * pricePerKg;
            const totalCost = seedCost + fertilizerCost + otherCost;
            const profit = revenue - totalCost;

            if(!isHard) {
                return {
                    question: `${qText}. C·ª© ${unitArea}m¬≤ thu ho·∫°ch ƒë∆∞·ª£c ${yieldPerUnit}kg. Gi√° b√°n ${formatMoney(pricePerKg)}ƒë/kg. Chi ph√≠: Gi·ªëng ${formatMoney(seedCost)}ƒë, Ph√¢n b√≥n ${formatMoney(fertilizerCost)}ƒë, Kh√°c ${formatMoney(otherCost)}ƒë. T√≠nh l·ª£i nhu·∫≠n?`,
                    answer: profit, unit: "ƒë·ªìng", svg: svg,
                    steps: [
                        {type:'header', text:'B∆∞·ªõc 1: T√≠nh di·ªán t√≠ch & S·∫£n l∆∞·ª£ng'},
                        {type:'step', text:`Di·ªán t√≠ch: ${S} (m¬≤)`},
                        {type:'step', text:`T·ªïng thu ho·∫°ch: (${S} : ${unitArea}) . ${yieldPerUnit} = ${totalYield} (kg)`},
                        {type:'header', text:'B∆∞·ªõc 2: T√≠nh doanh thu & Chi ph√≠'},
                        {type:'step', text:`Doanh thu: ${totalYield} . ${formatMoney(pricePerKg)} = ${formatMoney(revenue)} (ƒë)`},
                        {type:'step', text:`T·ªïng chi ph√≠: ${formatMoney(seedCost)} + ... = ${formatMoney(totalCost)} (ƒë)`},
                        {type:'header', text:'B∆∞·ªõc 3: T√≠nh l·ª£i nhu·∫≠n'},
                        {type:'step', text:`L√£i: ${formatMoney(revenue)} - ${formatMoney(totalCost)} = ${formatMoney(profit)} (ƒë)`, isLast:true}
                    ]
                };
            } else {
                // HARD MODE: 9 Steps Reverse
                return {
                    question: `B√°c Ba tr·ªìng v·ª• m√πa tr√™n th·ª≠a ru·ªông ${isRhombus?'h√¨nh thoi':'HBH'}. Sau khi tr·ª´ t·ªïng chi ph√≠ ${formatMoney(totalCost)}ƒë (gi·ªëng, ph√¢n, c√¥ng), b√°c l√£i ƒë∆∞·ª£c ${formatMoney(profit)}ƒë. Bi·∫øt gi√° n√¥ng s·∫£n l√† ${formatMoney(pricePerKg)}ƒë/kg. NƒÉng su·∫•t: ${unitArea}m¬≤ ƒë∆∞·ª£c ${yieldPerUnit}kg. Bi·∫øt ${isRhombus?`ƒë∆∞·ªùng ch√©o d1=${d1}m`:`c·∫°nh ƒë√°y=${b}m`}. T√≠nh ${isRhombus?'ƒë∆∞·ªùng ch√©o c√≤n l·∫°i':'chi·ªÅu cao'}?`,
                    answer: missingVal, unit: "m", svg: svg,
                    steps: [
                        {type:'header', text:'Giai ƒëo·∫°n 1: T√≠nh doanh thu'},
                        {type:'step', text:`1. Doanh thu = L·ª£i nhu·∫≠n + Chi ph√≠`},
                        {type:'step', text:`   = ${formatMoney(profit)} + ${formatMoney(totalCost)} = ${formatMoney(revenue)} (ƒë)`},
                        {type:'header', text:'Giai ƒëo·∫°n 2: T√≠nh s·∫£n l∆∞·ª£ng'},
                        {type:'step', text:`2. T·ªïng s·ªë kg = Doanh thu : Gi√° b√°n`},
                        {type:'step', text:`   = ${formatMoney(revenue)} : ${formatMoney(pricePerKg)} = ${totalYield} (kg)`},
                        {type:'header', text:'Giai ƒëo·∫°n 3: T√≠nh di·ªán t√≠ch'},
                        {type:'step', text:`3. S·ªë kho·∫£nh ${unitArea}m¬≤ = T·ªïng kg : NƒÉng su·∫•t ƒë∆°n v·ªã`},
                        {type:'step', text:`   = ${totalYield} : ${yieldPerUnit} = ${S/unitArea} (kho·∫£nh)`},
                        {type:'step', text:`4. Di·ªán t√≠ch ru·ªông = S·ªë kho·∫£nh . ${unitArea}`},
                        {type:'step', text:`   = ${S/unitArea} . ${unitArea} = ${S} (m¬≤)`},
                        {type:'header', text:'Giai ƒëo·∫°n 4: T√≠nh k√≠ch th∆∞·ªõc'},
                        {type:'step', text: isRhombus ? `5. T√≠ch 2 ch√©o = Di·ªán t√≠ch . 2 = ${S*2}` : `5. Chi·ªÅu cao = Di·ªán t√≠ch : ƒê√°y`},
                        {type:'step', text: isRhombus ? `6. ƒê∆∞·ªùng ch√©o d2 = T√≠ch : d1 = ${S*2} : ${d1} = ${missingVal} (m)` : `   = ${S} : ${b} = ${missingVal} (m)`, isLast:true}
                    ]
                };
            }
        }

        // --- 4. TRAPEZOID (AO H·ªí) ---
        function generateProblem_Trapezoid(isHard) {
            let a = getRandomInt(10, 20); 
            let b = getRandomInt(20, 30); 
            if ((a+b)%2 !== 0) b++; 
            let h = getRandomInt(10, 20);
            
            const S = (a+b)*h/2; 
            const svg = getVisualization('trapezoid', {a:a, b:b, h:h});
            
            const depth = 2; 
            const priceExcavate = 30000; // per m3
            const transportPrice = 20000; // per m3
            const volume = S * depth;
            const costExcavate = volume * priceExcavate;
            const costTransport = volume * transportPrice;
            const totalCost = costExcavate + costTransport;

            if (!isHard) {
                return {
                    question: `ƒê√†o ao h√¨nh thang (ƒë√°y ${a}m, ${b}m, cao ${h}m), s√¢u ${depth}m. C√¥ng ƒë√†o ${formatMoney(priceExcavate)}ƒë/m¬≥, c√¥ng v·∫≠n chuy·ªÉn ƒë·∫•t ${formatMoney(transportPrice)}ƒë/m¬≥. T√≠nh t·ªïng chi ph√≠?`,
                    answer: totalCost, unit: "ƒë·ªìng", svg: svg,
                    steps: [
                        {type:'step', text:`S m·∫∑t ao: (${a}+${b}).${h}:2 = ${S} m¬≤`},
                        {type:'step', text:`Th·ªÉ t√≠ch ƒë·∫•t: ${S}.${depth} = ${volume} m¬≥`},
                        {type:'step', text:`Ti·ªÅn ƒë√†o: ${volume}.${formatMoney(priceExcavate)} = ${formatMoney(costExcavate)} ƒë`},
                        {type:'step', text:`Ti·ªÅn v·∫≠n chuy·ªÉn: ${volume}.${formatMoney(transportPrice)} = ${formatMoney(costTransport)} ƒë`},
                        {type:'step', text:`T·ªïng: ${formatMoney(totalCost)} ƒë`, isLast:true}
                    ]
                };
            } else {
                return {
                    question: `D·ª± √°n ƒë√†o ao h√¨nh thang (ƒë√°y l·ªõn ${b}m, cao ${h}m) s√¢u ${depth}m t·ªën t·ªïng c·ªông ${formatMoney(totalCost)}ƒë. Bi·∫øt chi ph√≠ ƒë√†o l√† ${formatMoney(priceExcavate)}ƒë/m¬≥, v·∫≠n chuy·ªÉn l√† ${formatMoney(transportPrice)}ƒë/m¬≥. T√≠nh ƒë·ªô d√†i ƒë√°y b√© c·ªßa ao?`,
                    answer: a, unit: "m", svg: svg,
                    steps: [
                        {type:'header', text:'Giai ƒëo·∫°n 1: T√≠nh ƒë∆°n gi√° t·ªïng'},
                        {type:'step', text:`1. Gi√° tr·ªçn g√≥i 1m¬≥ = Gi√° ƒë√†o + Gi√° v·∫≠n chuy·ªÉn`},
                        {type:'step', text:`   = ${formatMoney(priceExcavate)} + ${formatMoney(transportPrice)} = ${formatMoney(priceExcavate+transportPrice)} (ƒë/m¬≥)`},
                        {type:'header', text:'Giai ƒëo·∫°n 2: T√≠nh th·ªÉ t√≠ch'},
                        {type:'step', text:`2. Th·ªÉ t√≠ch ƒë·∫•t = T·ªïng ti·ªÅn : Gi√° tr·ªçn g√≥i`},
                        {type:'step', text:`   = ${formatMoney(totalCost)} : ${formatMoney(priceExcavate+transportPrice)} = ${volume} (m¬≥)`},
                        {type:'header', text:'Giai ƒëo·∫°n 3: T√≠nh di·ªán t√≠ch'},
                        {type:'step', text:`3. Di·ªán t√≠ch m·∫∑t ao = Th·ªÉ t√≠ch : ƒê·ªô s√¢u`},
                        {type:'step', text:`   = ${volume} : ${depth} = ${S} (m¬≤)`},
                        {type:'header', text:'Giai ƒëo·∫°n 4: T√≠nh ƒë√°y b√©'},
                        {type:'step', text:`4. T·ªïng hai ƒë√°y = Di·ªán t√≠ch . 2 : Chi·ªÅu cao`},
                        {type:'step', text:`   = ${S} . 2 : ${h} = ${a+b} (m)`},
                        {type:'step', text:`5. ƒê√°y b√© = T·ªïng ƒë√°y - ƒê√°y l·ªõn`},
                        {type:'step', text:`   = ${a+b} - ${b} = ${a} (m)`, isLast:true}
                    ]
                };
            }
        }

        // --- 5. PAINT (S∆†N T∆Ø·ªúNG) ---
        function generateProblem_Paint(isHard) {
            const h = getRandomInt(3, 5); const w = getRandomInt(5, 8); const win = getRandomInt(2, 4);
            const S_paint = h*w - win; 
            const svg = getVisualization('paint', {h:h, w:w});

            const coverage = 4; // m2/liter
            const bucket5L = 5; 
            const price5L = 500000; 
            const laborPrice = 300000; // Total fixed labor

            const litersNeeded = Math.ceil(S_paint / coverage); 
            const bucketsNeeded = Math.ceil(litersNeeded / bucket5L);
            const paintCost = bucketsNeeded * price5L;
            const total = paintCost + laborPrice;

            if(!isHard) {
                return {
                    question: `S∆°n t∆∞·ªùng ${w}m x ${h}m (c·ª≠a ${win}m¬≤). 1 l√≠t s∆°n ƒë∆∞·ª£c ${coverage}m¬≤. Mua th√πng ${bucket5L} l√≠t (${formatMoney(price5L)}ƒë/th√πng). C√¥ng th·ª£ ${formatMoney(laborPrice)}ƒë. T√≠nh t·ªïng chi ph√≠?`,
                    answer: total, unit: "ƒë·ªìng", svg: svg,
                    steps: [
                        {type:'step', text:`S s∆°n: ${w}.${h} - ${win} = ${S_paint} m¬≤`},
                        {type:'step', text:`L√≠t s∆°n: ${S_paint} : ${coverage} ‚âà ${litersNeeded} l√≠t`},
                        {type:'step', text:`S·ªë th√πng: ${litersNeeded} : ${bucket5L} = ${bucketsNeeded} th√πng`},
                        {type:'step', text:`Ti·ªÅn s∆°n: ${bucketsNeeded} . ${formatMoney(price5L)} = ${formatMoney(paintCost)} ƒë`},
                        {type:'step', text:`T·ªïng: ${formatMoney(paintCost)} + ${formatMoney(laborPrice)} = ${formatMoney(total)} ƒë`, isLast:true}
                    ]
                };
            } else {
                return {
                    question: `S∆°n m·ªôt b·ª©c t∆∞·ªùng r·ªông ${w}m (c·ª≠a s·ªï ${win}m¬≤) h·∫øt t·∫•t c·∫£ ${formatMoney(total)}ƒë. Bi·∫øt ti·ªÅn c√¥ng l√† ${formatMoney(laborPrice)}ƒë. S∆°n mua lo·∫°i th√πng ${bucket5L} l√≠t gi√° ${formatMoney(price5L)}ƒë/th√πng. ƒê·ªãnh m·ª©c s∆°n ${coverage}m¬≤/l√≠t. (Bi·∫øt s·ªë th√πng mua v·ª´a ƒë·ªß s∆°n, kh√¥ng d∆∞ nhi·ªÅu). T√≠nh chi·ªÅu cao b·ª©c t∆∞·ªùng?`,
                    answer: h, unit: "m", svg: svg,
                    steps: [
                        {type:'header', text:'Giai ƒëo·∫°n 1: T√≠nh v·∫≠t t∆∞'},
                        {type:'step', text:`1. Ti·ªÅn s∆°n = T·ªïng - C√¥ng = ${formatMoney(total)} - ${formatMoney(laborPrice)} = ${formatMoney(paintCost)}ƒë`},
                        {type:'step', text:`2. S·ªë th√πng = Ti·ªÅn s∆°n : Gi√° th√πng = ${paintCost} : ${price5L} = ${bucketsNeeded} th√πng`},
                        {type:'step', text:`3. S·ªë l√≠t t·ªëi ƒëa = S·ªë th√πng . ${bucket5L} = ${bucketsNeeded*bucket5L} l√≠t`},
                        {type:'header', text:'Giai ƒëo·∫°n 2: T√≠nh di·ªán t√≠ch'},
                        {type:'step', text:`*L∆∞u √Ω: Ta l·∫•y di·ªán t√≠ch t·ªëi ƒëa c√≥ th·ªÉ s∆°n l√†m chu·∫©n*`},
                        {type:'step', text:`4. Di·ªán t√≠ch s∆°n = S·ªë l√≠t . ƒê·ªãnh m·ª©c`},
                        {type:'step', text:`   (Th·ª±c t·∫ø l·∫•y x·∫•p x·ªâ): S ‚âà ${S_paint} m¬≤`},
                        {type:'step', text:`5. Di·ªán t√≠ch to√†n b·ªô = S s∆°n + S c·ª≠a = ${S_paint} + ${win} = ${h*w} m¬≤`},
                        {type:'header', text:'Giai ƒëo·∫°n 3: T√≠nh chi·ªÅu cao'},
                        {type:'step', text:`6. Chi·ªÅu cao = S to√†n b·ªô : Chi·ªÅu r·ªông`},
                        {type:'step', text:`   = ${h*w} : ${w} = ${h} (m)`, isLast:true}
                    ]
                };
            }
        }

        // --- UI FUNCTIONS ---
        function nextQuestion() {
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            const inputEl = document.getElementById('user-ans');
            inputEl.value = ''; inputEl.disabled = false;
            inputEl.classList.remove('border-emerald-500', 'bg-emerald-50', 'border-red-500', 'bg-red-50');
            isAnswered = false; stepIndex = 0; usedHint = false;
            
            document.getElementById('steps-container').innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-20 flex flex-col items-center select-none"><i class="fas fa-pencil-alt text-4xl mb-3 opacity-20"></i><span>B·∫•m "Ki·ªÉm tra" ho·∫∑c "Ti·∫øp" ƒë·ªÉ xem l·ªùi gi·∫£i.</span></div>`;
            document.getElementById('btn-show-step').innerHTML = '<span>Ti·∫øp</span> <i class="fas fa-chevron-right text-[10px]"></i>';
            document.getElementById('btn-show-step').disabled = false;

            let data = generateProblem();
            while(!data) data = generateProblem();
            currentData = data;

            document.getElementById('problem-text').innerHTML = data.question.replace(/\n/g, '<br>');
            document.getElementById('svg-container').innerHTML = data.svg;
            document.getElementById('step-counter').textContent = `0/${currentData.steps.length}`;
            inputEl.focus();
            if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
        }

        function showNextStep() {
            usedHint = true;
            const container = document.getElementById('steps-container');
            if (stepIndex === 0) container.innerHTML = ''; 

            if (stepIndex < currentData.steps.length) {
                const item = currentData.steps[stepIndex];
                if (item.type === 'header') {
                    const div = document.createElement('div');
                    div.className = "mt-3 mb-1 text-xs font-extrabold text-emerald-600 uppercase border-b border-emerald-200 pb-1";
                    div.innerHTML = `<i class="fas fa-caret-right"></i> ${item.text}`;
                    container.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = item.isLast ? "step-item bg-emerald-50 p-3 rounded-lg border-l-4 shadow-md text-emerald-800 font-bold border-emerald-600" : "step-item bg-white p-3 rounded-lg border-l-4 shadow-sm text-gray-700 font-mono text-sm md:text-base border-emerald-400";
                    div.innerHTML = item.isLast ? `<i class="fas fa-check-square mr-2"></i>${item.text}` : item.text;
                    container.appendChild(div);
                }
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentData.steps.length}`;
            }
            if (stepIndex >= currentData.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-flag-checkered"></i> <span>H·∫øt</span>';
            }
            if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
        }

        function checkAnswer() {
            if (isAnswered) return;
            const inputEl = document.getElementById('user-ans');
            const userVal = parseFloat(inputEl.value.replace(/\./g, '').replace(/,/g, ''));
            const feedback = document.getElementById('feedback');
            feedback.className = "mt-4 text-center p-4 rounded-lg text-sm font-bold animate-pulse"; 

            if (isNaN(userVal)) { feedback.textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë!"; feedback.classList.add('bg-yellow-100', 'text-yellow-800'); feedback.classList.remove('hidden'); return; }

            if (Math.abs(userVal - currentData.answer) < 0.1) {
                if (!usedHint) { state.correct++; state.streak++; feedback.innerHTML = '<i class="fas fa-crown text-xl block mb-1"></i> Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.'; feedback.classList.add('bg-emerald-100', 'text-emerald-800'); }
                else { feedback.innerHTML = '<i class="fas fa-check text-xl block mb-1"></i> Ch√≠nh x√°c! (ƒê√£ d√πng g·ª£i √Ω)'; feedback.classList.add('bg-blue-100', 'text-blue-800'); }
                inputEl.classList.add('border-emerald-500', 'bg-emerald-50'); inputEl.classList.remove('border-gray-300');
                const reveal = setInterval(() => { if(stepIndex < currentData.steps.length) showNextStep(); else clearInterval(reveal); }, 150);
                isAnswered = true;
            } else {
                state.wrong++; state.streak = 0;
                inputEl.classList.add('border-red-500', 'bg-red-50');
                feedback.innerHTML = `<i class="fas fa-times-circle text-xl block mb-1"></i> Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√† <span class="text-lg text-red-600 bg-white px-2 rounded border border-red-200">${formatMoney(currentData.answer)}</span>`;
                feedback.classList.add('bg-red-100', 'text-red-800'); feedback.classList.remove('hidden');
            }
            renderStats();
        }
        function renderStats() {
            document.getElementById('stat-streak').textContent = state.streak; document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong; document.getElementById('stat-skipped').textContent = state.skipped;
        }
    </script>
</body>
</html>