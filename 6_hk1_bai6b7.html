<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p To√°n 6 HK1 - B√†i 6b & 7 (Full Shapes)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #ecfdf5; /* Green-50 */
            background-image: radial-gradient(#6ee7b7 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .chalkboard {
            background-color: #064e3b; /* Green-900 */
            color: #d1fae5;
            border: 8px solid #78350f; /* Wood color */
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.15;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar { width: 8px; }
        #steps-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb { background: #6ee7b7; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb:hover { background: #34d399; }
        
        .streak-fire { color: #ea580c; animation: burn 0.5s infinite alternate; }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fdba74, 0 -2px 4px #fb923c; }
            to { text-shadow: 0 0 4px #fdba74, 0 -4px 8px #ea580c; }
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23065f46' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
        /* MathJax overrides */
        mjx-container { font-size: 110% !important; }

        /* LOADING OVERLAY STYLES */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ecfdf5;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #d1fae5;
            border-top: 5px solid #059669; /* Emerald-600 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- MathJax Configuration & Loading -->
    <script>
        // C·∫•u h√¨nh MathJax ƒë·ªÉ x·ª≠ l√Ω loading screen
        window.MathJax = {
            startup: {
                pageReady: () => {
                    // 1. Ch·∫°y logic sinh c√¢u h·ªèi
                    if (window.nextQuestion) window.nextQuestion();
                    
                    // 2. ƒê·ªÉ MathJax x·ª≠ l√Ω hi·ªÉn th·ªã c√¥ng th·ª©c (return promise)
                    return MathJax.startup.defaultPageReady().then(() => {
                        // 3. ·∫®n m√†n h√¨nh ch·ªù khi xong
                        const overlay = document.getElementById('loading-overlay');
                        if (overlay) {
                            overlay.style.opacity = '0';
                            setTimeout(() => overlay.remove(), 500);
                        }
                    });
                }
            }
        };

        // Fallback: N·∫øu MathJax l·ªói ho·∫∑c load qu√° l√¢u (5s), t·ª± ƒë·ªông ·∫©n overlay
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay && document.body.contains(overlay)) {
                console.warn("MathJax taking too long, forcing display.");
                if (window.nextQuestion && document.getElementById('problem-text').innerText.includes("ƒêang t·∫£i")) {
                    window.nextQuestion();
                }
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 500);
            }
        }, 5000);
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="text-emerald-800 font-bold text-lg animate-pulse text-center px-4">
            <i class="fas fa-shapes mr-2"></i>ƒêang t·∫£i th∆∞ vi·ªán To√°n h·ªçc...<br>
            <span class="text-sm font-normal text-emerald-600">(Vui l√≤ng ƒë·ª£i gi√¢y l√°t)</span>
        </div>
    </div>

    <div class="max-w-7xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-emerald-600">
        <!-- Header -->
        <div class="bg-emerald-700 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-ruler-combined mr-2"></i>√în t·∫≠p To√°n 6 HK1 - B√†i 6b & 7
            </h1>
            <p class="text-emerald-100 font-medium text-sm md:text-base">Ch·ªß ƒë·ªÅ: H√¨nh h·ªçc th·ª±c t·∫ø & B√†i to√°n ng∆∞·ª£c (Full Shapes)</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-emerald-50 rounded-xl shadow-inner p-3 grid grid-cols-4 gap-2 text-center select-none border border-emerald-100" id="stats-container">
                <div class="flex flex-col items-center transform transition hover:scale-105">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-orange-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-emerald-200 transform transition hover:scale-105">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-emerald-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-emerald-200 transform transition hover:scale-105">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-emerald-200 transform transition hover:scale-105">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs (3/5 width) -->
                <div class="lg:col-span-3 flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[280px] relative flex items-center justify-center">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-emerald-200 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        <div id="problem-text" class="font-serif text-lg md:text-xl w-full text-center leading-relaxed px-2">
                            ƒêang t·∫£i ƒë·ªÅ b√†i...
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white p-6 rounded-xl border-2 border-emerald-100 shadow-lg relative">
                        <!-- Problem Type Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-emerald-800 font-bold text-xs uppercase mb-1">D·∫°ng b√†i (Full Shapes):</label>
                                <select id="problem-type" class="w-full p-2 text-sm font-bold text-gray-700 bg-emerald-50 border border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition-colors cursor-pointer" onchange="nextQuestion()">
                                    <option value="mix">üé≤ T·ªïng h·ª£p (T·∫•t c·∫£ c√°c h√¨nh)</option>
                                    <option value="rect_square">üü© HCN & H√¨nh Vu√¥ng (R√†o, L√°t)</option>
                                    <option value="rhombus_para">üî∂ H√¨nh Thoi & HBH (Tr·ªìng hoa)</option>
                                    <option value="trapezoid">üè† H√¨nh Thang (B√† NƒÉm)</option>
                                    <option value="paint">üñåÔ∏è S∆°n t∆∞·ªùng (Tr·ª´ c·ª≠a)</option>
                                    <option value="complex">üß© H√¨nh gh√©p (Ch·ªØ L, U)</option>
                                </select>
                            </div>
                            <div class="flex items-end justify-between pb-1">
                                <label class="inline-flex items-center cursor-pointer select-none bg-red-50 px-3 py-2 rounded-lg w-full justify-between border border-red-100 hover:bg-red-100 transition">
                                    <span class="text-sm font-bold text-red-800 mr-2 flex flex-col leading-tight">
                                        <span><i class="fas fa-brain text-red-600 mr-1"></i>Ch·∫ø ƒë·ªô KH√ì</span>
                                        <span class="text-[10px] text-red-500 font-normal">T√≠nh ng∆∞·ª£c 3-4 b∆∞·ªõc</span>
                                    </span>
                                    <div class="relative">
                                        <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                        <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-gray-600 font-bold text-sm uppercase mb-2 text-center">Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n:</label>
                            <div class="relative max-w-sm mx-auto group">
                                <input type="text" id="user-ans" placeholder="..." 
                                    class="w-full text-center font-bold text-3xl p-3 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 focus:outline-none transition-all"
                                    onkeydown="if(event.key === 'Enter') checkAnswer()">
                                <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold text-sm pointer-events-none" id="unit-label"></div>
                            </div>
                            <p class="text-xs text-center text-gray-400 mt-2 italic">
                                (Nh·∫≠p s·ªë t·ª± nhi√™n, v√≠ d·ª•: 2500000)
                            </p>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-random"></i> B√†i kh√°c
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform active:translate-y-0.5 transition-all flex items-center justify-center gap-2 text-lg">
                                <i class="fas fa-check-circle"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <!-- Feedback Area -->
                        <div id="feedback" class="hidden mt-4 text-center p-4 rounded-lg text-sm font-bold animate-pulse"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step (2/5 width) -->
                <div class="lg:col-span-2 flex flex-col h-[500px] lg:h-[600px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">
                                <i class="fas fa-file-signature text-emerald-600 mr-1"></i>L·ªùi gi·∫£i chi ti·∫øt
                            </h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="step-counter" class="text-xs font-bold text-gray-500 bg-gray-200 px-2 py-1 rounded">0/0</span>
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span>Ti·∫øp</span> <i class="fas fa-chevron-right text-[10px]"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Hints/Rules Box -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-xs p-2 rounded-lg border-l-4 border-yellow-400 shadow-sm shrink-0">
                        <i class="fas fa-lightbulb mr-1 text-yellow-600"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>
                    
                    <!-- Scrollable Steps -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth space-y-3">
                        <div class="text-gray-400 italic text-sm text-center mt-20 flex flex-col items-center select-none">
                            <i class="fas fa-pencil-alt text-4xl mb-3 opacity-20"></i>
                            <span>B·∫•m "Ki·ªÉm tra" ho·∫∑c "Ti·∫øp" ƒë·ªÉ xem l·ªùi gi·∫£i.</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- Utilities ---
        const formatMoney = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const roundTo = (n, digits) => Number(Math.round(n + 'e' + digits) + 'e-' + digits);

        const state = { streak: 0, correct: 0, wrong: 0, skipped: 0 };
        let currentData = { answer: 0, steps: [], unit: "" };
        let isAnswered = false;
        let stepIndex = 0;
        let usedHint = false;

        // --- CORE PROBLEM GENERATION ---

        function generateProblem() {
            const isHard = document.getElementById('mode-hard').checked;
            let type = document.getElementById('problem-type').value;

            if (type === 'mix') {
                const types = ['rect_square', 'rhombus_para', 'trapezoid', 'paint', 'complex'];
                type = types[getRandomInt(0, types.length - 1)];
            }

            // --- TYPE 1: RECTANGLE & SQUARE (HCN & HV) ---
            if (type === 'rect_square') {
                const subType = Math.random() < 0.4 ? 'square' : 'rect'; // 40% Square
                const price = getRandomInt(3, 6) * 10000; // Gi√° r√†o ho·∫∑c gi√° g·∫°ch
                
                if (subType === 'square') {
                    const side = getRandomInt(10, 30);
                    const P = side * 4;
                    const S = side * side;
                    const cost = P * price; // Gi·∫£ s·ª≠ t√≠nh r√†o
                    
                    if (!isHard) {
                        return {
                            question: `M·ªôt m·∫£nh v∆∞·ªùn h√¨nh vu√¥ng c√≥ c·∫°nh ${side}m. T√≠nh chi ph√≠ ƒë·ªÉ r√†o l∆∞·ªõi xung quanh m·∫£nh v∆∞·ªùn (kh√¥ng ch·ª´a c·ªïng), bi·∫øt gi√° l∆∞·ªõi l√† ${formatMoney(price)} ƒë/m?`,
                            answer: cost, unit: "ƒë·ªìng",
                            steps: [
                                {type:'step', text:`Chu vi h√¨nh vu√¥ng: ${side} . 4 = ${P} (m)`},
                                {type:'step', text:`T·ªïng ti·ªÅn: ${P} . ${formatMoney(price)} = ${formatMoney(cost)} (ƒë·ªìng)`, isLast:true}
                            ]
                        };
                    } else {
                        // HARD: Ti·ªÅn R√†o -> Chu vi -> C·∫°nh -> Di·ªán T√≠ch (Ng∆∞·ª£c 3 b∆∞·ªõc)
                        return {
                            question: `B√°c Ba r√†o xung quanh m·ªôt m·∫£nh v∆∞·ªùn h√¨nh vu√¥ng h·∫øt ${formatMoney(cost)} ƒë·ªìng ti·ªÅn l∆∞·ªõi (gi√° ${formatMoney(price)} ƒë/m). T√≠nh di·ªán t√≠ch m·∫£nh v∆∞·ªùn ƒë√≥?`,
                            answer: S, unit: "m¬≤",
                            steps: [
                                {type:'header', text:'Ph√¢n t√≠ch ng∆∞·ª£c', rule: 'Ti·ªÅn -> Chu vi -> C·∫°nh -> Di·ªán t√≠ch'},
                                {type:'step', text:`1. Chi·ªÅu d√†i l∆∞·ªõi (Chu vi): ${cost} : ${price} = ${P} (m)`},
                                {type:'step', text:`2. C·∫°nh h√¨nh vu√¥ng: ${P} : 4 = ${side} (m)`},
                                {type:'step', text:`3. Di·ªán t√≠ch: ${side} . ${side} = ${S} (m¬≤)`, isLast:true}
                            ]
                        };
                    }
                } else {
                    // Rectangle logic (Same as Fence type before but cleaner)
                    const w = getRandomInt(8, 15);
                    const l = getRandomInt(w+5, w+20);
                    const P = (l + w) * 2;
                    const S = l * w;
                    const cost = P * price;

                    if (!isHard) {
                        return {
                            question: `HCN d√†i ${l}m, r·ªông ${w}m. T√≠nh ti·ªÅn r√†o xung quanh bi·∫øt gi√° ${formatMoney(price)} ƒë/m?`,
                            answer: cost, unit: "ƒë·ªìng",
                            steps: [
                                {type:'step', text:`Chu vi: (${l}+${w}).2 = ${P} (m)`},
                                {type:'step', text:`Ti·ªÅn: ${P}.${formatMoney(price)} = ${formatMoney(cost)} ƒë`, isLast:true}
                            ]
                        };
                    } else {
                        // HARD: Ti·ªÅn -> Chu vi -> N·ª≠a CV -> T√¨m D√†i (bi·∫øt R·ªông) -> Di·ªán t√≠ch
                        return {
                            question: `Ng∆∞·ªùi ta r√†o k√≠n m·ªôt m·∫£nh ƒë·∫•t HCN c√≥ chi·ªÅu r·ªông ${w}m h·∫øt ${formatMoney(cost)} ƒë·ªìng ti·ªÅn l∆∞·ªõi (gi√° ${formatMoney(price)} ƒë/m). T√≠nh di·ªán t√≠ch m·∫£nh ƒë·∫•t ƒë√≥?`,
                            answer: S, unit: "m¬≤",
                            steps: [
                                {type:'header', text:'Ph√¢n t√≠ch ng∆∞·ª£c'},
                                {type:'step', text:`1. Chu vi: ${cost} : ${price} = ${P} (m)`},
                                {type:'step', text:`2. N·ª≠a chu vi: ${P} : 2 = ${P/2} (m)`},
                                {type:'step', text:`3. Chi·ªÅu d√†i: ${P/2} - ${w} = ${l} (m)`},
                                {type:'step', text:`4. Di·ªán t√≠ch: ${l} . ${w} = ${S} (m¬≤)`, isLast:true}
                            ]
                        };
                    }
                }
            }

            // --- TYPE 2: RHOMBUS & PARALLELOGRAM (H.THOI & HBH) ---
            if (type === 'rhombus_para') {
                const isRhombus = Math.random() < 0.5;
                const price = 50000; // Gi√° tr·ªìng hoa/m2
                
                if (isRhombus) {
                    const d1 = getRandomInt(6, 12) * 2; // S·ªë ch·∫µn
                    const d2 = getRandomInt(8, 15) * 2; 
                    const S = (d1 * d2) / 2;
                    const cost = S * price;
                    
                    if (!isHard) {
                        return {
                            question: `M·ªôt b·ªìn hoa h√¨nh thoi c√≥ hai ƒë∆∞·ªùng ch√©o l√† ${d1}m v√† ${d2}m. T√≠nh chi ph√≠ tr·ªìng hoa tr√™n b·ªìn ƒë√≥, bi·∫øt gi√° ${formatMoney(price)} ƒë/m¬≤?`,
                            answer: cost, unit: "ƒë·ªìng",
                            steps: [
                                {type:'step', text:`Di·ªán t√≠ch h√¨nh thoi: (${d1} . ${d2}) : 2 = ${S} (m¬≤)`},
                                {type:'step', text:`Chi ph√≠: ${S} . ${formatMoney(price)} = ${formatMoney(cost)} (ƒë·ªìng)`, isLast:true}
                            ]
                        };
                    } else {
                        // HARD: Ti·ªÅn -> Di·ªán t√≠ch -> T√≠ch 2 ch√©o -> T√¨m ch√©o c√≤n l·∫°i
                        return {
                            question: `Chi ph√≠ tr·ªìng hoa cho m·ªôt b·ªìn hoa h√¨nh thoi l√† ${formatMoney(cost)} ƒë·ªìng (ƒë∆°n gi√° ${formatMoney(price)} ƒë/m¬≤). Bi·∫øt ƒë·ªô d√†i m·ªôt ƒë∆∞·ªùng ch√©o l√† ${d1}m. T√≠nh ƒë·ªô d√†i ƒë∆∞·ªùng ch√©o c√≤n l·∫°i?`,
                            answer: d2, unit: "m",
                            steps: [
                                {type:'header', text:'Ph√¢n t√≠ch ng∆∞·ª£c', rule: 'Ti·ªÅn -> Di·ªán t√≠ch -> T√≠ch 2 ch√©o -> Ch√©o kia'},
                                {type:'step', text:`1. Di·ªán t√≠ch b·ªìn hoa: ${cost} : ${price} = ${S} (m¬≤)`},
                                {type:'step', text:`2. T√≠ch hai ƒë∆∞·ªùng ch√©o: ${S} . 2 = ${S*2} (m¬≤)`},
                                {type:'step', text:`3. ƒê∆∞·ªùng ch√©o c√≤n l·∫°i: ${S*2} : ${d1} = ${d2} (m)`, isLast:true}
                            ]
                        };
                    }
                } else {
                    // Parallelogram
                    const b = getRandomInt(10, 20);
                    const h = getRandomInt(5, 10);
                    const S = b * h;
                    const cost = S * price;
                    
                    if (!isHard) {
                        return {
                            question: `M·∫£nh v∆∞·ªùn h√¨nh b√¨nh h√†nh c√≥ ƒë·ªô d√†i ƒë√°y ${b}m, chi·ªÅu cao ${h}m. T√≠nh ti·ªÅn tr·ªìng c·ªè (gi√° ${formatMoney(price)} ƒë/m¬≤)?`,
                            answer: cost, unit: "ƒë·ªìng",
                            steps: [
                                {type:'step', text:`Di·ªán t√≠ch HBH: ${b} . ${h} = ${S} (m¬≤)`},
                                {type:'step', text:`Ti·ªÅn: ${S} . ${formatMoney(price)} = ${formatMoney(cost)} ƒë`, isLast:true}
                            ]
                        };
                    } else {
                        // HARD: Ti·ªÅn -> Di·ªán t√≠ch -> T√¨m Chi·ªÅu cao (bi·∫øt ƒë√°y)
                        return {
                            question: `Ng∆∞·ªùi ta chi ${formatMoney(cost)} ƒë·ªìng ƒë·ªÉ tr·ªìng c·ªè cho m·∫£nh v∆∞·ªùn h√¨nh b√¨nh h√†nh c√≥ c·∫°nh ƒë√°y ${b}m (gi√° ${formatMoney(price)} ƒë/m¬≤). T√≠nh chi·ªÅu cao t∆∞∆°ng ·ª©ng c·ªßa m·∫£nh v∆∞·ªùn?`,
                            answer: h, unit: "m",
                            steps: [
                                {type:'header', text:'Ph√¢n t√≠ch ng∆∞·ª£c'},
                                {type:'step', text:`1. Di·ªán t√≠ch m·∫£nh v∆∞·ªùn: ${cost} : ${price} = ${S} (m¬≤)`},
                                {type:'step', text:`2. Chi·ªÅu cao: ${S} : ${b} = ${h} (m)`, isLast:true}
                            ]
                        };
                    }
                }
            }

            // --- TYPE 3: TRAPEZOID (H√åNH THANG - Inverse Height) ---
            if (type === 'trapezoid') {
                const a = getRandomInt(10, 15);
                const b = getRandomInt(20, 30);
                const h = getRandomInt(8, 12);
                const S = (a + b) * h / 2;
                const price = getRandomInt(10, 15) * 10000;
                const cost = S * price;

                if (!isHard) {
                    return {
                        question: `M·∫£nh ƒë·∫•t h√¨nh thang c√≥ ƒë√°y b√© ${a}m, ƒë√°y l·ªõn ${b}m, chi·ªÅu cao ${h}m. T√≠nh gi√° tr·ªã m·∫£nh ƒë·∫•t bi·∫øt 1m¬≤ gi√° ${formatMoney(price)} ƒë·ªìng?`,
                        answer: cost, unit: "ƒë·ªìng",
                        steps: [
                            {type:'step', text:`Di·ªán t√≠ch: (${a} + ${b}) . ${h} : 2 = ${S} (m¬≤)`},
                            {type:'step', text:`Gi√° tr·ªã: ${S} . ${formatMoney(price)} = ${formatMoney(cost)} ƒë`, isLast:true}
                        ]
                    };
                } else {
                    // HARD: Ti·ªÅn -> Di·ªán t√≠ch -> T√¨m Chi·ªÅu cao
                    return {
                        question: `M·ªôt m·∫£nh ƒë·∫•t h√¨nh thang c√≥ ƒë√°y b√© ${a}m, ƒë√°y l·ªõn ${b}m ƒë∆∞·ª£c ƒë·ªãnh gi√° ${formatMoney(cost)} ƒë·ªìng (ƒë∆°n gi√° ${formatMoney(price)} ƒë/m¬≤). T√≠nh chi·ªÅu cao c·ªßa m·∫£nh ƒë·∫•t ƒë√≥?`,
                        answer: h, unit: "m",
                        steps: [
                            {type:'header', text:'Ph√¢n t√≠ch ng∆∞·ª£c', rule: 'Ti·ªÅn -> S -> Chi·ªÅu cao = S.2 : (ƒë√°y+ƒë√°y)'},
                            {type:'step', text:`1. Di·ªán t√≠ch m·∫£nh ƒë·∫•t: ${cost} : ${price} = ${S} (m¬≤)`},
                            {type:'step', text:`2. T·ªïng hai ƒë√°y: ${a} + ${b} = ${a+b} (m)`},
                            {type:'step', text:`3. Chi·ªÅu cao: ${S} . 2 : ${a+b} = ${h} (m)`, isLast:true}
                        ]
                    };
                }
            }
            
            // --- Reuse Complex & Paint Types (Logic unchanged but context integrated) ---
            if (type === 'paint') return generateProblem_Paint(isHard);
            if (type === 'complex') return generateProblem_Complex(isHard);

            return generateProblem(); // Retry
        }

        // --- Helpers for modularity ---
        function generateProblem_Paint(isHard) {
            const h = getRandomInt(3, 5);
            const w = getRandomInt(5, 8);
            const win = getRandomInt(2, 4);
            const S_paint = h*w - win;
            const price = 40000;
            const cost = S_paint * price;
            
            if(!isHard) {
                return {
                    question: `T∆∞·ªùng ${w}m x ${h}m, c·ª≠a s·ªï ${win}m¬≤. T√≠nh ti·ªÅn s∆°n (gi√° ${formatMoney(price)} ƒë/m¬≤)?`,
                    answer: cost, unit: "ƒë·ªìng",
                    steps: [{type:'step', text:`S t∆∞·ªùng: ${w}.${h}=${w*h} m¬≤`}, {type:'step', text:`S s∆°n: ${w*h}-${win}=${S_paint} m¬≤`}, {type:'step', text:`Ti·ªÅn: ${S_paint}.${price} = ${formatMoney(cost)} ƒë`, isLast:true}]
                };
            } else {
                return {
                    question: `S∆°n t∆∞·ªùng r·ªông ${w}m (tr·ª´ c·ª≠a ${win}m¬≤) h·∫øt ${formatMoney(cost)} ƒë·ªìng (gi√° ${formatMoney(price)} ƒë/m¬≤). T√≠nh chi·ªÅu cao t∆∞·ªùng?`,
                    answer: h, unit: "m",
                    steps: [
                        {type:'header', text:'Ng∆∞·ª£c 3 b∆∞·ªõc'},
                        {type:'step', text:`1. S s∆°n: ${cost}:${price}=${S_paint} m¬≤`},
                        {type:'step', text:`2. S to√†n b·ªô: ${S_paint}+${win}=${w*h} m¬≤`},
                        {type:'step', text:`3. Chi·ªÅu cao: ${w*h}:${w}=${h} m`, isLast:true}
                    ]
                };
            }
        }

        function generateProblem_Complex(isHard) {
            // L-shape logic
            const H = getRandomInt(10, 20);
            const W = getRandomInt(10, 15);
            const h_cut = getRandomInt(4, 8);
            const w_cut = getRandomInt(4, 8);
            const S = H*W - h_cut*w_cut;
            const P = (H+W)*2;
            
            if(!isHard) {
                return {
                    question: `H√¨nh ch·ªØ L c·∫Øt t·ª´ HCN ${W}m x ${H}m (b·ªã c·∫Øt g√≥c ${w_cut}m x ${h_cut}m). T√≠nh di·ªán t√≠ch?`,
                    answer: S, unit: "m¬≤",
                    steps: [{type:'step', text:`S bao: ${W}.${H}=${W*H}`}, {type:'step', text:`S c·∫Øt: ${w_cut}.${h_cut}=${w_cut*h_cut}`}, {type:'step', text:`S h√¨nh L: ${W*H}-${w_cut*h_cut}=${S}`, isLast:true}]
                };
            } else {
                return {
                    question: `T√≠nh chu vi m·∫£nh ƒë·∫•t h√¨nh ch·ªØ L (c·∫Øt t·ª´ g√≥c HCN ${W}m x ${H}m). M·∫πo: D√πng t·ªãnh ti·∫øn.`,
                    answer: P, unit: "m",
                    steps: [{type:'step', text:`Chu vi h√¨nh L = Chu vi HCN bao ngo√†i`}, {type:'step', text:`(${H}+${W}).2 = ${P} m`, isLast:true}]
                };
            }
        }

        // --- CORE FUNCTIONS (UI) ---

        function nextQuestion() {
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            const inputEl = document.getElementById('user-ans');
            inputEl.value = '';
            inputEl.disabled = false;
            inputEl.classList.remove('border-emerald-500', 'bg-emerald-50', 'border-red-500', 'bg-red-50');
            
            isAnswered = false;
            stepIndex = 0;
            usedHint = false;
            
            document.getElementById('steps-container').innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-20 flex flex-col items-center select-none"><i class="fas fa-pencil-alt text-4xl mb-3 opacity-20"></i><span>B·∫•m "Ki·ªÉm tra" ho·∫∑c "Ti·∫øp" ƒë·ªÉ xem l·ªùi gi·∫£i.</span></div>`;
            document.getElementById('btn-show-step').innerHTML = '<span>Ti·∫øp</span> <i class="fas fa-chevron-right text-[10px]"></i>';
            document.getElementById('btn-show-step').disabled = false;

            let data = generateProblem();
            while(!data) data = generateProblem();
            currentData = data;

            document.getElementById('problem-text').innerHTML = data.question.replace(/\n/g, '<br>');
            document.getElementById('unit-label').textContent = data.unit;
            document.getElementById('step-counter').textContent = `0/${currentData.steps.length}`;
            
            inputEl.focus();
            if (window.MathJax && MathJax.typesetPromise) {
                 // D√πng typesetPromise ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã l·ªói khi g·ªçi li√™n t·ª•c
                 MathJax.typesetPromise(); 
            }
        }

        function showNextStep() {
            usedHint = true;
            const container = document.getElementById('steps-container');
            if (stepIndex === 0) container.innerHTML = ''; 

            if (stepIndex < currentData.steps.length) {
                const item = currentData.steps[stepIndex];
                if (item.type === 'header') {
                    const div = document.createElement('div');
                    div.className = "mt-3 mb-1 text-xs font-extrabold text-emerald-600 uppercase border-b border-emerald-200 pb-1";
                    div.innerHTML = `<i class="fas fa-caret-right"></i> ${item.text}`;
                    container.appendChild(div);
                    if(item.rule) {
                         const rule = document.getElementById('rule-area');
                         document.getElementById('rule-content').textContent = item.rule;
                         rule.classList.remove('hidden');
                    }
                } else {
                    const div = document.createElement('div');
                    div.className = item.isLast 
                        ? "step-item bg-emerald-50 p-3 rounded-lg border-l-4 shadow-md text-emerald-800 font-bold border-emerald-600"
                        : "step-item bg-white p-3 rounded-lg border-l-4 shadow-sm text-gray-700 font-mono text-sm md:text-base border-emerald-400";
                    div.innerHTML = item.isLast ? `<i class="fas fa-check-square mr-2"></i>${item.text}` : item.text;
                    container.appendChild(div);
                }
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentData.steps.length}`;
            }

            if (stepIndex >= currentData.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-flag-checkered"></i> <span>H·∫øt</span>';
            }
            
            // Re-render MathJax cho c√°c b∆∞·ªõc gi·∫£i m·ªõi
            if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
        }

        function checkAnswer() {
            if (isAnswered) return;
            const inputEl = document.getElementById('user-ans');
            let rawVal = inputEl.value.replace(/\./g, '').replace(/,/g, '');
            const userVal = parseFloat(rawVal);
            const feedback = document.getElementById('feedback');
            feedback.className = "mt-4 text-center p-4 rounded-lg text-sm font-bold animate-pulse"; 

            if (isNaN(userVal)) {
                 feedback.textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë!";
                 feedback.classList.add('bg-yellow-100', 'text-yellow-800');
                 feedback.classList.remove('hidden');
                 return;
            }

            if (Math.abs(userVal - currentData.answer) < 0.1) {
                if (!usedHint) {
                    state.correct++;
                    state.streak++;
                    feedback.innerHTML = '<i class="fas fa-crown text-xl block mb-1"></i> Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.';
                    feedback.classList.add('bg-emerald-100', 'text-emerald-800');
                } else {
                    feedback.innerHTML = '<i class="fas fa-check text-xl block mb-1"></i> Ch√≠nh x√°c! (ƒê√£ d√πng g·ª£i √Ω)';
                    feedback.classList.add('bg-blue-100', 'text-blue-800');
                }
                inputEl.classList.add('border-emerald-500', 'bg-emerald-50');
                inputEl.classList.remove('border-gray-300');
                
                const reveal = setInterval(() => {
                    if(stepIndex < currentData.steps.length) showNextStep();
                    else clearInterval(reveal);
                }, 150);
                isAnswered = true;
            } else {
                state.wrong++;
                state.streak = 0;
                inputEl.classList.add('border-red-500', 'bg-red-50');
                feedback.innerHTML = `<i class="fas fa-times-circle text-xl block mb-1"></i> Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√† <span class="text-lg text-red-600 bg-white px-2 rounded border border-red-200">${formatMoney(currentData.answer)}</span>`;
                feedback.classList.add('bg-red-100', 'text-red-800');
                feedback.classList.remove('hidden');
            }
            renderStats();
        }

        function renderStats() {
            document.getElementById('stat-streak').textContent = state.streak;
            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-skipped').textContent = state.skipped;
        }

        // Kh√¥ng d√πng window.onload n·ªØa v√¨ ƒë√£ x·ª≠ l√Ω trong MathJax.startup.pageReady
    </script>
</body>
</html>