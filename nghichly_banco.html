<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngh·ªãch L√Ω B√†n C·ªù: 64 = 65? - CLB To√°n H·ªçc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fff1f2; /* Rose background */
        }
        h1, h2, h3, .handwritten {
            font-family: 'Patrick Hand', cursive;
        }
        canvas {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: white;
            border-radius: 8px;
            cursor: pointer;
            touch-action: none;
        }
        /* Scrollbar styles */
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .modal-content::-webkit-scrollbar-thumb { background: #fda4af; border-radius: 4px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #fb7185; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-modal { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="text-slate-800 select-none h-screen flex flex-col">

    <div class="container mx-auto px-4 py-6 max-w-5xl flex-grow">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-rose-600 mb-1 drop-shadow-sm">Ngh·ªãch L√Ω B√†n C·ªù</h1>
            <p class="text-xl text-slate-500 handwritten">T·ª´ 64 √¥ vu√¥ng bi·∫øn th√†nh 65 √¥? Ph√©p thu·∫≠t Winx √†?</p>
        </header>

        <!-- Main Simulation Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Controls -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-lg border border-rose-100">
                    <h2 class="text-2xl font-bold mb-3 text-rose-600">B√†n ƒêi·ªÅu Khi·ªÉn</h2>
                    
                    <button id="toggleBtn" class="w-full bg-gradient-to-r from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-xl transition transform hover:scale-[1.02] shadow-md mb-4 flex items-center justify-center gap-2 text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        <span id="btnText">Bi·∫øn H√¨nh (8x8 -> 5x13)</span>
                    </button>

                    <div class="space-y-2 bg-slate-50 p-3 rounded-lg text-sm">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="showLine" class="w-4 h-4 text-rose-600 rounded focus:ring-rose-500 cursor-pointer">
                            <label for="showLine" class="font-medium cursor-pointer text-slate-700">Soi ƒë∆∞·ªùng ch√©o th·∫≠t</label>
                        </div>
                         <div class="flex items-center gap-2">
                            <input type="checkbox" id="showNumbers" class="w-4 h-4 text-rose-600 rounded focus:ring-rose-500 cursor-pointer">
                            <label for="showNumbers" class="font-medium cursor-pointer text-slate-700">Hi·ªÉn th·ªã k√≠ch th∆∞·ªõc</label>
                        </div>
                    </div>
                </div>

                <div class="bg-amber-100 p-4 rounded-xl border-2 border-amber-300 shadow-sm">
                    <h3 class="font-bold text-amber-800 text-xl mb-1">ü§î C√¢u h·ªèi l·ªõn:</h3>
                    <p class="text-amber-900 text-base handwritten leading-tight mb-2">
                        H√¨nh vu√¥ng ban ƒë·∫ßu c√≥ c·∫°nh 8x8 = 64 √¥. <br>
                        H√¨nh ch·ªØ nh·∫≠t l√∫c sau c√≥ c·∫°nh 5x13 = 65 √¥.
                    </p>
                    <p class="text-amber-900 font-bold bg-white/50 p-2 rounded text-center">
                        D∆∞ ra 1 √¥ ·ªü ƒë√¢u v·∫≠y?
                    </p>
                </div>

                <button id="openExplainBtn" class="w-full bg-white border-2 border-indigo-400 text-indigo-700 hover:bg-indigo-50 font-bold py-3 px-4 rounded-xl transition shadow-sm flex items-center justify-center gap-2 group">
                    <span class="text-2xl group-hover:scale-110 transition">üéì</span>
                    <span class="text-lg">Gi·∫£i th√≠ch to√°n h·ªçc</span>
                </button>
            </div>

            <!-- Canvas -->
            <div class="lg:col-span-2 flex justify-center items-start">
                <canvas id="puzzleCanvas" width="600" height="400" class="w-full h-auto border-2 border-slate-200 rounded-xl shadow-xl bg-white"></canvas>
            </div>
        </div>
        
        <footer class="mt-auto text-center text-slate-400 text-xs py-4 border-t border-rose-200">
            <p>M√¥ ph·ªèng ph·ª•c v·ª• gi√°o d·ª•c STEM THCS | D√£y s·ªë Fibonacci</p>
        </footer>
    </div>

    <!-- MODAL POPUP -->
    <div id="explainModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col animate-modal transform scale-95 transition-transform duration-300">
            
            <div class="flex justify-between items-center p-6 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <span class="bg-rose-100 text-rose-600 p-2 rounded-lg text-2xl">üìê</span>
                    <h2 class="text-3xl font-bold text-slate-800">B√≠ M·∫≠t C·ªßa H·ªá S·ªë G√≥c</h2>
                </div>
                <button id="closeExplainBtn" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-2 rounded-full transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-6 overflow-y-auto modal-content space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Explain 1 -->
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                        <h3 class="text-xl font-bold text-blue-700 mb-2">1. D√£y s·ªë Fibonacci</h3>
                        <p class="text-slate-600 mb-2 text-sm">C√°c con s·ªë n√†y kh√¥ng ph·∫£i ng·∫´u nhi√™n:</p>
                        <div class="flex justify-center items-center gap-2 font-mono text-lg font-bold text-blue-800 my-2">
                            <span>3</span> <span>,</span>
                            <span>5</span> <span>,</span>
                            <span>8</span> <span>,</span>
                            <span>13</span>
                        </div>
                        <p class="text-slate-600 text-sm">
                            ƒê√¢y l√† c√°c s·ªë li√™n ti·∫øp trong d√£y Fibonacci. <br>
                            Quy t·∫Øc th√∫ v·ªã: $F_{n-1} \times F_{n+1} = F_n^2 + (-1)^n$
                        </p>
                        <p class="mt-2 text-sm italic text-blue-600 border-t border-blue-200 pt-2">
                            Trong tr∆∞·ªùng h·ª£p n√†y: <br>
                            $5 \times 13 = 65$ <br>
                            $8 \times 8 = 64$ <br>
                            Ch√™nh l·ªách ƒë√∫ng 1 ƒë∆°n v·ªã!
                        </p>
                    </div>

                    <!-- Explain 2 -->
                    <div class="bg-orange-50 p-5 rounded-xl border border-orange-200">
                        <h3 class="text-xl font-bold text-orange-700 mb-2">2. ƒê∆∞·ªùng ch√©o kh√¥ng th·∫≥ng!</h3>
                        <p class="text-slate-600 mb-2 text-sm">H√£y nh√¨n k·ªπ ƒë·ªô d·ªëc (h·ªá s·ªë g√≥c) c·ªßa hai m·∫£nh gh√©p:</p>
                        <ul class="space-y-2 text-slate-700 text-sm ml-2">
                            <li>üî¥ <strong>Tam gi√°c ƒë·ªè:</strong> Cao 3, Ngang 8. <br>H·ªá s·ªë g√≥c $k_1 = 3/8 = \mathbf{0.375}$</li>
                            <li>üîµ <strong>H√¨nh thang xanh:</strong> Cao 2, Ngang 5. <br>H·ªá s·ªë g√≥c $k_2 = 2/5 = \mathbf{0.400}$</li>
                        </ul>
                        <div class="mt-3 bg-white p-2 rounded text-orange-800 text-xs font-bold border border-orange-100 text-center shadow-sm">
                            $0.375 \neq 0.400$ <br> M·∫Øt th∆∞·ªùng kh√≥ nh·∫≠n ra s·ª± ch√™nh l·ªách nh·ªè n√†y!
                        </div>
                    </div>
                </div>

                <!-- Visual Reveal -->
                <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg text-center">
                    <h3 class="text-2xl font-bold mb-3 text-yellow-400">K·∫øt Lu·∫≠n</h3>
                    <p class="mb-4">
                        Khi x·∫øp th√†nh h√¨nh ch·ªØ nh·∫≠t 5x13, c√°c m·∫£nh gh√©p t·∫°o ra m·ªôt <span class="text-yellow-400 font-bold">h√¨nh b√¨nh h√†nh r·∫•t h·∫πp</span> ch·∫°y d·ªçc theo ƒë∆∞·ªùng ch√©o.
                    </p>
                    <p class="text-sm opacity-80">
                        Di·ªán t√≠ch c·ªßa khe h·ªü h·∫πp n√†y ch√≠nh b·∫±ng di·ªán t√≠ch c·ªßa 1 √¥ vu√¥ng "t·ª´ tr√™n tr·ªùi r∆°i xu·ªëng".
                    </p>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end">
                <button id="closeExplainBtnBottom" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-6 rounded-lg transition">
                    ƒê√£ hi·ªÉu!
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('puzzleCanvas');
        const ctx = canvas.getContext('2d');
        const toggleBtn = document.getElementById('toggleBtn');
        const btnText = document.getElementById('btnText');
        const showLineCheckbox = document.getElementById('showLine');
        const showNumbersCheckbox = document.getElementById('showNumbers');
        
        // Modal Logic
        const modal = document.getElementById('explainModal');
        const openBtn = document.getElementById('openExplainBtn');
        const closeBtns = [document.getElementById('closeExplainBtn'), document.getElementById('closeExplainBtnBottom')];

        function toggleModal(show) {
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('div').classList.replace('scale-95', 'scale-100');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.replace('scale-100', 'scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        openBtn.addEventListener('click', () => toggleModal(true));
        closeBtns.forEach(btn => btn.addEventListener('click', () => toggleModal(false)));
        modal.addEventListener('click', (e) => { if (e.target === modal) toggleModal(false); });

        // --- SIMULATION CONFIG ---
        const CELL = 35; // Size of one square
        const OFFSET_X = 50;
        const OFFSET_Y = 50;
        
        let currentState = 0; // 0: Square (8x8), 1: Rectangle (5x13)
        let animationProgress = 1; 
        let isAnimating = false;

        // OFFSETS for States
        // Canvas Origin for drawing (to center figures)
        const ORIGIN_SQ = {x: 4, y: 1}; // Square state offset
        const ORIGIN_RECT = {x: 1, y: 3}; // Rectangle state offset

        const Polygons = {
            // RED: Trapezoid (Height 5, Width 5, Short Height 3)
            // Square: Bottom Left
            // Rect: Bottom Left
            Red: { 
                p0: [{x:0,y:3}, {x:5,y:5}, {x:5,y:8}, {x:0,y:8}], // Sq: Tall Left
                p1: [{x:0,y:0}, {x:5,y:2}, {x:5,y:5}, {x:0,y:5}], // Rect: Tall Left
                color: '#fb7185', stroke: '#be123c'
            },
            
            // BLUE: Trapezoid (Height 5, Width 5, Short Height 3)
            // Square: Top Left
            // Rect: Top Right
            Blue: { 
                p0: [{x:0,y:0}, {x:5,y:0}, {x:5,y:5}, {x:0,y:3}], // Sq: Tall Right (matches Red)
                p1: [{x:8,y:0}, {x:13,y:0}, {x:13,y:5}, {x:8,y:3}], // Rect: Tall Right
                color: '#60a5fa', stroke: '#1d4ed8'
            },
            
            // GREEN: Triangle (Base 8, Height 3)
            // Square: Top Right (3x8 Vertical)
            // Rect: Bottom Right (8x3 Horizontal)
            Green: { 
                p0: [{x:5,y:0}, {x:8,y:0}, {x:5,y:8}], // Sq: Vertical 3x8
                p1: [{x:5,y:2}, {x:13,y:5}, {x:5,y:5}], // Rect: Horizontal 8x3
                color: '#4ade80', stroke: '#15803d'
            },
            
            // YELLOW: Triangle (Base 8, Height 3)
            // Square: Bottom Right (3x8 Vertical)
            // Rect: Top Left (8x3 Horizontal)
            Yellow: { 
                p0: [{x:5,y:8}, {x:8,y:0}, {x:8,y:8}], // Sq: Vertical 3x8
                p1: [{x:0,y:0}, {x:8,y:0}, {x:8,y:3}], // Rect: Horizontal 8x3
                color: '#fde047', stroke: '#a16207'
            }
        };

        function lerp(a, b, t) { return a + (b - a) * t; }
        
        function easeInOutBack(x) {
            const c1 = 1.70158;
            const c2 = c1 * 1.525;
            return x < 0.5
                ? (Math.pow(2 * x, 2) * ((c2 + 1) * 2 * x - c2)) / 2
                : (Math.pow(2 * x - 2, 2) * ((c2 + 1) * (2 * x - 2) + c2) + 2) / 2;
        }

        function drawGrid(originX, originY, cols, rows, opacity = 1) {
            ctx.save();
            ctx.translate(OFFSET_X + originX * CELL, OFFSET_Y + originY * CELL);
            ctx.globalAlpha = opacity;
            
            // Draw border
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, cols * CELL, rows * CELL);

            // Draw inner grid lines
            ctx.beginPath();
            for (let x = 1; x < cols; x++) {
                ctx.moveTo(x * CELL, 0);
                ctx.lineTo(x * CELL, rows * CELL);
            }
            for (let y = 1; y < rows; y++) {
                ctx.moveTo(0, y * CELL);
                ctx.lineTo(cols * CELL, y * CELL);
            }
            ctx.stroke();

            // Dimensions text
            if(showNumbersCheckbox.checked) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(cols, cols*CELL/2, -5);
                ctx.textAlign = 'right';
                ctx.fillText(rows, -5, rows*CELL/2);
            }
            ctx.restore();
        }

        function drawPoly(poly, t) {
            const startPts = currentState === 1 ? poly.p0 : poly.p1;
            const endPts = currentState === 1 ? poly.p1 : poly.p0;
            
            const startOrigin = currentState === 1 ? ORIGIN_SQ : ORIGIN_RECT;
            const endOrigin = currentState === 1 ? ORIGIN_RECT : ORIGIN_SQ;

            // Interpolate vertices
            const pts = startPts.map((p, i) => ({
                x: lerp(p.x + startOrigin.x, endPts[i].x + endOrigin.x, t),
                y: lerp(p.y + startOrigin.y, endPts[i].y + endOrigin.y, t)
            }));

            ctx.save();
            ctx.translate(OFFSET_X, OFFSET_Y);
            
            // Path
            ctx.beginPath();
            ctx.moveTo(pts[0].x * CELL, pts[0].y * CELL);
            for(let i=1; i<pts.length; i++) ctx.lineTo(pts[i].x * CELL, pts[i].y * CELL);
            ctx.closePath();

            // Fill & Stroke
            ctx.fillStyle = poly.color;
            ctx.fill();
            ctx.strokeStyle = poly.stroke;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw internal grid pattern (aesthetic)
            ctx.save();
            ctx.clip();
            ctx.fillStyle = 'rgba(0,0,0,0.05)';
            // Draw a simple grid pattern over the bounding box
            const minX = Math.min(...pts.map(p=>p.x));
            const maxX = Math.max(...pts.map(p=>p.x));
            const minY = Math.min(...pts.map(p=>p.y));
            const maxY = Math.max(...pts.map(p=>p.y));
            
            for(let x=Math.floor(minX); x<=Math.ceil(maxX); x++) {
                for(let y=Math.floor(minY); y<=Math.ceil(maxY); y++) {
                    if ((x+y)%2 === 1) ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
                }
            }
            
            // Draw white grid lines
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let x=Math.floor(minX); x<=Math.ceil(maxX); x++) {
                ctx.moveTo(x*CELL, minY*CELL); ctx.lineTo(x*CELL, maxY*CELL);
            }
            for(let y=Math.floor(minY); y<=Math.ceil(maxY); y++) {
                ctx.moveTo(minX*CELL, y*CELL); ctx.lineTo(maxX*CELL, y*CELL);
            }
            ctx.stroke();
            
            ctx.restore(); // End Clip
            ctx.restore(); // End Translate
        }

        function drawTrueLine() {
            if(!showLineCheckbox.checked) return;
            
            let opacity = 0;
            if (currentState === 1) opacity = animationProgress;
            else opacity = 1 - animationProgress;
            
            if(opacity < 0.05) return;

            ctx.save();
            ctx.translate(OFFSET_X + ORIGIN_RECT.x*CELL, OFFSET_Y + ORIGIN_RECT.y*CELL);
            
            ctx.beginPath();
            ctx.moveTo(0, 5*CELL); // Bottom Left (Canvas Y is down)
            ctx.lineTo(13*CELL, 0); // Top Right
            
            ctx.strokeStyle = `rgba(220, 38, 38, ${opacity})`;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.restore();
        }

        function update() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const t = easeInOutBack(animationProgress);
            
            // Draw target grid faint in background
            if (currentState === 0) {
                 drawGrid(ORIGIN_SQ.x, ORIGIN_SQ.y, 8, 8, t); 
                 drawGrid(ORIGIN_RECT.x, ORIGIN_RECT.y, 13, 5, 1-t);
            } else {
                 drawGrid(ORIGIN_RECT.x, ORIGIN_RECT.y, 13, 5, t);
                 drawGrid(ORIGIN_SQ.x, ORIGIN_SQ.y, 8, 8, 1-t);
            }

            // Draw Shapes
            drawPoly(Polygons.Green, t);
            drawPoly(Polygons.Yellow, t);
            drawPoly(Polygons.Red, t);
            drawPoly(Polygons.Blue, t);
            
            drawTrueLine();

            if (isAnimating) {
                animationProgress += 0.015; // Speed
                if (animationProgress >= 1) {
                    animationProgress = 1;
                    isAnimating = false;
                }
                requestAnimationFrame(update);
            }
        }

        function toggleState() {
            if (isAnimating) return;
            currentState = currentState === 0 ? 1 : 0;
            animationProgress = 0;
            isAnimating = true;
            btnText.innerText = currentState === 0 ? "Bi·∫øn H√¨nh (8x8 -> 5x13)" : "Ho√†n T√°c (5x13 -> 8x8)";
            update();
        }

        toggleBtn.addEventListener('click', toggleState);
        canvas.addEventListener('pointerdown', toggleState);
        showLineCheckbox.addEventListener('change', () => requestAnimationFrame(update));
        showNumbersCheckbox.addEventListener('change', () => requestAnimationFrame(update));

        update();

    </script>
</body>
</html>