<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện tập Toán 7 - Tìm X Tỉ lệ thức (Vô hạn)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0fdf4;
        }
        .step-enter {
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
            transform: translateX(-10px);
        }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- 1. CÔNG CỤ SINH SỐ NGẪU NHIÊN ---
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const randomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const fmtNum = (n) => n < 0 ? `(${n})` : `${n}`;

        // --- 2. LOGIC TẠO ĐỀ BÀI (GENERATOR NÂNG CAO) ---
        const generateProblem = () => {
            // Xác định dạng bài: Basic (x đứng 1 mình) hoặc Advanced (x +/- k)
            const isAdvanced = Math.random() > 0.6; // 40% cơ hội ra bài nâng cao
            
            let x_val, partner, other1, other2;
            let targetBlockVal; // Giá trị của cụm chứa x (nếu basic thì bằng x, advanced thì bằng x +/- k)
            let k = 0; // Số đi kèm x trong bài nâng cao
            let isValid = false;
            let questionTex = "";
            let steps = [];
            let hint = "";
            let level = isAdvanced ? "Nâng cao" : "Cơ bản";
            
            // Loop tìm bộ số đẹp
            while (!isValid) {
                // 1. Chọn giá trị x mong muốn (đáp án)
                x_val = randomInt(-15, 15);
                if (x_val === 0) x_val = 5;

                // 2. Nếu là Advanced, tạo số k và tính giá trị cụm (x+k)
                if (isAdvanced) {
                    k = randomInt(-9, 9);
                    if (k === 0) k = 1;
                    targetBlockVal = x_val + k;
                } else {
                    targetBlockVal = x_val;
                }

                // Nếu cụm chứa x = 0 thì bỏ qua (tránh rắc rối khi chia hoặc mẫu số = 0)
                if (targetBlockVal === 0) continue;

                // 3. Chọn 2 số khác (Partner và Other1)
                // Partner là số nằm chéo với x, Other1 là số nằm cùng hàng/cột
                partner = randomInt(-10, 10);
                if (partner === 0) partner = 2;
                
                other1 = randomInt(-10, 10);
                if (other1 === 0) other1 = 3;

                // 4. Tính Other2 dựa trên tỉ lệ thức: Target * Partner = Other1 * Other2
                // => Other2 = (Target * Partner) / Other1
                // Kiểm tra xem có chia hết không để số đẹp
                if ((targetBlockVal * partner) % other1 === 0) {
                    other2 = (targetBlockVal * partner) / other1;
                    
                    // Tránh số quá to hoặc bằng 0
                    if (Math.abs(other2) <= 50 && other2 !== 0) {
                        isValid = true;
                    }
                }
            }

            // --- XÂY DỰNG VỊ TRÍ NGẪU NHIÊN ---
            // Tỉ lệ thức dạng: A/B = C/D
            // Các vị trí: 0:A (TL), 1:B (BL), 2:C (TR), 3:D (BR)
            const pos = randomInt(0, 3);
            let A, B, C, D;
            let targetTex = isAdvanced ? (k > 0 ? `x + ${k}` : `x - ${Math.abs(k)}`) : "x";
            let targetTexDisplay = isAdvanced ? `(${k > 0 ? `x + ${k}` : `x - ${Math.abs(k)}`})` : "x"; // Dùng trong bước giải có ngoặc

            // Gán giá trị vào vị trí
            // Quy tắc: Vị trí chứa x và Partner luôn chéo nhau (A-D hoặc B-C)
            // Hai vị trí còn lại là Other1 và Other2
            
            if (pos === 0) { // x nằm ở A (Tử trái) -> Partner là D
                A = targetTex; D = partner;
                // Other1 và Other2 có thể ở B hoặc C tùy ý, random tiếp cho tự nhiên
                if (Math.random() > 0.5) { B = other1; C = other2; } else { B = other2; C = other1; }
            } else if (pos === 1) { // x nằm ở B (Mẫu trái) -> Partner là C
                B = targetTex; C = partner;
                if (Math.random() > 0.5) { A = other1; D = other2; } else { A = other2; D = other1; }
            } else if (pos === 2) { // x nằm ở C (Tử phải) -> Partner là B
                C = targetTex; B = partner;
                if (Math.random() > 0.5) { A = other1; D = other2; } else { A = other2; D = other1; }
            } else { // x nằm ở D (Mẫu phải) -> Partner là A
                D = targetTex; A = partner;
                if (Math.random() > 0.5) { B = other1; C = other2; } else { B = other2; C = other1; }
            }

            questionTex = `\\frac{${A}}{${B}} = \\frac{${C}}{${D}}`;

            // --- XÂY DỰNG LỜI GIẢI ---
            // Bước 1: Nhân chéo
            // Luôn viết vế chứa x bên trái: Target * Partner = Other1 * Other2
            let step1_LHS = `${targetTexDisplay} \\cdot ${fmtNum(partner)}`;
            let productVal = other1 * other2;
            let step1_RHS = `${fmtNum(other1)} \\cdot ${fmtNum(other2)}`;
            
            steps.push({
                title: "Bước 1: Nhân chéo",
                tex: `${step1_LHS} = ${step1_RHS}`
            });

            // Bước 2: Tính tích
            steps.push({
                title: "Bước 2: Tính tích các số đã biết",
                tex: `${targetTexDisplay} \\cdot ${fmtNum(partner)} = ${productVal}`
            });

            // Bước 3: Tìm cụm chứa x (Chia cho Partner)
            steps.push({
                title: `Bước 3: Tìm ${isAdvanced ? "cụm chứa x" : "x"}`,
                tex: `${targetTexDisplay} = ${productVal} : ${fmtNum(partner)} = ${targetBlockVal}`
            });

            // Bước 4 (Nếu Advanced): Tìm x
            if (isAdvanced) {
                // targetBlockVal = x + k => x = targetBlockVal - k
                let calcTex = k > 0 
                    ? `x = ${targetBlockVal} - ${k}` 
                    : `x = ${targetBlockVal} + ${Math.abs(k)}`;
                steps.push({
                    title: "Bước 4: Chuyển vế tìm x",
                    tex: calcTex
                });
                steps.push({
                    title: "Kết quả",
                    tex: `x = ${x_val}`
                });
            } else {
                 steps.push({
                    title: "Kết quả",
                    tex: `x = ${x_val}`
                });
            }

            // Gợi ý
            hint = `Áp dụng tính chất tỉ lệ thức: Tích ngoại tỉ bằng tích trung tỉ.<br>
                    Nói dễ hiểu: <b>Nhân chéo</b> hai số đã biết rồi chia cho số nằm chéo với $x$.`;

            return { id: Date.now(), level, questionTex, answer: x_val, hint, steps };
        };

        // --- 3. COMPONENT MATH (KaTeX) ---
        const MathTex = ({ tex, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && window.katex) {
                    try {
                        katex.render(tex, containerRef.current, {
                            throwOnError: false,
                            displayMode: true
                        });
                    } catch (e) { console.error(e); }
                }
            }, [tex]);
            return <div ref={containerRef} className={`${className} overflow-x-auto overflow-y-hidden py-1`} />;
        };

        // --- 4. ỨNG DỤNG CHÍNH ---
        const App = () => {
            const [problem, setProblem] = useState(null);
            const [userInput, setUserInput] = useState("");
            const [status, setStatus] = useState("idle"); 
            const [score, setScore] = useState(0);
            const [streak, setStreak] = useState(0);
            const [revealedSteps, setRevealedSteps] = useState(0); 

            useEffect(() => { nextProblem(); }, []);

            const nextProblem = useCallback(() => {
                const p = generateProblem();
                setProblem(p);
                setUserInput("");
                setStatus("idle");
                setRevealedSteps(0);
            }, []);

            const handleHintClick = () => {
                if (problem && revealedSteps <= problem.steps.length) {
                    setRevealedSteps(prev => prev + 1);
                }
            };

            const handleCheck = () => {
                if (!userInput) return;
                
                let userVal = NaN;
                let str = userInput.trim().replace(',', '.');
                if (str.includes('/')) {
                    const [n, d] = str.split('/');
                    userVal = parseFloat(n) / parseFloat(d);
                } else {
                    userVal = parseFloat(str);
                }

                if (isNaN(userVal)) { alert("Vui lòng nhập số!"); return; }

                if (Math.abs(userVal - problem.answer) < 0.001) {
                    setStatus("correct");
                    setScore(s => s + 10);
                    setStreak(s => s + 1);
                    if (window.confetti) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    setRevealedSteps(problem.steps.length + 1);
                } else {
                    setStatus("wrong");
                    setStreak(0);
                }
            };

            const handleSkip = () => {
                setStreak(0);
                nextProblem();
            };

            const handleShowAnswer = () => {
                setStatus("revealed");
                setRevealedSteps(problem.steps.length + 1);
                setStreak(0);
            };

            if (!problem) return <div className="p-10 text-center">Đang tải...</div>;

            const totalSteps = problem.steps.length;
            const isFullRevealed = revealedSteps > totalSteps;
            const hintBtnText = revealedSteps === 0 ? "Xem gợi ý" : 
                                revealedSteps <= totalSteps ? `Hiện bước ${revealedSteps}` : "Đã hiện hết";

            return (
                <div className="min-h-screen flex flex-col items-center py-6 px-4 max-w-6xl mx-auto">
                    {/* Header */}
                    <header className="w-full flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-emerald-100 w-12 h-12 flex items-center justify-center rounded-full text-emerald-600">
                                <i className="fas fa-infinity text-xl"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-800">Luyện tập Toán 7</h1>
                                <p className="text-sm text-gray-500">Tìm x trong Tỉ lệ thức (Ngẫu nhiên)</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="text-center">
                                <div className="text-xs text-gray-400 font-bold uppercase tracking-wider">Chuỗi thắng</div>
                                <div className="text-xl font-bold text-orange-500">
                                    <i className="fas fa-fire mr-1"></i>{streak}
                                </div>
                            </div>
                            <div className="text-center px-4 border-l">
                                <div className="text-xs text-gray-400 font-bold uppercase tracking-wider">Điểm số</div>
                                <div className="text-2xl font-bold text-emerald-600">{score}</div>
                            </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 w-full">
                        
                        {/* CỘT TRÁI: ĐỀ BÀI & NHẬP LIỆU (7/12) */}
                        <div className="lg:col-span-7 flex flex-col gap-6">
                            
                            {/* Card Đề bài */}
                            <div className="bg-white rounded-2xl shadow-md border-2 border-indigo-50 overflow-hidden relative">
                                <div className="bg-indigo-50 px-6 py-3 border-b border-indigo-100 flex justify-between items-center">
                                    <span className="font-bold text-indigo-700 uppercase text-xs tracking-wider flex items-center gap-2">
                                        <span className={`px-2 py-0.5 rounded ${problem.level === 'Nâng cao' ? 'bg-orange-100 text-orange-800' : 'bg-indigo-200 text-indigo-800'}`}>
                                            {problem.level}
                                        </span>
                                        #{problem.id.toString().slice(-4)}
                                    </span>
                                    
                                    <button 
                                        onClick={handleHintClick}
                                        disabled={isFullRevealed || status === 'correct'}
                                        className={`text-xs font-bold px-3 py-1.5 rounded-lg flex items-center gap-1 transition-all border
                                            ${isFullRevealed 
                                                ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' 
                                                : 'bg-white text-indigo-600 border-indigo-200 hover:bg-indigo-50 shadow-sm hover:shadow'}`}
                                    >
                                        <i className="far fa-lightbulb"></i>
                                        {hintBtnText}
                                    </button>
                                </div>
                                
                                <div className="p-8 flex flex-col items-center justify-center min-h-[240px] bg-slate-50">
                                    <div className="transform scale-125 transition-all duration-300 hover:scale-150 cursor-default">
                                        <MathTex tex={problem.questionTex} />
                                    </div>
                                </div>
                            </div>

                            {/* Card Nhập liệu */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                <div className="flex flex-col gap-4">
                                    <label className="text-sm font-bold text-gray-700 flex items-center gap-2">
                                        <i className="fas fa-keyboard text-gray-400"></i>
                                        Nhập kết quả x:
                                    </label>
                                    
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <div className="relative flex-grow group">
                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-serif italic text-xl font-bold transition-colors group-focus-within:text-indigo-500">x =</span>
                                            <input 
                                                type="text" 
                                                value={userInput}
                                                onChange={(e) => setUserInput(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && handleCheck()}
                                                placeholder="VD: 5 hoặc -3/2"
                                                disabled={status === "correct" || status === "revealed"}
                                                className={`w-full pl-14 pr-12 py-4 rounded-xl border-2 outline-none text-xl font-bold tracking-wide transition-all
                                                    ${status === 'correct' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 
                                                      status === 'wrong' ? 'border-rose-300 bg-rose-50 text-rose-700' : 
                                                      'border-gray-200 focus:border-indigo-500 focus:shadow-lg'}`}
                                            />
                                            <div className="absolute right-4 top-1/2 -translate-y-1/2 text-xl">
                                                {status === 'correct' && <i className="fas fa-check-circle text-emerald-500 animate-bounce"></i>}
                                                {status === 'wrong' && <i className="fas fa-times-circle text-rose-500 animate-pulse"></i>}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-2 flex-wrap">
                                        {(status === 'correct' || status === 'revealed') ? (
                                            <button 
                                                onClick={nextProblem}
                                                className="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-emerald-200 transition-all animate-bounce flex justify-center items-center gap-2"
                                            >
                                                <span>Câu tiếp theo</span>
                                                <i className="fas fa-arrow-right"></i>
                                            </button>
                                        ) : (
                                            <>
                                                <button 
                                                    onClick={handleCheck}
                                                    className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-all"
                                                >
                                                    Kiểm tra
                                                </button>
                                                
                                                <button 
                                                    onClick={handleShowAnswer}
                                                    className="px-4 py-3 bg-white border-2 border-gray-200 text-gray-500 rounded-xl hover:bg-gray-50 hover:text-gray-700 hover:border-gray-300 transition-colors"
                                                    title="Xem đáp án (Mất chuỗi thắng)"
                                                >
                                                    <i className="fas fa-key"></i>
                                                </button>

                                                <button 
                                                    onClick={handleSkip}
                                                    className="px-4 py-3 bg-white border-2 border-orange-200 text-orange-500 rounded-xl hover:bg-orange-50 hover:text-orange-600 hover:border-orange-300 transition-colors flex items-center gap-2"
                                                    title="Qua câu khác (Tiết kiệm thời gian)"
                                                >
                                                    <span className="hidden sm:inline font-semibold">Qua câu khác</span>
                                                    <i className="fas fa-forward"></i>
                                                </button>
                                            </>
                                        )}
                                    </div>
                                    
                                    {status === 'wrong' && (
                                        <div className="fade-in mt-2 bg-rose-50 border border-rose-100 text-rose-600 px-4 py-3 rounded-lg flex items-center gap-3 text-sm">
                                            <i className="fas fa-exclamation-triangle"></i>
                                            <div>
                                                <strong>Chưa chính xác!</strong> Hãy dùng nút "Gợi ý" để xem từng bước nhé.
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* CỘT PHẢI: HƯỚNG DẪN GIẢI (5/12) */}
                        <div className="lg:col-span-5">
                            <div className={`h-full bg-white rounded-2xl shadow-sm border border-amber-200 flex flex-col transition-all duration-500 overflow-hidden ${revealedSteps > 0 ? 'opacity-100' : 'opacity-90'}`}>
                                <div className="bg-amber-50 px-5 py-4 border-b border-amber-100 flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <div className="bg-amber-200 p-1.5 rounded-full text-amber-700">
                                            <i className="fas fa-graduation-cap text-sm"></i>
                                        </div>
                                        <h3 className="font-bold text-amber-900">Hướng dẫn từng bước</h3>
                                    </div>
                                    <div className="text-xs font-semibold text-amber-600 bg-amber-100 px-2 py-1 rounded">
                                        {revealedSteps}/{totalSteps + 1}
                                    </div>
                                </div>
                                
                                <div className="p-5 flex-1 overflow-y-auto max-h-[600px] bg-slate-50/50">
                                    {revealedSteps === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400 space-y-4 py-12">
                                            <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center animate-pulse">
                                                <i className="fas fa-lock text-3xl text-gray-300"></i>
                                            </div>
                                            <div className="text-center px-6">
                                                <p className="font-bold text-gray-500">Đang ẩn lời giải</p>
                                                <p className="text-sm mt-1">Bấm nút <strong>"Xem gợi ý"</strong> trên đề bài để hiện từng bước.</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="step-enter bg-blue-50 p-4 rounded-xl border border-blue-100 text-blue-900 text-sm shadow-sm">
                                                <div className="font-bold mb-1 flex items-center gap-2">
                                                    <i className="fas fa-info-circle text-blue-500"></i> Nhắc lại kiến thức:
                                                </div>
                                                <div dangerouslySetInnerHTML={{__html: problem.hint.replace(/\$(.*?)\$/g, '<span class="font-mono bg-blue-100 px-1 rounded text-blue-700">$1</span>')}}></div>
                                            </div>
                                            
                                            <div className="relative pl-4 border-l-2 border-indigo-100 space-y-6 py-2">
                                                {problem.steps.map((step, idx) => {
                                                    if (idx < revealedSteps - 1) {
                                                        return (
                                                            <div key={idx} className="step-enter relative">
                                                                <div className="absolute -left-[21px] top-3 w-3 h-3 rounded-full bg-white border-2 border-indigo-400"></div>
                                                                <div className="flex flex-col gap-1">
                                                                    <span className="text-xs font-bold text-gray-500 uppercase tracking-wide">
                                                                        {step.title}
                                                                    </span>
                                                                    <div className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-indigo-300 transition-all">
                                                                        <MathTex tex={step.tex} className="text-gray-800 text-lg" />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    }
                                                    return null;
                                                })}
                                            </div>
                                            
                                            {!isFullRevealed && (
                                                <div className="text-center pt-4 opacity-50 text-sm italic">
                                                    ... Bấm "Hiện bước tiếp theo" để xem tiếp ...
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>