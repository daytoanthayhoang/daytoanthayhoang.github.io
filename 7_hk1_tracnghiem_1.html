<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p Chinh Ph·ª•c To√°n 7 HK1 - C√¢u 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- MathJax Configuration: Cho ph√©p d√πng d·∫•u $ cho to√°n -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <!-- MathJax for rendering math formulas -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #ecfeff; /* Cyan-50 background */
        }

        .btn-option {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        
        .btn-option:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-option:active:not(:disabled) {
            transform: scale(0.98);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s ease-in-out;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop {
            animation: pop 0.2s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }

        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }

        .mode-active {
            background-color: #0891b2; /* cyan-600 */
            color: white;
            border-color: #0891b2;
        }

        .mode-inactive {
            background-color: white;
            color: #374151;
            border-color: #d1d5db;
        }
        .mode-inactive:hover {
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
<header class="w-full max-w-2xl text-center mb-6">
        <h1 class="text-2xl md:text-3xl font-extrabold text-cyan-800 mb-2 uppercase drop-shadow-sm">
            <i class="fas fa-square-root-alt mr-2"></i>√în t·∫≠p Chinh Ph·ª•c To√°n 7 HK1 - C√¢u 1
        </h1>
        <p class="text-cyan-600 font-medium">Ch·ªß ƒë·ªÅ: CƒÉn b·∫≠c hai s·ªë h·ªçc</p>
    </header>

    <!-- Mode Selection -->
    <div class="w-full max-w-2xl grid grid-cols-3 gap-2 mb-6">
        <button onclick="setMode('all')" id="btn-mode-all" class="mode-active py-2 px-2 rounded-lg font-bold border-2 shadow-sm text-sm md:text-base">
            <i class="fas fa-random mr-1"></i> T·ªïng H·ª£p
        </button>
        <button onclick="setMode('calc')" id="btn-mode-calc" class="mode-inactive py-2 px-2 rounded-lg font-bold border-2 shadow-sm text-sm md:text-base">
            <i class="fas fa-calculator mr-1"></i> T√≠nh to√°n
        </button>
        <button onclick="setMode('theory')" id="btn-mode-theory" class="mode-inactive py-2 px-2 rounded-lg font-bold border-2 shadow-sm text-sm md:text-base">
            <i class="fas fa-book mr-1"></i> L√Ω thuy·∫øt
        </button>
    </div>

    <!-- Stats Board -->
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-md p-4 mb-6 grid grid-cols-4 gap-2 text-center select-none" id="stats-container">
        <!-- Rendered by JS -->
    </div>

    <!-- Question Card -->
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg border-b-4 border-cyan-600 p-6 relative overflow-hidden">
        
        <!-- Question Badge -->
        <div class="absolute top-0 left-0 bg-cyan-100 text-cyan-800 px-3 py-1 rounded-br-lg text-xs font-bold uppercase" id="question-type-badge">
            D·∫°ng c√¢u h·ªèi
        </div>

        <!-- Question Content -->
        <div class="mt-4 mb-8 fade-in">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 text-center leading-relaxed" id="question-text">
                ƒêang t·∫£i c√¢u h·ªèi...
            </h2>
        </div>

        <!-- Options Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-container">
            <!-- Buttons will be injected here -->
        </div>

        <!-- Explanation Area -->
        <div id="explanation-area" class="hidden mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg text-gray-700 text-sm md:text-base fade-in">
             <!-- JS will inject content -->
        </div>

        <!-- Feedback & Next -->
        <div class="mt-6 h-12 flex items-center justify-between">
            <div id="feedback-msg" class="text-lg font-bold hidden pl-2"></div>
            <button onclick="handleNextClick()" id="btn-next" class="bg-white border border-gray-300 text-gray-600 px-6 py-2 rounded-full font-bold hover:bg-gray-100 transition flex items-center ml-auto shadow-sm">
                B·ªè qua <i class="fas fa-forward ml-2"></i>
            </button>
        </div>
    </div>

    <footer class="mt-auto py-6 text-center text-gray-400 text-xs">
        ¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io
    </footer>

    <!-- Feedback Modal (Overlay) -->
    <div id="feedback-overlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 text-center relative">
            <div id="feedback-icon" class="text-6xl mb-4"></div>
            <h3 id="feedback-title" class="text-2xl font-bold mb-2"></h3>
            <p id="feedback-message" class="text-gray-700 mb-4 text-lg font-medium"></p>
            <div class="bg-blue-50 p-4 rounded-xl text-left mb-6">
                <p class="text-xs text-blue-500 font-bold uppercase mb-1">Gi·∫£i th√≠ch:</p>
                <div id="feedback-detail" class="text-gray-800 text-sm leading-relaxed"></div>
            </div>
            <button onclick="closeModal()" class="w-full py-3 bg-cyan-600 text-white font-bold rounded-xl shadow-lg hover:bg-cyan-700 transition transform hover:-translate-y-1">
                ƒê√≥ng ƒë·ªÉ xem l·∫°i <i class="fas fa-times ml-2"></i>
            </button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const state = {
            mode: 'all', // all, calc, theory
            streak: 0,
            correct: 0,
            wrong: 0,
            skipped: 0,
            currentQuestion: null,
            isAnswered: false
        };

        // --- UTILS ---
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const formatVN = (n) => {
            if (n === undefined || n === null) return "";
            if (typeof n === 'string') {
                return n.replace('.', ',');
            }
            let parts = n.toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            return parts.join(',');
        };

        // --- DATA BANKS ---
        const refCalculations = [
            { num: 64, sqrt: 8 }, { num: 1.21, sqrt: 1.1 }, { num: 16, sqrt: 4 },
            { num: 9, sqrt: 3 }, { num: 25, sqrt: 5 }, { num: 36, sqrt: 6 },
            { num: 4, sqrt: 2 }, { num: 49, sqrt: 7 }, { num: 100, sqrt: 10 },
            { num: 81, sqrt: 9 }
        ];

        const devCalculations = [
            { num: 0, sqrt: 0 }, { num: 144, sqrt: 12 }, { num: 121, sqrt: 11 },
            { num: 225, sqrt: 15 }, { num: 0.01, sqrt: 0.1 }, { num: 0.04, sqrt: 0.2 },
            { num: "1/4", sqrt: "1/2", isFraction: true }, { num: "4/9", sqrt: "2/3", isFraction: true },
            { num: "25/16", sqrt: "5/4", isFraction: true }
        ];

        // --- GENERATORS ---

        // D·∫†NG 1: T√çNH GI√Å TR·ªä CƒÇN B·∫¨C HAI S·ªê H·ªåC (C≈®)
        const generateCalculationQ = () => {
            const isReference = Math.random() < 0.7;
            let dataItem;
            if (isReference) dataItem = refCalculations[randomInt(0, refCalculations.length - 1)];
            else dataItem = devCalculations[randomInt(0, devCalculations.length - 1)];

            const { num, sqrt, isFraction } = dataItem;
            const displayNum = formatVN(num);
            let questionText;
            if (Math.random() < 0.6) questionText = `CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa <b>${displayNum}</b> l√†:`;
            else questionText = `Gi√° tr·ªã c·ªßa \\(\\sqrt{${displayNum}}\\) l√†:`;

            let rawCorrect = sqrt;
            let rawDistractors = [];
            if (isFraction) {
                let [tu, mau] = num.split('/').map(Number);
                rawDistractors.push(`-${sqrt}`); 
                rawDistractors.push(num); 
                rawDistractors.push(`${tu*tu}/${mau*mau}`); 
            } else {
                rawDistractors.push(typeof sqrt === 'number' ? -sqrt : `-${sqrt}`);
                rawDistractors.push(num);
                if (num === 1.21) rawDistractors.push(0.11); 
                else if (num === 0.01) rawDistractors.push(0.001);
                else rawDistractors.push(Math.floor(num/2));
                if (num === 0) rawDistractors = [1, -1, "Kh√¥ng x√°c ƒë·ªãnh"];
            }

            rawDistractors = rawDistractors.filter(d => d != rawCorrect);
            while(rawDistractors.length < 3) {
                let r = randomInt(1, 20);
                if (r != rawCorrect && !rawDistractors.includes(r)) rawDistractors.push(r);
            }
            rawDistractors = rawDistractors.slice(0, 3);

            const formattedCorrect = formatVN(rawCorrect);
            const formattedDistractors = rawDistractors.map(d => formatVN(d));
            const allOptions = shuffleArray([formattedCorrect, ...formattedDistractors]);
            const explanation = `V√¨ $(${formattedCorrect})^2 = ${displayNum}$ v√† ${formattedCorrect} $\\ge$ 0 n√™n cƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa ${displayNum} l√† <b>${formattedCorrect}</b>.`;

            return {
                typeLabel: "T√≠nh to√°n gi√° tr·ªã",
                text: questionText,
                correct: formattedCorrect,
                options: allOptions,
                explanation: explanation
            };
        };

        // --- C√ÅC D·∫†NG L√ù THUY·∫æT M·ªöI & C≈® ---

        const generateTheoryQ = () => {
            // TƒÉng s·ªë l∆∞·ª£ng d·∫°ng:
            // 1. ƒê·ªãnh nghƒ©a (C≈©)
            // 2. K√Ω hi·ªáu (C≈©)
            // 3. New Type 1: ƒêi·ªÅu ki·ªán c·ªßa x
            // 4. New Type 2: Quan h·ªá a, b (t√¨m c√¢u sai)
            // 5. New Type 3: Nh·∫≠n ƒë·ªãnh I, II
            // 6. New Type 4: ƒê√∫ng/Sai (Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng/sai)

            const type = randomInt(1, 6);
            let question, correct, options, explanation, typeLabel;

            // D·∫°ng 1 & 2: ƒê·ªãnh nghƒ©a v√† K√Ω hi·ªáu c∆° b·∫£n (Gi·ªØ l·∫°i t·ª´ phi√™n b·∫£n c≈©)
            if (type === 1) {
                typeLabel = "L√Ω thuy·∫øt: ƒê·ªãnh nghƒ©a";
                question = "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa s·ªë \\(a\\) kh√¥ng √¢m l√†:";
                correct = "S·ªë \\(x \\ge 0\\) sao cho \\(x^2 = a\\)";
                options = shuffleArray([
                    correct,
                    "S·ªë \\(x\\) sao cho \\(x^2 = a\\)", 
                    "S·ªë \\(x > 0\\) sao cho \\(x^2 = a\\)", 
                    "Ch√≠nh s·ªë \\(a\\)"
                ]);
                explanation = "ƒê·ªãnh nghƒ©a: V·ªõi s·ªë d∆∞∆°ng $a$, s·ªë $\\sqrt{a}$ ƒë∆∞·ª£c g·ªçi l√† cƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa $a$. $x$ ph·∫£i kh√¥ng √¢m.";
            } 
            else if (type === 2) {
                typeLabel = "L√Ω thuy·∫øt: K√Ω hi·ªáu";
                question = "Cho s·ªë th·ª±c \\(a > 0\\). CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa \\(a\\) ƒë∆∞·ª£c k√≠ hi·ªáu l√†:";
                correct = "\\(\\sqrt{a}\\)";
                options = shuffleArray([
                    correct,
                    "\\(-\\sqrt{a}\\)",
                    "\\(\\sqrt{a^2}\\)",
                    "\\(a^2\\)"
                ]);
                explanation = "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa s·ªë kh√¥ng √¢m $a$ ƒë∆∞·ª£c k√≠ hi·ªáu l√† $\\sqrt{a}$.";
            }
            // D·∫°ng 3 (M·ªõi): ƒêi·ªÅu ki·ªán chi ti·∫øt c·ªßa x
            else if (type === 3) {
                typeLabel = "L√Ω thuy·∫øt: ƒêi·ªÅu ki·ªán";
                question = "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa s·ªë th·ª±c $a$ kh√¥ng √¢m l√† s·ªë $x$ th·ªèa m√£n ƒëi·ªÅu ki·ªán n√†o sau ƒë√¢y?";
                correct = "$x \\geq 0$ v√† $x^2=a$";
                options = shuffleArray([
                    correct,
                    "$x < 0$ v√† $x^2=a$",
                    "$x > 0$ v√† $x^2=a$", // Sai v√¨ thi·∫øu s·ªë 0
                    "$x \\geq 0$ v√† $x=a^2$" // Sai c√¥ng th·ª©c
                ]);
                explanation = "Theo ƒë·ªãnh nghƒ©a, cƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa $a$ l√† s·ªë $x$ sao cho $x$ kh√¥ng √¢m ($x \\ge 0$) v√† b√¨nh ph∆∞∆°ng c·ªßa n√≥ b·∫±ng $a$ ($x^2 = a$).";
            }
            // D·∫°ng 4 (M·ªõi): Quan h·ªá bi·∫øn a, b (T√¨m c√¢u sai)
            else if (type === 4) {
                typeLabel = "L√Ω thuy·∫øt: Quan h·ªá bi·∫øn";
                question = "Bi·∫øt $b$ l√† cƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa $a$ ($a \\ge 0$), kh·∫≥ng ƒë·ªãnh n√†o d∆∞·ªõi ƒë√¢y l√† <b>SAI</b>?";
                correct = "$b=a^2$"; // ƒê√¢y l√† c√¢u sai
                options = shuffleArray([
                    correct,
                    "$b=\\sqrt{a}$", // ƒê√∫ng
                    "$a=b^2$",       // ƒê√∫ng
                    "$a \\geq 0$ v√† $b \\geq 0$" // ƒê√∫ng
                ]);
                explanation = "V√¨ $b$ l√† cƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa $a$ n√™n $b = \\sqrt{a}$ v√† $b^2 = a$. Kh·∫≥ng ƒë·ªãnh $b = a^2$ l√† sai (tr·ª´ khi $a=0$ ho·∫∑c $a=1$).";
            }
            // D·∫°ng 5 (M·ªõi): Ph√¢n t√≠ch nh·∫≠n ƒë·ªãnh (I) v√† (II)
            else if (type === 5) {
                typeLabel = "L√Ω thuy·∫øt: Ph√¢n t√≠ch";
                // Sinh ng·∫´u nhi√™n s·ªë li·ªáu ƒë·ªÉ c√¢u h·ªèi phong ph√∫
                const nums = [
                    {n: "0,25", root: "0,5"},
                    {n: "0,49", root: "0,7"},
                    {n: "0,04", root: "0,2"},
                    {n: "100", root: "10"}
                ];
                const item = nums[randomInt(0, nums.length - 1)];
                
                question = `CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa ${item.n} l√†:<br>
                (I): $-${item.root}$ v√¨ $(-${item.root})^2=${item.n}$.<br>
                (II): $${item.root}$ v√¨ $(${item.root})^2=${item.n}$.<br>
                Ch·ªçn nh·∫≠n ƒë·ªãnh ƒë√∫ng.`;
                
                correct = "(II) ƒë√∫ng, (I) sai";
                options = shuffleArray([
                    correct,
                    "(I) ƒë√∫ng, (II) sai",
                    "(I), (II) ƒë·ªÅu sai",
                    "(I), (II) ƒë·ªÅu ƒë√∫ng"
                ]);
                explanation = `CƒÉn b·∫≠c hai s·ªë h·ªçc b·∫Øt bu·ªôc ph·∫£i l√† s·ªë kh√¥ng √¢m. Do ƒë√≥ ch·ªâ c√≥ (II) l√† ƒë√∫ng v√¨ ${item.root} > 0. (I) sai v√¨ gi√° tr·ªã √¢m kh√¥ng ph·∫£i l√† cƒÉn b·∫≠c hai s·ªë h·ªçc.`;
            }
            // D·∫°ng 6 (M·ªõi): Kh·∫≥ng ƒë·ªãnh ƒê√∫ng/Sai
            else {
                typeLabel = "L√Ω thuy·∫øt: ƒê√∫ng/Sai";
                // Ch·ªçn ng·∫´u nhi√™n ki·ªÉu h·ªèi: "T√¨m c√¢u ƒê√öNG" ho·∫∑c "T√¨m c√¢u SAI"
                const askTrue = Math.random() < 0.5;
                
                const trueStmts = [
                    "N·∫øu $\\sqrt{a}=7$ th√¨ $a=49$",
                    "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa 81 l√† 9",
                    "S·ªë $-16$ kh√¥ng c√≥ cƒÉn b·∫≠c hai s·ªë h·ªçc",
                    "$\\sqrt{0} = 0$"
                ];
                
                const falseStmts = [
                    "$\\sqrt{36} = \\pm 6$",
                    "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa 4 l√† -2",
                    "S·ªë √¢m c√≥ cƒÉn b·∫≠c hai s·ªë h·ªçc",
                    "$\\sqrt{(-5)^2} = -5$"
                ];

                if (askTrue) {
                    question = "Trong c√°c kh·∫≥ng ƒë·ªãnh sau, kh·∫≥ng ƒë·ªãnh n√†o <b>ƒê√öNG</b>?";
                    correct = trueStmts[randomInt(0, trueStmts.length - 1)];
                    // L·∫•y 3 c√¢u sai l√†m nhi·ªÖu
                    let distractors = shuffleArray([...falseStmts]).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    explanation = `Kh·∫≥ng ƒë·ªãnh "<b>${correct}</b>" l√† ƒë√∫ng. C√°c kh·∫≥ng ƒë·ªãnh c√≤n l·∫°i sai do vi ph·∫°m ƒë·ªãnh nghƒ©a cƒÉn b·∫≠c hai s·ªë h·ªçc (ph·∫£i kh√¥ng √¢m, s·ªë √¢m kh√¥ng c√≥ cƒÉn...).`;
                } else {
                    question = "Trong c√°c kh·∫≥ng ƒë·ªãnh sau, kh·∫≥ng ƒë·ªãnh n√†o <b>SAI</b>?";
                    correct = falseStmts[randomInt(0, falseStmts.length - 1)];
                    // L·∫•y 3 c√¢u ƒë√∫ng l√†m nhi·ªÖu
                    let distractors = shuffleArray([...trueStmts]).slice(0, 3);
                    options = shuffleArray([correct, ...distractors]);
                    explanation = `Kh·∫≥ng ƒë·ªãnh "<b>${correct}</b>" l√† sai. CƒÉn b·∫≠c hai s·ªë h·ªçc lu√¥n tr·∫£ v·ªÅ k·∫øt qu·∫£ kh√¥ng √¢m v√† ch·ªâ t·ªìn t·∫°i v·ªõi s·ªë kh√¥ng √¢m.`;
                }
            }

            return {
                typeLabel: typeLabel,
                text: question,
                correct: correct,
                options: options,
                explanation: explanation
            };
        };

        // --- CORE FUNCTIONS ---

        const renderStats = () => {
            const container = document.getElementById('stats-container');
            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span class="text-3xl font-extrabold ${state.streak > 2 ? 'streak-fire' : 'text-gray-800'}">
                        ${state.streak > 2 ? '<i class="fas fa-fire"></i> ' : ''}${state.streak}
                    </span>
                </div>
                <div class="flex flex-col items-center border-l">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span class="text-xl font-bold text-green-600">${state.correct}</span>
                </div>
                <div class="flex flex-col items-center border-l">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span class="text-xl font-bold text-red-500">${state.wrong}</span>
                </div>
                <div class="flex flex-col items-center border-l">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span class="text-xl font-bold text-gray-400">${state.skipped}</span>
                </div>
            `;
        };

        const setMode = (mode) => {
            state.mode = mode;
            ['all', 'calc', 'theory'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if (m == mode) {
                    btn.className = "mode-active py-2 px-2 rounded-lg font-bold border-2 shadow-sm transform scale-105 transition text-sm md:text-base";
                } else {
                    btn.className = "mode-inactive py-2 px-2 rounded-lg font-bold border-2 shadow-sm transition text-sm md:text-base";
                }
            });
            handleNextClick(true);
        };

        const loadQuestion = () => {
            state.isAnswered = false;
            let qData;
            
            let selectedMode = state.mode;
            
            if (state.mode === 'all') {
                selectedMode = Math.random() < 0.5 ? 'calc' : 'theory'; 
            }

            if (selectedMode == 'calc') qData = generateCalculationQ();
            else qData = generateTheoryQ();

            state.currentQuestion = qData;

            // Render UI
            document.getElementById('question-type-badge').innerText = qData.typeLabel;
            document.getElementById('question-text').innerHTML = qData.text;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            qData.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "btn-option w-full bg-cyan-50 hover:bg-cyan-100 text-cyan-900 border border-cyan-200 p-4 rounded-xl text-lg font-semibold shadow-sm text-left flex items-center group";
                
                // QUAN TR·ªåNG: L∆∞u gi√° tr·ªã c·ªßa n√∫t ƒë·ªÉ so s√°nh sau n√†y
                btn.dataset.value = opt; 

                const labels = ['A', 'B', 'C', 'D'];
                btn.innerHTML = `<span class="inline-block w-8 h-8 rounded-full bg-cyan-200 text-center leading-8 mr-3 text-cyan-800 font-bold shadow-sm group-hover:bg-cyan-600 group-hover:text-white transition flex-shrink-0">${labels[index]}</span> <span>${opt}</span>`;
                
                btn.onclick = () => checkAnswer(opt, btn);
                optionsContainer.appendChild(btn);
            });

            // Reset footer & Feedback
            document.getElementById('feedback-msg').className = "hidden";
            document.getElementById('explanation-area').className = "hidden mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg text-gray-700 text-sm md:text-base fade-in";
            document.getElementById('explanation-area').innerHTML = '';
            
            const btnNext = document.getElementById('btn-next');
            btnNext.innerHTML = 'B·ªè qua <i class="fas fa-forward ml-2"></i>';
            btnNext.className = "bg-white border border-gray-300 text-gray-600 px-6 py-2 rounded-full font-bold hover:bg-gray-100 transition flex items-center ml-auto shadow-sm";

            // Trigger MathJax render
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        };

        const checkAnswer = (selectedVal, btnElement) => {
            if (state.isAnswered) return;
            state.isAnswered = true;

            const isCorrect = selectedVal == state.currentQuestion.correct;
            const feedbackEl = document.getElementById('feedback-msg');
            const explArea = document.getElementById('explanation-area');
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('feedback-icon');
            const title = document.getElementById('feedback-title');
            const msg = document.getElementById('feedback-message');
            const detail = document.getElementById('feedback-detail');

            // Disable all buttons
            const allBtns = document.querySelectorAll('.btn-option');
            allBtns.forEach(b => {
                b.disabled = true;
                b.classList.add('opacity-70');
            });

            // --- T√åM V√Ä T√î ƒê·∫¨M ƒê√ÅP √ÅN ƒê√öNG ---
            const correctBtn = Array.from(allBtns).find(b => b.dataset.value === state.currentQuestion.correct);
            
            if (correctBtn) {
                correctBtn.classList.remove('bg-cyan-50', 'text-cyan-900', 'border-cyan-200', 'opacity-70');
                correctBtn.classList.add('bg-green-100', 'text-green-800', 'border-green-600', 'border-2', 'opacity-100');
                const span = correctBtn.querySelector('span'); // Label
                if(span) {
                    span.classList.remove('bg-cyan-200', 'text-cyan-800');
                    span.classList.add('bg-green-600', 'text-white');
                }
            }

            // X·ª≠ l√Ω n√∫t ng∆∞·ªùi d√πng ch·ªçn
            if (isCorrect) {
                btnElement.classList.add('bg-green-500', 'text-white', 'pop', 'opacity-100');
                btnElement.classList.remove('bg-green-100', 'text-green-800'); 
                const span = btnElement.querySelector('span'); // Label
                if(span) span.classList.add('bg-white', 'text-green-600');

                feedbackEl.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> Ch√≠nh x√°c!</span>`;
                feedbackEl.className = "text-lg font-bold block pl-2 animate-bounce";
                
                state.streak++;
                state.correct++;
            } else {
                btnElement.classList.add('bg-red-500', 'text-white', 'border-red-600', 'shake', 'opacity-100');
                btnElement.classList.remove('bg-cyan-50');
                const span = btnElement.querySelector('span'); // Label
                if(span) span.classList.add('bg-white', 'text-red-600');
                
                feedbackEl.innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> Ch∆∞a ƒë√∫ng!</span>`;
                feedbackEl.className = "text-lg font-bold block pl-2";

                state.streak = 0;
                state.wrong++;

                // Setup Modal
                icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                title.innerText = "Ch∆∞a ch√≠nh x√°c";
                title.className = "text-2xl font-bold mb-2 text-red-600";
                msg.innerHTML = `ƒê√°p √°n ƒë√∫ng l√†: <br><span class="text-green-600 font-bold text-xl">${state.currentQuestion.correct}</span>`;
                
                // Show modal after delay
                setTimeout(() => { overlay.classList.remove('hidden'); MathJax.typesetPromise(); }, 600);
            }

            renderStats();

            // Hi·ªÉn th·ªã gi·∫£i th√≠ch inline
            explArea.innerHTML = `<p class="font-bold text-cyan-800 mb-1"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Gi·∫£i th√≠ch chi ti·∫øt:</p> ${state.currentQuestion.explanation}`;
            explArea.classList.remove('hidden');

            // Setup Modal Detail
            detail.innerHTML = state.currentQuestion.explanation;

            // Update Next Button
            const btnNext = document.getElementById('btn-next');
            btnNext.innerHTML = `Ti·∫øp theo <i class="fas fa-arrow-right ml-2"></i>`;
            btnNext.className = "bg-cyan-600 text-white px-6 py-2 rounded-full font-bold hover:bg-cyan-700 transition flex items-center ml-auto shadow-lg transform scale-105";

            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        };

        const handleNextClick = (forceSkip = false) => {
            if (!state.isAnswered && !forceSkip) {
                // Logic B·ªè qua
                state.streak = 0;
                state.skipped++;
                renderStats();
            }
            loadQuestion();
        };

        const closeModal = () => {
            document.getElementById('feedback-overlay').classList.add('hidden');
        };

        // Init
        window.onload = () => {
            renderStats();
            loadQuestion();
        }

    </script>
</body>
</html>