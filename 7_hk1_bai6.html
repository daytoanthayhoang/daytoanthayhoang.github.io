<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p chinh ph·ª•c To√°n 7 HK1 - B√†i 6 (ƒê∆∞·ªùng th·∫≥ng song song)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Chalkboard Style */
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
            z-index: 1;
        }

        /* SVG Line Drawing */
        .geo-svg {
            width: 100%;
            height: 220px;
            margin: 0 auto;
            display: block;
            z-index: 2;
        }
        .geo-line { stroke: white; stroke-width: 2.5; stroke-linecap: round; }
        .geo-text { font-size: 14px; font-weight: 800; font-family: 'Nunito', sans-serif; text-shadow: 1px 1px 2px #000; }
        .geo-point { fill: #f87171; stroke: #fff; stroke-width: 1; }
        .geo-arc { fill: none; stroke-width: 2; stroke-linecap: round; }

        /* Step Animation */
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        #steps-container::-webkit-scrollbar { width: 8px; }
        #steps-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Stats & Effects */
        .streak-fire { color: #ef4444; animation: burn 0.5s infinite alternate; }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box { transition: all 0.3s ease; }
        .stats-box:hover { transform: translateY(-2px); }
        
        mjx-container { font-size: 110% !important; }

        .hint-box {
            border-left: 4px solid #f59e0b;
            background-color: #fffbeb;
            color: #92400e;
            margin-bottom: 12px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 relative shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-xl md:text-2xl font-extrabold text-white uppercase tracking-wider">
                    <i class="fas fa-shapes mr-2"></i>√în t·∫≠p chinh ph·ª•c To√°n 7 HK1 - B√†i 6
                </h1>
                <p class="text-blue-200 font-medium text-sm">Ch·ªß ƒë·ªÅ: ƒê∆∞·ªùng th·∫≥ng song song & Ti√™n ƒë·ªÅ Euclid</p>
            </div>
            
            <button class="bg-white/10 text-white border border-white/40 px-4 py-2 rounded-lg font-bold text-sm transition-all flex items-center gap-2 group cursor-default opacity-80">
                <i class="fas fa-file-pdf"></i>
                <span>T√†i li·ªáu (S·∫Øp c√≥)</span>
            </button>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-4 min-h-[350px] relative">
                         <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            H√¨nh minh h·ªça
                        </div>
                        
                        <!-- Geometry SVG Render Area -->
                        <div id="geo-canvas" class="mt-4 mb-2 flex justify-center items-center">
                            <!-- SVG will be injected here -->
                        </div>

                        <div id="question-text" class="text-white text-base md:text-lg font-medium leading-relaxed font-sans px-2 tracking-wide border-t border-white/10 pt-2">
                            ƒêang t·∫£i ƒë·ªÅ b√†i...
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        
                        <!-- Control Row: Type & Hard Mode -->
                        <div class="flex flex-wrap justify-between items-center mb-4 pb-3 border-b border-gray-200 gap-2">
                             <div class="flex items-center gap-2 flex-grow">
                                <label class="text-[10px] font-bold text-gray-400 uppercase whitespace-nowrap">D·∫°ng to√°n:</label>
                                <select id="problem-type" class="text-xs font-bold p-1.5 rounded border-gray-300 focus:ring-indigo-500 bg-white w-full max-w-[220px]" onchange="nextQuestion()">
                                    <option value="random">üé≤ Ng·∫´u nhi√™n (50/50)</option>
                                    <option value="calc">üìê T√≠nh g√≥c (Xu√¥i)</option>
                                    <option value="prove">üõ°Ô∏è Ch·ª©ng minh (Ng∆∞·ª£c)</option>
                                </select>
                            </div>

                            <label class="inline-flex items-center cursor-pointer select-none shrink-0" title="B·∫≠t ch·∫ø ƒë·ªô b√†i to√°n l·∫Øt l√©o (G√≥c kh√¥ng ƒë·∫πp, v·ªã tr√≠ kh√≥)">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-xs font-bold text-gray-600 peer-checked:text-red-600 flex items-center">
                                    <i class="fas fa-skull-crossbones mr-1"></i>V·∫≠n d·ª•ng
                                </span>
                            </label>
                        </div>

                        <!-- Answer Input -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-4">
                            <label class="block text-gray-400 font-bold text-xs uppercase mb-2" id="label-final-req">K·∫øt qu·∫£:</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="ans-final" placeholder="Nh·∫≠p s·ªë ƒëo..." class="flex-grow text-center font-bold text-xl p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none transition-colors">
                                <span id="unit-display" class="font-bold text-gray-500 bg-gray-100 p-2 rounded border border-gray-200 min-w-[60px] text-center">ƒë·ªô</span>
                            </div>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <div id="feedback" class="hidden mt-3 text-center p-2 rounded-lg text-sm font-bold"></div>
                        <div id="hint-warning" class="hidden mt-2 text-center text-xs text-amber-600 font-semibold bg-amber-50 p-1 rounded border border-amber-200">
                            <i class="fas fa-lock mr-1"></i>ƒê√£ xem h∆∞·ªõng d·∫´n: Th√†nh t√≠ch c√¢u n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh.
                        </div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[600px] lg:h-[750px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>H∆∞·ªõng d·∫´n gi·∫£i</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Hint Box -->
                    <div id="hint-box" class="hidden hint-box p-3 rounded-lg text-sm shadow-sm">
                        <div class="font-bold flex items-center gap-2 mb-1">
                            <i class="fas fa-lightbulb text-amber-500"></i> G·ª£i √Ω:
                        </div>
                        <div id="hint-content"></div>
                    </div>

                    <!-- Steps Content -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "H∆∞·ªõng d·∫´n gi·∫£i" ƒë·ªÉ xem b√†i l√†m m·∫´u t·ª´ng b∆∞·ªõc</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- Game State ---
        let currentProblem = {};
        let stepIndex = 0;
        let isAnswered = false;
        
        // Stats
        let streak = 0;
        let correctTotal = 0;
        let wrongTotal = 0;
        let skippedTotal = 0;
        let statsEnabled = true;

        // --- Utils ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function updateStatsUI() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = streak;
            document.getElementById('stat-correct').textContent = correctTotal;
            document.getElementById('stat-wrong').textContent = wrongTotal;
            document.getElementById('stat-skipped').textContent = skippedTotal;

            if (!statsEnabled) {
                document.getElementById('hint-warning').classList.remove('hidden');
            } else {
                document.getElementById('hint-warning').classList.add('hidden');
            }

            if (streak > 2) {
                streakEl.classList.add('streak-fire');
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${streak}`;
            } else {
                streakEl.classList.remove('streak-fire');
                streakEl.textContent = streak;
            }
        }
        
        function disableStats() {
            if (statsEnabled) {
                statsEnabled = false;
                updateStatsUI();
            }
        }

        // --- GEOMETRY ENGINE ---

        // Map angle indices to their geometric properties
        const posMap = {
            1: "G√≥c tr√™n b√™n tr√°i",
            2: "G√≥c tr√™n b√™n ph·∫£i",
            3: "G√≥c d∆∞·ªõi b√™n ph·∫£i",
            4: "G√≥c d∆∞·ªõi b√™n tr√°i"
        };

        const relations = {
            'soletrong': [[4, 2], [3, 1]], 
            'dongvi': [[1, 1], [2, 2], [3, 3], [4, 4]], 
            'trongcungphia': [[4, 1], [3, 2]], 
            'doidinh': [[1, 3], [2, 4]], 
            'kebu': [[1, 2], [2, 3], [3, 4], [4, 1]] 
        };

        function getRelation(idxA, idxB) {
            if ((idxA === 4 && idxB === 2) || (idxA === 3 && idxB === 1)) return "soletrong";
            if (idxA === idxB) return "dongvi";
            if ((idxA === 4 && idxB === 1) || (idxA === 3 && idxB === 2)) return "trongcungphia";
            if ((idxA === 1 && idxB === 3) || (idxA === 2 && idxB === 4)) return "solengoai";
            return "unknown";
        }

        // IMPROVED GEOMETRY DRAWING WITH VECTOR MATH
        function drawGeometrySVG(angleA2, labelA, labelB, line1Name, line2Name) {
            // angleA2: The true value of Top-Right Angle.
            
            const width = 300;
            const height = 220;
            const y1 = 70;  // Line 1
            const y2 = 150; // Line 2
            const midX = width / 2;

            // 1. Calculate Coordinates
            const s = 60; // Slant offset
            let xTop, xBot;

            if (angleA2 < 90) {
                // Shape / (Acute TR) -> Top is Right of Bot (Wait, no)
                // If angle TR < 90, ray UP and ray RIGHT form acute.
                // Vector UP is Top-Right. Line goes Bot-Left to Top-Right.
                // So Top Point x > Bot Point x.
                // Shape /
                xTop = midX + s; 
                xBot = midX - s;
            } else {
                // Shape \ (Obtuse TR) -> Top is Left of Bot
                xTop = midX - s;
                xBot = midX + s;
            }

            // Extend the line
            const slope = (y2 - y1) / (xBot - xTop); 
            const extY_Top = y1 - 45;
            const extY_Bot = y2 + 45;
            const extX_Top = (extY_Top - y1) / slope + xTop;
            const extX_Bot = (extY_Bot - y2) / slope + xBot;

            // 2. Helper: Draw Arc and Label using Vector Bisectors
            const drawAngle = (cx, cy, idx, isTop) => {
                const isActive = (isTop && idx === labelA) || (!isTop && idx === labelB);
                const color = isActive ? "#fbbf24" : "rgba(255,255,255,0.3)";
                const textColor = isActive ? "#fbbf24" : "rgba(255,255,255,0.5)";
                const textWeight = isActive ? "800" : "400";
                
                // Define Vectors for the two rays of the angle
                // Line Vector (Top to Bot): V_line = (xBot-xTop, y2-y1)
                // Horizontal Vector (Right): V_horz = (1, 0)
                
                let v1, v2; // Two vectors forming the angle
                const dx = xBot - xTop;
                const dy = y2 - y1;

                // Normalize helper
                const norm = (v) => { const l = Math.sqrt(v.x*v.x + v.y*v.y); return {x:v.x/l, y:v.y/l}; };

                if (idx === 1) { // TL: Left & Up
                    v1 = {x:-1, y:0}; 
                    v2 = {x:-dx, y:-dy}; // Vector Bot->Top
                }
                if (idx === 2) { // TR: Up & Right
                    v1 = {x:-dx, y:-dy}; // Vector Bot->Top
                    v2 = {x:1, y:0}; 
                }
                if (idx === 3) { // BR: Right & Down
                    v1 = {x:1, y:0}; 
                    v2 = {x:dx, y:dy}; // Vector Top->Bot
                }
                if (idx === 4) { // BL: Down & Left
                    v1 = {x:dx, y:dy}; // Vector Top->Bot
                    v2 = {x:-1, y:0}; 
                }
                
                // Bisector = V1_norm + V2_norm
                const nv1 = norm(v1);
                const nv2 = norm(v2);
                const bisect = {x: nv1.x + nv2.x, y: nv1.y + nv2.y};
                
                // Calculate Label Pos
                const labelDist = 40;
                // If bisect is 0 (180 deg), handle edge case? Won't happen here.
                const nb = norm(bisect);
                const lx = cx + nb.x * labelDist;
                const ly = cy + nb.y * labelDist;

                // Draw Arc (only if active)
                let arcPath = "";
                if (isActive) {
                    const r = 25;
                    const ang1 = Math.atan2(v1.y, v1.x);
                    const ang2 = Math.atan2(v2.y, v2.x);
                    
                    // Arc drawing logic usually needs angles in order
                    // We simply draw from ang1 to ang2. 
                    // Need to check direction to ensure small angle (not reflex)
                    let diff = ang2 - ang1;
                    while (diff <= -Math.PI) diff += 2*Math.PI;
                    while (diff > Math.PI) diff -= 2*Math.PI;
                    
                    // If diff is positive, sweep flag 1? 
                    // Let's use simpler SVG arc command
                    const sx = cx + r * Math.cos(ang1);
                    const sy = cy + r * Math.sin(ang1);
                    const ex = cx + r * Math.cos(ang2);
                    const ey = cy + r * Math.sin(ang2);
                    
                    // Sweep flag: 0 if counter-clockwise (smaller), 1 if clockwise?
                    // We want the interior angle (<180).
                    const sweep = (diff > 0) ? 1 : 0; 
                    // Wait, standard SVG A rx ry rot large sweep x y
                    // Let's force it:
                    
                    // Alternative: Compute intermediate point to be sure
                    const mx = cx + r * nb.x;
                    const my = cy + r * nb.y;
                    
                    arcPath = `<path d="M ${sx} ${sy} Q ${mx} ${my} ${ex} ${ey}" fill="none" stroke="${color}" stroke-width="2" />`;
                }

                return `
                    ${arcPath}
                    <text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="${textColor}" font-weight="${textWeight}" font-size="14" font-family="Nunito">
                        ${isTop ? 'A' : 'B'}<tspan dy="4" font-size="10">${idx}</tspan>
                    </text>
                `;
            };

            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${height}" class="geo-svg">
                <!-- Lines -->
                <line x1="20" y1="${y1}" x2="${width-20}" y2="${y1}" class="geo-line" />
                <text x="${width-25}" y="${y1-10}" fill="white" font-size="16" font-style="italic" font-weight="bold">${line1Name}</text>

                <line x1="20" y1="${y2}" x2="${width-20}" y2="${y2}" class="geo-line" />
                <text x="${width-25}" y="${y2-10}" fill="white" font-size="16" font-style="italic" font-weight="bold">${line2Name}</text>

                <!-- Transversal -->
                <line x1="${extX_Top}" y1="${extY_Top}" x2="${extX_Bot}" y2="${extY_Bot}" class="geo-line" />
                <text x="${extX_Top}" y="${extY_Top-5}" fill="white" font-size="14" font-style="italic">c</text>

                <!-- Labels & Arcs A -->
                ${drawAngle(xTop, y1, 1, true)}
                ${drawAngle(xTop, y1, 2, true)}
                ${drawAngle(xTop, y1, 3, true)}
                ${drawAngle(xTop, y1, 4, true)}

                <!-- Labels & Arcs B -->
                ${drawAngle(xBot, y2, 1, false)}
                ${drawAngle(xBot, y2, 2, false)}
                ${drawAngle(xBot, y2, 3, false)}
                ${drawAngle(xBot, y2, 4, false)}

                <!-- Intersection Dots -->
                <circle cx="${xTop}" cy="${y1}" r="3" class="geo-point" />
                <circle cx="${xBot}" cy="${y2}" r="3" class="geo-point" />
            </svg>`;
        }

        // --- PROBLEM GENERATOR ---

        function generateGeometryProblem() {
            const typeSelect = document.getElementById('problem-type').value;
            const isHardMode = document.getElementById('mode-hard').checked;

            // Randomize Line Names
            const linePairs = [['x', 'y'], ['a', 'b'], ['m', 'n'], ['u', 'v'], ['d', 'd\'']];
            const pair = linePairs[getRandomInt(0, linePairs.length-1)];
            const line1 = pair[0];
            const line2 = pair[1];

            // 1. Determine Type: 50/50 Chance
            let type = typeSelect;
            if (type === 'random') {
                type = Math.random() < 0.5 ? 'calc' : 'prove';
            }

            // 2. Determine Complexity (Internal 50/50 split)
            let isComplex = Math.random() < 0.5; 
            if (isHardMode) isComplex = true;

            // 3. Generate Angle Values
            let angleA2;
            if (isComplex || isHardMode) {
                // Odd numbers
                angleA2 = getRandomInt(35, 145); 
            } else {
                // Nice numbers
                const niceAngles = [40, 50, 60, 70, 80, 100, 110, 120, 130, 140];
                angleA2 = niceAngles[getRandomInt(0, niceAngles.length - 1)];
            }

            const anglesA = {
                1: 180 - angleA2,
                2: angleA2,
                3: 180 - angleA2,
                4: angleA2
            };
            const anglesB = { ...anglesA }; 

            // 4. Pick Source Angle A
            const idxA = getRandomInt(1, 4);
            const valA = anglesA[idxA];

            // 5. Pick Target Angle B
            let idxB;
            let relation = "";

            if (!isComplex) {
                // EASY: Direct Relation
                const easyRelations = ['soletrong', 'dongvi', 'trongcungphia'];
                const targetRel = easyRelations[getRandomInt(0, 2)];
                for (let b = 1; b <= 4; b++) {
                    if (getRelation(idxA, b) === targetRel) {
                        idxB = b;
                        break;
                    }
                }
                if (!idxB) idxB = (idxA % 4) + 1;
            } else {
                // HARD: Indirect
                let attempts = 0;
                do {
                    idxB = getRandomInt(1, 4);
                    relation = getRelation(idxA, idxB);
                    attempts++;
                } while ((relation === 'soletrong' || relation === 'dongvi' || relation === 'trongcungphia') && attempts < 20);
            }

            relation = getRelation(idxA, idxB);
            const valB = anglesB[idxB];
            
            // SVG Generation
            const svgContent = drawGeometrySVG(anglesA[2], idxA, idxB, line1, line2); 
            document.getElementById('geo-canvas').innerHTML = svgContent;

            // Problem Text & Solution
            let question = "";
            let steps = [];
            let finalAns = 0;
            let hint = "";
            
            // --- SCENARIO 1: CALC (T√≠nh g√≥c) ---
            if (type === 'calc') {
                question = `Cho h√¨nh v·∫Ω, bi·∫øt $${line1} // ${line2}$.<br>Bi·∫øt s·ªë ƒëo g√≥c $\\widehat{A_${idxA}} = ${valA}^\\circ$.<br>T√≠nh s·ªë ƒëo g√≥c $\\widehat{B_${idxB}}$.`;
                finalAns = valB;

                steps.push({
                    title: "Ph√¢n t√≠ch ƒë·ªÅ b√†i",
                    content: `<div>- Gi·∫£ thi·∫øt: $${line1} // ${line2}$.<br>- ƒê√£ bi·∫øt: $\\widehat{A_${idxA}} = ${valA}^\\circ$.<br>- C·∫ßn t√≠nh: $\\widehat{B_${idxB}}$.</div>`
                });

                if (['soletrong', 'dongvi', 'trongcungphia'].includes(relation)) {
                    let reasonName = "";
                    let logicMath = "";
                    let conclusion = "";

                    if (relation === 'soletrong') {
                        reasonName = "so le trong";
                        logicMath = `$\\widehat{B_${idxB}} = \\widehat{A_${idxA}}$`;
                        conclusion = `V·∫≠y $\\widehat{B_${idxB}} = ${valB}^\\circ$.`;
                    } else if (relation === 'dongvi') {
                        reasonName = "ƒë·ªìng v·ªã";
                        logicMath = `$\\widehat{B_${idxB}} = \\widehat{A_${idxA}}$`;
                        conclusion = `V·∫≠y $\\widehat{B_${idxB}} = ${valB}^\\circ$.`;
                    } else { // trongcungphia
                        reasonName = "trong c√πng ph√≠a";
                        logicMath = `$\\widehat{A_${idxA}} + \\widehat{B_${idxB}} = 180^\\circ$`;
                        conclusion = `$\\Rightarrow \\widehat{B_${idxB}} = 180^\\circ - ${valA}^\\circ = ${valB}^\\circ$.`;
                    }

                    steps.push({
                        title: "B∆∞·ªõc 1: L·∫≠p lu·∫≠n tr·ª±c ti·∫øp",
                        content: `V√¨ $${line1} // ${line2}$ n√™n ta c√≥ c·∫∑p g√≥c ${reasonName}:<br>${logicMath}`
                    });
                    steps.push({ title: "K·∫øt lu·∫≠n", content: conclusion });
                    hint = `Hai g√≥c n√†y ·ªü v·ªã tr√≠ ${reasonName}. H√£y nh·ªõ t√≠nh ch·∫•t c·ªßa ch√∫ng.`;
                } 
                else {
                    const idxB_temp = idxA; 
                    const valB_temp = valA;

                    steps.push({
                        title: "B∆∞·ªõc 1: T√≠nh g√≥c trung gian",
                        content: `G√≥c c·∫ßn t√≠nh kh√¥ng c√≥ quan h·ªá ƒë·∫∑c bi·ªát tr·ª±c ti·∫øp v·ªõi $\\widehat{A_${idxA}}$.<br>Ta t√≠nh th√¥ng qua g√≥c trung gian $\\widehat{B_${idxB_temp}}$ (ƒë·ªìng v·ªã v·ªõi $\\widehat{A_${idxA}}$).<br>V√¨ $${line1} // ${line2}$ n√™n $\\widehat{B_${idxB_temp}} = \\widehat{A_${idxA}} = ${valA}^\\circ$.`
                    });

                    let rel2 = (Math.abs(idxB - idxB_temp) === 2) ? "ƒë·ªëi ƒë·ªânh" : "k·ªÅ b√π";

                    if (rel2 === 'doidinh') {
                         steps.push({
                            title: "B∆∞·ªõc 2: S·ª≠ d·ª•ng t√≠nh ch·∫•t ƒë·ªëi ƒë·ªânh",
                            content: `Ta c√≥ $\\widehat{B_${idxB}}$ v√† $\\widehat{B_${idxB_temp}}$ l√† hai g√≥c ƒë·ªëi ƒë·ªânh.<br>$\\Rightarrow \\widehat{B_${idxB}} = \\widehat{B_${idxB_temp}} = ${valB}^\\circ$.`
                        });
                    } else {
                         steps.push({
                            title: "B∆∞·ªõc 2: S·ª≠ d·ª•ng t√≠nh ch·∫•t k·ªÅ b√π",
                            content: `Ta c√≥ $\\widehat{B_${idxB}}$ v√† $\\widehat{B_${idxB_temp}}$ l√† hai g√≥c k·ªÅ b√π (t·ªïng $180^\\circ$).<br>$\\Rightarrow \\widehat{B_${idxB}} = 180^\\circ - \\widehat{B_${idxB_temp}}$<br>$\\Rightarrow \\widehat{B_${idxB}} = 180^\\circ - ${valB_temp}^\\circ = ${valB}^\\circ$.`
                        });
                    }
                    steps.push({ title: "K·∫øt lu·∫≠n", content: `V·∫≠y $\\widehat{B_${idxB}} = ${valB}^\\circ$.` });
                    hint = "B√†i to√°n c·∫ßn b∆∞·ªõc trung gian. H√£y th·ª≠ t√≠nh g√≥c ƒë·ªìng v·ªã ho·∫∑c so le trong tr∆∞·ªõc, sau ƒë√≥ suy ra g√≥c c·∫ßn t√¨m.";
                }
            }
            // --- SCENARIO 2: PROVE (Ch·ª©ng minh) ---
            else {
                // D·∫°ng ng∆∞·ª£c: Cho 2 g√≥c -> Ch·ª©ng minh song song.
                // C√¢u h·ªèi: Y√™u c·∫ßu t√≠nh m·ªôt gi√° tr·ªã ƒë·ªÉ K·∫æT LU·∫¨N.
                
                // Case A: Relation is TCP -> Sum is 180.
                if (relation === 'trongcungphia') {
                    question = `Cho h√¨nh v·∫Ω. Bi·∫øt $\\widehat{A_${idxA}} = ${valA}^\\circ$ v√† $\\widehat{B_${idxB}} = ${valB}^\\circ$.<br>ƒê·ªÉ ch·ª©ng minh $${line1} // ${line2}$, ta c·∫ßn t√≠nh t·ªïng hai g√≥c n√†y.<br>H·ªèi t·ªïng $\\widehat{A_${idxA}} + \\widehat{B_${idxB}}$ b·∫±ng bao nhi√™u?`;
                    finalAns = 180;
                    
                    steps.push({
                         title: "B∆∞·ªõc 1: Nh·∫≠n x√©t v·ªã tr√≠",
                         content: `G√≥c $\\widehat{A_${idxA}}$ v√† $\\widehat{B_${idxB}}$ n·∫±m ·ªü v·ªã tr√≠ <b>trong c√πng ph√≠a</b>.`
                    });
                    steps.push({
                         title: "B∆∞·ªõc 2: T√≠nh t·ªïng",
                         content: `T·ªïng s·ªë ƒëo: $${valA}^\\circ + ${valB}^\\circ = 180^\\circ$.`
                    });
                    steps.push({
                         title: "K·∫øt lu·∫≠n",
                         content: `V√¨ t·ªïng hai g√≥c trong c√πng ph√≠a b·∫±ng $180^\\circ$ (b√π nhau) n√™n suy ra $${line1} // ${line2}$.`
                    });
                    hint = "H√£y c·ªông hai g√≥c l·∫°i. N·∫øu b·∫±ng 180 ƒë·ªô th√¨ hai ƒë∆∞·ªùng th·∫≥ng song song.";
                } 
                // Case B: Relation is SLT/DongVi -> Values are Equal.
                else if (relation === 'soletrong' || relation === 'dongvi') {
                    // H·ªèi gi√° tr·ªã c·ªßa m·ªôt g√≥c kh√°c ƒë·ªÉ ki·ªÉm ch·ª©ng?
                    // Ho·∫∑c ƒë∆°n gi·∫£n h·ªèi: "G√≥c B... ph·∫£i c√≥ gi√° tr·ªã bao nhi√™u ƒë·ªÉ song song?" (nh∆∞ c≈©)
                    // NH∆ØNG user mu·ªën "Cho s·ªë ƒëo 2 g√≥c b·∫•t k·ª≥".
                    // V·∫≠y ƒë·ªÅ b√†i: "Cho A=x, B=x. Ch·ª©ng minh //."
                    // C√¢u h·ªèi: "ƒê·ªÉ kh·∫≥ng ƒë·ªãnh ch·ª©ng minh ƒë√∫ng, h√£y cho bi·∫øt c·∫∑p g√≥c n√†y ·ªü v·ªã tr√≠ n√†o v√† c√≥ t√≠nh ch·∫•t g√¨? (Nh·∫≠p gi√° tr·ªã g√≥c A ƒë·ªÉ x√°c nh·∫≠n)".
                    // ƒê·ªïi m·ªõi: H·ªèi gi√° tr·ªã c·ªßa g√≥c K·ªÄ B√ô v·ªõi B.
                    
                    const idxB_kebu = (idxB % 4) + 1; // G√≥c k·ªÅ (sai s·ªë t√≠ nh∆∞ng ok cho logic) - Wait, k·ªÅ b√π l√† 1-2, 3-4.
                    let neighborIdx = (idxB === 1) ? 2 : (idxB === 2) ? 1 : (idxB === 3) ? 4 : 3;
                    
                    question = `Cho h√¨nh v·∫Ω. Bi·∫øt $\\widehat{A_${idxA}} = ${valA}^\\circ$ v√† $\\widehat{B_${idxB}} = ${valB}^\\circ$.<br>ƒê·ªÉ ch·ª©ng minh $${line1} // ${line2}$, h√£y t√≠nh s·ªë ƒëo g√≥c k·ªÅ b√π v·ªõi $\\widehat{B_${idxB}}$ (t·ª©c l√† g√≥c $\\widehat{B_${neighborIdx}}$)?`;
                    finalAns = 180 - valB;
                    
                    let relName = (relation === 'soletrong') ? "so le trong" : "ƒë·ªìng v·ªã";
                    steps.push({
                         title: "B∆∞·ªõc 1: Nh·∫≠n x√©t c·∫∑p g√≥c ƒë√£ cho",
                         content: `Ta th·∫•y $\\widehat{A_${idxA}} = \\widehat{B_${idxB}} = ${valA}^\\circ$.<br>Hai g√≥c n√†y ·ªü v·ªã tr√≠ <b>${relName}</b> v√† b·∫±ng nhau $\\Rightarrow ${line1} // ${line2}$.`
                    });
                    steps.push({
                         title: "B∆∞·ªõc 2: T√≠nh to√°n y√™u c·∫ßu",
                         content: `ƒê·ªÅ b√†i y√™u c·∫ßu t√≠nh g√≥c k·ªÅ b√π v·ªõi $\\widehat{B_${idxB}}$.<br>$\\widehat{B_${neighborIdx}} = 180^\\circ - ${valB}^\\circ$.`
                    });
                    steps.push({
                         title: "K·∫øt lu·∫≠n",
                         content: `V·∫≠y $\\widehat{B_${neighborIdx}} = ${finalAns}^\\circ$.`
                    });
                    hint = "ƒê√¢y l√† b√†i to√°n ki·ªÉm tra ki·∫øn th·ª©c t·ªïng h·ª£p. H√£y t√≠nh g√≥c k·ªÅ b√π v·ªõi g√≥c B ƒë√£ cho.";
                }
                // Case C: Indirect Relation (Hard)
                else {
                    // Given A_idxA, B_idxB. Prove Parallel.
                    // Ask to calculate the Intermediate Angle (Dong Vi at B).
                    const idxB_dongvi = idxA;
                    question = `Cho h√¨nh v·∫Ω. Bi·∫øt $\\widehat{A_${idxA}} = ${valA}^\\circ$ v√† $\\widehat{B_${idxB}} = ${valB}^\\circ$.<br>ƒê·ªÉ ch·ª©ng minh $${line1} // ${line2}$ b·∫±ng c√°ch s·ª≠ d·ª•ng g√≥c trung gian, h√£y t√≠nh s·ªë ƒëo g√≥c $\\widehat{B_${idxB_dongvi}}$ (ƒë·ªìng v·ªã v·ªõi $\\widehat{A_${idxA}}$).`;
                    finalAns = valA;
                    
                    steps.push({
                        title: "B∆∞·ªõc 1: Ph√¢n t√≠ch",
                        content: `Ta c·∫ßn ch·ª©ng minh $${line1} // ${line2}$. M·ªôt trong c√°c c√°ch l√† ch·ªâ ra c·∫∑p g√≥c ƒë·ªìng v·ªã b·∫±ng nhau.`
                    });
                    steps.push({
                        title: "B∆∞·ªõc 2: X√°c ƒë·ªãnh g√≥c so s√°nh",
                        content: `G√≥c ƒë·ªìng v·ªã v·ªõi $\\widehat{A_${idxA}}$ ch√≠nh l√† $\\widehat{B_${idxB_dongvi}}$.<br>D·ª±a v√†o c√°c t√≠nh ch·∫•t g√≥c ƒë·ªëi ƒë·ªânh/k·ªÅ b√π t·ª´ $\\widehat{B_${idxB}}$, ta t√≠nh ƒë∆∞·ª£c $\\widehat{B_${idxB_dongvi}} = ${valA}^\\circ$.`
                    });
                    steps.push({
                        title: "K·∫øt lu·∫≠n",
                        content: `Ta th·∫•y $\\widehat{B_${idxB_dongvi}} = \\widehat{A_${idxA}}$ (c√πng b·∫±ng ${valA}^\\circ$).<br>Suy ra $${line1} // ${line2}$.<br>ƒê√°p s·ªë c·∫ßn ƒëi·ªÅn: ${valA}$.`
                    });
                    hint = "H√£y t√¨m g√≥c ·ªü ƒë·ªânh B m√† n·∫±m ·ªü v·ªã tr√≠ ƒë·ªìng v·ªã v·ªõi g√≥c A ƒë√£ cho.";
                }
            }

            return {
                question,
                steps,
                finalAns,
                hint
            };
        }

        // --- CORE FUNCTIONS ---
        function nextQuestion() {
            if (!isAnswered && document.getElementById('question-text').innerText !== 'ƒêang t·∫£i ƒë·ªÅ b√†i...') {
                skippedTotal++;
                streak = 0;
                updateStatsUI();
            }

            currentProblem = generateGeometryProblem();
            
            stepIndex = 0;
            isAnswered = false;
            statsEnabled = true;
            updateStatsUI();

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('hint-box').classList.add('hidden');
            document.getElementById('steps-container').innerHTML = '<div class="text-gray-400 italic text-sm text-center mt-10"><i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i><br>B·∫•m "H∆∞·ªõng d·∫´n gi·∫£i" ƒë·ªÉ xem b√†i l√†m m·∫´u</div>';
            
            document.getElementById('btn-show-step').disabled = false;
            document.getElementById('btn-show-step').innerHTML = 'H∆∞·ªõng d·∫´n gi·∫£i <i class="fas fa-arrow-right ml-1"></i>';

            document.getElementById('question-text').innerHTML = currentProblem.question;
            document.getElementById('hint-content').innerHTML = currentProblem.hint;
            
            document.getElementById('ans-final').value = '';
            document.getElementById('ans-final').className = "flex-grow text-center font-bold text-xl p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none transition-colors";
            document.getElementById('ans-final').focus();
            
            MathJax.typesetPromise([document.getElementById('question-text'), document.getElementById('steps-container')]);
            updateStepCounter();
        }

        function updateStepCounter() {
            document.getElementById('step-counter').textContent = `B∆∞·ªõc: ${stepIndex}/${currentProblem.steps.length}`;
        }

        function showNextStep() {
            disableStats(); 
            document.getElementById('hint-box').classList.remove('hidden');

            const container = document.getElementById('steps-container');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentProblem.steps.length) {
                const step = currentProblem.steps[stepIndex];
                
                const s = document.createElement('div');
                const isOdd = stepIndex % 2 !== 0;
                s.className = `step-item p-3 rounded-lg shadow-sm text-sm border-l-4 font-medium mb-3 ${isOdd ? 'bg-indigo-50 border-indigo-400 text-indigo-900' : 'bg-white border-gray-300 text-gray-800'}`;
                
                s.innerHTML = `<div class="font-bold text-xs uppercase mb-1 opacity-70">${step.title}</div><div class="text-base">${step.content}</div>`;
                
                container.appendChild(s);
                MathJax.typesetPromise([s]);
                
                stepIndex++;
                updateStepCounter();
                container.scrollTop = container.scrollHeight;
            }

            if (stepIndex >= currentProblem.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> H·∫øt';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const finalInp = document.getElementById('ans-final');
            const userVal = parseFloat(finalInp.value.replace(/,/g, '').replace(/\s/g, ''));
            const correctVal = currentProblem.finalAns;
            
            const fb = document.getElementById('feedback');
            fb.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');

            if (Math.abs(userVal - correctVal) < 0.1) {
                finalInp.classList.remove('border-gray-300', 'border-red-500');
                finalInp.classList.add('border-emerald-500', 'bg-emerald-50');

                if (statsEnabled) {
                    streak++;
                    correctTotal++;
                    fb.innerHTML = '<i class="fas fa-crown"></i> Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.';
                    fb.classList.add('bg-green-100', 'text-green-800');
                    updateStatsUI();
                } else {
                    fb.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem h∆∞·ªõng d·∫´n)';
                    fb.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                isAnswered = true;
                const timer = setInterval(() => {
                    if (stepIndex < currentProblem.steps.length) showNextStep();
                    else clearInterval(timer);
                }, 400);

            } else {
                finalInp.classList.remove('border-gray-300', 'border-emerald-500');
                finalInp.classList.add('border-red-500', 'bg-red-50');
                
                fb.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Sai r·ªìi. H√£y th·ª≠ l·∫°i ho·∫∑c xem h∆∞·ªõng d·∫´n.`;
                fb.classList.add('bg-red-100', 'text-red-700');
                
                if (statsEnabled) {
                    streak = 0;
                    wrongTotal++;
                    updateStatsUI();
                }
            }
        }

        window.onload = function() {
            nextQuestion();
        };

    </script>
</body>
</html>