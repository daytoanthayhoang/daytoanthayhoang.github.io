<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p To√°n 7 HK1 - B√†i 6 (ƒê∆∞·ªùng th·∫≥ng song song)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Chalkboard Style */
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
            z-index: 1;
        }

        /* SVG Line Drawing */
        .geo-svg {
            width: 100%;
            height: 220px;
            margin: 0 auto;
            display: block;
            z-index: 2;
        }
        .geo-line { stroke: white; stroke-width: 2.5; stroke-linecap: round; }
        .geo-text { font-size: 14px; font-weight: 800; font-family: 'Nunito', sans-serif; text-shadow: 1px 1px 2px #000; }
        .geo-point { fill: #f87171; stroke: #fff; stroke-width: 1; }
        .geo-arc { fill: none; stroke-width: 2; stroke-linecap: round; }

        /* Step Animation */
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        #steps-container::-webkit-scrollbar { width: 8px; }
        #steps-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Stats & Effects */
        .streak-fire { color: #ef4444; animation: burn 0.5s infinite alternate; }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box { transition: all 0.3s ease; }
        .stats-box:hover { transform: translateY(-2px); }
        
        mjx-container { font-size: 110% !important; }

        .hint-box {
            border-left: 4px solid #f59e0b;
            background-color: #fffbeb;
            color: #92400e;
            margin-bottom: 12px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 relative shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-xl md:text-2xl font-extrabold text-white uppercase tracking-wider">
                    <i class="fas fa-shapes mr-2"></i>√în t·∫≠p To√°n 7 HK1 - B√†i 6
                </h1>
                <p class="text-blue-200 font-medium text-sm">Ch·ªß ƒë·ªÅ: ƒê∆∞·ªùng th·∫≥ng song song & Ti√™n ƒë·ªÅ Euclid</p>
            </div>
            
            <button class="bg-white/10 text-white border border-white/40 px-4 py-2 rounded-lg font-bold text-sm transition-all flex items-center gap-2 group cursor-default opacity-80">
                <i class="fas fa-file-pdf"></i>
                <span>T√†i li·ªáu (S·∫Øp c√≥)</span>
            </button>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-4 min-h-[350px] relative">
                         <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            H√¨nh minh h·ªça
                        </div>
                        
                        <!-- Geometry SVG Render Area -->
                        <div id="geo-canvas" class="mt-4 mb-2 flex justify-center items-center">
                            <!-- SVG will be injected here -->
                        </div>

                        <div id="question-text" class="text-white text-base md:text-lg font-medium leading-relaxed font-sans px-2 tracking-wide border-t border-white/10 pt-2">
                            ƒêang t·∫£i ƒë·ªÅ b√†i...
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        
                        <!-- Control Row: Type & Hard Mode -->
                        <div class="flex flex-wrap justify-between items-center mb-4 pb-3 border-b border-gray-200 gap-2">
                             <div class="flex items-center gap-2 flex-grow">
                                <label class="text-[10px] font-bold text-gray-400 uppercase whitespace-nowrap">D·∫°ng to√°n:</label>
                                <select id="problem-type" class="text-xs font-bold p-1.5 rounded border-gray-300 focus:ring-indigo-500 bg-white w-full max-w-[220px]" onchange="nextQuestion()">
                                    <option value="random">üé≤ Ng·∫´u nhi√™n (50/50)</option>
                                    <option value="calc">üìê T√≠nh g√≥c (Xu√¥i)</option>
                                    <option value="prove">üõ°Ô∏è Ch·ª©ng minh (Ng∆∞·ª£c)</option>
                                </select>
                            </div>

                            <label class="inline-flex items-center cursor-pointer select-none shrink-0" title="B·∫≠t ch·∫ø ƒë·ªô b√†i to√°n l·∫Øt l√©o (G√≥c kh√¥ng ƒë·∫πp, v·ªã tr√≠ kh√≥)">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-xs font-bold text-gray-600 peer-checked:text-red-600 flex items-center">
                                    <i class="fas fa-skull-crossbones mr-1"></i>V·∫≠n d·ª•ng
                                </span>
                            </label>
                        </div>

                        <!-- Answer Input Section -->
                        <div id="input-section" class="bg-white p-4 rounded-lg border border-gray-200 mb-4 transition-all">
                            <label class="block text-gray-400 font-bold text-xs uppercase mb-2" id="label-final-req">K·∫øt qu·∫£:</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="ans-final" placeholder="Nh·∫≠p s·ªë ƒëo..." class="flex-grow text-center font-bold text-xl p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none transition-colors">
                                <span id="unit-display" class="font-bold text-gray-500 bg-gray-100 p-2 rounded border border-gray-200 min-w-[60px] text-center">ƒë·ªô</span>
                            </div>
                        </div>

                        <!-- Info Box for Prove Mode -->
                        <div id="prove-info" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4 text-center">
                            <p class="text-blue-800 font-bold text-sm">
                                <i class="fas fa-info-circle mr-1"></i> ƒê√¢y l√† d·∫°ng b√†i t·ª± lu·∫≠n.
                            </p>
                            <p class="text-blue-600 text-xs mt-1">H√£y suy nghƒ© c√°ch ch·ª©ng minh, sau ƒë√≥ b·∫•m "H∆∞·ªõng d·∫´n gi·∫£i" ƒë·ªÉ xem b√†i m·∫´u.</p>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button id="btn-check" onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <div id="feedback" class="hidden mt-3 text-center p-2 rounded-lg text-sm font-bold"></div>
                        <div id="hint-warning" class="hidden mt-2 text-center text-xs text-amber-600 font-semibold bg-amber-50 p-1 rounded border border-amber-200">
                            <i class="fas fa-lock mr-1"></i>ƒê√£ xem h∆∞·ªõng d·∫´n: Th√†nh t√≠ch c√¢u n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh.
                        </div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[600px] lg:h-[750px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>H∆∞·ªõng d·∫´n gi·∫£i</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Hint Box -->
                    <div id="hint-box" class="hidden hint-box p-3 rounded-lg text-sm shadow-sm">
                        <div class="font-bold flex items-center gap-2 mb-1">
                            <i class="fas fa-lightbulb text-amber-500"></i> G·ª£i √Ω:
                        </div>
                        <div id="hint-content"></div>
                    </div>

                    <!-- Steps Content -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "H∆∞·ªõng d·∫´n gi·∫£i" ƒë·ªÉ xem b√†i l√†m m·∫´u t·ª´ng b∆∞·ªõc</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full pb-4">
        <p>¬© C√¥ng c·ª• h·ªó tr·ª£ √¥n t·∫≠p To√°n 7 - HK1</p>
    </footer>

    <script>
        // --- Game State ---
        let currentProblem = {};
        let stepIndex = 0;
        let isAnswered = false;
        
        // Stats
        let streak = 0;
        let correctTotal = 0;
        let wrongTotal = 0;
        let skippedTotal = 0;
        let statsEnabled = true;

        // --- Utils ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function updateStatsUI() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = streak;
            document.getElementById('stat-correct').textContent = correctTotal;
            document.getElementById('stat-wrong').textContent = wrongTotal;
            document.getElementById('stat-skipped').textContent = skippedTotal;

            if (!statsEnabled) {
                document.getElementById('hint-warning').classList.remove('hidden');
            } else {
                document.getElementById('hint-warning').classList.add('hidden');
            }

            if (streak > 2) {
                streakEl.classList.add('streak-fire');
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${streak}`;
            } else {
                streakEl.classList.remove('streak-fire');
                streakEl.textContent = streak;
            }
        }
        
        function disableStats() {
            if (statsEnabled) {
                statsEnabled = false;
                updateStatsUI();
            }
        }

        // --- GEOMETRY ENGINE ---

        const posMap = {
            1: "G√≥c tr√™n b√™n tr√°i",
            2: "G√≥c tr√™n b√™n ph·∫£i",
            3: "G√≥c d∆∞·ªõi b√™n ph·∫£i",
            4: "G√≥c d∆∞·ªõi b√™n tr√°i"
        };

        const relations = {
            'soletrong': [[4, 2], [3, 1]], 
            'dongvi': [[1, 1], [2, 2], [3, 3], [4, 4]], 
            'doidinh': [[1, 3], [2, 4]], 
            'kebu': [[1, 2], [2, 3], [3, 4], [4, 1]] 
        };

        function getRelation(idxA, idxB) {
            if ((idxA === 4 && idxB === 2) || (idxA === 3 && idxB === 1)) return "soletrong";
            if (idxA === idxB) return "dongvi";
            // Removed TCP check for pure relation, handled by logic
            return "unknown";
        }

        // IMPROVED GEOMETRY DRAWING WITH VECTOR MATH
        function drawGeometrySVG(angleA2, labelA, labelB, line1Name, line2Name) {
            
            const width = 300;
            const height = 220;
            const y1 = 70;  // Line 1
            const y2 = 150; // Line 2
            const midX = width / 2;

            // 1. Calculate Coordinates
            const s = 60; // Slant offset
            let xTop, xBot;

            if (angleA2 < 90) {
                // Shape /
                xTop = midX + s; 
                xBot = midX - s;
            } else {
                // Shape \
                xTop = midX - s;
                xBot = midX + s;
            }

            // Extend the line
            const slope = (y2 - y1) / (xBot - xTop); 
            const extY_Top = y1 - 45;
            const extY_Bot = y2 + 45;
            const extX_Top = (extY_Top - y1) / slope + xTop;
            const extX_Bot = (extY_Bot - y2) / slope + xBot;

            // 2. Helper: Draw Arc and Label using Vector Bisectors
            const drawAngle = (cx, cy, idx, isTop) => {
                const isActiveA = Array.isArray(labelA) ? labelA.includes(idx) : labelA === idx;
                const isActiveB = Array.isArray(labelB) ? labelB.includes(idx) : labelB === idx;
                const isActive = (isTop && isActiveA) || (!isTop && isActiveB);
                
                const color = isActive ? "#fbbf24" : "rgba(255,255,255,0.3)";
                const textColor = isActive ? "#fbbf24" : "rgba(255,255,255,0.5)";
                const textWeight = isActive ? "800" : "400";
                
                let v1, v2; 
                const dx = xBot - xTop;
                const dy = y2 - y1;

                const norm = (v) => { const l = Math.sqrt(v.x*v.x + v.y*v.y); return {x:v.x/l, y:v.y/l}; };

                if (idx === 1) { v1 = {x:-1, y:0}; v2 = {x:-dx, y:-dy}; }
                if (idx === 2) { v1 = {x:-dx, y:-dy}; v2 = {x:1, y:0}; }
                if (idx === 3) { v1 = {x:1, y:0}; v2 = {x:dx, y:dy}; }
                if (idx === 4) { v1 = {x:dx, y:dy}; v2 = {x:-1, y:0}; }
                
                const nv1 = norm(v1);
                const nv2 = norm(v2);
                const bisect = {x: nv1.x + nv2.x, y: nv1.y + nv2.y};
                
                const labelDist = 40;
                const nb = norm(bisect);
                const lx = cx + nb.x * labelDist;
                const ly = cy + nb.y * labelDist;

                let arcPath = "";
                if (isActive) {
                    const r = 25;
                    const ang1 = Math.atan2(v1.y, v1.x);
                    const ang2 = Math.atan2(v2.y, v2.x);
                    
                    let diff = ang2 - ang1;
                    while (diff <= -Math.PI) diff += 2*Math.PI;
                    while (diff > Math.PI) diff -= 2*Math.PI;
                    
                    const sx = cx + r * Math.cos(ang1);
                    const sy = cy + r * Math.sin(ang1);
                    const ex = cx + r * Math.cos(ang2);
                    const ey = cy + r * Math.sin(ang2);
                    const mx = cx + r * nb.x;
                    const my = cy + r * nb.y;
                    
                    arcPath = `<path d="M ${sx} ${sy} Q ${mx} ${my} ${ex} ${ey}" fill="none" stroke="${color}" stroke-width="2" />`;
                }

                return `
                    ${arcPath}
                    <text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="${textColor}" font-weight="${textWeight}" font-size="14" font-family="Nunito">
                        ${isTop ? 'A' : 'B'}<tspan dy="4" font-size="10">${idx}</tspan>
                    </text>
                `;
            };

            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${height}" class="geo-svg">
                <line x1="20" y1="${y1}" x2="${width-20}" y2="${y1}" class="geo-line" />
                <text x="${width-25}" y="${y1-10}" fill="white" font-size="16" font-style="italic" font-weight="bold">${line1Name}</text>

                <line x1="20" y1="${y2}" x2="${width-20}" y2="${y2}" class="geo-line" />
                <text x="${width-25}" y="${y2-10}" fill="white" font-size="16" font-style="italic" font-weight="bold">${line2Name}</text>

                <line x1="${extX_Top}" y1="${extY_Top}" x2="${extX_Bot}" y2="${extY_Bot}" class="geo-line" />
                <text x="${extX_Top}" y="${extY_Top-5}" fill="white" font-size="14" font-style="italic">c</text>

                ${drawAngle(xTop, y1, 1, true)}
                ${drawAngle(xTop, y1, 2, true)}
                ${drawAngle(xTop, y1, 3, true)}
                ${drawAngle(xTop, y1, 4, true)}

                ${drawAngle(xBot, y2, 1, false)}
                ${drawAngle(xBot, y2, 2, false)}
                ${drawAngle(xBot, y2, 3, false)}
                ${drawAngle(xBot, y2, 4, false)}

                <circle cx="${xTop}" cy="${y1}" r="3" class="geo-point" />
                <circle cx="${xBot}" cy="${y2}" r="3" class="geo-point" />
            </svg>`;
        }

        // --- PROBLEM GENERATOR ---

        function generateGeometryProblem() {
            const typeSelect = document.getElementById('problem-type').value;
            const isHardMode = document.getElementById('mode-hard').checked;

            const linePairs = [['x', 'y'], ['a', 'b'], ['m', 'n'], ['u', 'v'], ['d', 'd\'']];
            const pair = linePairs[getRandomInt(0, linePairs.length-1)];
            const line1 = pair[0];
            const line2 = pair[1];

            let type = typeSelect;
            if (type === 'random') {
                type = Math.random() < 0.5 ? 'calc' : 'prove';
            }

            let isComplex = Math.random() < 0.5; 
            if (isHardMode) isComplex = true;

            let angleA2;
            if (isComplex || isHardMode) {
                angleA2 = getRandomInt(35, 145); 
            } else {
                const niceAngles = [40, 50, 60, 70, 80, 100, 110, 120, 130, 140];
                angleA2 = niceAngles[getRandomInt(0, niceAngles.length - 1)];
            }

            const anglesA = {
                1: 180 - angleA2,
                2: angleA2,
                3: 180 - angleA2,
                4: angleA2
            };
            const anglesB = { ...anglesA }; 

            let question = "";
            let steps = [];
            let finalAns = 0;
            let hint = "";
            let labelA_SVG, labelB_SVG;

            // --- SCENARIO 1: CALC ---
            if (type === 'calc') {
                const idxA = getRandomInt(1, 4);
                const valA = anglesA[idxA];
                labelA_SVG = [idxA];

                let idxA_target = (idxA % 4) + 1; 
                if (Math.random() < 0.4) idxA_target = (idxA + 2 > 4) ? idxA - 2 : idxA + 2; 
                const valA_target = anglesA[idxA_target];
                labelA_SVG.push(idxA_target);

                const easyRelations = ['soletrong', 'dongvi'];
                let relation = easyRelations[getRandomInt(0, 1)];
                let idxB_target;
                
                for (let b = 1; b <= 4; b++) {
                    if (getRelation(idxA, b) === relation) {
                        idxB_target = b;
                        break;
                    }
                }
                if (!idxB_target) { 
                    idxB_target = (idxA % 4) + 1;
                    relation = "unknown";
                }
                const valB_target = anglesB[idxB_target];
                labelB_SVG = [idxB_target];

                question = `Cho h√¨nh v·∫Ω. Gi·∫£ s·ª≠ $${line1} // ${line2}$ v√† $\\widehat{A_${idxA}} = ${valA}^\\circ$.<br>T√≠nh s·ªë ƒëo $\\widehat{A_${idxA_target}}$ v√† $\\widehat{B_${idxB_target}}$.`;
                finalAns = valB_target;
                document.getElementById('label-final-req').innerText = `K·∫øt qu·∫£ g√≥c B${idxB_target}:`;

                steps.push({ title: "Gi·∫£i:", content: `` });

                let relationA = (Math.abs(idxA - idxA_target) === 2) ? "ƒë·ªëi ƒë·ªânh" : "k·ªÅ b√π";
                let logicA = "";
                if (relationA === "ƒë·ªëi ƒë·ªânh") {
                    logicA = `
- Ta c√≥: $\\quad \\widehat{A_${idxA_target}} = \\widehat{A_${idxA}}$ (ƒë·ªëi ƒë·ªânh)
$$ \\text { n√™n } \\quad \\widehat{A_${idxA_target}} = ${valA_target}^\\circ $$
`;
                } else {
                    logicA = `
- Ta c√≥:
$$
\\begin{aligned}
& \\widehat{A_${idxA}} + \\widehat{A_${idxA_target}} = 180^\\circ \\text{ (k·ªÅ b√π) } \\\\
& ${valA}^\\circ + \\widehat{A_${idxA_target}} = 180^\\circ \\\\
& \\widehat{A_${idxA_target}} = 180^\\circ - ${valA}^\\circ \\\\
& \\widehat{A_${idxA_target}} = ${valA_target}^\\circ
\\end{aligned}
$$
`;
                }
                steps.push({ title: `a)`, content: logicA });

                let logicB = "";
                let relNameB = (relation === 'soletrong') ? "so le trong" : "ƒë·ªìng v·ªã";
                
                if (['soletrong', 'dongvi'].includes(relation)) {
                    logicB = `
- Ta c√≥: $${line1} // ${line2}$ n√™n
$$ \\widehat{B_${idxB_target}} = \\widehat{A_${idxA}} \\text { (2 g√≥c ${relNameB}) } $$
Suy ra $\\widehat{B_${idxB_target}} = ${valB_target}^\\circ$.
`;
                } else {
                    const idxB_inter = idxA;
                    const valB_inter = valA;
                    
                    let subStep1 = `
- Ta c√≥: $${line1} // ${line2}$ n√™n
$$ \\widehat{B_${idxB_inter}} = \\widehat{A_${idxA}} \\text { (2 g√≥c ƒë·ªìng v·ªã) } $$
Suy ra $\\widehat{B_${idxB_inter}} = ${valA}^\\circ$.
`;
                    let subStep2 = "";
                    let relInter = (Math.abs(idxB_inter - idxB_target) === 2) ? "ƒë·ªëi ƒë·ªânh" : "k·ªÅ b√π";
                    
                    if (idxB_inter === idxB_target) {
                        logicB = subStep1 + `Suy ra $\\widehat{B_${idxB_target}} = ${valB_target}^\\circ$.`;
                    } else if (relInter === "ƒë·ªëi ƒë·ªânh") {
                        subStep2 = `
- Ta c√≥: $\\quad \\widehat{B_${idxB_target}} = \\widehat{B_${idxB_inter}}$ (ƒë·ªëi ƒë·ªânh)
$$ \\text { n√™n } \\quad \\widehat{B_${idxB_target}} = ${valB_target}^\\circ $$`;
                        logicB = subStep1 + subStep2;
                    } else { 
                        subStep2 = `
- Ta l·∫°i c√≥:
$$
\\begin{aligned}
& \\widehat{B_${idxB_target}} + \\widehat{B_${idxB_inter}} = 180^\\circ \\text{ (k·ªÅ b√π) } \\\\
& \\widehat{B_${idxB_target}} + ${valA}^\\circ = 180^\\circ \\\\
& \\widehat{B_${idxB_target}} = 180^\\circ - ${valA}^\\circ \\\\
& \\widehat{B_${idxB_target}} = ${valB_target}^\\circ
\\end{aligned}
$$`;
                        logicB = subStep1 + subStep2;
                    }
                }
                steps.push({ title: ``, content: logicB });
                hint = `√Åp d·ª•ng t√≠nh ch·∫•t k·ªÅ b√π/ƒë·ªëi ƒë·ªânh ƒë·ªÉ t√≠nh g√≥c A. D√πng t√≠nh ch·∫•t song song ƒë·ªÉ t√≠nh g√≥c B.`;
            }

            // --- SCENARIO 2: PROVE (Updated Logic) ---
            else {
                // Randomly pick ANY pair A and B
                const idxA = getRandomInt(1, 4);
                const valA = anglesA[idxA];
                labelA_SVG = [idxA];
                
                // Allow any B, calculate value based on parallel property
                const idxB = getRandomInt(1, 4);
                // Correct B val: If (idxA is odd and idxB is odd) OR (idxA even and idxB even) => Equal.
                // Else => Supplementary.
                const isTypeA = (idxA % 2 !== 0); // 1,3 are type 1 (equal to each other). 2,4 are type 2.
                const isTypeB = (idxB % 2 !== 0);
                
                // Note on angle mapping:
                // A1, A3 are Vert. A2, A4 are Vert.
                // A1+A2=180.
                // If parallel, B1=A1. B3=A3=A1.
                // B2=A2. B4=A4=A2.
                // So odd indices match odd indices. Even match even.
                
                let valB;
                if (isTypeA === isTypeB) {
                    valB = valA; // Equal
                } else {
                    valB = 180 - valA; // Supplementary
                }
                
                labelB_SVG = [idxB];
                
                question = `Cho h√¨nh v·∫Ω. Gi·∫£ s·ª≠ $\\widehat{A_${idxA}} = ${valA}^\\circ$ v√† $\\widehat{B_${idxB}} = ${valB}^\\circ$.<br>Ch·ª©ng minh $${line1} // ${line2}$.`;
                
                finalAns = 0;
                steps.push({ title: "Gi·∫£i:", content: `` });

                // --- Generate 2 Ways ---
                
                // Helper to create a proof step
                const createProof = (methodTitle, targetIdx, isAtA) => {
                    let logic = "";
                    let bridgeRel = "";
                    let finalRel = "";
                    
                    // We need to bridge to a standard relation (DongVi/SLT)
                    // Standard relations between A and B:
                    // DongVi: A1-B1, A2-B2, A3-B3, A4-B4. (Indices Equal)
                    // SLT: A4-B2, A3-B1. (Standard interior).
                    
                    // Let's force bridge to be a DONG VI pair for simplicity in explanation if possible, or SLT.
                    // If isAtA, we find A_bridge that is DongVi/SLT to B.
                    // If isAtB, we find B_bridge that is DongVi/SLT to A.
                    
                    let sourceIdx = isAtA ? idxB : idxA; // The one we stay at
                    let changingIdx = isAtA ? idxA : idxB; // The one we move
                    let bridgeIdx;
                    let targetRelationName; 
                    
                    // Strategy: 
                    // 1. Try to find bridge that is DongVi.
                    // Bridge index for DongVi is simply sourceIdx.
                    // e.g. if we hold A fixed (source A), we want B_bridge = idxA.
                    // e.g. if we hold B fixed (source B), we want A_bridge = idxB.
                    
                    // 2. Try to find bridge that is SoLeTrong.
                    // SLT pairs: 4-2, 3-1. 
                    // If source is 1, SLT bridge is 3. If 2 -> 4. If 3 -> 1. If 4 -> 2.
                    // This covers all if we consider generalized SLT (or exterior).
                    
                    // Let's decide strategy for Way 1 and Way 2.
                    // Way 1: Use Vertical/Linear Pair at B to move B -> B'. Then B' & A are Direct.
                    // Way 2: Use Vertical/Linear Pair at A to move A -> A'. Then A' & B are Direct.
                    
                    let movingIdx, fixedIdx, bridgeVal, bridgeRelType, directRelType;
                    
                    if (!isAtA) { // Way 1: Move B. Fixed A.
                        movingIdx = idxB; fixedIdx = idxA;
                        // Target bridge at B that matches A directly.
                        // Try DongVi first (bridge = idxA).
                        bridgeIdx = idxA;
                        directRelType = "ƒë·ªìng v·ªã";
                        // If bridgeIdx == movingIdx, it's already direct.
                        if (bridgeIdx === movingIdx) {
                            // If already DongVi, maybe switch to SLT target for variety?
                            // SLT map: 1->3, 2->4, 3->1, 4->2.
                            let sltIdx = (idxA === 1) ? 3 : (idxA === 2) ? 4 : (idxA === 3) ? 1 : 2;
                            bridgeIdx = sltIdx;
                            directRelType = "so le trong";
                        }
                    } else { // Way 2: Move A. Fixed B.
                        movingIdx = idxA; fixedIdx = idxB;
                        // Target bridge at A that matches B directly.
                        // Try DongVi (bridge = idxB).
                        bridgeIdx = idxB;
                        directRelType = "ƒë·ªìng v·ªã";
                        if (bridgeIdx === movingIdx) {
                            let sltIdx = (idxB === 1) ? 3 : (idxB === 2) ? 4 : (idxB === 3) ? 1 : 2;
                            bridgeIdx = sltIdx;
                            directRelType = "so le trong";
                        }
                    }
                    
                    // Calculate Relation between Moving and Bridge
                    let bridgeAngleVal;
                    if ((movingIdx % 2) === (bridgeIdx % 2)) {
                        // Same parity (both odd or both even) -> Equal -> Vertical
                        // Or same angle (handled above).
                        bridgeRelType = "ƒë·ªëi ƒë·ªânh";
                        bridgeAngleVal = (isAtA ? valA : valB); 
                    } else {
                        // Different parity -> Supplementary -> Linear Pair
                        bridgeRelType = "k·ªÅ b√π";
                        bridgeAngleVal = 180 - (isAtA ? valA : valB);
                    }
                    
                    // Generate Text
                    let charMov = isAtA ? "A" : "B";
                    let charFix = isAtA ? "B" : "A";
                    let valMov = isAtA ? valA : valB;
                    
                    let stepHtml = `<div class="mb-2 underline font-bold">${methodTitle}</div>`;
                    
                    if (bridgeRelType === "ƒë·ªëi ƒë·ªânh") {
                        stepHtml += `
- Ta c√≥: $\\widehat{${charMov}_${bridgeIdx}} = \\widehat{${charMov}_${movingIdx}}$ (ƒë·ªëi ƒë·ªânh)
$$ \\text{N√™n } \\widehat{${charMov}_${bridgeIdx}} = ${valMov}^\\circ $$`;
                    } else {
                        stepHtml += `
- Ta c√≥: $\\widehat{${charMov}_${movingIdx}} + \\widehat{${charMov}_${bridgeIdx}} = 180^\\circ$ (k·ªÅ b√π)
$$
\\begin{aligned}
& ${valMov}^\\circ + \\widehat{${charMov}_${bridgeIdx}} = 180^\\circ \\\\
& \\widehat{${charMov}_${bridgeIdx}} = 180^\\circ - ${valMov}^\\circ \\\\
& \\widehat{${charMov}_${bridgeIdx}} = ${bridgeAngleVal}^\\circ
\\end{aligned}
$$`;
                    }
                    
                    // Conclusion
                    // Check if bridgeVal equals fixedVal (should match if parallel)
                    let valFix = isAtA ? valB : valA;
                    // Note: bridgeAngleVal is calculated from Moving. valFix is given.
                    // They should match.
                    
                    stepHtml += `
- Ta th·∫•y: $\\widehat{${charMov}_${bridgeIdx}} = \\widehat{${charFix}_${fixedIdx}} \\left(= ${valFix}^\\circ\\right)$
M√† hai g√≥c n√†y ·ªü v·ªã tr√≠ ${directRelType} n√™n $${line1} // ${line2}$.
`;
                    return stepHtml;
                };

                // Generate 2 ways
                // Way 1: Transform B (Indirect at B)
                let w1 = createProof("C√°ch 1 (Bi·∫øn ƒë·ªïi g√≥c B):", idxB, false);
                
                // Way 2: Transform A (Indirect at A)
                let w2 = createProof("C√°ch 2 (Bi·∫øn ƒë·ªïi g√≥c A):", idxA, true);
                
                // Check if Direct Case to avoid redundancy
                // If A and B are already SLT or DongVi, both ways might look similar or artificial.
                // But the logic handles "If bridge == moving, switch to SLT" so it forces an indirect path even for direct start.
                // Example: Start A1, B1 (Direct DV).
                // W1: Move B1 -> B3 (Vert). B3 & A1 are SLT. (Valid proof).
                // W2: Move A1 -> A3 (Vert). A3 & B1 are SLT. (Valid proof).
                // This satisfies "Show 2 ways" perfectly.

                steps.push({
                    title: "b)",
                    content: w1 + "<br>" + w2
                });
                
                hint = "C√≥ th·ªÉ d√πng t√≠nh ch·∫•t g√≥c ƒë·ªëi ƒë·ªânh ho·∫∑c k·ªÅ b√π ƒë·ªÉ ƒë∆∞a v·ªÅ c√°c c·∫∑p g√≥c so le trong/ƒë·ªìng v·ªã.";
            }
            
            const svgContent = drawGeometrySVG(anglesA[2], labelA_SVG, labelB_SVG, line1, line2); 
            document.getElementById('geo-canvas').innerHTML = svgContent;

            return {
                question,
                steps,
                finalAns,
                hint,
                type
            };
        }

        // --- CORE FUNCTIONS ---
        function nextQuestion() {
            if (!isAnswered && document.getElementById('question-text').innerText !== 'ƒêang t·∫£i ƒë·ªÅ b√†i...') {
                skippedTotal++;
                streak = 0;
                updateStatsUI();
            }

            currentProblem = generateGeometryProblem();
            
            stepIndex = 0;
            isAnswered = false;
            statsEnabled = true;
            updateStatsUI();

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('hint-box').classList.add('hidden');
            document.getElementById('steps-container').innerHTML = '<div class="text-gray-400 italic text-sm text-center mt-10"><i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i><br>B·∫•m "H∆∞·ªõng d·∫´n gi·∫£i" ƒë·ªÉ xem b√†i l√†m m·∫´u</div>';
            
            document.getElementById('btn-show-step').disabled = false;
            document.getElementById('btn-show-step').innerHTML = 'H∆∞·ªõng d·∫´n gi·∫£i <i class="fas fa-arrow-right ml-1"></i>';

            document.getElementById('question-text').innerHTML = currentProblem.question;
            document.getElementById('hint-content').innerHTML = currentProblem.hint;
            
            const inpSec = document.getElementById('input-section');
            const infoSec = document.getElementById('prove-info');
            const checkBtn = document.getElementById('btn-check');

            if (currentProblem.type === 'prove') {
                inpSec.classList.add('hidden');
                infoSec.classList.remove('hidden');
                checkBtn.classList.add('hidden'); 
            } else {
                inpSec.classList.remove('hidden');
                infoSec.classList.add('hidden');
                checkBtn.classList.remove('hidden');
                
                document.getElementById('ans-final').value = '';
                document.getElementById('ans-final').className = "flex-grow text-center font-bold text-xl p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none transition-colors";
                document.getElementById('ans-final').focus();
            }
            
            MathJax.typesetPromise([document.getElementById('question-text'), document.getElementById('steps-container')]);
            updateStepCounter();
        }

        function updateStepCounter() {
            document.getElementById('step-counter').textContent = `B∆∞·ªõc: ${stepIndex}/${currentProblem.steps.length}`;
        }

        function showNextStep() {
            disableStats(); 
            document.getElementById('hint-box').classList.remove('hidden');

            const container = document.getElementById('steps-container');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentProblem.steps.length) {
                const step = currentProblem.steps[stepIndex];
                
                const s = document.createElement('div');
                const isOdd = stepIndex % 2 !== 0;
                s.className = `step-item p-3 rounded-lg shadow-sm text-sm border-l-4 font-medium mb-3 ${isOdd ? 'bg-indigo-50 border-indigo-400 text-indigo-900' : 'bg-white border-gray-300 text-gray-800'}`;
                
                let titleHtml = '';
                if (step.title && step.title.length > 0 && step.title !== 'Gi·∫£i:') {
                    titleHtml = `<div class="font-bold text-xs uppercase mb-1 opacity-70">${step.title}</div>`;
                }
                
                s.innerHTML = `${titleHtml}<div class="text-base">${step.content}</div>`;
                
                container.appendChild(s);
                MathJax.typesetPromise([s]);
                
                stepIndex++;
                updateStepCounter();
                container.scrollTop = container.scrollHeight;
            }

            if (stepIndex >= currentProblem.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> H·∫øt';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const finalInp = document.getElementById('ans-final');
            const userVal = parseFloat(finalInp.value.replace(/,/g, '').replace(/\s/g, ''));
            const correctVal = currentProblem.finalAns;
            
            const fb = document.getElementById('feedback');
            fb.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');

            if (Math.abs(userVal - correctVal) < 0.1) {
                finalInp.classList.remove('border-gray-300', 'border-red-500');
                finalInp.classList.add('border-emerald-500', 'bg-emerald-50');

                if (statsEnabled) {
                    streak++;
                    correctTotal++;
                    fb.innerHTML = '<i class="fas fa-crown"></i> Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.';
                    fb.classList.add('bg-green-100', 'text-green-800');
                    updateStatsUI();
                } else {
                    fb.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem h∆∞·ªõng d·∫´n)';
                    fb.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                isAnswered = true;
                const timer = setInterval(() => {
                    if (stepIndex < currentProblem.steps.length) showNextStep();
                    else clearInterval(timer);
                }, 400);

            } else {
                finalInp.classList.remove('border-gray-300', 'border-emerald-500');
                finalInp.classList.add('border-red-500', 'bg-red-50');
                
                fb.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Sai r·ªìi. H√£y th·ª≠ l·∫°i ho·∫∑c xem h∆∞·ªõng d·∫´n.`;
                fb.classList.add('bg-red-100', 'text-red-700');
                
                if (statsEnabled) {
                    streak = 0;
                    wrongTotal++;
                    updateStatsUI();
                }
            }
        }

        window.onload = function() {
            nextQuestion();
        };

    </script>
</body>
</html>