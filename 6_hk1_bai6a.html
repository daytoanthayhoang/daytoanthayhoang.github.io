<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 6a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar {
            width: 8px;
        }
        #steps-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .input-group:focus-within label {
            color: #4f46e5;
        }
        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box {
            transition: all 0.3s ease;
        }
        .stats-box:hover {
            transform: translateY(-2px);
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-calculator mr-2"></i>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 6a
            </h1>
            <p class="text-white font-medium">Ch·ªß ƒë·ªÅ: To√°n th·ª±c t·∫ø s·ªë nguy√™n</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[250px] relative flex items-center">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        
                        <div id="problem-text" class="font-mono text-lg md:text-xl w-full text-center leading-relaxed px-2">
                            Loading...
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner relative">
                        <!-- Problem Type Selection -->
                        <div class="mb-4 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                            <label class="block text-indigo-800 font-bold text-xs uppercase mb-1">Ch·ªçn d·∫°ng luy·ªán t·∫≠p:</label>
                            <select id="problem-type" class="w-full p-2 text-sm font-bold text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors cursor-pointer" onchange="nextQuestion()">
                                <option value="all">üé≤ Ng·∫´u nhi√™n (T·∫•t c·∫£)</option>
                                <option value="profit">üí∞ D·∫°ng 1: Kinh doanh & L·ª£i nhu·∫≠n</option>
                                <option value="temp">üå°Ô∏è D·∫°ng 2: S·ª± thay ƒë·ªïi Nhi·ªát ƒë·ªô</option>
                                <option value="score">üéØ D·∫°ng 3: ƒêi·ªÉm s·ªë cu·ªôc thi</option>
                                <option value="height">‚úàÔ∏è D·∫°ng 4: ƒê·ªô cao & V·ªã tr√≠</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-600 font-bold text-sm uppercase mb-2 text-center">Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n:</label>
                            <div class="relative max-w-xs mx-auto">
                                <input type="number" id="user-ans" placeholder="?" 
                                    class="w-full text-center font-bold text-2xl p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                    onkeydown="if(event.key === 'Enter') checkAnswer()">
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm font-bold" id="unit-label"></div>
                            </div>
                            <p class="text-xs text-center text-gray-400 mt-2 italic">(Ch·ªâ nh·∫≠p s·ªë, v√≠ d·ª•: -500000 ho·∫∑c 24)</p>
                        </div>

                        <!-- Difficulty Toggle -->
                        <div class="flex items-center justify-between mb-4 border-t border-gray-200 pt-2">
                             <div class="text-xs text-gray-500 italic">
                                *Ch·∫ø ƒë·ªô kh√≥ = To√°n ngh·ªãch/Ph·ª©c t·∫°p
                            </div>
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-sm font-bold text-gray-600 peer-checked:text-red-600 transition-colors">
                                    <i class="fas fa-skull-crossbones mr-1"></i>Ch·∫ø ƒë·ªô kh√≥
                                </span>
                            </label>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <!-- Feedback Area -->
                        <div id="feedback" class="hidden mt-4 text-center p-3 rounded-lg text-sm font-bold"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[500px] lg:h-[550px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <!-- Button -->
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Rule Hint Area -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <i class="fas fa-info-circle mr-2 text-yellow-600"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>
                    
                    <!-- Scrollable Steps (The "Exam Paper") -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full pb-4">
        <p>¬© C√¥ng c·ª• √¥n t·∫≠p To√°n 6 - B√†i 6a: To√°n th·ª±c t·∫ø s·ªë nguy√™n</p>
    </footer>

    <script>
        // --- Configuration & Utils ---
        const state = {
            streak: 0,
            correct: 0,
            wrong: 0,
            skipped: 0
        };

        let currentData = {
            answer: 0,
            allSteps: [],
            unit: ""
        };
        let isAnswered = false;
        let stepIndex = 0;
        let usedHint = false;

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function formatMoney(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // --- Core Logic: Generate Problem ---

        function generateProblem() {
            const isHard = document.getElementById('mode-hard').checked;
            const selectedType = document.getElementById('problem-type').value;
            
            // Determine Problem Type
            let type = selectedType;
            if (type === 'all') {
                const types = ['profit', 'temp', 'score', 'height'];
                type = types[getRandomInt(0, types.length - 1)];
            }

            // --- TYPE 1: PROFIT (L·ª£i Nhu·∫≠n) ---
            if (type === 'profit') {
                const names = ["Lan", "Mai", "Hoa", "B√¨nh", "Minh"];
                const name = names[getRandomInt(0, names.length - 1)];
                const item = ["tr√† s·ªØa", "qu·∫ßn √°o", "b√°nh ng·ªçt", "gi√†y d√©p"][getRandomInt(0, 3)];

                if (!isHard) {
                    // NORMAL (Xu√¥i): Calculate Total Profit
                    const days1 = getRandomInt(10, 30);
                    const profitPerDay1 = getRandomInt(1, 5) * 100000; 
                    const days2 = getRandomInt(5, 15);
                    const lossPerDay2 = getRandomInt(1, 4) * 100000; 
                    const profitPerDay2 = -lossPerDay2;
                    const totalProfit = (days1 * profitPerDay1) + (days2 * profitPerDay2);
                    
                    return {
                        question: `Ch·ªã ${name} b√°n ${item}. ${days1} ng√†y ƒë·∫ßu l√£i ${formatMoney(profitPerDay1)} ƒë/ng√†y. ${days2} ng√†y sau l·ªó ${formatMoney(lossPerDay2)} ƒë/ng√†y. T√≠nh t·ªïng l·ª£i nhu·∫≠n?`,
                        answer: totalProfit,
                        unit: "ƒë·ªìng",
                        steps: [
                            { type: 'header', text: 'T√≥m t·∫Øt', rule: 'L√£i (+), L·ªó (-).' },
                            { type: 'step', text: `Giai ƒëo·∫°n 1: ${days1} . ${formatMoney(profitPerDay1)}` },
                            { type: 'step', text: `Giai ƒëo·∫°n 2: ${days2} . (${formatMoney(profitPerDay2)})` },
                            { type: 'header', text: 'Gi·∫£i' },
                            { type: 'step', text: `Ph√©p t√≠nh t·ªïng l·ª£i nhu·∫≠n:` },
                            { type: 'step', text: `${days1}.${formatMoney(profitPerDay1)} + ${days2}.(${formatMoney(profitPerDay2)})` },
                            { type: 'step', text: `= ${formatMoney(days1 * profitPerDay1)} + (${formatMoney(days2 * profitPerDay2)})` },
                            { type: 'step', text: `= ${formatMoney(totalProfit)} (ƒë·ªìng)`, isLast: true },
                            { type: 'step', text: `K·∫øt lu·∫≠n: ${totalProfit >= 0 ? 'L√£i' : 'L·ªó'} ${formatMoney(Math.abs(totalProfit))} ƒë·ªìng.` }
                        ]
                    };
                } else {
                    // HARD (Ngh·ªãch): Find Profit of Period 2 given Total
                    const days1 = getRandomInt(5, 10);
                    const profit1 = getRandomInt(2, 5) * 1000000; // Period 1 profit (Total)
                    
                    const days2 = getRandomInt(5, 10);
                    const profit2 = -getRandomInt(1, 3) * 1000000; // Period 2 profit (Total) - hidden
                    
                    const finalProfit = profit1 + profit2;

                    return {
                        question: `C·ª≠a h√†ng ${item} c·ªßa ${name} c√≥ t·ªïng k·∫øt sau 2 th√°ng l√† l√£i ${formatMoney(finalProfit)} ƒë·ªìng. Bi·∫øt th√°ng 1 c·ª≠a h√†ng l√£i ${formatMoney(profit1)} ƒë·ªìng. H·ªèi th√°ng 2 c·ª≠a h√†ng l√£i hay l·ªó bao nhi√™u ti·ªÅn?`,
                        answer: profit2,
                        unit: "ƒë·ªìng",
                        steps: [
                            { type: 'header', text: 'Ph√¢n t√≠ch (To√°n ngh·ªãch)', rule: 'T·ªïng = Th√°ng 1 + Th√°ng 2 => Th√°ng 2 = T·ªïng - Th√°ng 1' },
                            { type: 'step', text: `L·ª£i nhu·∫≠n t·ªïng: ${formatMoney(finalProfit)}` },
                            { type: 'step', text: `L·ª£i nhu·∫≠n th√°ng 1: ${formatMoney(profit1)}` },
                            { type: 'header', text: 'Gi·∫£i', rule: '‚ö†Ô∏è L∆∞u √Ω ph√©p tr·ª´ s·ªë nguy√™n' },
                            { type: 'step', text: `L·ª£i nhu·∫≠n th√°ng 2 l√†:` },
                            { type: 'step', text: `${finalProfit} - ${profit1}` },
                            { type: 'step', text: `= ${formatMoney(profit2)} (ƒë·ªìng)`, isLast: true },
                            { type: 'step', text: `K·∫øt lu·∫≠n: Th√°ng 2 l·ªó ${formatMoney(Math.abs(profit2))} ƒë·ªìng.` }
                        ]
                    };
                }
            }

            // --- TYPE 2: TEMPERATURE (Nhi·ªát ƒë·ªô) ---
            if (type === 'temp') {
                if (!isHard) {
                    // NORMAL (Xu√¥i): Calculate Final Temp
                    const startTemp = getRandomInt(20, 35); 
                    const rate = getRandomInt(2, 5); 
                    const time = getRandomInt(5, 15); 
                    const finalTemp = startTemp - (rate * time);

                    return {
                        question: `T·ªß ƒë√¥ng ƒëang ·ªü ${startTemp}¬∞C. Nhi·ªát ƒë·ªô gi·∫£m ${rate}¬∞C m·ªói ph√∫t. H·ªèi sau ${time} ph√∫t, nhi·ªát ƒë·ªô l√† bao nhi√™u?`,
                        answer: finalTemp,
                        unit: "¬∞C",
                        steps: [
                            { type: 'header', text: 'Ph√¢n t√≠ch', rule: 'Nhi·ªát ƒë·ªô gi·∫£m => Tr·ª´ b·ªõt' },
                            { type: 'step', text: `Gi·∫£m t·ªïng c·ªông: ${time} . ${rate} = ${time * rate}¬∞C` },
                            { type: 'header', text: 'Gi·∫£i' },
                            { type: 'step', text: `Nhi·ªát ƒë·ªô l√∫c sau l√†:` },
                            { type: 'step', text: `${startTemp} - ${time * rate} = ${finalTemp} (¬∞C)`, isLast: true }
                        ]
                    };
                } else {
                    // HARD (Ngh·ªãch): Find Time
                    const startTemp = getRandomInt(25, 30);
                    const rate = getRandomInt(2, 4);
                    const time = getRandomInt(10, 20); 
                    const finalTemp = startTemp - (rate * time); 

                    return {
                        question: `M·ªôt kho l·∫°nh ƒëang ·ªü ${startTemp}¬∞C. M√°y l√†m l·∫°nh gi·∫£m ƒë∆∞·ª£c ${rate}¬∞C m·ªói ph√∫t. H·ªèi sau bao l√¢u nhi·ªát ƒë·ªô ƒë·∫°t ${finalTemp}¬∞C?`,
                        answer: time,
                        unit: "ph√∫t",
                        steps: [
                            { type: 'header', text: 'Ph√¢n t√≠ch (To√°n ngh·ªãch)', rule: 'T√¨m ƒë·ªô ch√™nh l·ªách nhi·ªát ƒë·ªô tr∆∞·ªõc, sau ƒë√≥ chia cho t·ªëc ƒë·ªô.' },
                            { type: 'step', text: `Nhi·ªát ƒë·ªô c·∫ßn gi·∫£m l√†:` },
                            { type: 'step', text: `${startTemp} - (${finalTemp}) = ${startTemp - finalTemp} (¬∞C)` },
                            { type: 'header', text: 'Gi·∫£i' },
                            { type: 'step', text: `Th·ªùi gian c·∫ßn thi·∫øt l√†:` },
                            { type: 'step', text: `${startTemp - finalTemp} : ${rate} = ${time} (ph√∫t)`, isLast: true }
                        ]
                    };
                }
            }

            // --- TYPE 3: SCORES (ƒêi·ªÉm s·ªë) ---
            if (type === 'score') {
                if (!isHard) {
                    // NORMAL (Xu√¥i): Calculate Total Score
                    const correct = getRandomInt(10, 20);
                    const wrong = getRandomInt(2, 5);
                    const ptsCorrect = 10;
                    const ptsWrong = -5;
                    const score = (correct * ptsCorrect) + (wrong * ptsWrong);

                    return {
                        question: `Thi tr·∫Øc nghi·ªám: ƒê√∫ng +${ptsCorrect} ƒëi·ªÉm, Sai ${ptsWrong} ƒëi·ªÉm. B·∫°n An ƒë√∫ng ${correct} c√¢u, sai ${wrong} c√¢u. H·ªèi An ƒë∆∞·ª£c bao nhi√™u ƒëi·ªÉm?`,
                        answer: score,
                        unit: "ƒëi·ªÉm",
                        steps: [
                            { type: 'header', text: 'T√≥m t·∫Øt', rule: 'ƒêi·ªÉm = (ƒê√∫ng x 10) + (Sai x -5)' },
                            { type: 'step', text: `ƒêi·ªÉm c√¢u ƒë√∫ng: ${correct} . 10 = ${correct*10}` },
                            { type: 'step', text: `ƒêi·ªÉm c√¢u sai: ${wrong} . (-5) = ${wrong*ptsWrong}` },
                            { type: 'header', text: 'Gi·∫£i' },
                            { type: 'step', text: `T·ªïng ƒëi·ªÉm c·ªßa An:` },
                            { type: 'step', text: `${correct*10} + (${wrong*ptsWrong}) = ${score} (ƒëi·ªÉm)`, isLast: true }
                        ]
                    };
                } else {
                    // HARD (Ngh·ªãch): Find Wrong Answers given Total Score
                    const correct = getRandomInt(15, 20);
                    const wrong = getRandomInt(1, 6);
                    const ptsCorrect = 5;
                    const ptsWrong = -2;
                    const totalScore = (correct * ptsCorrect) + (wrong * ptsWrong);

                    return {
                        question: `Trong cu·ªôc thi: ƒê√∫ng +${ptsCorrect}ƒë, Sai tr·ª´ ${Math.abs(ptsWrong)}ƒë (t·ª©c ${ptsWrong}ƒë). B·∫°n B√¨nh tr·∫£ l·ªùi ƒë√∫ng ${correct} c√¢u v√† nh·∫≠n ƒë∆∞·ª£c t·ªïng ${totalScore} ƒëi·ªÉm. H·ªèi B√¨nh ƒë√£ tr·∫£ l·ªùi sai bao nhi√™u c√¢u?`,
                        answer: wrong,
                        unit: "c√¢u",
                        steps: [
                            { type: 'header', text: 'Ph√¢n t√≠ch (To√°n ngh·ªãch)', rule: 'T√≠nh ƒëi·ªÉm t·ª´ c√°c c√¢u ƒë√∫ng tr∆∞·ªõc. Ph·∫ßn c√≤n thi·∫øu l√† do b·ªã tr·ª´ ƒëi·ªÉm.' },
                            { type: 'step', text: `S·ªë ƒëi·ªÉm nh·∫≠n t·ª´ ${correct} c√¢u ƒë√∫ng: ${correct} . ${ptsCorrect} = ${correct*ptsCorrect} ƒë` },
                            { type: 'step', text: `S·ªë ƒëi·ªÉm b·ªã m·∫•t do sai: T·ªïng - ƒêi·ªÉm ƒê√∫ng` },
                            { type: 'step', text: `${totalScore} - ${correct*ptsCorrect} = ${totalScore - (correct*ptsCorrect)} ƒë` },
                            { type: 'header', text: 'Gi·∫£i' },
                            { type: 'step', text: `S·ªë c√¢u tr·∫£ l·ªùi sai l√†:` },
                            { type: 'step', text: `${totalScore - (correct*ptsCorrect)} : (${ptsWrong}) = ${wrong} (c√¢u)`, isLast: true }
                        ]
                    };
                }
            }

            // --- TYPE 4: HEIGHT (ƒê·ªô cao) ---
            if (type === 'height') {
                if (!isHard) {
                    // NORMAL (Xu√¥i): Calculate Final Height
                    const startH = getRandomInt(200, 500); 
                    const move1 = -getRandomInt(50, 100); 
                    const move2 = getRandomInt(20, 50);  
                    const finalH = startH + move1 + move2;

                    return {
                        question: `M√°y bay ƒëang ·ªü ƒë·ªô cao ${startH}m. N√≥ h·∫° xu·ªëng ${Math.abs(move1)}m, r·ªìi l·∫°i bay l√™n ${move2}m. T√¨m ƒë·ªô cao cu·ªëi c√πng?`,
                        answer: finalH,
                        unit: "m√©t",
                        steps: [
                            { type: 'header', text: 'Quy ∆∞·ªõc', rule: 'H·∫° xu·ªëng (-), Bay l√™n (+)' },
                            { type: 'step', text: `Ban ƒë·∫ßu: ${startH}` },
                            { type: 'step', text: `H·∫° xu·ªëng: ${move1}` },
                            { type: 'step', text: `Bay l√™n: +${move2}` },
                            { type: 'header', text: 'Gi·∫£i' },
                            { type: 'step', text: `ƒê·ªô cao cu·ªëi c√πng:` },
                            { type: 'step', text: `${startH} - ${Math.abs(move1)} + ${move2} = ${finalH} (m)`, isLast: true }
                        ]
                    };
                } else {
                    // HARD (Ngh·ªãch): Find First Movement
                    const startH = -getRandomInt(20, 40); // Submarine depth
                    const move1 = -getRandomInt(10, 20); // Hidden move (Dive deeper)
                    const move2 = getRandomInt(30, 50); // Surface
                    const finalH = startH + move1 + move2;

                    return {
                        question: `T√†u ng·∫ßm ƒëang ·ªü ƒë·ªô s√¢u ${Math.abs(startH)}m (ƒë·ªô cao ${startH}m). T√†u l·∫∑n xu·ªëng th√™m m·ªôt ƒëo·∫°n, sau ƒë√≥ n·ªïi l√™n ${move2}m th√¨ d·ª´ng ·ªü ƒë·ªô cao ${finalH}m. H·ªèi t√†u ƒë√£ l·∫∑n xu·ªëng bao nhi√™u m√©t?`,
                        answer: Math.abs(move1), // User usually enters positive distance for "how many meters"
                        unit: "m√©t",
                        steps: [
                            { type: 'header', text: 'Ph√¢n t√≠ch (To√°n ngh·ªãch)', rule: 'Start + Move1 + Move2 = Final => Move1 = Final - Start - Move2' },
                            { type: 'step', text: `G·ªçi ƒë·ªô cao l·∫∑n th√™m l√† x (s·ªë √¢m)` },
                            { type: 'step', text: `Ta c√≥: ${startH} + x + ${move2} = ${finalH}` },
                            { type: 'header', text: 'Gi·∫£i' },
                            { type: 'step', text: `Gi√° tr·ªã ƒë·∫°i s·ªë c·ªßa l·∫ßn di chuy·ªÉn ƒë·∫ßu:` },
                            { type: 'step', text: `x = ${finalH} - ${startH} - ${move2} = ${move1}` },
                            { type: 'step', text: `V·∫≠y t√†u ƒë√£ l·∫∑n xu·ªëng:`, isLast: true },
                            { type: 'step', text: `|${move1}| = ${Math.abs(move1)} m√©t` }
                        ]
                    };
                }
            }
        }

        // --- UI Functions ---

        function renderStats() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = state.streak;
            if (state.streak > 2) {
                streakEl.classList.add('streak-fire');
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${state.streak}`;
            } else {
                streakEl.classList.remove('streak-fire');
            }

            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-skipped').textContent = state.skipped;
        }

        function nextQuestion() {
            if (!isAnswered && document.getElementById('problem-text').innerText !== 'Loading...') {
                state.skipped++;
                state.streak = 0;
                renderStats();
            }

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            
            const inputEl = document.getElementById('user-ans');
            inputEl.value = '';
            inputEl.disabled = false;
            inputEl.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');
            
            isAnswered = false;
            stepIndex = 0;
            usedHint = false;
            
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center"><i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i><span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span></div>`;
            
            const btnStep = document.getElementById('btn-show-step');
            btnStep.innerHTML = '<span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>';
            btnStep.disabled = false;

            const data = generateProblem();
            currentData = data;

            document.getElementById('problem-text').textContent = data.question;
            document.getElementById('unit-label').textContent = data.unit;
            document.getElementById('step-counter').textContent = `0/${currentData.steps.length}`;
            
            // Focus input
            inputEl.focus();
        }

        function showNextStep() {
            usedHint = true;
            
            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            const ruleContent = document.getElementById('rule-content');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentData.steps.length) {
                const item = currentData.steps[stepIndex];
                let newElement = null; 
                
                if (item.type === 'header') {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "mt-4 mb-2 text-xs font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 flex items-center";
                    headerDiv.innerHTML = `<i class="fas fa-caret-right mr-1"></i> ${item.text}`;
                    container.appendChild(headerDiv);
                    newElement = headerDiv;

                    if (item.rule) {
                        ruleContent.textContent = item.rule;
                        ruleArea.classList.remove('hidden');
                        ruleArea.classList.remove('animate-pulse');
                        void ruleArea.offsetWidth; // trigger reflow
                        ruleArea.classList.add('animate-pulse');
                    }
                } else {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-item bg-white p-2 rounded border-l-4 shadow-sm mb-2 text-sm md:text-base font-mono';
                    
                    if (item.isLast) {
                        stepDiv.classList.add('border-green-500', 'bg-green-50');
                        stepDiv.innerHTML = `<span class="text-green-700 font-bold">${item.text}</span>`;
                    } else {
                        stepDiv.classList.add('border-indigo-400');
                        stepDiv.textContent = item.text;
                    }
                    container.appendChild(stepDiv);
                    newElement = stepDiv;
                }

                if (newElement) {
                    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                }

                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentData.steps.length}`;
            }

            if (stepIndex >= currentData.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>H·∫øt</span>';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const inputEl = document.getElementById('user-ans');
            const userVal = parseInt(inputEl.value);
            
            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');

            if (isNaN(userVal)) {
                 feedback.textContent = "Vui l√≤ng nh·∫≠p m·ªôt s·ªë!";
                 feedback.classList.add('bg-yellow-100', 'text-yellow-800');
                 feedback.classList.remove('hidden');
                 return;
            }

            if (userVal === currentData.answer) {
                if (!usedHint) {
                    state.correct++;
                    state.streak++;
                    feedback.innerHTML = '<i class="fas fa-crown"></i> Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.';
                    feedback.classList.add('bg-green-100', 'text-green-800');
                } else {
                    feedback.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem g·ª£i √Ω)';
                    feedback.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                inputEl.classList.add('border-green-500', 'bg-green-50');
                inputEl.classList.remove('border-gray-300');
                
                renderStats();
                
                // Auto reveal steps
                const reveal = setInterval(() => {
                    if(stepIndex < currentData.steps.length) showNextStep();
                    else clearInterval(reveal);
                }, 100);
                isAnswered = true;
            } else {
                state.wrong++;
                state.streak = 0;
                renderStats();

                inputEl.classList.add('border-red-500', 'bg-red-50');
                feedback.textContent = `Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† ${currentData.answer}. Xem l·ªùi gi·∫£i b√™n ph·∫£i nh√©!`;
                feedback.classList.add('bg-red-100', 'text-red-800');
            }
        }

        // Initialize
        window.onload = nextQuestion;

    </script>
</body>
</html>