<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 6a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar {
            width: 8px;
        }
        #steps-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .input-group:focus-within label {
            color: #4f46e5;
        }
        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box {
            transition: all 0.3s ease;
        }
        .stats-box:hover {
            transform: translateY(-2px);
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-calculator mr-2"></i>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 6a
            </h1>
            <p class="text-white font-medium">Ch·ªß ƒë·ªÅ: To√°n th·ª±c t·∫ø s·ªë nguy√™n (T·ªïng h·ª£p & N√¢ng cao)</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[250px] relative flex items-center">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        
                        <div id="problem-text" class="font-mono text-lg md:text-xl w-full text-center leading-relaxed px-2">
                            Loading...
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner relative">
                        <!-- Problem Type Selection -->
                        <div class="mb-4 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                            <label class="block text-indigo-800 font-bold text-xs uppercase mb-1">Ch·ªçn d·∫°ng luy·ªán t·∫≠p:</label>
                            <select id="problem-type" class="w-full p-2 text-sm font-bold text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors cursor-pointer" onchange="nextQuestion()">
                                <option value="all">üé≤ Ng·∫´u nhi√™n (T·∫•t c·∫£)</option>
                                <option value="profit">üí∞ D·∫°ng 1: Kinh doanh & L·ª£i nhu·∫≠n</option>
                                <option value="temp">üå°Ô∏è D·∫°ng 2: S·ª± thay ƒë·ªïi Nhi·ªát ƒë·ªô</option>
                                <option value="score">üéØ D·∫°ng 3: ƒêi·ªÉm s·ªë cu·ªôc thi</option>
                                <option value="height">‚úàÔ∏è D·∫°ng 4: ƒê·ªô cao (T√†u ng·∫ßm/M√°y bay)</option>
                                <option value="elevator">üèóÔ∏è D·∫°ng 5: Thang m√°y & T√≤a nh√†</option>
                                <option value="history">‚è≥ D·∫°ng 6: L·ªãch s·ª≠ & Th·ªùi gian</option>
                                <option value="timezone">üåç D·∫°ng 7: M√∫i gi·ªù th·∫ø gi·ªõi (M·ªõi)</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-600 font-bold text-sm uppercase mb-2 text-center">Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n:</label>
                            <div class="relative max-w-xs mx-auto">
                                <input type="number" id="user-ans" placeholder="?" 
                                    class="w-full text-center font-bold text-2xl p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                    onkeydown="if(event.key === 'Enter') checkAnswer()">
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm font-bold" id="unit-label"></div>
                            </div>
                            <p class="text-xs text-center text-gray-400 mt-2 italic">(Ch·ªâ nh·∫≠p s·ªë, v√≠ d·ª•: -500000 ho·∫∑c 24)</p>
                        </div>

                        <!-- Difficulty Toggle -->
                        <div class="flex items-center justify-between mb-4 border-t border-gray-200 pt-2">
                             <div class="text-xs text-gray-500 italic">
                                *Ch·∫ø ƒë·ªô kh√≥ = B√†i to√°n t·ªïng h·ª£p/Nhi·ªÅu b∆∞·ªõc
                            </div>
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-sm font-bold text-gray-600 peer-checked:text-red-600 transition-colors">
                                    <i class="fas fa-skull-crossbones mr-1"></i>Ch·∫ø ƒë·ªô kh√≥
                                </span>
                            </label>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <!-- Feedback Area -->
                        <div id="feedback" class="hidden mt-4 text-center p-3 rounded-lg text-sm font-bold"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[500px] lg:h-[550px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <!-- Button -->
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Rule Hint Area -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <i class="fas fa-info-circle mr-2 text-yellow-600"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>
                    
                    <!-- Scrollable Steps (The "Exam Paper") -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- Configuration & Utils ---
        const state = {
            streak: 0,
            correct: 0,
            wrong: 0,
            skipped: 0
        };

        let currentData = {
            answer: 0,
            allSteps: [],
            unit: ""
        };
        let isAnswered = false;
        let stepIndex = 0;
        let usedHint = false;

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function formatMoney(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function formatZone(z) {
            return z >= 0 ? `+${z}` : `${z}`;
        }

        // --- Core Logic: Generate Problem ---

        function generateProblem() {
            const isHard = document.getElementById('mode-hard').checked;
            const selectedType = document.getElementById('problem-type').value;
            
            // Determine Problem Type
            let type = selectedType;
            if (type === 'all') {
                const types = ['profit', 'temp', 'score', 'height', 'elevator', 'history', 'timezone'];
                type = types[getRandomInt(0, types.length - 1)];
            }

            // --- TYPE 1: PROFIT (L·ª£i Nhu·∫≠n) ---
            if (type === 'profit') {
                const names = ["Lan", "Mai", "Hoa", "B√¨nh", "Minh"];
                const name = names[getRandomInt(0, names.length - 1)];
                const item = ["tr√† s·ªØa", "qu·∫ßn √°o", "b√°nh ng·ªçt", "gi√†y d√©p"][getRandomInt(0, 3)];

                if (!isHard) {
                    // NORMAL: Calculate Total Profit
                    const days1 = getRandomInt(10, 30);
                    const profitPerDay1 = getRandomInt(1, 5) * 100000; 
                    const days2 = getRandomInt(5, 15);
                    const lossPerDay2 = getRandomInt(1, 4) * 100000; 
                    const profitPerDay2 = -lossPerDay2;
                    const totalProfit = (days1 * profitPerDay1) + (days2 * profitPerDay2);
                    
                    return {
                        question: `Ch·ªã ${name} b√°n ${item}. ${days1} ng√†y ƒë·∫ßu l√£i ${formatMoney(profitPerDay1)} ƒë/ng√†y. ${days2} ng√†y sau l·ªó ${formatMoney(lossPerDay2)} ƒë/ng√†y. T√≠nh t·ªïng l·ª£i nhu·∫≠n?`,
                        answer: totalProfit,
                        unit: "ƒë·ªìng",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: Quy ƒë·ªïi ra s·ªë nguy√™n', rule: 'M·∫πo: H√£y d√πng s·ªë √¢m cho kho·∫£n L·ªó ƒë·ªÉ c·ªông ƒë·∫°i s·ªë.' },
                            { type: 'step', text: `L√£i ${formatMoney(profitPerDay1)} ƒë => +${formatMoney(profitPerDay1)}` },
                            { type: 'step', text: `L·ªó ${formatMoney(lossPerDay2)} ƒë => -${formatMoney(lossPerDay2)}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Thi·∫øt l·∫≠p ph√©p t√≠nh', rule: 'Vi·∫øt bi·ªÉu th·ª©c tr∆∞·ªõc r·ªìi m·ªõi t√≠nh ra k·∫øt qu·∫£.' },
                            { type: 'step', text: `T·ªïng l·ª£i nhu·∫≠n = (Ng√†y ƒë·∫ßu x L√£i) + (Ng√†y sau x L·ªó)` },
                            { type: 'step', text: `Bi·ªÉu th·ª©c: ${days1}.${formatMoney(profitPerDay1)} + ${days2}.(${formatMoney(profitPerDay2)})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: T√≠nh to√°n & K·∫øt lu·∫≠n' },
                            { type: 'step', text: `= ${formatMoney(days1 * profitPerDay1)} + (${formatMoney(days2 * profitPerDay2)})` },
                            { type: 'step', text: `= ${formatMoney(totalProfit)} (ƒë·ªìng)`, isLast: true },
                            { type: 'step', text: `K·∫øt lu·∫≠n: ${totalProfit >= 0 ? 'L√£i' : 'L·ªó'} ${formatMoney(Math.abs(totalProfit))} ƒë·ªìng.` }
                        ]
                    };
                } else {
                    // HARD: Capital Management
                    const startCapital = getRandomInt(10, 50) * 1000000;
                    const importCost = getRandomInt(5, 15) * 1000000; 
                    const revenue = getRandomInt(8, 20) * 1000000;   
                    const rent = getRandomInt(2, 5) * 1000000;        
                    
                    const finalCapital = startCapital - importCost + revenue - rent;

                    return {
                        question: `Ch·ªã ${name} m·ªü c·ª≠a h√†ng v·ªõi v·ªën ban ƒë·∫ßu ${formatMoney(startCapital)}ƒë. Trong th√°ng ƒë·∫ßu: nh·∫≠p h√†ng h·∫øt ${formatMoney(importCost)}ƒë, doanh thu b√°n ƒë∆∞·ª£c ${formatMoney(revenue)}ƒë, tr·∫£ ti·ªÅn thu√™ m·∫∑t b·∫±ng ${formatMoney(rent)}ƒë. H·ªèi sau th√°ng ƒë·∫ßu, s·ªë ti·ªÅn trong qu·ªπ c·ªßa ch·ªã ${name} l√† bao nhi√™u?`,
                        answer: finalCapital,
                        unit: "ƒë·ªìng",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: X√°c ƒë·ªãnh d·∫•u', rule: 'Chi ph√≠ l√† s·ªë √¢m (-), Thu nh·∫≠p l√† s·ªë d∆∞∆°ng (+).' },
                            { type: 'step', text: `Nh·∫≠p h√†ng: -${formatMoney(importCost)}` },
                            { type: 'step', text: `Doanh thu: +${formatMoney(revenue)}` },
                            { type: 'step', text: `Thu√™ m·∫∑t b·∫±ng: -${formatMoney(rent)}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Vi·∫øt bi·ªÉu th·ª©c c·ªông', rule: 'Sai l·∫ßm th∆∞·ªùng g·∫∑p: D√πng ph√©p tr·ª´ s·ªë h·ªçc g√¢y nh·∫ßm l·∫´n. H√£y c·ªông c√°c s·ªë nguy√™n.' },
                            { type: 'step', text: `Qu·ªπ = V·ªën + (Doanh thu) + (Chi ph√≠)` },
                            { type: 'step', text: `${formatMoney(startCapital)} + (${formatMoney(revenue)}) + (-${formatMoney(importCost)}) + (-${formatMoney(rent)})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: T√≠nh to√°n' },
                            { type: 'step', text: `= ${formatMoney(startCapital)} + ${formatMoney(revenue)} - ${formatMoney(importCost)} - ${formatMoney(rent)}` },
                            { type: 'step', text: `= ${formatMoney(finalCapital)} (ƒë·ªìng)`, isLast: true }
                        ]
                    };
                }
            }

            // --- TYPE 2: TEMPERATURE (Nhi·ªát ƒë·ªô) ---
            if (type === 'temp') {
                if (!isHard) {
                    // NORMAL: Calculate Final Temp
                    const startTemp = getRandomInt(20, 35); 
                    const rate = getRandomInt(2, 5); 
                    const time = getRandomInt(5, 15); 
                    const finalTemp = startTemp - (rate * time);

                    return {
                        question: `T·ªß ƒë√¥ng ƒëang ·ªü ${startTemp}¬∞C. Nhi·ªát ƒë·ªô gi·∫£m ${rate}¬∞C m·ªói ph√∫t. H·ªèi sau ${time} ph√∫t, nhi·ªát ƒë·ªô l√† bao nhi√™u?`,
                        answer: finalTemp,
                        unit: "¬∞C",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: Quy ƒë·ªïi s·ª± thay ƒë·ªïi', rule: 'Gi·∫£m x ƒë·ªô nghƒ©a l√† c·ªông th√™m (-x) ƒë·ªô.' },
                            { type: 'step', text: `M·ª©c gi·∫£m m·ªói ph√∫t: -${rate}¬∞C` },
                            { type: 'step', text: `T·ªïng gi·∫£m trong ${time} ph√∫t: ${time} . (-${rate}) = -${time * rate}¬∞C` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Ph√©p t√≠nh nhi·ªát ƒë·ªô', rule: 'Nhi·ªát ƒë·ªô sau = Nhi·ªát ƒë·ªô ƒë·∫ßu + (S·ª± thay ƒë·ªïi)' },
                            { type: 'step', text: `${startTemp} + (-${time * rate})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt qu·∫£' },
                            { type: 'step', text: `= ${startTemp} - ${time * rate}` },
                            { type: 'step', text: `= ${finalTemp} (¬∞C)`, isLast: true }
                        ]
                    };
                } else {
                    // HARD: Multi-step Change (Finding Start)
                    const drop1 = getRandomInt(3, 8);
                    const rise1 = getRandomInt(5, 12);
                    const drop2 = getRandomInt(2, 6);
                    const startTemp = getRandomInt(20, 30);
                    const finalTemp = startTemp - drop1 + rise1 - drop2;

                    return {
                        question: `M·ªôt ph√≤ng th√≠ nghi·ªám ƒëi·ªÅu ch·ªânh nhi·ªát ƒë·ªô. Giai ƒëo·∫°n 1 gi·∫£m ${drop1}¬∞C, giai ƒëo·∫°n 2 tƒÉng ${rise1}¬∞C, giai ƒëo·∫°n 3 gi·∫£m th√™m ${drop2}¬∞C. Cu·ªëi c√πng nhi·ªát ƒë·ªô ƒëo ƒë∆∞·ª£c l√† ${finalTemp}¬∞C. H·ªèi nhi·ªát ƒë·ªô ban ƒë·∫ßu l√† bao nhi√™u?`,
                        answer: startTemp,
                        unit: "¬∞C",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: T∆∞ duy ng∆∞·ª£c (T√≠nh l√πi)', rule: 'ƒê·ªÉ t√¨m nhi·ªát ƒë·ªô ban ƒë·∫ßu, ta l·∫•y nhi·ªát ƒë·ªô cu·ªëi TR·ª™ ng∆∞·ª£c l·∫°i c√°c s·ª± thay ƒë·ªïi.' },
                            { type: 'step', text: `Nhi·ªát ƒë·ªô cu·ªëi c√πng: ${finalTemp}¬∞C` },
                            { type: 'step', text: `C√°c thay ƒë·ªïi: Gi·∫£m ${drop1} (-${drop1}), TƒÉng ${rise1} (+${rise1}), Gi·∫£m ${drop2} (-${drop2}).` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Thi·∫øt l·∫≠p ph√©p t√≠nh', rule: 'L∆∞u √Ω: Tr·ª´ cho s·ªë √¢m th√†nh c·ªông s·ªë d∆∞∆°ng.' },
                            { type: 'step', text: `Ban ƒë·∫ßu = Cu·ªëi - (C√°c thay ƒë·ªïi)` },
                            { type: 'step', text: `${finalTemp} - (-${drop2}) - (+${rise1}) - (-${drop1})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: T√≠nh to√°n' },
                            { type: 'step', text: `= ${finalTemp} + ${drop2} - ${rise1} + ${drop1}` },
                            { type: 'step', text: `= ${startTemp} (¬∞C)`, isLast: true }
                        ]
                    };
                }
            }

            // --- TYPE 3: SCORES (ƒêi·ªÉm s·ªë) ---
            if (type === 'score') {
                if (!isHard) {
                    const correct = getRandomInt(10, 20);
                    const wrong = getRandomInt(2, 5);
                    const ptsCorrect = 10;
                    const ptsWrong = -5;
                    const score = (correct * ptsCorrect) + (wrong * ptsWrong);

                    return {
                        question: `Thi tr·∫Øc nghi·ªám: ƒê√∫ng +${ptsCorrect} ƒëi·ªÉm, Sai ${ptsWrong} ƒëi·ªÉm. B·∫°n An ƒë√∫ng ${correct} c√¢u, sai ${wrong} c√¢u. H·ªèi An ƒë∆∞·ª£c bao nhi√™u ƒëi·ªÉm?`,
                        answer: score,
                        unit: "ƒëi·ªÉm",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: X√°c ƒë·ªãnh gi√° tr·ªã', rule: 'ƒêi·ªÉm sai l√† s·ªë √¢m. H√£y d√πng ph√©p nh√¢n s·ªë nguy√™n.' },
                            { type: 'step', text: `ƒêi·ªÉm t·ª´ c√¢u ƒë√∫ng: ${correct} . (+10)` },
                            { type: 'step', text: `ƒêi·ªÉm t·ª´ c√¢u sai: ${wrong} . (-5)` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Ph√©p t√≠nh t·ªïng' },
                            { type: 'step', text: `T·ªïng = (${correct}.10) + (${wrong}.(-5))` },
                            { type: 'step', text: `= ${correct*10} + (${wrong*ptsWrong})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt lu·∫≠n' },
                            { type: 'step', text: `= ${score} (ƒëi·ªÉm)`, isLast: true }
                        ]
                    };
                } else {
                    const correctA = getRandomInt(10, 15);
                    const wrongA = getRandomInt(2, 5);
                    const correctB = getRandomInt(10, 15);
                    const wrongB = getRandomInt(2, 5);
                    const ptsCorrect = 5;
                    const ptsWrong = -2;
                    const scoreA = correctA * ptsCorrect + wrongA * ptsWrong;
                    const scoreB = correctB * ptsCorrect + wrongB * ptsWrong;
                    const diff = scoreA - scoreB;

                    return {
                        question: `Hai b·∫°n thi ƒë·∫•u (ƒê√∫ng +${ptsCorrect}ƒë, Sai ${ptsWrong}ƒë). B·∫°n A: ${correctA} ƒë√∫ng, ${wrongA} sai. B·∫°n B: ${correctB} ƒë√∫ng, ${wrongB} sai. H·ªèi ƒëi·ªÉm c·ªßa b·∫°n A h∆°n b·∫°n B bao nhi√™u ƒëi·ªÉm?`,
                        answer: diff,
                        unit: "ƒëi·ªÉm",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: T√≠nh ƒëi·ªÉm t·ª´ng ng∆∞·ªùi', rule: 'C·∫©n th·∫≠n: Sai l√† c·ªông v·ªõi s·ªë √¢m.' },
                            { type: 'step', text: `A = ${correctA}.5 + ${wrongA}.(-2) = ${scoreA}` },
                            { type: 'step', text: `B = ${correctB}.5 + ${wrongB}.(-2) = ${scoreB}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Thi·∫øt l·∫≠p hi·ªáu s·ªë', rule: 'H∆°n k√©m nhau = Ph√©p tr·ª´ ƒë·∫°i s·ªë (A - B).' },
                            { type: 'step', text: `Hi·ªáu = ${scoreA} - ${scoreB}` },
                            { type: 'header', text: 'B∆∞·ªõc 3: T√≠nh to√°n' },
                            { type: 'step', text: `= ${diff} (ƒëi·ªÉm)`, isLast: true },
                            { type: 'step', text: `(N·∫øu ra s·ªë √¢m nghƒ©a l√† A th·∫•p ƒëi·ªÉm h∆°n B)` }
                        ]
                    };
                }
            }

            // --- TYPE 4: HEIGHT (ƒê·ªô cao) ---
            if (type === 'height') {
                if (!isHard) {
                    const startH = getRandomInt(200, 500); 
                    const move1 = -getRandomInt(50, 100); 
                    const move2 = getRandomInt(20, 50);  
                    const finalH = startH + move1 + move2;

                    return {
                        question: `M√°y bay ƒëang ·ªü ƒë·ªô cao ${startH}m. N√≥ h·∫° xu·ªëng ${Math.abs(move1)}m, r·ªìi l·∫°i bay l√™n ${move2}m. T√¨m ƒë·ªô cao cu·ªëi c√πng?`,
                        answer: finalH,
                        unit: "m√©t",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: Quy ƒë·ªïi chuy·ªÉn ƒë·ªông', rule: 'H·∫° xu·ªëng = C·ªông s·ªë √¢m. Bay l√™n = C·ªông s·ªë d∆∞∆°ng.' },
                            { type: 'step', text: `H·∫° ${Math.abs(move1)}m => +(${move1})` },
                            { type: 'step', text: `L√™n ${move2}m => +(${move2})` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Ph√©p t√≠nh c·ªông' },
                            { type: 'step', text: `${startH} + (${move1}) + ${move2}` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt qu·∫£' },
                            { type: 'step', text: `= ${startH - Math.abs(move1)} + ${move2}` },
                            { type: 'step', text: `= ${finalH} (m)`, isLast: true }
                        ]
                    };
                } else {
                    const posA = -getRandomInt(10, 50); 
                    const posC = -getRandomInt(60, 120); 
                    const dist = posA - posC; 

                    return {
                        question: `T√†u ng·∫ßm A ƒëang ·ªü ƒë·ªô cao ${posA}m (t·ª©c s√¢u ${Math.abs(posA)}m). T√†u ng·∫ßm B ƒëang ·ªü ƒë·ªô cao ${posC}m (t·ª©c s√¢u ${Math.abs(posC)}m). H·ªèi t√†u A n·∫±m cao h∆°n t√†u B bao nhi√™u m√©t?`,
                        answer: dist,
                        unit: "m√©t",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: X√°c ƒë·ªãnh t·ªça ƒë·ªô', rule: 'ƒê·ªô s√¢u l√† s·ªë √¢m.' },
                            { type: 'step', text: `T√†u A: ${posA}` },
                            { type: 'step', text: `T√†u B: ${posC}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Thi·∫øt l·∫≠p ph√©p tr·ª´', rule: 'Kho·∫£ng c√°ch ƒë·∫°i s·ªë = V·ªã tr√≠ tr√™n - V·ªã tr√≠ d∆∞·ªõi.' },
                            { type: 'step', text: `Kho·∫£ng c√°ch = ${posA} - (${posC})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: T√≠nh to√°n' },
                            { type: 'step', text: `Tr·ª´ s·ªë √¢m th√†nh c·ªông s·ªë d∆∞∆°ng: ${posA} + ${Math.abs(posC)}` },
                            { type: 'step', text: `= ${dist} (m√©t)`, isLast: true }
                        ]
                    };
                }
            }

            // --- TYPE 5: ELEVATOR (Thang m√°y) ---
            if (type === 'elevator') {
                if (!isHard) {
                    const startF = getRandomInt(0, 5); 
                    const move1 = getRandomInt(5, 10); 
                    const move2 = -getRandomInt(2, 8); 
                    const finalF = startF + move1 + move2;
                    const floorName = (f) => f === 0 ? "tr·ªát (0)" : (f < 0 ? `h·∫ßm B${Math.abs(f)}` : `t·∫ßng ${f}`);

                    return {
                        question: `Thang m√°y ƒëang ·ªü ${floorName(startF)}. N√≥ ƒëi l√™n ${move1} t·∫ßng, r·ªìi ƒëi xu·ªëng ${Math.abs(move2)} t·∫ßng. H·ªèi cu·ªëi c√πng thang m√°y d·ª´ng ·ªü t·∫ßng n√†o?`,
                        answer: finalF,
                        unit: "t·∫ßng",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: S·ªë h√≥a h√†nh tr√¨nh', rule: 'ƒêi xu·ªëng l√† c·ªông v·ªõi s·ªë nguy√™n √¢m.' },
                            { type: 'step', text: `V·ªã tr√≠ ƒë·∫ßu: ${startF}` },
                            { type: 'step', text: `ƒêi xu·ªëng ${Math.abs(move2)} => +(${move2})` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Bi·ªÉu th·ª©c c·ªông' },
                            { type: 'step', text: `${startF} + ${move1} + (${move2})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt qu·∫£' },
                            { type: 'step', text: `= ${finalF} (${floorName(finalF)})`, isLast: true }
                        ]
                    };
                } else {
                    const startF = getRandomInt(1, 5);
                    const move1 = getRandomInt(3, 6); // Up
                    const move2 = -getRandomInt(6, 10); // Down deep
                    const finalF = getRandomInt(5, 10); // Ends high
                    const move3 = finalF - (startF + move1 + move2);

                    return {
                        question: `Thang m√°y b·∫Øt ƒë·∫ßu t·ª´ t·∫ßng ${startF}. ƒêi l√™n ${move1} t·∫ßng, r·ªìi ƒëi xu·ªëng ${Math.abs(move2)} t·∫ßng. Sau ƒë√≥ n√≥ ƒëi l√™n th√™m m·ªôt ƒëo·∫°n n·ªØa th√¨ d·ª´ng l·∫°i ·ªü t·∫ßng ${finalF}. H·ªèi ƒëo·∫°n ƒëi l√™n cu·ªëi c√πng d√†i bao nhi√™u t·∫ßng?`,
                        answer: move3,
                        unit: "t·∫ßng",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: T√≠nh v·ªã tr√≠ t·∫°m th·ªùi', rule: 'T√≠nh v·ªã tr√≠ c·ªßa thang m√°y tr∆∞·ªõc khi ƒëi ƒëo·∫°n cu·ªëi.' },
                            { type: 'step', text: `V·ªã tr√≠ sau 2 l∆∞·ª£t ƒëi ƒë·∫ßu: ${startF} + ${move1} + (${move2}) = ${startF + move1 + move2}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: T√¨m ph·∫ßn c√≤n thi·∫øu', rule: 'ƒêo·∫°n ƒëi th√™m = ƒê√≠ch ƒë·∫øn - V·ªã tr√≠ hi·ªán t·∫°i' },
                            { type: 'step', text: `ƒê√≠ch ƒë·∫øn: ${finalF}` },
                            { type: 'step', text: `ƒêo·∫°n c·∫ßn ƒëi: ${finalF} - (${startF + move1 + move2})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt qu·∫£' },
                            { type: 'step', text: `= ${move3} (t·∫ßng)`, isLast: true }
                        ]
                    };
                }
            }

            // --- TYPE 6: HISTORY (L·ªãch s·ª≠) ---
            if (type === 'history') {
                if (!isHard) {
                    const birthYear = -getRandomInt(50, 300); // TCN
                    const age = getRandomInt(40, 80);
                    const deathYear = birthYear + age;
                    const formatYear = (y) => y < 0 ? `${Math.abs(y)} TCN` : `${y} SCN`;

                    return {
                        question: `Nh√† to√°n h·ªçc X sinh nƒÉm ${Math.abs(birthYear)} TCN v√† h∆∞·ªüng th·ªç ${age} tu·ªïi. H·ªèi √¥ng m·∫•t nƒÉm n√†o? (Bi·∫øt nƒÉm TCN l√† s·ªë nguy√™n √¢m, SCN l√† s·ªë nguy√™n d∆∞∆°ng, b·ªè qua nƒÉm 0).`,
                        answer: deathYear,
                        unit: "nƒÉm",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: Quy ∆∞·ªõc s·ªë √¢m', rule: 'NƒÉm TCN l√† s·ªë √¢m.' },
                            { type: 'step', text: `NƒÉm sinh: ${birthYear}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Ph√©p t√≠nh c·ªông', rule: 'Th·ªùi ƒëi·ªÉm m·∫•t = Th·ªùi ƒëi·ªÉm sinh + Th·ªùi gian s·ªëng.' },
                            { type: 'step', text: `${birthYear} + ${age}` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt lu·∫≠n' },
                            { type: 'step', text: `= ${deathYear}`, isLast: true },
                            { type: 'step', text: `Nghƒ©a l√† nƒÉm ${formatYear(deathYear)}` }
                        ]
                    };
                } else {
                    const birthA = -getRandomInt(200, 500);
                    const ageA = getRandomInt(50, 90);
                    const diedA = birthA + ageA;
                    const birthB = -getRandomInt(50, 100);
                    const ageB = getRandomInt(30, 80);
                    const diedB = birthB + ageB;
                    const diff = ageA - ageB;

                    return {
                        question: `√îng A sinh nƒÉm ${Math.abs(birthA)} TCN, m·∫•t nƒÉm ${diedA < 0 ? Math.abs(diedA) + ' TCN' : diedA + ' SCN'}. √îng B sinh nƒÉm ${Math.abs(birthB)} TCN, m·∫•t nƒÉm ${diedB < 0 ? Math.abs(diedB) + ' TCN' : diedB + ' SCN'}. H·ªèi √¥ng A s·ªëng th·ªç h∆°n √¥ng B bao nhi√™u tu·ªïi?`,
                        answer: diff,
                        unit: "tu·ªïi",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: T√≠nh tu·ªïi t·ª´ng ng∆∞·ªùi', rule: 'Tu·ªïi = NƒÉm m·∫•t - NƒÉm sinh (Ch√∫ √Ω tr·ª´ s·ªë √¢m).' },
                            { type: 'step', text: `Tu·ªïi A = ${diedA} - (${birthA}) = ${ageA}` },
                            { type: 'step', text: `Tu·ªïi B = ${diedB} - (${birthB}) = ${ageB}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: T√≠nh hi·ªáu', rule: 'Ch√™nh l·ªách = Tu·ªïi A - Tu·ªïi B' },
                            { type: 'step', text: `${ageA} - ${ageB}` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt qu·∫£' },
                            { type: 'step', text: `= ${diff} (tu·ªïi)`, isLast: true }
                        ]
                    };
                }
            }

            // --- TYPE 7: TIME ZONES (M√∫i gi·ªù) ---
            if (type === 'timezone') {
                const cities = [
                    { name: "H√† N·ªôi", zone: 7 },
                    { name: "Bangkok", zone: 7 },
                    { name: "Tokyo", zone: 9 },
                    { name: "B·∫Øc Kinh", zone: 8 },
                    { name: "Sydney", zone: 10 },
                    { name: "London", zone: 0 },
                    { name: "Paris", zone: 1 },
                    { name: "New York", zone: -5 },
                    { name: "Los Angeles", zone: -8 },
                    { name: "Moscow", zone: 3 }
                ];

                const origin = cities[getRandomInt(0, cities.length - 1)];
                let dest = cities[getRandomInt(0, cities.length - 1)];
                while (dest.name === origin.name) dest = cities[getRandomInt(0, cities.length - 1)];

                if (!isHard) {
                    const timeOrigin = getRandomInt(6, 18);
                    const diff = dest.zone - origin.zone;
                    let timeDestRaw = timeOrigin + diff;
                    let timeDest = timeDestRaw;
                    let dayShift = "";
                    if (timeDestRaw >= 24) {
                        timeDest = timeDestRaw - 24;
                        dayShift = "ng√†y h√¥m sau";
                    } else if (timeDestRaw < 0) {
                        timeDest = timeDestRaw + 24;
                        dayShift = "ng√†y h√¥m tr∆∞·ªõc";
                    }

                    return {
                        question: `Bi·∫øt ${origin.name} (m√∫i gi·ªù ${formatZone(origin.zone)}) ƒëang l√† ${timeOrigin} gi·ªù. H·ªèi l√∫c ƒë√≥ ·ªü ${dest.name} (m√∫i gi·ªù ${formatZone(dest.zone)}) l√† m·∫•y gi·ªù? (N·∫øu qua ng√†y kh√°c, h√£y quy ƒë·ªïi v·ªÅ gi·ªù trong ng√†y 0-23h).`,
                        answer: timeDest,
                        unit: "gi·ªù",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: T√≠nh ch√™nh l·ªách m√∫i', rule: 'Hi·ªáu m√∫i = M√∫i ƒë√≠ch - M√∫i ngu·ªìn' },
                            { type: 'step', text: `${dest.zone} - ${origin.zone} = ${diff}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Ph√©p t√≠nh gi·ªù', rule: 'Gi·ªù ƒë√≠ch = Gi·ªù ngu·ªìn + Hi·ªáu m√∫i' },
                            { type: 'step', text: `${timeOrigin} + (${diff}) = ${timeDestRaw}` },
                            { type: 'header', text: 'B∆∞·ªõc 3: X·ª≠ l√Ω qua ng√†y' },
                            ...(timeDestRaw !== timeDest ? [
                                { type: 'step', text: `V√¨ ${timeDestRaw} kh√¥ng thu·ªôc 0-24h n√™n ta ƒëi·ªÅu ch·ªânh.` },
                                { type: 'step', text: `= ${timeDest} gi·ªù (${dayShift})`, isLast: true }
                            ] : [
                                { type: 'step', text: `= ${timeDest} gi·ªù`, isLast: true }
                            ])
                        ]
                    };
                } else {
                    const departTime = getRandomInt(8, 14); 
                    const duration = getRandomInt(5, 12);
                    const diffZone = dest.zone - origin.zone;
                    let arrivalLocalRaw = departTime + diffZone + duration;
                    let arrivalLocal = arrivalLocalRaw;
                    let arrivalDayText = "c√πng ng√†y";
                    if (arrivalLocalRaw >= 24) {
                        arrivalLocal = arrivalLocalRaw - 24;
                        arrivalDayText = "ng√†y h√¥m sau";
                    } else if (arrivalLocalRaw < 0) {
                        arrivalLocal = arrivalLocalRaw + 24;
                        arrivalDayText = "ng√†y h√¥m tr∆∞·ªõc";
                    }

                    return {
                        question: `M√°y bay c·∫•t c√°nh t·ª´ ${origin.name} (m√∫i gi·ªù ${formatZone(origin.zone)}) l√∫c ${departTime} gi·ªù. M√°y bay h·∫° c√°nh t·∫°i ${dest.name} (m√∫i gi·ªù ${formatZone(dest.zone)}) l√∫c ${arrivalLocal} gi·ªù ${arrivalDayText}. H·ªèi th·ªùi gian bay l√† bao nhi√™u ti·∫øng?`,
                        answer: duration,
                        unit: "ti·∫øng",
                        steps: [
                            { type: 'header', text: 'B∆∞·ªõc 1: ƒê·ªïi v·ªÅ c√πng h·ªá quy chi·∫øu', rule: 'T√≠nh gi·ªù ƒë·∫øn gi·∫£ ƒë·ªãnh n·∫øu kh√¥ng bay (t·ª©c gi·ªù t·∫°i n∆°i ƒë·∫øn l√∫c m√°y bay ƒëi).' },
                            { type: 'step', text: `Gi·ªù ${dest.name} l√∫c c·∫•t c√°nh: ${departTime} + (${dest.zone} - ${origin.zone}) = ${departTime + diffZone}` },
                            { type: 'header', text: 'B∆∞·ªõc 2: Ph√©p t√≠nh th·ªùi gian bay', rule: 'Th·ªùi gian bay = Gi·ªù H·∫° c√°nh - Gi·ªù C·∫•t c√°nh (t·∫°i c√πng ƒë·ªãa ƒëi·ªÉm).' },
                            { type: 'step', text: `Quy ƒë·ªïi gi·ªù h·∫° c√°nh th·ª±c t·∫ø (n·∫øu qua ng√†y): ${arrivalLocalRaw}` },
                            { type: 'step', text: `Ph√©p tr·ª´: ${arrivalLocalRaw} - (${departTime + diffZone})` },
                            { type: 'header', text: 'B∆∞·ªõc 3: K·∫øt qu·∫£' },
                            { type: 'step', text: `= ${duration} (ti·∫øng)`, isLast: true }
                        ]
                    };
                }
            }

            return null; // Fallback
        }

        // --- UI Functions ---

        function renderStats() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = state.streak;
            if (state.streak > 2) {
                streakEl.classList.add('streak-fire');
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${state.streak}`;
            } else {
                streakEl.classList.remove('streak-fire');
            }

            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-skipped').textContent = state.skipped;
        }

        function nextQuestion() {
            if (!isAnswered && document.getElementById('problem-text').innerText !== 'Loading...') {
                state.skipped++;
                state.streak = 0;
                renderStats();
            }

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            
            const inputEl = document.getElementById('user-ans');
            inputEl.value = '';
            inputEl.disabled = false;
            inputEl.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');
            
            isAnswered = false;
            stepIndex = 0;
            usedHint = false;
            
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center"><i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i><span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span></div>`;
            
            const btnStep = document.getElementById('btn-show-step');
            btnStep.innerHTML = '<span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>';
            btnStep.disabled = false;

            let data = generateProblem();
            while(!data) data = generateProblem(); // Retry if fallback
            currentData = data;

            document.getElementById('problem-text').textContent = data.question;
            document.getElementById('unit-label').textContent = data.unit;
            document.getElementById('step-counter').textContent = `0/${currentData.steps.length}`;
            
            // Focus input
            inputEl.focus();
        }

        function showNextStep() {
            usedHint = true;
            
            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            const ruleContent = document.getElementById('rule-content');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentData.steps.length) {
                const item = currentData.steps[stepIndex];
                let newElement = null; 
                
                if (item.type === 'header') {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "mt-4 mb-2 text-xs font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 flex items-center";
                    headerDiv.innerHTML = `<i class="fas fa-caret-right mr-1"></i> ${item.text}`;
                    container.appendChild(headerDiv);
                    newElement = headerDiv;

                    if (item.rule) {
                        ruleContent.textContent = item.rule;
                        ruleArea.classList.remove('hidden');
                        ruleArea.classList.remove('animate-pulse');
                        void ruleArea.offsetWidth; // trigger reflow
                        ruleArea.classList.add('animate-pulse');
                    }
                } else {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-item bg-white p-2 rounded border-l-4 shadow-sm mb-2 text-sm md:text-base font-mono';
                    
                    if (item.isLast) {
                        stepDiv.classList.add('border-green-500', 'bg-green-50');
                        stepDiv.innerHTML = `<span class="text-green-700 font-bold">${item.text}</span>`;
                    } else {
                        stepDiv.classList.add('border-indigo-400');
                        stepDiv.textContent = item.text;
                    }
                    container.appendChild(stepDiv);
                    newElement = stepDiv;
                }

                if (newElement) {
                    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                }

                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentData.steps.length}`;
            }

            if (stepIndex >= currentData.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>H·∫øt</span>';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const inputEl = document.getElementById('user-ans');
            const userVal = parseInt(inputEl.value);
            
            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800');

            if (isNaN(userVal)) {
                 feedback.textContent = "Vui l√≤ng nh·∫≠p m·ªôt s·ªë!";
                 feedback.classList.add('bg-yellow-100', 'text-yellow-800');
                 feedback.classList.remove('hidden');
                 return;
            }

            if (userVal === currentData.answer) {
                if (!usedHint) {
                    state.correct++;
                    state.streak++;
                    feedback.innerHTML = '<i class="fas fa-crown"></i> Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.';
                    feedback.classList.add('bg-green-100', 'text-green-800');
                } else {
                    feedback.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem g·ª£i √Ω)';
                    feedback.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                inputEl.classList.add('border-green-500', 'bg-green-50');
                inputEl.classList.remove('border-gray-300');
                
                renderStats();
                
                // Auto reveal steps
                const reveal = setInterval(() => {
                    if(stepIndex < currentData.steps.length) showNextStep();
                    else clearInterval(reveal);
                }, 100);
                isAnswered = true;
            } else {
                state.wrong++;
                state.streak = 0;
                renderStats();

                inputEl.classList.add('border-red-500', 'bg-red-50');
                feedback.textContent = `Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† ${currentData.answer}. Xem l·ªùi gi·∫£i b√™n ph·∫£i nh√©!`;
                feedback.classList.add('bg-red-100', 'text-red-800');
            }
        }

        // Initialize
        window.onload = nextQuestion;

    </script>
</body>
</html>