<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p To√°n 7 HK1 - B√†i 5 (T·ªâ l·ªá thu·∫≠n)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
	
	
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
  <!-- --- C·∫§U H√åNH T√ÄI LI·ªÜU PDF --- -->

<script>
	
// 
// Khi n√†o c√≥ file, b·∫°n ch·ªâ c·∫ßn s·ª≠a isAvailable: true v√† c·∫≠p nh·∫≠t link
const pdfConfig = {
    isAvailable: true,  // false: Ch∆∞a c√≥ | true: ƒê√£ c√≥
    fileName: "7_hk1_bai5_tilenghich.pdf" // T√™n file ho·∫∑c ƒë∆∞·ªùng d·∫´n
};

// H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t (S·∫Ω ch·∫°y khi t·∫£i trang)
function initPdfButton() {
    const btn = document.getElementById('pdf-btn');
    const txt = document.getElementById('pdf-text');
    const icon = document.getElementById('pdf-icon');

    if (pdfConfig.isAvailable) {
        // Tr·∫°ng th√°i: C√ì T√ÄI LI·ªÜU
        btn.href = pdfConfig.fileName;
        btn.classList.add('hover:bg-white/20', 'cursor-pointer');
        btn.classList.remove('opacity-60', 'cursor-not-allowed', 'bg-gray-500/10');
        txt.textContent = "T·∫£i t√†i li·ªáu PDF";
        icon.className = "fas fa-file-pdf text-red-300 group-hover:text-red-200";
    } else {
        // Tr·∫°ng th√°i: CH∆ØA C·∫¨P NH·∫¨T
        btn.removeAttribute('href');
        btn.classList.remove('hover:bg-white/20', 'cursor-pointer');
        btn.classList.add('opacity-60', 'cursor-not-allowed', 'bg-gray-500/10');
        txt.textContent = "Ch∆∞a c·∫≠p nh·∫≠t PDF";
        icon.className = "fas fa-clock text-gray-300"; // ƒê·ªïi icon th√†nh ƒë·ªìng h·ªì
    }
}
    </script>

    <!-- Load MathJax -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Chalkboard Style */
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }

        /* Step Animation */
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        #steps-container::-webkit-scrollbar { width: 8px; }
        #steps-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Stats & Effects */
        .streak-fire { color: #ef4444; animation: burn 0.5s infinite alternate; }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box { transition: all 0.3s ease; }
        .stats-box:hover { transform: translateY(-2px); }
        
        /* MathJax Override for size */
        mjx-container { font-size: 110% !important; }

        .hint-box {
            border-left: 4px solid #f59e0b;
            background-color: #fffbeb;
            color: #92400e;
            margin-bottom: 12px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 relative shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-xl md:text-2xl font-extrabold text-white uppercase tracking-wider">
                    <i class="fas fa-chart-line mr-2"></i>√în t·∫≠p To√°n 7 HK1 - B√†i 5
                </h1>
                <p class="text-blue-200 font-medium text-sm">Ch·ªß ƒë·ªÅ: ƒê·∫°i l∆∞·ª£ng T·ªâ l·ªá thu·∫≠n (V·∫≠n d·ª•ng th·ª±c t·∫ø)</p>
            </div>
            
			<a id="pdf-btn" href="#" target="_blank" class="bg-white/10 text-white border border-white/40 px-4 py-2 rounded-lg font-bold text-sm transition-all flex items-center gap-2 group">
				<i id="pdf-icon" class="fas fa-file-pdf"></i>
				<span id="pdf-text">ƒêang t·∫£i tr·∫°ng th√°i...</span>
			</a>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[280px] relative">
                         <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        <div id="question-text" class="text-white text-lg font-medium leading-relaxed font-sans mt-4 px-2 tracking-wide">
                            ƒêang t·∫£i ƒë·ªÅ b√†i...
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        
                        <!-- Control Row: Type & Hard Mode -->
                        <div class="flex flex-wrap justify-between items-center mb-4 pb-3 border-b border-gray-200 gap-2">
                             <div class="flex items-center gap-2 flex-grow">
                                <label class="text-[10px] font-bold text-gray-400 uppercase whitespace-nowrap">D·∫°ng to√°n:</label>
                                <select id="problem-type" class="text-xs font-bold p-1.5 rounded border-gray-300 focus:ring-indigo-500 bg-white w-full max-w-[220px]" onchange="nextQuestion()">
                                    <option value="random">üé≤ Ng·∫´u nhi√™n (70% C∆° b·∫£n)</option>
                                    <option value="budget">üí∞ Ng√¢n s√°ch & Chi ph√≠ (M·ªõi)</option>
                                    <option value="worker">üë∑ C√¥ng nh√¢n & S·∫£n ph·∫©m</option>
                                    <option value="machine">üöú M√°y m√≥c & Di·ªán t√≠ch</option>
                                    <option value="consume">üçö Nhu c·∫ßu & Ti√™u th·ª•</option>
                                    <option value="motion">üöó Chuy·ªÉn ƒë·ªông (V·∫≠n t·ªëc & Qƒê)</option>
                                </select>
                            </div>

                            <label class="inline-flex items-center cursor-pointer select-none shrink-0" title="B·∫≠t ch·∫ø ƒë·ªô b√†i to√°n v·∫≠n d·ª•ng cao (v√≠ d·ª•: t√≠nh l∆∞·ª£ng tƒÉng th√™m)">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-xs font-bold text-gray-600 peer-checked:text-red-600 flex items-center">
                                    <i class="fas fa-skull-crossbones mr-1"></i>V·∫≠n d·ª•ng cao
                                </span>
                            </label>
                        </div>

                        <!-- Answer Input -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-4">
                            <label class="block text-gray-400 font-bold text-xs uppercase mb-2" id="label-final-req">K·∫øt qu·∫£ b√†i to√°n:</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="ans-final" placeholder="Nh·∫≠p ƒë√°p s·ªë..." class="flex-grow text-center font-bold text-xl p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none transition-colors">
                                <span id="unit-display" class="font-bold text-gray-500 bg-gray-100 p-2 rounded border border-gray-200 min-w-[60px] text-center">...</span>
                            </div>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <div id="feedback" class="hidden mt-3 text-center p-2 rounded-lg text-sm font-bold"></div>
                        <div id="hint-warning" class="hidden mt-2 text-center text-xs text-amber-600 font-semibold bg-amber-50 p-1 rounded border border-amber-200">
                            <i class="fas fa-lock mr-1"></i>ƒê√£ xem h∆∞·ªõng d·∫´n: Th√†nh t√≠ch c√¢u n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh.
                        </div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[600px] lg:h-[750px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>H∆∞·ªõng d·∫´n gi·∫£i</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Hint Box (Moved Here) -->
                    <div id="hint-box" class="hidden hint-box p-3 rounded-lg text-sm shadow-sm">
                        <div class="font-bold flex items-center gap-2 mb-1">
                            <i class="fas fa-lightbulb text-amber-500"></i> G·ª£i √Ω nhanh:
                        </div>
                        <div id="hint-content"></div>
                    </div>

                    <!-- Steps Content -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "H∆∞·ªõng d·∫´n gi·∫£i" ƒë·ªÉ xem b√†i l√†m m·∫´u t·ª´ng b∆∞·ªõc</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- Game State ---
        let currentProblem = {};
        let stepIndex = 0;
        let isAnswered = false;
        
        // Stats
        let streak = 0;
        let correctTotal = 0;
        let wrongTotal = 0;
        let skippedTotal = 0;
        let statsEnabled = true;

        // --- Utils ---
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function updateStatsUI() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = streak;
            document.getElementById('stat-correct').textContent = correctTotal;
            document.getElementById('stat-wrong').textContent = wrongTotal;
            document.getElementById('stat-skipped').textContent = skippedTotal;

            if (!statsEnabled) {
                document.getElementById('hint-warning').classList.remove('hidden');
            } else {
                document.getElementById('hint-warning').classList.add('hidden');
            }

            if (streak > 2) {
                streakEl.classList.add('streak-fire');
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${streak}`;
            } else {
                streakEl.classList.remove('streak-fire');
                streakEl.textContent = streak;
            }
        }
        
        function disableStats() {
            if (statsEnabled) {
                statsEnabled = false;
                updateStatsUI();
            }
        }

        // --- SCENARIO DATA & GENERATORS ---

        const scenarios = {
            worker: {
                subj: ["M·ªôt ƒë·ªôi c√¥ng nh√¢n", "M·ªôt nh√≥m th·ª£", "M·ªôt t·ªï s·∫£n xu·∫•t"],
                unit_subj: "ng∆∞·ªùi",
                verb: ["l√†m ƒë∆∞·ª£c", "s·∫£n xu·∫•t ƒë∆∞·ª£c", "l·∫Øp r√°p ƒë∆∞·ª£c", "ƒë√≥ng g√≥i ƒë∆∞·ª£c"],
                obj: ["s·∫£n ph·∫©m", "chi ti·∫øt m√°y", "h·ªôp qu√†", "b·ªô qu·∫ßn √°o"],
                unit_obj: ["s·∫£n ph·∫©m", "chi ti·∫øt", "h·ªôp", "b·ªô"],
                time_constraint: ["trong m·ªôt ng√†y", "trong m·ªôt gi·ªù", "trong c√πng th·ªùi gian d·ª± ki·∫øn"],
                type: "direct"
            },
            machine: {
                subj: ["M·ªôt ƒë·ªôi m√°y c√†y", "M·ªôt nh√≥m m√°y x√∫c", "ƒê·ªôi xe v·∫≠n t·∫£i"],
                unit_subj: "m√°y",
                verb: ["c√†y ƒë∆∞·ª£c", "san l·∫•p ƒë∆∞·ª£c", "v·∫≠n chuy·ªÉn ƒë∆∞·ª£c"],
                obj: ["ha ƒë·∫•t", "m√©t ƒë∆∞·ªùng", "t·∫•n h√†ng"],
                unit_obj: ["ha", "m", "t·∫•n"],
                time_constraint: ["trong c√πng th·ªùi gian", "trong m·ªôt bu·ªïi"],
                type: "direct" 
            },
            consume: {
                subj: ["B·∫øp ƒÉn t·∫≠p th·ªÉ", "ƒê∆°n v·ªã b·ªô ƒë·ªôi", "Tr·∫°i h√®"],
                unit_subj: "ng∆∞·ªùi",
                verb: ["ti√™u th·ª• h·∫øt", "d√πng h·∫øt", "ƒÉn h·∫øt"],
                obj: ["g·∫°o", "n∆∞·ªõc s·∫°ch", "th·ª±c ph·∫©m"],
                unit_obj: ["kg", "l√≠t", "kg"],
                time_constraint: ["trong m·ªôt ng√†y", "m·ªói ng√†y"],
                type: "direct" 
            },
            motion: {
                subj: ["M·ªôt √¥ t√¥", "M·ªôt xe m√°y", "M·ªôt v·∫≠n ƒë·ªông vi√™n"],
                unit_subj: "km/h", 
                subj_label: "v·∫≠n t·ªëc",
                verb: ["ƒëi ƒë∆∞·ª£c", "ch·∫°y ƒë∆∞·ª£c"],
                obj: ["qu√£ng ƒë∆∞·ªùng"],
                unit_obj: ["km", "m"],
                time_constraint: ["trong c√πng kho·∫£ng th·ªùi gian", "v·ªõi th·ªùi gian kh√¥ng ƒë·ªïi"],
                type: "direct" 
            }
        };

        // NEW: Budget & Cost Special Scenarios
        const budgetTemplates = [
            {
                // √Åo phao
                type: "increase",
                template: "Theo d·ª± to√°n ban ƒë·∫ßu, {place} ƒë∆∞·ª£c c·∫•p {money} tri·ªáu ƒë·ªìng ƒë·ªÉ mua {qty} chi·∫øc {item} trang b·ªã cho ƒë·ªôi xung k√≠ch. Tuy nhi√™n, do t√¨nh h√¨nh {reason}, {place} quy·∫øt ƒë·ªãnh b·ªï sung th√™m nh√¢n s·ª± n√™n c·∫ßn mua nhi·ªÅu h∆°n d·ª± ki·∫øn {delta} chi·∫øc. H·ªèi v·ªõi s·ªë l∆∞·ª£ng th·ª±c t·∫ø c·∫ßn mua, {place} ph·∫£i chi t·ªïng c·ªông bao nhi√™u ti·ªÅn? (Gi·∫£ s·ª≠ gi√° m·ªói chi·∫øc l√† kh√¥ng ƒë·ªïi).",
                vars: {
                    place: ["th√¥n Z", "x√£ X", "huy·ªán Y"],
                    item: ["√°o phao", "ƒë√®n pin chuy√™n d·ª•ng", "m≈© b·∫£o h·ªô"],
                    reason: ["m∆∞a l≈© di·ªÖn bi·∫øn ph·ª©c t·∫°p", "thi√™n tai b·∫•t th∆∞·ªùng", "nhu c·∫ßu c·∫•p thi·∫øt"]
                },
                unit_subj: "chi·∫øc",
                unit_obj: "tri·ªáu ƒë·ªìng",
                subj_label: "s·ªë l∆∞·ª£ng",
                obj_label: "s·ªë ti·ªÅn"
            },
            {
                // ƒê√™ k√®
                type: "increase",
                template: "ƒê·ªÉ gia c·ªë ƒëo·∫°n ƒë√™ bao quanh {place}, ƒë∆°n v·ªã thi c√¥ng b√°o gi√°: ƒê·ªÉ k√® ƒë√° ƒë∆∞·ª£c ƒëo·∫°n ƒë√™ d√†i {qty} m√©t th√¨ chi ph√≠ tr·ªçn g√≥i l√† {money} tri·ªáu ƒë·ªìng. Sau khi kh·∫£o s√°t l·∫°i, Ban ch·ªâ huy ph√≤ng ch·ªëng l·ª•t b√£o y√™u c·∫ßu k√® th√™m {delta} m√©t n·ªØa ·ªü ƒëo·∫°n xung y·∫øu. H·ªèi t·ªïng chi ph√≠ ƒë·ªÉ ho√†n th√†nh ƒëo·∫°n ƒë√™ (bao g·ªìm c·∫£ ph·∫ßn ph√°t sinh) l√† bao nhi√™u?",
                vars: {
                    place: ["th√¥n Z", "x√£ A", "v√πng ven bi·ªÉn"],
                },
                unit_subj: "m√©t",
                unit_obj: "tri·ªáu ƒë·ªìng",
                subj_label: "ƒë·ªô d√†i ƒë√™",
                obj_label: "chi ph√≠"
            },
            {
                // L√∫a gi·ªëng (Gi·∫£m)
                type: "decrease",
                template: "Qu·ªπ khuy·∫øn n√¥ng d·ª± ƒë·ªãnh d√πng s·ªë ti·ªÅn {money} tri·ªáu ƒë·ªìng ƒë·ªÉ mua {item} c·∫•p ph√°t cho {qty} h·ªô d√¢n b·ªã m·∫•t tr·∫Øng v·ª• m√πa (m·ª©c c·∫•p ph√°t m·ªói h·ªô nh∆∞ nhau). Tuy nhi√™n, c√≥ {delta} h·ªô trong danh s√°ch ƒë√£ nh·∫≠n ƒë∆∞·ª£c h·ªó tr·ª£ t·ª´ ngu·ªìn x√£ h·ªôi h√≥a kh√°c n√™n t·ª± nguy·ªán r√∫t t√™n. H·ªèi s·ªë ti·ªÅn th·ª±c t·∫ø Qu·ªπ c·∫ßn chi ƒë·ªÉ mua {item} cho c√°c h·ªô c√≤n l·∫°i l√† bao nhi√™u?",
                vars: {
                    item: ["l√∫a gi·ªëng", "ng√¥ gi·ªëng", "c√¢y gi·ªëng"],
                },
                unit_subj: "h·ªô",
                unit_obj: "tri·ªáu ƒë·ªìng",
                subj_label: "s·ªë h·ªô",
                obj_label: "s·ªë ti·ªÅn"
            },
            {
                // Phun thu·ªëc (Gi·∫£m)
                type: "decrease",
                template: "Sau khi n∆∞·ªõc r√∫t, Trung t√¢m Y t·∫ø d·ª± ph√≤ng c·ª≠ ƒë·ªôi phun thu·ªëc kh·ª≠ khu·∫©n m√¥i tr∆∞·ªùng cho {place}. Theo k·∫ø ho·∫°ch, chi ph√≠ h√≥a ch·∫•t ƒë·ªÉ phun to√†n b·ªô {qty} m2 khu v·ª±c c√¥ng c·ªông l√† {money} tri·ªáu ƒë·ªìng. Th·ª±c t·∫ø, c√°c ng√µ ng√°ch nh·ªè xe phun kh√¥ng v√†o ƒë∆∞·ª£c n√™n di·ªán t√≠ch phun m√°y gi·∫£m ƒëi {delta} m2 so v·ªõi k·∫ø ho·∫°ch. H·ªèi chi ph√≠ h√≥a ch·∫•t th·ª±c t·∫ø ƒë√£ s·ª≠ d·ª•ng l√† bao nhi√™u?",
                vars: {
                    place: ["th√¥n Z", "khu ph·ªë 5", "tr∆∞·ªùng h·ªçc"],
                },
                unit_subj: "m2",
                unit_obj: "tri·ªáu ƒë·ªìng",
                subj_label: "di·ªán t√≠ch",
                obj_label: "chi ph√≠"
            }
        ];

        function generateBudgetProblem() {
            // 1. Pick a template
            const tplIdx = getRandomInt(0, budgetTemplates.length - 1);
            const tplData = budgetTemplates[tplIdx];

            // 2. Generate numbers logic (Clean division)
            // Price per unit should be reasonable or simple fraction
            // Let's generate price P first, then Quantity X1. Y1 = P * X1.
            
            let price, x1, delta;
            
            // Adjust ranges based on context to make numbers realistic
            if (tplData.unit_subj === "m2") {
                // Phun thu·ªëc: price low, x1 large. E.g. 5000d/m2 = 0.005 mil/m2.
                // Or make money integer. 210 mil / 42000 = 0.005. 
                // Let's generate Y1 (Money) first, divisible by something.
                const moneyBase = getRandomInt(5, 50) * 10; // 50, 60... 500
                const div = [100, 200, 500]; // divisor factor
                const factor = div[getRandomInt(0, div.length-1)]; 
                x1 = moneyBase * factor; // e.g. 210 * 200 = 42000
                price = moneyBase / x1;
                delta = getRandomInt(1, 5) * factor * 10; // small chunk
            } else {
                // Normal items
                price = getRandomInt(1, 10) * 0.1; // 0.3, 1.5, ...
                if (Math.random() < 0.5) price = getRandomInt(1, 5); // Integer price 2, 3...
                
                // x1 should make y1 integer or simple decimal 1 decimal place
                // y1 = x1 * price.
                const seed = getRandomInt(2, 20);
                x1 = seed * 10; // 20, 30... 
                // Ensure x1 * price is nice. 
                // Easier: Pick Y1 and X1 such that Y1/X1 is clean.
                // Let's stick to user example: 210 mil, 700 items -> 0.3 price.
                
                const prices = [0.2, 0.3, 0.5, 1.2, 1.5, 2, 2.5, 3];
                price = prices[getRandomInt(0, prices.length-1)];
                
                // Find X1 such that Price * X1 is integer (money in millions)
                // If price 0.3, X1 must be multiple of 10.
                x1 = getRandomInt(5, 50) * 10;
                
                delta = getRandomInt(1, 5) * 10;
            }

            let y1 = Math.round(x1 * price * 100) / 100; // Round to 2 decimals max
            // Re-check integer preference for money
            if (!Number.isInteger(y1)) {
                // Adjust X1 to make Y1 integer if possible, else keep decimal
                 x1 = x1 * 10;
                 delta = delta * 10;
                 y1 = Math.round(x1 * price);
            }

            let x2 = (tplData.type === 'increase') ? x1 + delta : x1 - delta;
            let y2 = Math.round(x2 * price * 100) / 100;

            // 3. Fill Template
            let text = tplData.template;
            text = text.replace("{money}", y1).replace("{qty}", x1).replace("{delta}", delta);
            
            // Random vars
            if (tplData.vars) {
                for (const [key, options] of Object.entries(tplData.vars)) {
                    const val = options[getRandomInt(0, options.length - 1)];
                    text = text.replace(`{${key}}`, val);
                    // Also replace recurring keys if any (simple replace only does first, use regex)
                    text = text.replace(new RegExp(`{${key}}`, 'g'), val);
                }
            }

            // 4. Build return object compatible with generateProblem
            // Steps need to be custom for this flow
            
            // T√≥m t·∫Øt
            let t_x1 = x1, t_y1 = y1;
            let t_x2 = x2, t_y2 = "x";
            
            let preStep = `<div>Theo ƒë·ªÅ b√†i, ${tplData.subj_label} th·ª±c t·∫ø l√†: $${x1} ${tplData.type === 'increase' ? '+' : '-'} ${delta} = ${x2}$ (${tplData.unit_subj})</div>`;

            let summaryTable = `
<div class="grid grid-cols-2 gap-4 text-center font-bold text-gray-600 bg-blue-50 p-2 rounded mb-2">
    <div class="border-b-2 border-blue-200 pb-1">${tplData.subj_label.charAt(0).toUpperCase() + tplData.subj_label.slice(1)} (${tplData.unit_subj})</div>
    <div class="border-b-2 border-blue-200 pb-1">${tplData.obj_label.charAt(0).toUpperCase() + tplData.obj_label.slice(1)} (${tplData.unit_obj})</div>
    <div class="py-1">${t_x1}</div>
    <div class="py-1">${t_y1}</div>
    <div class="py-1 text-indigo-600">${t_x2}</div>
    <div class="py-1 text-indigo-600">${t_y2}</div>
</div>
<div class="text-sm text-gray-500 italic mb-2">L∆∞u √Ω: ƒê·ªÅ cho d·ªØ ki·ªán "${tplData.type === 'increase' ? 'tƒÉng/b·ªï sung th√™m' : 'gi·∫£m/r√∫t b·ªõt'}", c·∫ßn t√≠nh ${tplData.subj_label} th·ª±c t·∫ø ƒë·ªÉ ƒëi·ªÅn v√†o t√≥m t·∫Øt.</div>
${preStep}
`;

            const steps = [];
            steps.push({ title: "T√≥m t·∫Øt & X·ª≠ l√Ω s·ªë li·ªáu", content: summaryTable });
            
            steps.push({
                title: "B∆∞·ªõc 1: G·ªçi ·∫©n",
                content: `G·ªçi ${tplData.obj_label} th·ª±c t·∫ø c·∫ßn t√¨m l√† $x$ (${tplData.unit_obj}) ($x > 0$).`
            });

            steps.push({
                title: "B∆∞·ªõc 2: L·∫≠p lu·∫≠n",
                content: `V√¨ ${tplData.obj_label} t·ªâ l·ªá thu·∫≠n v·ªõi ${tplData.subj_label} (s·ªë l∆∞·ª£ng/di·ªán t√≠ch c√†ng l·ªõn th√¨ chi ph√≠ c√†ng cao) n√™n ta c√≥ t·ªâ l·ªá th·ª©c:`
            });

            const calcStep = `x = \\dfrac{${x2} \\cdot ${y1}}{${x1}}`;
            
            steps.push({
                title: "B∆∞·ªõc 3: Thi·∫øt l·∫≠p t·ªâ l·ªá th·ª©c",
                content: `$$\\frac{x}{${y1}} = \\frac{${x2}}{${x1}} \\quad \\text{hay} \\quad \\frac{x}{${x2}} = \\frac{${y1}}{${x1}}$$`
            });

            steps.push({
                title: "B∆∞·ªõc 4: T√≠nh to√°n",
                content: `$$${calcStep}$$ 
                          $$x = ${y2}$$`
            });

            steps.push({
                title: "K·∫øt lu·∫≠n",
                content: `V·∫≠y ${tplData.obj_label} th·ª±c t·∫ø l√†: <b>${y2} ${tplData.unit_obj}</b>.`
            });

            return {
                question: text,
                steps: steps,
                finalAns: y2,
                unit: tplData.unit_obj,
                hint: `G·ª£i √Ω: ƒê√¢y l√† b√†i to√°n v·ªÅ chi ph√≠. Tr∆∞·ªõc h·∫øt h√£y t√≠nh t·ªïng s·ªë l∆∞·ª£ng/di·ªán t√≠ch th·ª±c t·∫ø (sau khi c·ªông th√™m ho·∫∑c tr·ª´ b·ªõt). S·ªë ti·ªÅn t·ªâ l·ªá thu·∫≠n v·ªõi s·ªë l∆∞·ª£ng.`
            };
        }

        function generateProblem() {
            const typeSelect = document.getElementById('problem-type').value;
            const isHard = document.getElementById('mode-hard').checked;
            
            // Handle Budget Scenario specially
            if (typeSelect === 'budget') {
                return generateBudgetProblem();
            }

            // 1. Select Scenario Type
            let selectedKey = typeSelect;
            if (selectedKey === 'random') {
                const rand = Math.random();
                // Add probability for budget in random mode
                if (rand < 0.2) return generateBudgetProblem();
                
                const keys = Object.keys(scenarios);
                if (rand < 0.45) selectedKey = 'worker';
                else if (rand < 0.70) selectedKey = 'machine';
                else selectedKey = keys[getRandomInt(0, keys.length - 1)];
            }

            const data = scenarios[selectedKey];
            
            // 2. Generate Numbers
            const baseX = getRandomInt(2, 9);
            const baseY = getRandomInt(2, 9) * getRandomInt(2, 5); 
            const k1 = getRandomInt(2, 8); 
            const k2 = k1 + getRandomInt(1, 4); 
            
            const x1 = baseX * k1;
            const y1 = baseY * k1;
            const x2 = baseX * k2;
            const y2 = baseY * k2;

            // 3. Logic: Determine Modes (Probability 30%)
            const isDeltaData = Math.random() < 0.3 || (isHard && Math.random() < 0.8);
            const isDeltaQuestion = Math.random() < 0.3 || (isHard && Math.random() < 0.8);

            // 4. Target Unknown: 50% Find X (Subject), 50% Find Y (Object)
            const findTargetX = Math.random() < 0.5;

            // Randomize text elements
            const subjText = data.subj[getRandomInt(0, data.subj.length-1)];
            const verbText = data.verb[getRandomInt(0, data.verb.length-1)];
            const objText = data.obj[getRandomInt(0, data.obj.length-1)];
            const unitSubj = data.unit_subj;
            const unitObj = Array.isArray(data.unit_obj) ? data.unit_obj[getRandomInt(0, data.unit_obj.length-1)] : data.unit_obj;
            const timeText = data.time_constraint[getRandomInt(0, data.time_constraint.length-1)];

            let subjLabel = data.subj_label || "s·ªë " + unitSubj;
            if (selectedKey === 'motion') subjLabel = "v·∫≠n t·ªëc";

            let question = "";
            let finalAns = 0;
            let finalUnit = "";
            let steps = [];
            let unknownLabel = "";
            let t_x1 = x1, t_y1 = y1, t_x2 = x2, t_y2 = y2;
            
            // --- Part 1: Given x1, y1 ---
            const part1 = `${subjText} ${selectedKey === 'motion' ? 'ch·∫°y v·ªõi v·∫≠n t·ªëc' : 'c√≥'} ${x1} ${unitSubj} ${verbText} ${y1} ${unitObj} ${timeText}.`;
            let part2 = "";
            let reqText = "";

            // --- Part 2 & Question ---
            if (findTargetX) {
                // We need to find X2. So we are given Y2.
                // Y2 can be given as Absolute OR Delta.
                t_x2 = "x";
                unknownLabel = subjLabel;
                finalUnit = unitSubj;

                let givenYText = "";
                let valY_ForDisplay = y2; // If absolute

                if (isDeltaData) {
                     const deltaY = y2 - y1;
                     // Ensure delta is positive for "increase" phrasing ease or handle decrease
                     // Since k2 > k1, y2 > y1 usually.
                     givenYText = `mu·ªën ${verbText} th√™m ${deltaY} ${unitObj}`;
                     if(selectedKey === 'motion') givenYText = `mu·ªën qu√£ng ƒë∆∞·ªùng ƒëi ƒë∆∞·ª£c tƒÉng th√™m ${deltaY} ${unitObj}`;
                } else {
                     givenYText = `mu·ªën ${verbText} ${y2} ${unitObj}`;
                     if(selectedKey === 'motion') givenYText = `mu·ªën ƒëi ƒë∆∞·ª£c qu√£ng ƒë∆∞·ªùng ${y2} ${unitObj}`;
                }

                part2 = `ƒê·ªÉ ${givenYText} ${timeText}`;

                // Question asks for X2. Can be Absolute or Delta.
                if (isDeltaQuestion) {
                    reqText = `th√¨ c·∫ßn ${selectedKey === 'motion' ? 'tƒÉng v·∫≠n t·ªëc th√™m' : 'tƒÉng th√™m'} bao nhi√™u ${unitSubj}?`;
                    finalAns = x2 - x1;
                } else {
                    reqText = `th√¨ c·∫ßn ${selectedKey === 'motion' ? 'v·∫≠n t·ªëc l√†' : 's·ªë l∆∞·ª£ng l√†'} bao nhi√™u ${unitSubj}?`;
                    finalAns = x2;
                }

            } else {
                // We need to find Y2. So we are given X2.
                // X2 can be given as Absolute OR Delta.
                t_y2 = "x";
                unknownLabel = `s·ªë ${unitObj} ${verbText}`;
                finalUnit = unitObj;

                let givenXText = "";
                if (isDeltaData) {
                    const deltaX = x2 - x1;
                    givenXText = `tƒÉng th√™m ${deltaX} ${unitSubj}`;
                    if (selectedKey === 'motion') givenXText = `tƒÉng v·∫≠n t·ªëc th√™m ${deltaX} ${unitSubj}`;
                    else if (selectedKey === 'worker' || selectedKey === 'consume') givenXText = `b·ªï sung th√™m ${deltaX} ${unitSubj}`;
                } else {
                    givenXText = `c√≥ ${x2} ${unitSubj}`;
                    if (selectedKey === 'motion') givenXText = `v·∫≠n t·ªëc l√† ${x2} ${unitSubj}`;
                }

                part2 = `N·∫øu ${givenXText}`;
                if(selectedKey === 'worker' || selectedKey === 'consume') part2 += ` l√†m vi·ªác ${timeText}`;
                else part2 += ` ${timeText}`;

                // Question asks for Y2. Can be Absolute or Delta.
                if (isDeltaQuestion) {
                    reqText = `th√¨ ${objText} ${verbText} tƒÉng th√™m bao nhi√™u ${unitObj}?`;
                    finalAns = y2 - y1;
                } else {
                    reqText = `th√¨ ${verbText} bao nhi√™u ${unitObj}?`;
                    finalAns = y2;
                }
            }

            question = `${part1} ${part2} ${reqText} (Gi·∫£ s·ª≠ nƒÉng su·∫•t kh√¥ng ƒë·ªïi).`;

            // --- SOLUTION STEPS ---
            
            // 1. T√≥m t·∫Øt
            // If data was delta, we need to calculate absolute for summary or show calculation
            // For simplicity, summary usually shows absolute values x1, y1, x2, y2.
            // But if input was delta, step 1 should convert delta to absolute first.
            let preStep = "";
            if (isDeltaData) {
                if (findTargetX) { // Given Y Delta
                     preStep = `<div>Ta c√≥ s·ªë ${unitObj} l√∫c sau l√†: $${y1} + ${y2-y1} = ${y2}$ (${unitObj})</div>`;
                } else { // Given X Delta
                     preStep = `<div>Ta c√≥ ${subjLabel} l√∫c sau l√†: $${x1} + ${x2-x1} = ${x2}$ (${unitSubj})</div>`;
                }
            }

            let summaryTable = `
<div class="grid grid-cols-2 gap-4 text-center font-bold text-gray-600 bg-blue-50 p-2 rounded mb-2">
    <div class="border-b-2 border-blue-200 pb-1">${subjLabel.charAt(0).toUpperCase() + subjLabel.slice(1)} (${unitSubj})</div>
    <div class="border-b-2 border-blue-200 pb-1">${objText.charAt(0).toUpperCase() + objText.slice(1)} (${unitObj})</div>
    <div class="py-1">${t_x1}</div>
    <div class="py-1">${t_y1}</div>
    <div class="py-1 text-indigo-600">${t_x2}</div>
    <div class="py-1 text-indigo-600">${t_y2}</div>
</div>
${preStep ? '<div class="text-sm text-gray-500 italic mb-2">L∆∞u √Ω: ƒê·ªÅ cho d·ªØ ki·ªán "tƒÉng th√™m", c·∫ßn t√≠nh gi√° tr·ªã l√∫c sau ƒë·ªÉ ƒëi·ªÅn v√†o t√≥m t·∫Øt.</div>' + preStep : ''}
`;

            steps.push({
                title: "T√≥m t·∫Øt",
                content: summaryTable
            });

            // 2. B1: G·ªçi ·∫©n
            let step1Content = `G·ªçi ${unknownLabel} l√∫c sau l√† $x$ (${finalUnit}) ($x > 0$).`;
            if (isDeltaQuestion) {
                 // If asking for delta, we typically still solve for absolute first then subtract
                 step1Content += `<br>(B√†i to√°n h·ªèi ph·∫ßn tƒÉng th√™m, ta s·∫Ω t√≠nh t·ªïng s·ªë tr∆∞·ªõc r·ªìi tr·ª´ ƒëi ban ƒë·∫ßu).`;
            }

            steps.push({
                title: "B∆∞·ªõc 1: G·ªçi ·∫©n",
                content: step1Content
            });

            // 3. B2: Gi·∫£i th√≠ch
            // Format: "V√¨ s·ªë [ƒë∆°n v·ªã t√¨m] t·ªâ l·ªá thu·∫≠n v·ªõi s·ªë [ƒë∆°n v·ªã t∆∞∆°ng ·ª©ng] n√™n:"
            let labelX_Reason = subjLabel; 
            let labelY_Reason = (selectedKey === 'motion') ? "qu√£ng ƒë∆∞·ªùng" : ("s·ªë " + unitObj);
            
            let reasonText = "";
            if (findTargetX) {
                // Finding X (Subject)
                reasonText = `V√¨ ${labelX_Reason} t·ªâ l·ªá thu·∫≠n v·ªõi ${labelY_Reason} n√™n:`;
            } else {
                // Finding Y (Object)
                reasonText = `V√¨ ${labelY_Reason} t·ªâ l·ªá thu·∫≠n v·ªõi ${labelX_Reason} n√™n:`;
            }
            
            steps.push({
                title: "B∆∞·ªõc 2: L·∫≠p lu·∫≠n",
                content: reasonText
            });

            // 4. B3: C√¥ng th·ª©c
            let numeratorLeft, demonimatorLeft, numeratorRight, denominatorRight;
            let calcStep;
            let resultVal = (findTargetX) ? x2 : y2;
            
            if (findTargetX) { // Find X
                numeratorLeft = "x"; demonimatorLeft = x1;
                numeratorRight = y2; denominatorRight = y1;
                calcStep = `x = \\dfrac{${y2} \\cdot ${x1}}{${y1}}`;
            } else { // Find Y
                numeratorLeft = "x"; demonimatorLeft = y1;
                numeratorRight = x2; denominatorRight = x1;
                calcStep = `x = \\dfrac{${x2} \\cdot ${y1}}{${x1}}`;
            }

            steps.push({
                title: "B∆∞·ªõc 3: Thi·∫øt l·∫≠p t·ªâ l·ªá th·ª©c",
                content: `$$\\frac{${numeratorLeft}}{${demonimatorLeft}} = \\frac{${numeratorRight}}{${denominatorRight}}$$`
            });

            // 5. B4: T√≠nh to√°n
            steps.push({
                title: "B∆∞·ªõc 4: T√≠nh to√°n",
                content: `$$${calcStep}$$ 
                          $$x = ${resultVal}$$`
            });

            // 6. K·∫øt lu·∫≠n
            let conclusion = "";
            if (isDeltaQuestion) {
                let baseVal = (findTargetX) ? x1 : y1;
                let diff = Math.abs(resultVal - baseVal);
                conclusion = `Gi√° tr·ªã l√∫c sau l√†: $${resultVal}$.<br>
                              Theo y√™u c·∫ßu ƒë·ªÅ b√†i (t√≠nh ph·∫ßn tƒÉng th√™m):<br>
                              $$${resultVal} - ${baseVal} = ${diff} \\; (${finalUnit})$$<br>
                              <b>V·∫≠y ƒë√°p √°n l√†: ${diff} ${finalUnit}.</b>`;
            } else {
                conclusion = `V·∫≠y ${unknownLabel} l√†: <b>${resultVal} ${finalUnit}</b>.`;
            }

            steps.push({
                title: "K·∫øt lu·∫≠n",
                content: conclusion
            });

            // Hint Logic
            let hintText = "";
            if (selectedKey === 'worker') hintText = "G·ª£i √Ω: S·ªë ng∆∞·ªùi c√†ng ƒë√¥ng th√¨ l√†m ƒë∆∞·ª£c c√†ng nhi·ªÅu s·∫£n ph·∫©m. ƒê√¢y l√† t·ªâ l·ªá thu·∫≠n.";
            if (selectedKey === 'machine') hintText = "G·ª£i √Ω: C√†ng nhi·ªÅu m√°y th√¨ c√†y ƒë∆∞·ª£c c√†ng nhi·ªÅu ƒë·∫•t. T·ªâ s·ªë m√°y b·∫±ng t·ªâ s·ªë di·ªán t√≠ch.";
            if (selectedKey === 'motion') hintText = "G·ª£i √Ω: ƒêi c√†ng nhanh th√¨ qu√£ng ƒë∆∞·ªùng ƒëi ƒë∆∞·ª£c c√†ng d√†i (trong c√πng th·ªùi gian). V·∫≠n t·ªëc t·ªâ l·ªá thu·∫≠n v·ªõi qu√£ng ƒë∆∞·ªùng.";
            if (isDeltaData || isDeltaQuestion) hintText += "<br><b>L∆∞u √Ω:</b> ƒê·ªÅ b√†i c√≥ d·ªØ ki·ªán/c√¢u h·ªèi v·ªÅ 'tƒÉng th√™m', h√£y ch√∫ √Ω c·ªông/tr·ª´ v·ªõi gi√° tr·ªã ban ƒë·∫ßu.";

            return {
                question,
                steps,
                finalAns,
                unit: finalUnit,
                hint: hintText
            };
        }

        // --- Core Functions ---

        function nextQuestion() {
            if (!isAnswered && document.getElementById('question-text').innerText !== 'ƒêang t·∫£i ƒë·ªÅ b√†i...') {
                skippedTotal++;
                streak = 0;
                updateStatsUI();
            }

            currentProblem = generateProblem();
            
            // Reset UI
            stepIndex = 0;
            isAnswered = false;
            statsEnabled = true;
            updateStatsUI();

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('hint-box').classList.add('hidden');
            document.getElementById('steps-container').innerHTML = '<div class="text-gray-400 italic text-sm text-center mt-10"><i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i><br>B·∫•m "H∆∞·ªõng d·∫´n gi·∫£i" ƒë·ªÉ xem b√†i l√†m m·∫´u</div>';
            
            document.getElementById('btn-show-step').disabled = false;
            document.getElementById('btn-show-step').innerHTML = 'H∆∞·ªõng d·∫´n gi·∫£i <i class="fas fa-arrow-right ml-1"></i>';

            // Render Question
            document.getElementById('question-text').innerHTML = currentProblem.question;
            document.getElementById('unit-display').textContent = currentProblem.unit;
            document.getElementById('hint-content').innerHTML = currentProblem.hint;
            
            // Reset input
            document.getElementById('ans-final').value = '';
            document.getElementById('ans-final').className = "flex-grow text-center font-bold text-xl p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none transition-colors";
            document.getElementById('ans-final').focus();
            
            MathJax.typesetPromise([document.getElementById('question-text')]);
            updateStepCounter();
        }

        function updateStepCounter() {
            document.getElementById('step-counter').textContent = `B∆∞·ªõc: ${stepIndex}/${currentProblem.steps.length}`;
        }

        function showNextStep() {
            disableStats(); // Showing steps disables stats for this question
            
            // Show hint box automatically when asking for help
            document.getElementById('hint-box').classList.remove('hidden');

            const container = document.getElementById('steps-container');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentProblem.steps.length) {
                const step = currentProblem.steps[stepIndex];
                
                const s = document.createElement('div');
                // Alternating colors for steps to differentiate
                const isOdd = stepIndex % 2 !== 0;
                s.className = `step-item p-3 rounded-lg shadow-sm text-sm border-l-4 font-medium mb-3 ${isOdd ? 'bg-indigo-50 border-indigo-400 text-indigo-900' : 'bg-white border-gray-300 text-gray-800'}`;
                
                s.innerHTML = `<div class="font-bold text-xs uppercase mb-1 opacity-70">${step.title}</div><div class="text-base">${step.content}</div>`;
                
                container.appendChild(s);
                MathJax.typesetPromise([s]);
                
                stepIndex++;
                updateStepCounter();
                container.scrollTop = container.scrollHeight;
            }

            if (stepIndex >= currentProblem.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> H·∫øt';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const finalInp = document.getElementById('ans-final');
            const userVal = parseFloat(finalInp.value.replace(/,/g, '').replace(/\s/g, ''));
            const correctVal = currentProblem.finalAns;
            
            const fb = document.getElementById('feedback');
            fb.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');

            if (Math.abs(userVal - correctVal) < 0.1) {
                // Correct
                finalInp.classList.remove('border-gray-300', 'border-red-500');
                finalInp.classList.add('border-emerald-500', 'bg-emerald-50');

                if (statsEnabled) {
                    streak++;
                    correctTotal++;
                    fb.innerHTML = '<i class="fas fa-crown"></i> Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.';
                    fb.classList.add('bg-green-100', 'text-green-800');
                    updateStatsUI();
                } else {
                    fb.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem h∆∞·ªõng d·∫´n)';
                    fb.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                isAnswered = true;
                // Auto show remaining steps
                const timer = setInterval(() => {
                    if (stepIndex < currentProblem.steps.length) showNextStep();
                    else clearInterval(timer);
                }, 150);

            } else {
                // Wrong
                finalInp.classList.remove('border-gray-300', 'border-emerald-500');
                finalInp.classList.add('border-red-500', 'bg-red-50');
                
                fb.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Sai r·ªìi. H√£y th·ª≠ l·∫°i ho·∫∑c xem h∆∞·ªõng d·∫´n.`;
                fb.classList.add('bg-red-100', 'text-red-700');
                
                if (statsEnabled) {
                    streak = 0;
                    wrongTotal++;
                    updateStatsUI();
                }
            }
        }

        window.onload = function() {
    initPdfButton(); // G·ªçi h√†m ki·ªÉm tra n√∫t PDF
    nextQuestion();  // G·ªçi h√†m t·∫°o c√¢u h·ªèi
};

    </script>
	
</body>
</html>