<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p To√°n 6 HK1 - B√†i 5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 280px;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar { width: 8px; }
        #steps-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .btn-mode {
            transition: all 0.2s;
        }
        .btn-mode.active {
            background-color: #4f46e5;
            color: white;
            border-color: #3730a3;
        }
        .btn-mode:not(.active):hover {
            background-color: #e0e7ff;
        }
        
        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-indigo-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-shapes mr-2"></i>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 5
            </h1>
            <p class="text-indigo-100 text-sm md:text-base font-medium mt-1">Ch·ªß ƒë·ªÅ: Quan h·ªá chia h·∫øt & T√¨m x n√¢ng cao</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column -->
                <div class="flex flex-col gap-4">
                    
                    <!-- Settings Area -->
                    <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 flex flex-col gap-2">
                        <label class="block text-indigo-800 font-bold text-xs uppercase text-center"><i class="fas fa-sliders-h mr-1"></i> Ch·ªçn d·∫°ng b√†i</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="changeMode('mix')" id="btn-mode-mix" class="btn-mode active text-xs md:text-sm font-bold py-2 px-1 rounded border border-indigo-200 text-indigo-700 bg-white">T·ªïng h·ª£p</button>
                            <button onclick="changeMode('div')" id="btn-mode-div" class="btn-mode text-xs md:text-sm font-bold py-2 px-1 rounded border border-indigo-200 text-indigo-700 bg-white">D·∫°ng ∆Ø·ªõc</button>
                            <button onclick="changeMode('calc')" id="btn-mode-calc" class="btn-mode text-xs md:text-sm font-bold py-2 px-1 rounded border border-indigo-200 text-indigo-700 bg-white">T√¨m x (2-3 b∆∞·ªõc)</button>
                        </div>
                        
                        <!-- Hard Mode Toggle -->
                        <div class="flex items-center justify-end mt-1 pt-2 border-t border-indigo-200">
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-sm font-bold text-gray-600 peer-checked:text-red-600 transition-colors flex items-center">
                                    <i class="fas fa-skull-crossbones mr-1"></i> Ch·∫ø ƒë·ªô Kh√≥
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 relative">
                        <div class="absolute top-3 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60 bg-black/20 px-2 rounded">
                            ƒê·ªÅ b√†i
                        </div>
                        
                        <div class="w-full text-center">
                             <div class="text-blue-200 text-lg font-sans mb-4"><i class="fas fa-question-circle mr-2"></i>T√¨m s·ªë nguy√™n x, bi·∫øt:</div>
                             <div id="question-display" class="font-mono text-3xl md:text-4xl text-white font-bold tracking-wide leading-relaxed">
                                 Loading...
                             </div>
                        </div>
                        
                        <div id="div-hint-text" class="text-yellow-400/80 text-sm mt-6 text-center italic hidden">
                            (G·ª£i √Ω: Nh·∫≠p c√°c gi√° tr·ªã t√¨m ƒë∆∞·ª£c c√°ch nhau b·ªüi d·∫•u ch·∫•m ph·∫©y ";")
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        <div class="mb-4">
                            <label class="block text-gray-500 font-bold text-xs uppercase mb-1 ml-1">K·∫øt qu·∫£ c·ªßa b·∫°n:</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold">x &in; {</span>
                                <input type="text" id="ans-input" placeholder="V√≠ d·ª•: -2; 5" autocomplete="off"
                                    class="w-full pl-12 pr-12 py-3 text-lg font-bold border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-gray-700"
                                    onkeydown="if(event.key === 'Enter') checkAnswer()">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold">}</span>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i kh√°c
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <!-- Feedback Area -->
                        <div id="feedback" class="hidden mt-3 text-center p-3 rounded-lg text-sm font-bold border-2"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[500px] lg:h-[600px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-indigo-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <i class="fas fa-lightbulb text-yellow-300"></i> <span>G·ª£i √Ω</span>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Rule Hint Area -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <i class="fas fa-info-circle mr-2 text-yellow-600"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>
                    
                    <!-- Scrollable Steps -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center select-none">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "G·ª£i √Ω" ƒë·ªÉ xem t·ª´ng b∆∞·ªõc gi·∫£i</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- State Management ---
        const state = {
            streak: 0,
            correct: 0,
            wrong: 0,
            skipped: 0
        };

        let currentMode = 'mix'; // mix, div, calc
        let currentProblem = null;
        let isAnswered = false;
        let stepIndex = 0;
        let usedHint = false;

        // --- Utils ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function fmt(num) {
            return num < 0 ? `(${num})` : `${num}`;
        }

        // H√†m sinh h·ªá s·ªë x theo t·ªâ l·ªá y√™u c·∫ßu
        function getCoefX() {
            const r = Math.random();
            if (r < 0.25) return 1;          // 25% h·ªá s·ªë 1
            if (r < 0.50) return -1;         // 25% h·ªá s·ªë -1
            if (r < 0.80) return -1 * getRandomInt(2, 5); // 30% h·ªá s·ªë √¢m
            return getRandomInt(2, 5);       // 20% h·ªá s·ªë d∆∞∆°ng
        }
        
        // Helper hi·ªÉn th·ªã s·ªë h·∫°ng x: k=1 -> 'x', k=-1 -> '-x', k=2 -> '2x'
        function fmtTermX(k) {
            if (k === 1) return 'x';
            if (k === -1) return '-x';
            return `${k}x`;
        }

        function getDivisors(n) {
            n = Math.abs(n);
            let divs = [];
            for (let i = 1; i <= n; i++) {
                if (n % i === 0) {
                    divs.push(i);
                    divs.push(-i);
                }
            }
            return divs.sort((a,b) => a - b);
        }

        // --- Logic: Quan h·ªá chia h·∫øt (B√†i 5a) ---
        function generateDivisibility(forceExam = true) {
            const examNumbers = [5, -10, 7, -5, -4, -9, 9, -6, -2, -12, -25, -16];
            let target;
            if (forceExam || Math.random() < 0.8) {
                target = examNumbers[getRandomInt(0, examNumbers.length - 1)];
            } else {
                target = getRandomInt(2, 15) * (Math.random() < 0.5 ? 1 : -1);
            }

            const typeProb = Math.random();
            const k = getRandomInt(1, 9);
            
            let displayExpr, innerExpr, answers;
            let divisors = getDivisors(target);
            let divStr = `{ ${divisors.join('; ')} }`;
            let solveSteps = [];
            
            if (typeProb < 0.33) {
                // D·∫°ng 1: A chia h·∫øt cho x - k
                displayExpr = `${target} &#8942; (x - ${k})`;
                innerExpr = `x - ${k}`;
                answers = divisors.map(d => d + k);
                
                let tableRows = divisors.map((d, i) => {
                    return `<div class="flex justify-between border-b border-gray-100 last:border-0 py-1">
                                <span>x - ${k} = ${d}</span>
                                <span>&rArr; x = ${answers[i]}</span>
                            </div>`;
                }).join('');

                solveSteps = [
                    { text: `V√¨ ${target} &#8942; (${innerExpr}) n√™n (${innerExpr}) &in; ∆Ø(${target})`, rule: `N·∫øu a chia h·∫øt cho b th√¨ b l√† ∆∞·ªõc c·ªßa a.` },
                    { text: `Ta c√≥: ∆Ø(${target}) = ${divStr}` },
                    { text: `Suy ra: (${innerExpr}) &in; ${divStr}` },
                    { text: `Ta c√≥ b·∫£ng gi√° tr·ªã:<br><div class="bg-indigo-50 p-2 rounded mt-1 text-sm font-mono">${tableRows}</div>`, rule: "T√¨m x b·∫±ng c√°ch: S·ªë b·ªã tr·ª´ = Hi·ªáu + S·ªë tr·ª´" },
                    { text: `V·∫≠y x &in; { ${answers.sort((a,b)=>a-b).join('; ')} }`, isResult: true }
                ];

            } else if (typeProb < 0.66) {
                // D·∫°ng 2: A chia h·∫øt cho x + k
                displayExpr = `${target} &#8942; (x + ${k})`;
                innerExpr = `x + ${k}`;
                answers = divisors.map(d => d - k);
                
                let tableRows = divisors.map((d, i) => {
                    return `<div class="flex justify-between border-b border-gray-100 last:border-0 py-1">
                                <span>x + ${k} = ${d}</span>
                                <span>&rArr; x = ${answers[i]}</span>
                            </div>`;
                }).join('');

                solveSteps = [
                    { text: `V√¨ ${target} &#8942; (${innerExpr}) n√™n (${innerExpr}) &in; ∆Ø(${target})`, rule: `N·∫øu a chia h·∫øt cho b th√¨ b l√† ∆∞·ªõc c·ªßa a.` },
                    { text: `Ta c√≥: ∆Ø(${target}) = ${divStr}` },
                    { text: `Suy ra: (${innerExpr}) &in; ${divStr}` },
                    { text: `Ta c√≥ b·∫£ng gi√° tr·ªã:<br><div class="bg-indigo-50 p-2 rounded mt-1 text-sm font-mono">${tableRows}</div>`, rule: "T√¨m x b·∫±ng c√°ch: S·ªë h·∫°ng = T·ªïng - S·ªë h·∫°ng kia" },
                    { text: `V·∫≠y x &in; { ${answers.sort((a,b)=>a-b).join('; ')} }`, isResult: true }
                ];
            } else {
                // D·∫°ng 3: A chia h·∫øt cho k - x
                displayExpr = `${target} &#8942; (${k} - x)`;
                innerExpr = `${k} - x`;
                answers = divisors.map(d => k - d);
                
                let tableRows = divisors.map((d, i) => {
                    return `<div class="flex justify-between border-b border-gray-100 last:border-0 py-1">
                                <span>${k} - x = ${d}</span>
                                <span>&rArr; x = ${answers[i]}</span>
                            </div>`;
                }).join('');

                solveSteps = [
                    { text: `V√¨ ${target} &#8942; (${innerExpr}) n√™n (${innerExpr}) &in; ∆Ø(${target})`, rule: `N·∫øu a chia h·∫øt cho b th√¨ b l√† ∆∞·ªõc c·ªßa a.` },
                    { text: `Ta c√≥: ∆Ø(${target}) = ${divStr}` },
                    { text: `Suy ra: (${innerExpr}) &in; ${divStr}` },
                    { text: `Ta c√≥ b·∫£ng gi√° tr·ªã:<br><div class="bg-indigo-50 p-2 rounded mt-1 text-sm font-mono">${tableRows}</div>`, rule: "T√¨m x b·∫±ng c√°ch: S·ªë tr·ª´ = S·ªë b·ªã tr·ª´ - Hi·ªáu" },
                    { text: `V·∫≠y x &in; { ${answers.sort((a,b)=>a-b).join('; ')} }`, isResult: true }
                ];
            }

            return {
                type: 'div',
                display: displayExpr,
                answers: answers.sort((a,b) => a-b),
                steps: solveSteps
            };
        }

        // --- Logic: T√¨m x n√¢ng cao (B√†i 5b) ---
        function generateCalc(forceHard) {
            const stepsType = Math.random() < 0.5 ? 2 : 3; 
            let steps = [];
            let displayStr = "";
            let answer = 0;
            let scale = forceHard ? 2 : 1; 
            
            // H√†m sinh h·ªá s·ªë k theo t·ªâ l·ªá ƒë√£ ƒë·ªãnh
            const k = getCoefX(); 
            const termX = fmtTermX(k);

            if (stepsType === 2) {
                // --- D·∫†NG 2 B∆Ø·ªöC ---
                const subType = getRandomInt(1, 3);
                
                if (subType === 1) { // a(kx+b) = c
                    let a = getRandomInt(2, 5 + scale) * (Math.random() < 0.5 ? 1 : -1);
                    let b = getRandomInt(1, 10 + 5*scale) * (Math.random() < 0.5 ? 1 : -1);
                    
                    // Ch·ªçn x sao cho kx+b chia h·∫øt v√† h·ª£p l√Ω
                    let x = getRandomInt(-10, 10);
                    let inner = k * x + b; // Gi√° tr·ªã trong ngo·∫∑c
                    let c = a * inner;
                    answer = x;
                    
                    let opB = b >= 0 ? '+' : '-';
                    let absB = Math.abs(b);
                    
                    displayStr = `${a} . (${termX} ${opB} ${absB}) = ${c}`;
                    
                    steps.push({ text: `${termX} ${opB} ${absB} = ${c} : ${fmt(a)}`, rule: "T√¨m th·ª´a s·ªë ch∆∞a bi·∫øt (c·∫£ ngo·∫∑c)" });
                    steps.push({ text: `${termX} ${opB} ${absB} = ${inner}` });
                    
                    // B∆∞·ªõc ti·∫øp theo: T√¨m kx
                    if (opB === '+') steps.push({ text: `${termX} = ${inner} - ${absB}`, rule: "T√¨m s·ªë h·∫°ng ch∆∞a bi·∫øt" });
                    else steps.push({ text: `${termX} = ${inner} + ${absB}`, rule: "T√¨m s·ªë b·ªã tr·ª´" });
                    
                    steps.push({ text: `${termX} = ${k*x}` });
                    
                    // B∆∞·ªõc cu·ªëi: T√¨m x (n·∫øu k != 1)
                    if (k !== 1) {
                         steps.push({ text: `x = ${k*x} : ${fmt(k)}`, rule: "T√¨m x (Th·ª´a s·ªë)" });
                    }
                    steps.push({ text: `x = ${answer}`, isResult: true });
                } 
                else if (subType === 2) { // kx + b = c  (Thay a c≈© b·∫±ng k m·ªõi)
                    // k ƒë√£ c√≥.
                    let x = getRandomInt(-10, 10);
                    let kx = k * x;
                    let b = getRandomInt(1, 20 + 10*scale);
                    let op = Math.random() < 0.5 ? '+' : '-';
                    let c = op === '+' ? (kx + b) : (kx - b);
                    answer = x;
                    
                    displayStr = `${termX} ${op} ${b} = ${c}`;
                    
                    if(op === '+') steps.push({ text: `${termX} = ${c} - ${b}`, rule: "Chuy·ªÉn v·∫ø ƒë·ªïi d·∫•u: + th√†nh -" });
                    else steps.push({ text: `${termX} = ${c} + ${b}`, rule: "Chuy·ªÉn v·∫ø ƒë·ªïi d·∫•u: - th√†nh +" });
                    
                    steps.push({ text: `${termX} = ${kx}` });
                    
                    if (k !== 1) {
                        steps.push({ text: `x = ${kx} : ${fmt(k)}`, rule: "T√¨m th·ª´a s·ªë x" });
                    }
                    steps.push({ text: `x = ${answer}`, isResult: true });
                }
                else { // (kx+b):a = c
                    let a = getRandomInt(2, 5 + scale) * (Math.random() < 0.5 ? 1 : -1);
                    let b = getRandomInt(1, 10 + 5*scale) * (Math.random() < 0.5 ? 1 : -1);
                    let c = getRandomInt(1, 10);
                    let inner = c * a; // gi√° tr·ªã kx+b
                    
                    // C·∫ßn x nguy√™n => kx = inner - b => x = (inner - b)/k
                    // Do k sinh ng·∫´u nhi√™n, ta c·∫ßn ch·ªânh l·∫°i b√†i to√°n ƒë·ªÉ x nguy√™n.
                    // C√°ch l√†m: Ch·ªçn x tr∆∞·ªõc, t√≠nh ng∆∞·ª£c l·∫°i.
                    let x = getRandomInt(-10, 10);
                    let kx = k * x;
                    inner = kx + b;
                    // B√¢y gi·ªù inner c√≥ th·ªÉ ko chia h·∫øt cho a, ta c·∫ßn ƒëi·ªÅu ch·ªânh c ho·∫∑c a.
                    // ƒê·ªÉ ƒë∆°n gi·∫£n, ta gi·ªØ kx+b, t√≠nh c v√† a sao cho (kx+b) chia h·∫øt cho a l√† OK.
                    // Nh∆∞ng logic ban ƒë·∫ßu l√† (kx+b):a = c.
                    // Ta bu·ªôc a ph·∫£i l√† ∆∞·ªõc c·ªßa (kx+b).
                    // N·∫øu (kx+b) = 0 th√¨ a t√πy √Ω. N·∫øu kh√°c 0, t√¨m ∆∞·ªõc.
                    if (inner === 0) inner = a * c; // Fallback n·∫øu x xui l√†m inner=0
                    
                    // Recalculate to ensure integrity
                    // Chi·∫øn thu·∫≠t: Ch·ªçn x, k, b -> t√≠nh kx+b. Ch·ªçn a l√† ∆∞·ªõc c·ªßa n√≥. T√≠nh c.
                    // k, x, b ƒë√£ c√≥.
                    let numerator = k*x + b;
                    if (numerator === 0) { b++; numerator = k*x + b; } // Avoid 0 for divisor check ease
                    
                    let divs = getDivisors(numerator);
                    // L·ªçc a ph√π h·ª£p (ko qu√° l·ªõn, ko l√† 1, -1)
                    divs = divs.filter(d => Math.abs(d) > 1 && Math.abs(d) <= 20);
                    if (divs.length === 0) a = 1; 
                    else a = divs[getRandomInt(0, divs.length-1)];
                    
                    c = numerator / a;
                    answer = x;
                    
                    let opB = b >= 0 ? '+' : '-';
                    let absB = Math.abs(b);
                    
                    displayStr = `(${termX} ${opB} ${absB}) : ${fmt(a)} = ${c}`;
                    
                    steps.push({ text: `${termX} ${opB} ${absB} = ${c} . ${fmt(a)}`, rule: "T√¨m S·ªë b·ªã chia (c·∫£ ngo·∫∑c)" });
                    steps.push({ text: `${termX} ${opB} ${absB} = ${numerator}` });
                    
                    if (opB === '+') steps.push({ text: `${termX} = ${numerator} - ${absB}` });
                    else steps.push({ text: `${termX} = ${numerator} + ${absB}` });
                    
                    steps.push({ text: `${termX} = ${k*x}` });
                    
                    if (k !== 1) steps.push({ text: `x = ${k*x} : ${fmt(k)}` });
                    steps.push({ text: `x = ${answer}`, isResult: true });
                }
            } else {
                // --- D·∫†NG 3 B∆Ø·ªöC ---
                const subType = getRandomInt(1, 2);
                
                if (subType === 1 || forceHard) { // a - b(kx+h) = c
                    let b = getRandomInt(2, 5) * (forceHard ? 1 : (Math.random()<0.5?1:-1)); 
                    let h = getRandomInt(1, 10) * (Math.random() < 0.5 ? 1 : -1);
                    
                    // Ch·ªçn x tr∆∞·ªõc
                    let x = getRandomInt(-10, 10);
                    let inner = k*x + h; // Gi√° tr·ªã (kx+h)
                    let middleTerm = b * inner;
                    
                    let a = getRandomInt(20, 50 * scale);
                    let c = a - middleTerm;
                    answer = x;
                    
                    let opH = h >= 0 ? '+' : '-';
                    let absH = Math.abs(h);
                    
                    displayStr = `${a} - ${b > 0 && b!==1 ? b : '('+b+')'}.(${termX} ${opH} ${absH}) = ${c}`;
                    // N·∫øu b=1 th√¨ ko c·∫ßn vi·∫øt. ·ªû ƒë√¢y b >= 2 (ho·∫∑c √¢m).
                    // display logic fix:
                    let bDisp = b;
                    if (b > 0) bDisp = b === 1 ? '' : b;
                    else bDisp = b === -1 ? '-' : `(${b})`;
                    // Tuy nhi√™n logic t√≠nh to√°n ·ªü tr√™n a - b(...) = c ng·∫ßm hi·ªÉu b l√† s·ªë d∆∞∆°ng trong ph√©p tr·ª´,
                    // ho·∫∑c l√† c·ªông n·∫øu b √¢m. ƒê·ªÉ kh·ªõp v·ªõi "T√¨m s·ªë tr·ª´", ta n√™n ƒë·ªÉ b d∆∞∆°ng.
                    // N·∫øu forceHard, b d∆∞∆°ng.
                    // Code c≈©: a - b(...) v·ªõi b ng·∫´u nhi√™n.
                    // Fix: Hi·ªÉn th·ªã ƒë√∫ng d·∫•u.
                    
                    // Ta d√πng logic: A - B.C = D => B.C = A - D.
                    // N√™n hi·ªÉn th·ªã d·∫°ng: a - b.(...) = c
                    let bVal = Math.abs(b);
                    displayStr = `${a} - ${bVal}.(${termX} ${opH} ${absH}) = ${c}`;
                    
                    steps.push({ text: `${bVal}.(${termX} ${opH} ${absH}) = ${a} - ${c}`, rule: "T√¨m S·ªë tr·ª´ (c·ª•m nh√¢n): L·∫•y SBT - Hi·ªáu" });
                    steps.push({ text: `${bVal}.(${termX} ${opH} ${absH}) = ${middleTerm}` }); // middleTerm ·ªü ƒë√¢y th·ª±c ra l√† bVal * inner.
                    // C·∫ßn recalculate middleTerm theo bVal (d∆∞∆°ng)
                    let realMiddle = bVal * inner;
                    // Ki·ªÉm tra l·∫°i logic sinh ƒë·ªÅ:
                    // ƒê·ªÅ: a - bVal * inner = c.
                    // => c ƒë∆∞·ª£c t√≠nh t·ª´ a - bVal * inner. ƒê√∫ng.
                    
                    steps.push({ text: `${termX} ${opH} ${absH} = ${realMiddle} : ${bVal}`, rule: "T√¨m th·ª´a s·ªë ch∆∞a bi·∫øt (c·∫£ ngo·∫∑c)" });
                    steps.push({ text: `${termX} ${opH} ${absH} = ${inner}` });
                    
                    if(opH === '+') steps.push({ text: `${termX} = ${inner} - ${absH}` });
                    else steps.push({ text: `${termX} = ${inner} + ${absH}` });
                    
                    steps.push({ text: `${termX} = ${k*x}` });
                    if (k !== 1) steps.push({ text: `x = ${k*x} : ${fmt(k)}` });
                    steps.push({ text: `x = ${answer}`, isResult: true });
                    
                } else { // (ax + b) : c = d  ---> chuy·ªÉn th√†nh (kx + b) : c = d
                    // k ƒë√£ c√≥
                    let c = getRandomInt(2, 6) * (Math.random() < 0.5 ? 1 : -1);
                    let d = getRandomInt(1, 10) * (Math.random() < 0.5 ? 1 : -1);
                    let divident = c * d; // (kx+b)
                    
                    // Ch·ªçn x, t√≠nh b
                    let x = getRandomInt(-10, 10);
                    let kx = k * x;
                    let b = divident - kx;
                    
                    answer = x;
                    
                    let opB = b >= 0 ? '+' : '-';
                    let absB = Math.abs(b);
                    
                    displayStr = `(${termX} ${opB} ${absB}) : ${fmt(c)} = ${d}`;
                    
                    steps.push({ text: `${termX} ${opB} ${absB} = ${d} . ${fmt(c)}`, rule: "T√¨m S·ªë b·ªã chia (c·∫£ ngo·∫∑c)" });
                    steps.push({ text: `${termX} ${opB} ${absB} = ${divident}` });
                    
                    if(opB === '+') steps.push({ text: `${termX} = ${divident} - ${absB}`, rule: "Chuy·ªÉn v·∫ø: + th√†nh -" });
                    else steps.push({ text: `${termX} = ${divident} + ${absB}`, rule: "Chuy·ªÉn v·∫ø: - th√†nh +" });
                    
                    steps.push({ text: `${termX} = ${kx}` });
                    if (k !== 1) steps.push({ text: `x = ${kx} : ${fmt(k)}` });
                    steps.push({ text: `x = ${answer}`, isResult: true });
                }
            }

            return {
                type: 'calc',
                display: displayStr,
                answers: [answer],
                steps: steps
            };
        }

        function generateProblem() {
            const isHard = document.getElementById('mode-hard').checked;
            let data;
            
            if (currentMode === 'div') {
                data = generateDivisibility(false); 
            } else if (currentMode === 'calc') {
                data = generateCalc(isHard);
            } else {
                if (Math.random() < 0.5) data = generateDivisibility(true); 
                else data = generateCalc(isHard);
            }
            return data;
        }

        // --- UI Interactions ---

        function changeMode(mode) {
            currentMode = mode;
            ['mix', 'div', 'calc'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if (m === mode) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            nextQuestion();
        }

        function renderStats() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = state.streak;
            if (state.streak > 2) {
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${state.streak}`;
                streakEl.classList.add('streak-fire');
            } else {
                streakEl.classList.remove('streak-fire');
            }
            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-skipped').textContent = state.skipped;
        }

        function nextQuestion() {
            if (!isAnswered && document.getElementById('question-display').innerText !== 'Loading...') {
                state.skipped++;
                state.streak = 0;
                renderStats();
            }

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('ans-input').value = '';
            document.getElementById('ans-input').disabled = false;
            document.getElementById('ans-input').classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');
            document.getElementById('rule-area').classList.add('hidden');
            
            isAnswered = false;
            stepIndex = 0;
            usedHint = false;
            
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center select-none"><i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i><span>B·∫•m "G·ª£i √Ω" ƒë·ªÉ xem t·ª´ng b∆∞·ªõc gi·∫£i</span></div>`;
            
            const btnStep = document.getElementById('btn-show-step');
            btnStep.innerHTML = '<i class="fas fa-lightbulb text-yellow-300"></i> <span>G·ª£i √Ω</span>';
            btnStep.disabled = false;
            btnStep.className = 'bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 ml-2';

            currentProblem = generateProblem();
            
            document.getElementById('question-display').innerHTML = currentProblem.display;
            document.getElementById('step-counter').textContent = `0/${currentProblem.steps.length}`;
            
            if (currentProblem.type === 'div') {
                document.getElementById('div-hint-text').classList.remove('hidden');
            } else {
                document.getElementById('div-hint-text').classList.add('hidden');
            }
        }

        function showNextStep() {
            usedHint = true;
            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            const ruleContent = document.getElementById('rule-content');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentProblem.steps.length) {
                const item = currentProblem.steps[stepIndex];
                
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-item bg-white p-3 rounded border-l-4 shadow-sm mb-3 text-base font-mono leading-relaxed';
                
                if (item.isResult) {
                    stepDiv.classList.add('border-green-500', 'bg-green-50');
                    stepDiv.innerHTML = `<span class="text-green-700 font-bold"><i class="fas fa-flag-checkered mr-2"></i>${item.text}</span>`;
                } else {
                    stepDiv.classList.add('border-indigo-400');
                    stepDiv.innerHTML = item.text;
                }
                container.appendChild(stepDiv);

                if (item.rule) {
                    ruleContent.textContent = item.rule;
                    ruleArea.classList.remove('hidden');
                    ruleArea.classList.remove('animate-pulse');
                    void ruleArea.offsetWidth; 
                    ruleArea.classList.add('animate-pulse');
                }

                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentProblem.steps.length}`;
            }

            if (stepIndex >= currentProblem.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>H·∫øt</span>';
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                btn.classList.remove('hover:bg-indigo-700');
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const inputEl = document.getElementById('ans-input');
            const rawVal = inputEl.value.trim();
            
            if (!rawVal) {
                alert("Vui l√≤ng nh·∫≠p ƒë√°p √°n!");
                return;
            }

            let userValues = rawVal.split(/[,;]+/).map(v => parseInt(v.trim())).filter(n => !isNaN(n));
            
            if (userValues.length === 0) {
                alert("Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá!");
                return;
            }

            const correctSet = new Set(currentProblem.answers);
            const userSet = new Set(userValues);
            
            let isCorrect = (correctSet.size === userSet.size) && [...userSet].every(v => correctSet.has(v));

            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'border-green-300', 'bg-red-100', 'text-red-800', 'border-red-300', 'bg-blue-100', 'text-blue-800', 'border-blue-300');

            if (isCorrect) {
                inputEl.classList.add('border-green-500', 'bg-green-50');
                inputEl.classList.remove('border-gray-300');
                
                if (!usedHint) {
                    state.correct++;
                    state.streak++;
                    feedback.innerHTML = '<i class="fas fa-crown text-xl mb-1"></i><br>Xu·∫•t s·∫Øc! ƒê√°p √°n ch√≠nh x√°c.';
                    feedback.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
                } else {
                    feedback.innerHTML = '<i class="fas fa-check text-xl mb-1"></i><br>ƒê√∫ng r·ªìi! (B·∫°n ƒë√£ xem g·ª£i √Ω)';
                    feedback.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-300');
                }
                
                const reveal = setInterval(() => {
                    if(stepIndex < currentProblem.steps.length) showNextStep();
                    else clearInterval(reveal);
                }, 150);
                
            } else {
                state.wrong++;
                state.streak = 0;
                inputEl.classList.add('border-red-500', 'bg-red-50');
                inputEl.classList.remove('border-gray-300');
                
                feedback.innerHTML = `<i class="fas fa-times-circle text-xl mb-1"></i><br>Ch∆∞a ƒë√∫ng. ƒê√°p √°n l√†: ${currentProblem.answers.join('; ')}`;
                feedback.classList.add('bg-red-100', 'text-red-800', 'border-red-300');
            }
            
            renderStats();
            isAnswered = true;
            inputEl.disabled = true;
        }

        window.onload = nextQuestion;

    </script>
</body>
</html>