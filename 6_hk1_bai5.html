<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Thi Toán 6 - Tìm X (Quy tắc Tìm Thành Phần)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #fdf4f0; /* Warm tint */
            background-image: radial-gradient(#fed7aa 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #262626; /* Neutral Dark */
            color: #ecf0f1;
            border: 8px solid #78350f; /* Wood color */
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .btn-mode {
            transition: all 0.2s;
            border-bottom: 4px solid transparent;
        }
        .btn-mode:active {
            transform: translateY(2px);
            border-bottom-width: 0;
        }
        .mode-active {
            background-color: #ea580c !important; /* orange-600 */
            color: white !important;
            border-bottom: 4px solid #9a3412 !important; /* orange-800 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.4s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar { width: 8px; }
        #steps-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
        #steps-container::-webkit-scrollbar-thumb:hover { background: #fb923c; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 md:p-6">

    <div class="max-w-6xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-orange-200">
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-600 to-red-500 p-4 md:p-6 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-4xl font-extrabold text-white uppercase tracking-wider drop-shadow-md">
                <i class="fas fa-calculator mr-3"></i>Luyện Thi Toán 6 - CHINH PHỤC BÀI 5
            </h1>
            <p class="text-orange-50 mt-2 text-sm md:text-base font-semibold">TÌM SỐ NGUYÊN X Dạng Ước Bội VÀ Dạng TÌM X 2-3 BƯỚC - daytoanthayhoang.github.io</p>
            <div class="absolute top-4 right-4 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full text-white font-bold border border-white/30 shadow-sm">
                Điểm: <span id="score" class="text-yellow-300 text-xl">0</span>
            </div>
        </div>

        <div class="p-4 md:p-6 space-y-6">
            
            <!-- Mode Selection -->
            <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 shadow-inner">
                <label class="block text-gray-700 font-bold mb-3 text-sm uppercase tracking-wide flex items-center">
                    <i class="fas fa-shapes text-orange-600 mr-2"></i>Chọn dạng bài:
                </label>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="setMode('exam_mix')" id="btn-exam_mix" class="btn-mode flex-1 min-w-[140px] bg-red-100 border border-red-300 text-red-800 py-3 px-4 rounded-xl font-bold text-sm hover:bg-red-200">
                        <i class="fas fa-random mr-1"></i> Tổng hợp Đề
                    </button>
                    
                    <button onclick="setMode('divisibility')" id="btn-divisibility" class="btn-mode flex-1 min-w-[140px] bg-purple-100 border border-purple-300 text-purple-800 py-3 px-4 rounded-xl font-bold text-sm hover:bg-purple-200">
                        <i class="fas fa-divide mr-1"></i> Dạng Ước
                    </button>

                    <button onclick="setMode('basic')" id="btn-basic" class="btn-mode flex-1 min-w-[120px] bg-blue-100 border border-blue-300 text-blue-800 py-3 px-4 rounded-xl font-bold text-sm hover:bg-blue-200">
                        Cơ bản (1 bước)
                    </button>
                    
                    <button onclick="setMode('advanced_2')" id="btn-advanced_2" class="btn-mode flex-1 min-w-[120px] bg-green-100 border border-green-300 text-green-800 py-3 px-4 rounded-xl font-bold text-sm hover:bg-green-200">
                        2 Bước
                    </button>

                    <button onclick="setMode('advanced_3')" id="btn-advanced_3" class="btn-mode flex-1 min-w-[120px] bg-teal-100 border border-teal-300 text-teal-800 py-3 px-4 rounded-xl font-bold text-sm hover:bg-teal-200">
                        3 Bước
                    </button>
                </div>
            </div>

            <!-- Question Area -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Question Board -->
                <div class="flex flex-col h-full">
                    <div class="chalkboard p-6 md:p-8 min-h-[300px]">
                        <div class="absolute top-4 left-4 text-gray-400 text-xs font-mono border border-gray-600 px-2 py-1 rounded">
                            <i class="fas fa-tag mr-1"></i><span id="question-type-label">...</span>
                        </div>
                        
                        <!-- Using innerHTML to render HTML content (fractions, special chars) -->
                        <div id="question-text" class="text-3xl md:text-4xl font-bold tracking-widest mb-6 font-mono leading-relaxed text-center">
                            Loading...
                        </div>
                        
                        <div class="text-gray-400 text-sm mt-auto border-t border-gray-600 pt-4 w-full text-center">
                            <i class="fas fa-info-circle mr-1"></i> <span id="input-hint">Kết quả là số nguyên</span>
                        </div>
                    </div>
                </div>

                <!-- Right: Step-by-step & Hint Area -->
                <div class="bg-white rounded-2xl border-2 border-dashed border-orange-300 p-5 flex flex-col h-full shadow-sm">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <h3 class="font-bold text-gray-700 flex items-center">
                            <span class="bg-orange-100 text-orange-700 p-1.5 rounded-lg mr-2"><i class="fas fa-list-ol"></i></span>
                            Hướng dẫn giải
                        </h3>
                        <button onclick="showNextStep()" id="btn-show-step" class="bg-blue-500 hover:bg-blue-600 text-white text-xs md:text-sm font-bold py-2 px-4 rounded-lg shadow transition-colors flex items-center">
                            <i class="fas fa-lightbulb mr-2"></i> Gợi ý
                        </button>
                    </div>
                    
                    <!-- Rule Hint Box -->
                    <div id="rule-hint" class="hidden mb-3 text-sm bg-yellow-50 text-yellow-800 p-3 rounded-xl border border-yellow-200 flex items-start">
                        <i class="fas fa-star text-yellow-500 mt-1 mr-2 flex-shrink-0"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>

                    <!-- Steps Container -->
                    <div id="steps-container" class="flex-grow space-y-3 overflow-y-auto max-h-[250px] text-gray-800 font-mono text-base pr-2">
                        <!-- Steps will appear here -->
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col md:flex-row gap-4 justify-center items-center pt-2">
                <div class="relative w-full md:w-1/3">
                    <input type="text" id="user-answer" placeholder="Nhập x..." autocomplete="off"
                        class="w-full text-center text-2xl font-bold p-3 border-2 border-gray-300 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-100 focus:outline-none transition-all placeholder-gray-300"
                        onkeydown="if(event.key === 'Enter') checkAnswer()">
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs hidden md:block">
                        ENTER
                    </div>
                </div>
                
                <button onclick="checkAnswer()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-all shadow-lg transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center min-w-[140px]">
                    <i class="fas fa-check mr-2"></i> Kiểm tra
                </button>
                
                <button onclick="nextQuestion()" class="w-full md:w-auto bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 px-6 rounded-xl text-lg transition-colors flex items-center justify-center">
                    <i class="fas fa-forward mr-2"></i> Câu khác
                </button>
            </div>

            <!-- Result Feedback -->
            <div id="feedback" class="hidden transform transition-all duration-300 ease-out origin-top"></div>

        </div>
    </div>

    <script>
        // --- State ---
        let currentQuestion = {};
        let score = 0;
        let isAnswered = false;
        let currentMode = 'exam_mix';
        let stepIndex = 0;

        // --- Utility ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function fmt(num) {
            return num < 0 ? `(${num})` : `${num}`;
        }
        
        function fmtDisplayOp(op, num) {
            // Helper to show "+ -5" as "- 5"
            if (op === '+') return num < 0 ? `- ${Math.abs(num)}` : `+ ${num}`;
            if (op === '-') return num < 0 ? `+ ${Math.abs(num)}` : `- ${num}`;
            return '';
        }

        // --- Logic: 1. Divisibility (Dạng Ước) ---
        // Support: x+b, x-b, b-x, b+x
        function generateDivisibility() {
            const targets = [-10, -4, -5, -6, -9, 5, 7, -25, -16, -2, 10, 12, -12];
            const a = targets[getRandomInt(0, targets.length - 1)];
            const b = getRandomInt(1, 9); // Keep b positive for easier reading in templates like b-x
            
            // Types: 0: x+b, 1: x-b, 2: b-x
            const type = getRandomInt(0, 2); 
            
            let expressionDisplay = "";
            let logicText = "";
            let answers = [];
            let tableRows = "";
            
            // Helper to get divisors
            let divisors = [];
            let absA = Math.abs(a);
            for(let i=1; i<=absA; i++) {
                if(absA % i === 0) { divisors.push(i); divisors.push(-i); }
            }
            divisors.sort((u,v) => u - v);

            if (type === 0) { 
                // x + b
                expressionDisplay = `x + ${b}`;
                answers = divisors.map(d => d - b);
                logicText = `x + ${b} = Ư(${a})`;
                tableRows = divisors.map((d, i) => `x + ${b} = ${d} &rArr; x = ${answers[i]}`).join('<br>');
            } else if (type === 1) { 
                // x - b
                expressionDisplay = `x - ${b}`;
                answers = divisors.map(d => d + b);
                logicText = `x - ${b} = Ư(${a})`;
                tableRows = divisors.map((d, i) => `x - ${b} = ${d} &rArr; x = ${answers[i]}`).join('<br>');
            } else { 
                // b - x
                expressionDisplay = `${b} - x`;
                // b - x = d => x = b - d
                answers = divisors.map(d => b - d);
                logicText = `${b} - x = Ư(${a})`;
                tableRows = divisors.map((d, i) => `${b} - x = ${d} &rArr; x = ${answers[i]}`).join('<br>');
            }

            return {
                label: "Dạng Ước",
                display: `<div class="text-3xl">${a} <span class="mx-2">⋮</span> (${expressionDisplay})</div>`,
                answer: answers.sort((x, y) => x - y),
                hintInput: "Nhập các giá trị x, cách nhau bởi dấu phẩy",
                hintRule: `Nếu a chia hết cho B thì B là Ước của a.`,
                steps: [
                    `Vì ${a} <span class="mx-1">⋮</span> (${expressionDisplay}) nên (${expressionDisplay}) &in; Ư(${a})`,
                    `Tìm các ước của ${a}:<br>Ư(${a}) = { ${divisors.join('; ')} }`,
                    `Ta có bảng giá trị:<br><div class="pl-4 border-l-2 border-gray-300 mt-1 text-sm bg-gray-50 p-2 rounded">${tableRows}</div>`,
                    `Vậy x &in; { ${answers.join('; ')} }`
                ]
            };
        }

        // --- Logic: 2. Basic Find X (Using Component Rules) ---
        // Rules: Số hạng, Số bị trừ (SBT), Số trừ (ST), Thừa số, Số bị chia (SBC), Số chia (SC)
        
        const basicGenerators = {
            add: () => { 
                const x = getRandomInt(-20, 20);
                const a = getRandomInt(-20, 20);
                const b = x + a;
                // Display: x + a = b
                return {
                    display: `x ${fmtDisplayOp('+', a)} = ${b}`,
                    answer: [x],
                    hintRule: "Muốn tìm Số hạng chưa biết, ta lấy Tổng trừ đi Số hạng đã biết.",
                    steps: [`x = ${b} - ${fmt(a)}`, `x = ${x}`]
                };
            },
            sub_x: () => { 
                const x = getRandomInt(-20, 20);
                const a = getRandomInt(1, 20); // Keep 'a' positive for standard "x - 5" look
                const b = x - a;
                // Display: x - a = b
                return {
                    display: `x - ${a} = ${b}`,
                    answer: [x],
                    hintRule: "Muốn tìm Số Bị Trừ, ta lấy Hiệu cộng với Số Trừ.",
                    steps: [`x = ${b} + ${a}`, `x = ${x}`]
                };
            },
            sub_a: () => { 
                const x = getRandomInt(-20, 20);
                const a = getRandomInt(-20, 20);
                const b = a - x;
                // Display: a - x = b
                return {
                    display: `${a} - x = ${b}`,
                    answer: [x],
                    hintRule: "Muốn tìm Số Trừ, ta lấy Số Bị Trừ trừ đi Hiệu.",
                    steps: [`x = ${a} - ${fmt(b)}`, `x = ${x}`]
                };
            },
            mul: () => { 
                const x = getRandomInt(-15, 15);
                let a = getRandomInt(-10, 10);
                while(a === 0 || a === 1) a = getRandomInt(-10, 10);
                const b = x * a;
                // Display: x . a = b (or a.x = b)
                // Randomize position of x
                if (Math.random() > 0.5) {
                    return {
                        display: `x . ${fmt(a)} = ${b}`,
                        answer: [x],
                        hintRule: "Muốn tìm Thừa Số chưa biết, ta lấy Tích chia cho Thừa Số đã biết.",
                        steps: [`x = ${b} : ${fmt(a)}`, `x = ${x}`]
                    };
                } else {
                     return {
                        display: `${a} . x = ${b}`, // Common notation: 5x = 10
                        answer: [x],
                        hintRule: "Muốn tìm Thừa Số chưa biết, ta lấy Tích chia cho Thừa Số đã biết.",
                        steps: [`x = ${b} : ${fmt(a)}`, `x = ${x}`]
                    };
                }
            },
            div_x: () => { 
                const a = getRandomInt(-10, 10) || 2; 
                const b = getRandomInt(-15, 15);
                const x = a * b;
                return {
                    display: `x : ${fmt(a)} = ${b}`,
                    answer: [x],
                    hintRule: "Muốn tìm Số Bị Chia, ta lấy Thương nhân với Số Chia.",
                    steps: [`x = ${b} . ${fmt(a)}`, `x = ${x}`]
                };
            },
            div_a: () => { 
                const x = getRandomInt(-10, 10) || 2; 
                const b = getRandomInt(-15, 15) || 2; 
                if (x === 0) x = 2; // Prevent div by zero
                const a = x * b;
                return {
                    display: `${a} : x = ${b}`,
                    answer: [x],
                    hintRule: "Muốn tìm Số Chia, ta lấy Số Bị Chia chia cho Thương.",
                    steps: [`x = ${a} : ${fmt(b)}`, `x = ${x}`]
                };
            }
        };

        // --- Logic: 3. Advanced 2 Steps (From user code) ---
        function generateAdvanced2() {
            const types = ['ax_plus_b', 'a_mul_x_plus_b', 'x_plus_b_div_a'];
            const type = types[getRandomInt(0, types.length - 1)];
            const x = getRandomInt(-20, 20);

            if (type === 'ax_plus_b') {
                // a.x + b = c  (Finding Component First)
                let a = getRandomInt(-9, 9) || 2;
                let b = getRandomInt(-20, 20);
                let ax = a * x;
                let c = ax + b;
                
                // Determine operator for display
                let op = b >= 0 ? '+' : '-';
                let absB = Math.abs(b);
                let display = `${a}x ${op} ${absB} = ${c}`;
                
                // Step 1: Find ax (Unknown term)
                let step1, rule;
                if (op === '+') {
                    // ax + b = c -> ax = c - b
                    rule = "Bước 1: Tìm số hạng chứa x (ax). Bước 2: Tìm x (Thừa số).";
                    step1 = `${a}x = ${c} - ${absB}`;
                } else {
                    // ax - b = c -> ax = c + b
                    rule = "Bước 1: Tìm Số Bị Trừ chứa x (ax). Bước 2: Tìm x.";
                    step1 = `${a}x = ${c} + ${absB}`;
                }

                return {
                    label: "Tìm X 2 Bước",
                    display: display,
                    answer: [x],
                    hintRule: rule,
                    steps: [
                        step1,
                        `${a}x = ${ax}`,
                        `x = ${ax} : ${a}`,
                        `x = ${x}`
                    ]
                };
            } else if (type === 'a_mul_x_plus_b') {
                // a.(x + b) = c (Finding Factor First)
                let a = getRandomInt(-9, 9) || 2;
                let b = getRandomInt(-15, 15);
                let x_plus_b = x + b;
                let c = a * x_plus_b;
                
                let op = b >= 0 ? '+' : '-';
                let absB = Math.abs(b);
                
                return {
                    label: "Tìm X 2 Bước",
                    display: `${a} . (x ${op} ${absB}) = ${c}`,
                    answer: [x],
                    hintRule: "Bước 1: Tìm thừa số chứa ngoặc (x " + op + " " + absB + ").",
                    steps: [
                        `x ${op} ${absB} = ${c} : ${fmt(a)}`,
                        `x ${op} ${absB} = ${x_plus_b}`,
                        // Step 2: Depends on op
                        (op === '+' ? `x = ${x_plus_b} - ${absB}` : `x = ${x_plus_b} + ${absB}`),
                        `x = ${x}`
                    ]
                };
            } else {
                // (x + b) : a = c (Finding SBC First)
                let a = getRandomInt(-9, 9) || 2;
                let b = getRandomInt(-15, 15);
                let c = getRandomInt(-10, 10);
                let x_plus_b = c * a;
                let real_x = x_plus_b - b; // Re-calc x to ensure integer
                
                let op = b >= 0 ? '+' : '-';
                let absB = Math.abs(b);
                
                return {
                    label: "Tìm X 2 Bước",
                    display: `(x ${op} ${absB}) : ${fmt(a)} = ${c}`,
                    answer: [real_x],
                    hintRule: "Bước 1: Tìm Số Bị Chia là cả ngoặc.",
                    steps: [
                        `x ${op} ${absB} = ${c} . ${fmt(a)}`,
                        `x ${op} ${absB} = ${x_plus_b}`,
                        (op === '+' ? `x = ${x_plus_b} - ${absB}` : `x = ${x_plus_b} + ${absB}`),
                        `x = ${real_x}`
                    ]
                };
            }
        }

        // --- Logic: 4. Advanced 3 Steps (From user code) ---
        function generateAdvanced3() {
            // Forms: (ax + b) : c = d  OR  c . (ax + b) = d
            const x = getRandomInt(-15, 15);
            const a = getRandomInt(-5, 5) || 2;
            const b = getRandomInt(-20, 20);
            const inner = a * x + b;
            
            let c, d, displayStr;
            let steps = [];
            let rule = "Bài toán 3 lớp: Tìm ngoặc -> Tìm số hạng chứa x -> Tìm x";

            // Randomly choose Div or Mul container
            const isDiv = Math.random() > 0.5;

            // Form 1: Container is Division: (ax + b) : c = d
            if (isDiv && inner !== 0) {
                 // Ensure divisibility for nice numbers
                let divisors = [];
                for(let i=1; i<=Math.abs(inner); i++) {
                    if(inner % i === 0) divisors.push(i);
                }
                
                if (divisors.length > 0) {
                    c = divisors[getRandomInt(0, divisors.length-1)] * (Math.random() > 0.5 ? 1 : -1);
                    d = inner / c;
                    
                    let opB = b >= 0 ? '+' : '-';
                    let absB = Math.abs(b);

                    displayStr = `(${a}x ${opB} ${absB}) : ${fmt(c)} = ${d}`;
                    
                    steps = [
                        `${a}x ${opB} ${absB} = ${d} . ${fmt(c)}`,
                        `${a}x ${opB} ${absB} = ${inner}`,
                        (opB === '+' ? `${a}x = ${inner} - ${absB}` : `${a}x = ${inner} + ${absB}`),
                        `${a}x = ${a*x}`,
                        `x = ${a*x} : ${fmt(a)}`,
                        `x = ${x}`
                    ];
                } else {
                     // Fallback to Mul if no divisors found easy
                     return generateAdvanced2();
                }
            } else {
                // Form 2: Container is Multiplication: c . (ax + b) = d
                c = getRandomInt(2, 5) * (Math.random() > 0.5 ? 1 : -1);
                d = inner * c;
                
                let opB = b >= 0 ? '+' : '-';
                let absB = Math.abs(b);
                
                displayStr = `${c} . (${a}x ${opB} ${absB}) = ${d}`;
                
                steps = [
                    `${a}x ${opB} ${absB} = ${d} : ${fmt(c)}`,
                    `${a}x ${opB} ${absB} = ${inner}`,
                    (opB === '+' ? `${a}x = ${inner} - ${absB}` : `${a}x = ${inner} + ${absB}`),
                    `${a}x = ${a*x}`,
                    `x = ${a*x} : ${fmt(a)}`,
                    `x = ${x}`
                ];
            }

            return {
                label: "Tìm X 3 Bước",
                display: displayStr,
                answer: [x],
                hintRule: rule,
                steps: steps
            };
        }


        // --- UI Controller ---

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('mode-active'));
            document.getElementById(`btn-${mode}`).classList.add('mode-active');
            nextQuestion();
        }

        function nextQuestion() {
            // Reset UI
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('user-answer').value = '';
            document.getElementById('user-answer').disabled = false;
            document.getElementById('user-answer').focus();
            document.getElementById('rule-hint').classList.add('hidden');
            
            // Reset Steps
            stepIndex = 0;
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = ''; 
            
            const btnStep = document.getElementById('btn-show-step');
            btnStep.disabled = false;
            btnStep.innerHTML = '<i class="fas fa-lightbulb mr-2"></i> Gợi ý';
            btnStep.className = 'bg-blue-500 hover:bg-blue-600 text-white text-xs md:text-sm font-bold py-2 px-4 rounded-lg shadow transition-colors flex items-center';
            
            isAnswered = false;

            // Generator Routing
            if (currentMode === 'divisibility') {
                currentQuestion = generateDivisibility();
            } else if (currentMode === 'basic') {
                const keys = Object.keys(basicGenerators);
                const key = keys[getRandomInt(0, keys.length - 1)];
                currentQuestion = basicGenerators[key]();
                currentQuestion.label = "Cơ bản";
            } else if (currentMode === 'advanced_2') {
                currentQuestion = generateAdvanced2();
            } else if (currentMode === 'advanced_3') {
                currentQuestion = generateAdvanced3();
            } else {
                // Exam Mix: 30% Div, 20% Basic, 30% Adv2, 20% Adv3
                const r = Math.random();
                if (r < 0.3) currentQuestion = generateDivisibility();
                else if (r < 0.5) {
                    const keys = Object.keys(basicGenerators);
                    const key = keys[getRandomInt(0, keys.length - 1)];
                    currentQuestion = basicGenerators[key]();
                    currentQuestion.label = "Cơ bản";
                }
                else if (r < 0.8) currentQuestion = generateAdvanced2();
                else currentQuestion = generateAdvanced3();
            }

            // Update DOM
            document.getElementById('question-text').innerHTML = currentQuestion.display;
            document.getElementById('input-hint').textContent = currentQuestion.hintInput || "Kết quả là số nguyên";
            document.getElementById('question-type-label').textContent = currentQuestion.label || "Bài tập";
        }

        function showNextStep() {
            const container = document.getElementById('steps-container');
            
            // Show Rule first
            if (stepIndex === 0 && currentQuestion.hintRule) {
                document.getElementById('rule-content').textContent = currentQuestion.hintRule;
                document.getElementById('rule-hint').classList.remove('hidden');
            }

            if (stepIndex < currentQuestion.steps.length) {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-item bg-orange-50 p-3 rounded-lg border-l-4 border-orange-400 font-bold shadow-sm text-lg';
                
                // Color formatting for last step (Answer)
                if (stepIndex === currentQuestion.steps.length - 1) {
                     stepDiv.className = 'step-item bg-green-50 p-3 rounded-lg border-l-4 border-green-500 font-bold text-green-800 shadow-sm text-lg';
                }
                
                // Add step index label
                stepDiv.innerHTML = `<span class="text-xs uppercase text-gray-400 block mb-1">Bước ${stepIndex + 1}</span> ${currentQuestion.steps[stepIndex]}`;
                container.appendChild(stepDiv);
                
                container.scrollTop = container.scrollHeight;
                stepIndex++;
            }

            // Button State
            if (stepIndex >= currentQuestion.steps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check mr-1"></i> Xong';
                btn.className = 'bg-gray-400 text-white text-xs md:text-sm font-bold py-2 px-4 rounded-lg cursor-not-allowed flex items-center';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;

            const input = document.getElementById('user-answer');
            const feedback = document.getElementById('feedback');
            const rawVal = input.value.trim();

            if (!rawVal) {
                alert("Bạn chưa nhập đáp án!");
                return;
            }

            // Handle multi-value answers
            let userValues = rawVal.split(/[ ,;]+/).filter(v => v !== '').map(v => parseInt(v));
            if (userValues.some(isNaN)) {
                alert("Vui lòng chỉ nhập số nguyên!");
                return;
            }

            isAnswered = true;
            input.disabled = true;

            // Check correctness
            const correctSet = new Set(currentQuestion.answer);
            const userSet = new Set(userValues);
            let isCorrect = (correctSet.size === userSet.size) && [...correctSet].every(val => userSet.has(val));

            if (isCorrect) {
                score += 10;
                document.getElementById('score').textContent = score;
                feedback.innerHTML = `
                    <div class="text-green-700 font-bold text-xl mb-1 flex items-center justify-center animate-bounce">
                        <i class="fas fa-check-circle mr-2 text-3xl"></i> Chính xác!
                    </div>
                    <div class="text-green-600">Đáp án: ${currentQuestion.answer.join('; ')}</div>
                `;
                feedback.className = "text-center mt-4 p-4 rounded-xl bg-green-100 border-2 border-green-300 shadow-lg";
                
                // Reveal all steps
                while(stepIndex < currentQuestion.steps.length) showNextStep();
                
            } else {
                feedback.innerHTML = `
                    <div class="text-red-600 font-bold text-xl mb-1 flex items-center justify-center">
                        <i class="fas fa-times-circle mr-2 text-3xl"></i> Sai rồi!
                    </div>
                    <div class="text-gray-700 mb-2">Đáp án đúng: <strong class="text-xl text-red-600">${currentQuestion.answer.join('; ')}</strong></div>
                `;
                feedback.className = "text-center mt-4 p-4 rounded-xl bg-red-50 border-2 border-red-200 shadow-lg";
                
                // Auto reveal steps
                let intv = setInterval(() => {
                    if(stepIndex < currentQuestion.steps.length) showNextStep();
                    else clearInterval(intv);
                }, 800);
            }
            feedback.classList.remove('hidden');
        }

        // Init
        window.onload = () => {
            setMode('exam_mix');
        };
    </script>
</body>
</html>