<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar {
            width: 8px;
        }
        #steps-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .input-group:focus-within label {
            color: #4f46e5;
        }

        /* --- STYLES FOR STATS --- */
        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box {
            transition: all 0.3s ease;
        }
        .stats-box:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-calculator mr-2"></i>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 2
            </h1>
		    <p class="text-white font-medium opacity-90">Ch·ªß ƒë·ªÅ: Th·ª±c hi·ªán ph√©p t√≠nh (C·ªông, Tr·ª´, Nh√¢n, Chia s·ªë nguy√™n)</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[350px] relative">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        <div class="absolute top-2 right-4 text-xs font-bold px-2 py-1 rounded bg-white/10 text-white/80" id="mode-display">
                            C∆° b·∫£n
                        </div>
                        
                        <div class="space-y-8 font-mono text-xl md:text-2xl w-full px-2 mt-4">
                            <!-- Question A -->
                            <div class="flex flex-col">
                                <div class="flex items-start mb-2">
                                    <span class="text-yellow-400 font-bold mr-3 mt-1">a)</span>
                                    <div id="q-a-text" class="text-white tracking-wider leading-relaxed break-words">Loading...</div>
                                </div>
                            </div>

                            <!-- Question B -->
                            <div class="flex flex-col border-t border-gray-600 pt-6">
                                <div class="flex items-start mb-2">
                                    <span class="text-yellow-400 font-bold mr-3 mt-1">b)</span>
                                    <div id="q-b-text" class="text-white tracking-wider leading-relaxed break-words">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        <div class="grid grid-cols-2 gap-6 mb-4">
                            <!-- Input A -->
                            <div class="input-group">
                                <label class="block text-gray-500 font-bold text-sm uppercase mb-1 text-center">K·∫øt qu·∫£ c√¢u a</label>
                                <input type="tel" id="ans-a" placeholder="?" 
                                    class="w-full text-center font-bold text-xl p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                    onkeydown="if(event.key === 'Enter') document.getElementById('ans-b').focus()">
                            </div>
                            <!-- Input B -->
                            <div class="input-group">
                                <label class="block text-gray-500 font-bold text-sm uppercase mb-1 text-center">K·∫øt qu·∫£ c√¢u b</label>
                                <input type="tel" id="ans-b" placeholder="?" 
                                    class="w-full text-center font-bold text-xl p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                    onkeydown="if(event.key === 'Enter') checkAnswer()">
                            </div>
                        </div>

                        <!-- Difficulty Toggle -->
                        <div class="flex items-center justify-end mt-4 mb-2">
                            <label class="inline-flex items-center cursor-pointer select-none">
                                <input type="checkbox" id="mode-hard" class="sr-only peer" onchange="nextQuestion()">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                <span class="ms-2 text-sm font-bold text-gray-600 peer-checked:text-red-600 transition-colors">
                                    <i class="fas fa-skull-crossbones mr-1"></i>Ch·∫ø ƒë·ªô kh√≥
                                </span>
                            </label>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <!-- Feedback Area -->
                        <div id="feedback" class="hidden mt-3 text-center p-3 rounded-lg text-sm font-bold"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[500px] lg:h-[600px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-signature text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <!-- Button -->
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Rule Hint Area -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>
                        <span id="rule-content" class="font-medium"></span>
                    </div>
                    
                    <!-- Scrollable Steps -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-nib text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- Configuration & Utils ---
        const state = {
            streak: 0,
            correct: 0,
            wrong: 0,
            skipped: 0
        };

        let currentData = {
            ansA: 0,
            ansB: 0,
            allSteps: []
        };
        let isAnswered = false;
        let stepIndex = 0;
        let usedHint = false;

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getNonZeroRandomInt(min, max) {
            let n = 0;
            while(n === 0) n = getRandomInt(min, max);
            return n;
        }

        // Shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Format number for display (wrap negatives in parens)
        function fmt(num) {
            if (num < 0) return `(${num})`;
            return `${num}`;
        }
        
        // --- Logic: Generate Part A (Addition/Subtraction) ---
        function generatePartA(isHard = false) {
            if (!isHard) {
                // NORMAL MODE: 80% (3 terms)
                let terms = [];
                for (let i = 0; i < 3; i++) terms.push(getNonZeroRandomInt(-50, 50));
                
                let displayStr = `${terms[0]}`;
                let ops = [Math.random() < 0.5 ? '+' : '-', Math.random() < 0.5 ? '+' : '-'];
                
                for(let i=0; i<2; i++) displayStr += ` ${ops[i]} ${fmt(terms[i+1])}`;
                
                let valsToSum = [terms[0]];
                let transformStr = `${terms[0]}`;
                let hasTransform = false;

                for (let i = 0; i < 2; i++) {
                    let nextTerm = terms[i+1];
                    if (ops[i] === '-') {
                        valsToSum.push(-nextTerm);
                        transformStr += ` + ${fmt(-nextTerm)}`;
                        hasTransform = true;
                    } else {
                        valsToSum.push(nextTerm);
                        transformStr += ` + ${fmt(nextTerm)}`;
                    }
                }

                let total = valsToSum.reduce((a,b)=>a+b, 0);
                let stepList = [displayStr];
                if(hasTransform) stepList.push(`= ${transformStr}`);
                
                let inter = valsToSum[0] + valsToSum[1];
                stepList.push(`= ${inter} + ${fmt(valsToSum[2])}`);
                stepList.push(`= ${total}`);

                return {
                    display: displayStr,
                    answer: total,
                    steps: stepList,
                    rule: "Quy t·∫Øc d·∫•u ngo·∫∑c: Tr·ª´ ƒëi m·ªôt s·ªë nguy√™n b·∫±ng c·ªông v·ªõi s·ªë ƒë·ªëi c·ªßa n√≥."
                };
            } else {
                // HARD MODE: Smart Sums (Commutative/Associative)
                // Goal: Create pairs that sum to nice numbers (0, 10, -10, 20, -20, 100, -100)
                
                const targets = [0, 10, -10, 20, -20, 100, -100];
                let numPairs = Math.random() < 0.6 ? 2 : 3; // 4 or 6 numbers
                let hasLoose = Math.random() < 0.3; // 30% chance for a loose number
                
                let pairs = [];
                let looseVal = 0;
                
                // Generate pairs
                for(let i=0; i<numPairs; i++) {
                    let target = targets[getRandomInt(0, targets.length-1)];
                    let n1 = getNonZeroRandomInt(-50, 50);
                    let n2 = target - n1;
                    pairs.push({n1, n2, target});
                }
                
                if (hasLoose) looseVal = getNonZeroRandomInt(-20, 20);

                // Flat list for shuffling
                let allTerms = [];
                pairs.forEach(p => { allTerms.push(p.n1); allTerms.push(p.n2); });
                if(hasLoose) allTerms.push(looseVal);
                
                // Shuffle terms to hide the pairs
                let shuffledTerms = [...allTerms];
                shuffleArray(shuffledTerms);

                // Build Display
                let displayStr = `${shuffledTerms[0]}`;
                for(let i=1; i<shuffledTerms.length; i++) {
                    // Randomize operators but keep value correct (subtract negative vs add positive)
                    // actually just simpler to use '+' for all in advanced mode to emphasize grouping
                    // unless we want to convert sub to add. Let's stick to + for clarity in grouping demo
                    let val = shuffledTerms[i];
                    if (val < 0) displayStr += ` + ${fmt(val)}`;
                    else displayStr += ` + ${val}`;
                }

                // Steps
                let stepList = [displayStr];
                
                // Grouping Step
                let groupStr = "";
                pairs.forEach((p, idx) => {
                    groupStr += `[${p.n1} + ${fmt(p.n2)}]`;
                    if (idx < pairs.length - 1 || hasLoose) groupStr += " + ";
                });
                if(hasLoose) groupStr += `${fmt(looseVal)}`;
                
                stepList.push(`= ${groupStr} (T√≠nh ch·∫•t giao ho√°n & k·∫øt h·ª£p)`);
                
                // Calc Step
                let calcStr = "";
                let finalTotal = 0;
                pairs.forEach((p, idx) => {
                    calcStr += `${p.target}`;
                    finalTotal += p.target;
                    if (idx < pairs.length - 1 || hasLoose) calcStr += " + ";
                });
                if(hasLoose) {
                    calcStr += `${fmt(looseVal)}`;
                    finalTotal += looseVal;
                }
                
                stepList.push(`= ${calcStr}`);
                stepList.push(`= ${finalTotal}`);

                return {
                    display: displayStr,
                    answer: finalTotal,
                    steps: stepList,
                    rule: "Nh√≥m c√°c s·ªë h·∫°ng c√≥ t·ªïng l√† s·ªë tr√≤n ch·ª•c, tr√≤n trƒÉm ho·∫∑c b·∫±ng 0 ƒë·ªÉ t√≠nh nhanh."
                };
            }
        }

        // --- Logic: Generate Part B (Mixed Operations) ---
        function generatePartB(isHard = false) {
            if (!isHard) {
                // NORMAL MODE: 80% (Same as before)
                let n1 = getNonZeroRandomInt(-15, 15);
                let n2 = getNonZeroRandomInt(-10, 10);
                let n3 = getNonZeroRandomInt(-10, 10);
                let n4 = getNonZeroRandomInt(-10, 10);
                
                let display = `${fmt(n1)} . ${fmt(n2)} - ${fmt(n3)} . ${fmt(n4)}`;
                let val1 = n1*n2;
                let val2 = n3*n4;
                let ans = val1 - val2;
                
                return {
                    display: display,
                    answer: ans,
                    steps: [
                        display,
                        `= ${fmt(val1)} - ${fmt(val2)}`,
                        `= ${ans}`
                    ],
                    rule: "Th·ª±c hi·ªán ph√©p nh√¢n tr∆∞·ªõc, ph√©p tr·ª´ sau."
                };
            } else {
                // HARD MODE: Distributive Property with Nice Numbers
                // Structure: a.b + a.c (+ a.d)
                
                let common = getNonZeroRandomInt(-20, 20); // Common factor 'a'
                let targetSum = [10, -10, 20, -20, 100, -100, 200, -200][getRandomInt(0, 7)]; // Sum inside brackets
                
                // Decide structure: 2 groups or 3 groups?
                let type = Math.random() < 0.7 ? 2 : 3;
                let parts = [];
                
                if (type === 2) {
                    let b = getNonZeroRandomInt(-50, 50);
                    let c = targetSum - b;
                    parts = [b, c];
                } else {
                    let b = getNonZeroRandomInt(-30, 30);
                    let c = getNonZeroRandomInt(-30, 30);
                    let d = targetSum - b - c;
                    parts = [b, c, d];
                }

                // Chance for a "loose" non-distributable term?
                // Prompt: "2 groups + 1 group cannot distribute"
                let looseTerm = 0;
                let hasLoose = Math.random() < 0.4;
                if (hasLoose) looseTerm = getNonZeroRandomInt(-20, 20);

                // Build Display
                // Shuffle terms to make it less obvious? E.g. a.b + K + a.c
                // But typically exams group them somewhat near. Let's just list them.
                
                let termObjs = parts.map(p => ({
                    val: p,
                    str: `${fmt(common)} . ${fmt(p)}`
                }));
                
                // Add loose term to the mix if exists
                if(hasLoose) {
                    termObjs.push({
                        val: null, // Marker
                        str: `${looseTerm > 0 ? '+ ' : '- '}${Math.abs(looseTerm)}`
                    });
                }
                
                // Construct string
                // Note: For the first term we don't need operator if positive, but loose term logic handled above is for trailing.
                // Let's simpler logic: Join with + or - 
                
                let display = "";
                // We'll reconstruct display carefully
                let rawTerms = parts.map(p => {
                     return { type: 'mul', a: common, b: p };
                });
                
                if (hasLoose) {
                    // Insert loose term at random position (start, middle, end)
                    let pos = getRandomInt(0, rawTerms.length);
                    rawTerms.splice(pos, 0, { type: 'val', val: looseTerm });
                }
                
                // Build string
                rawTerms.forEach((t, i) => {
                    if (t.type === 'mul') {
                        let s = `${fmt(t.a)} . ${fmt(t.b)}`;
                        if (i === 0) display += s;
                        else display += ` + ${s}`;
                    } else {
                        // Loose val
                        if (i === 0) display += `${t.val}`;
                        else display += ` ${t.val < 0 ? '-' : '+'} ${Math.abs(t.val)}`;
                    }
                });

                // Calculate
                let total = (common * targetSum) + looseTerm;

                // Steps
                let stepList = [display];
                
                // Step 2: Group
                // a . (b + c ...) + loose
                let insideStr = parts.map(p => fmt(p)).join(' + ');
                let groupStep = `${fmt(common)} . [${insideStr}]`;
                if(hasLoose) groupStep += ` ${looseTerm < 0 ? '-' : '+'} ${Math.abs(looseTerm)}`;
                
                stepList.push(`= ${groupStep} (T√≠nh ch·∫•t ph√¢n ph·ªëi)`);
                stepList.push(`= ${fmt(common)} . ${targetSum} ${hasLoose ? (looseTerm < 0 ? '-' : '+') + ' ' + Math.abs(looseTerm) : ''}`);
                
                let mulRes = common * targetSum;
                if(hasLoose) {
                    stepList.push(`= ${mulRes} ${looseTerm < 0 ? '-' : '+'} ${Math.abs(looseTerm)}`);
                }
                stepList.push(`= ${total}`);

                return {
                    display: display,
                    answer: total,
                    steps: stepList,
                    rule: "S·ª≠ d·ª•ng t√≠nh ch·∫•t ph√¢n ph·ªëi: a.b + a.c = a.(b+c) khi t·ªïng trong ngo·∫∑c l√† s·ªë tr√≤n."
                };
            }
        }

        function buildSteps(partA, partB) {
            return [
                { type: 'header', text: 'C√¢u a', rule: partA.rule },
                ...partA.steps.map(s => ({ type: 'step', text: s, isLast: s === partA.steps[partA.steps.length-1] })),
                
                { type: 'header', text: 'C√¢u b', rule: partB.rule },
                ...partB.steps.map(s => ({ type: 'step', text: s, isLast: s === partB.steps[partB.steps.length-1] }))
            ];
        }

        // --- Main UI Functions ---

        function renderStats() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = state.streak;
            if (state.streak > 2) {
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${state.streak}`;
                streakEl.classList.add('streak-fire');
            } else {
                streakEl.classList.remove('streak-fire');
            }

            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-skipped').textContent = state.skipped;
        }

        function nextQuestion() {
            if (!isAnswered && document.getElementById('q-a-text').innerText !== 'Loading...') {
                state.skipped++;
                state.streak = 0;
                renderStats();
            }

            // Reset UI
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            
            ['ans-a', 'ans-b'].forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.disabled = false;
                el.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');
            });
            
            isAnswered = false;
            stepIndex = 0;
            usedHint = false;
            
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center"><i class="fas fa-pen-nib text-3xl mb-2 opacity-30"></i><span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span></div>`;
            
            const btnStep = document.getElementById('btn-show-step');
            btnStep.innerHTML = '<span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>';
            btnStep.disabled = false;

            // Generate Logic
            const isHardMode = document.getElementById('mode-hard').checked;
            document.getElementById('mode-display').textContent = isHardMode ? "N√¢ng cao" : "C∆° b·∫£n";
            document.getElementById('mode-display').className = isHardMode 
                ? "absolute top-2 right-4 text-xs font-bold px-2 py-1 rounded bg-red-600 text-white shadow"
                : "absolute top-2 right-4 text-xs font-bold px-2 py-1 rounded bg-white/10 text-white/80";

            const pA = generatePartA(isHardMode);
            const pB = generatePartB(isHardMode);

            currentData = {
                ansA: pA.answer,
                ansB: pB.answer,
                allSteps: buildSteps(pA, pB)
            };

            document.getElementById('q-a-text').textContent = pA.display;
            document.getElementById('q-b-text').textContent = pB.display;
            document.getElementById('step-counter').textContent = `0/${currentData.allSteps.length}`;
            
            document.getElementById('ans-a').focus();
        }

        function showNextStep() {
            usedHint = true; 
            
            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            const ruleContent = document.getElementById('rule-content');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentData.allSteps.length) {
                const item = currentData.allSteps[stepIndex];
                
                if (item.type === 'header') {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "mt-4 mb-2 text-sm font-bold text-gray-600 uppercase border-b-2 border-indigo-100 pb-1 flex items-center";
                    headerDiv.innerHTML = `<i class="fas fa-chevron-circle-right mr-2 text-indigo-500"></i> ${item.text}`;
                    container.appendChild(headerDiv);

                    // Show Hint Rule
                    if (item.rule) {
                        ruleContent.textContent = item.rule;
                        ruleArea.classList.remove('hidden');
                        ruleArea.classList.remove('animate-pulse');
                        void ruleArea.offsetWidth;
                        ruleArea.classList.add('animate-pulse');
                    }
                } else {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-item bg-white p-3 rounded-r-lg border-l-4 shadow-sm mb-3 text-base font-mono leading-relaxed';
                    
                    if (item.isLast) {
                        stepDiv.classList.add('border-green-500', 'bg-green-50');
                        stepDiv.innerHTML = `<span class="text-green-700 font-bold">${item.text}</span>`;
                    } else {
                        stepDiv.classList.add('border-blue-400');
                        stepDiv.textContent = item.text;
                    }
                    container.appendChild(stepDiv);
                }

                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentData.allSteps.length}`;
            }

            if (stepIndex >= currentData.allSteps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>ƒê√£ h·∫øt</span>';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const iA = document.getElementById('ans-a');
            const iB = document.getElementById('ans-b');
            
            const vA = parseInt(iA.value);
            const vB = parseInt(iB.value);
            
            let correctCount = 0;

            // Check A
            if (vA === currentData.ansA) {
                correctCount++;
                iA.classList.add('border-green-500', 'bg-green-50');
                iA.classList.remove('border-gray-300');
            } else {
                iA.classList.add('border-red-500', 'bg-red-50');
            }

            // Check B
            if (vB === currentData.ansB) {
                correctCount++;
                iB.classList.add('border-green-500', 'bg-green-50');
                iB.classList.remove('border-gray-300');
            } else {
                iB.classList.add('border-red-500', 'bg-red-50');
            }

            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800');

            if (correctCount === 2) {
                if (!usedHint) {
                    state.correct++;
                    state.streak++;
                    feedback.innerHTML = '<i class="fas fa-crown text-xl mb-1 block"></i> Tuy·ªát v·ªùi! B·∫°n ƒë√∫ng c·∫£ 2 c√¢u.';
                    feedback.classList.add('bg-green-100', 'text-green-800');
                } else {
                    feedback.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem g·ª£i √Ω)';
                    feedback.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                renderStats();
                
                // Auto reveal steps
                const reveal = setInterval(() => {
                    if(stepIndex < currentData.allSteps.length) showNextStep();
                    else clearInterval(reveal);
                }, 150);
                isAnswered = true;
            } else {
                state.wrong++;
                state.streak = 0;
                renderStats();

                feedback.innerHTML = `<i class="fas fa-exclamation-triangle"></i> B·∫°n ƒë√∫ng ${correctCount}/2 c√¢u.<br>H√£y ki·ªÉm tra l·∫°i d·∫•u v√† th·ª© t·ª± t√≠nh to√°n!`;
                feedback.classList.add('bg-red-100', 'text-red-800');
            }
        }

        window.onload = nextQuestion;

    </script>
</body>
</html>