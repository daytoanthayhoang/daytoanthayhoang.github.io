<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chalkboard {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 8px solid #854d0e;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chalkboard::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0ibm9uZSIvPgo8cGF0aCBkPSJNMTAgMTBRNDAgNDAgMTAgNzAiIHN0cm9rZT0id2hpdGUiIG9wYWNpdHk9IjAuMDUiIGZpbGw9Im5vbmUiLz4KPC9zdmc+');
            opacity: 0.1;
            pointer-events: none;
        }
        .step-item {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown {
            to { opacity: 1; transform: translateY(0); }
        }
        #steps-container::-webkit-scrollbar {
            width: 8px;
        }
        #steps-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        #steps-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .input-group:focus-within label {
            color: #4f46e5;
        }
        
        /* Stats Animation */
        .streak-fire {
            color: #ef4444;
            animation: burn 0.5s infinite alternate;
        }
        @keyframes burn {
            from { text-shadow: 0 0 2px #fca5a5, 0 -2px 4px #f87171; }
            to { text-shadow: 0 0 4px #fca5a5, 0 -4px 8px #ef4444; }
        }
        .stats-box {
            transition: all 0.3s ease;
        }
        .stats-box:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-blue-200">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-center relative shadow-lg">
            <h1 class="text-2xl md:text-3xl font-extrabold text-white uppercase tracking-wider">
                <i class="fas fa-edit mr-2"></i>√în t·∫≠p Chinh Ph·ª•c To√°n 6 HK1 - B√†i 1
            </h1>
            <p class="text-white font-medium">Ch·ªß ƒë·ªÅ: Tr·ª•c s·ªë nguy√™n & So s√°nh s·ªë nguy√™n</p>
        </div>

        <div class="p-4 md:p-6 space-y-4">
            
            <!-- STATS BOARD -->
            <div class="bg-white rounded-xl shadow-md p-3 grid grid-cols-4 gap-2 text-center select-none border border-gray-100" id="stats-container">
                <div class="flex flex-col items-center stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Chu·ªói th·∫Øng üî•</span>
                    <span id="stat-streak" class="text-2xl md:text-3xl font-extrabold text-indigo-900">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">ƒê√∫ng</span>
                    <span id="stat-correct" class="text-xl md:text-2xl font-bold text-green-600">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">Sai</span>
                    <span id="stat-wrong" class="text-xl md:text-2xl font-bold text-red-500">0</span>
                </div>
                <div class="flex flex-col items-center border-l border-gray-200 stats-box">
                    <span class="text-xs text-gray-500 uppercase font-bold">B·ªè qua</span>
                    <span id="stat-skipped" class="text-xl md:text-2xl font-bold text-gray-400">0</span>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Chalkboard & Inputs -->
                <div class="flex flex-col gap-4">
                    <!-- Chalkboard -->
                    <div class="chalkboard p-6 min-h-[300px] relative">
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs font-mono uppercase tracking-widest opacity-60">
                            ƒê·ªÅ b√†i
                        </div>
                        
                        <div class="space-y-6 font-mono text-xl md:text-xl w-full px-4">
                            <!-- Question A: Number Line -->
                            <div class="flex flex-col">
                                <div class="flex items-start mb-2">
                                    <span class="text-yellow-400 font-bold mr-2 w-6">a)</span>
                                    <div class="flex flex-col">
                                        <span class="text-blue-200 text-lg font-sans">Bi·ªÉu di·ªÖn c√°c s·ªë sau tr√™n tr·ª•c s·ªë:</span>
                                        <div id="q-nums-text" class="text-white tracking-wider font-bold mt-1 text-2xl">Loading...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Question B: Comparison -->
                            <div class="flex flex-col border-t border-gray-600 pt-4">
                                <div class="flex items-start mb-2">
                                    <span class="text-yellow-400 font-bold mr-2 w-6">b)</span>
                                    <span class="text-blue-200 text-lg font-sans">So s√°nh c√°c c·∫∑p s·ªë:</span>
                                </div>
                                <div class="pl-8 space-y-3">
                                    <div class="flex items-center gap-3">
                                        <span class="text-gray-400 text-sm">1)</span>
                                        <div id="q-comp1-text" class="text-white tracking-wider">Loading...</div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-gray-400 text-sm">2)</span>
                                        <div id="q-comp2-text" class="text-white tracking-wider">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        <div class="space-y-4">
                            <!-- Input A: Sorting -->
                            <div>
                                <label class="block text-gray-700 font-bold text-sm mb-1">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded mr-1">C√¢u a</span>
                                    ƒê·ªÉ bi·ªÉu di·ªÖn ƒë√∫ng, h√£y s·∫Øp x·∫øp c√°c s·ªë theo th·ª© t·ª± tƒÉng d·∫ßn:
                                </label>
                                <input type="text" id="ans-sort" placeholder="V√≠ d·ª•: -5, -2, 0, 3" 
                                    class="w-full font-mono p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                                <p class="text-xs text-gray-400 mt-1 italic">(*Nh·∫≠p c√°c s·ªë c√°ch nhau b·ªüi d·∫•u ph·∫©y)</p>
                            </div>

                            <!-- Input B: Comparisons -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-bold text-sm mb-1">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded mr-1">C√¢u b1</span>
                                        ƒêi·ªÅn d·∫•u:
                                    </label>
                                    <div class="flex items-center gap-2 bg-white p-2 border rounded-lg">
                                        <span id="label-comp1-a" class="font-bold text-gray-600">?</span>
                                        <select id="ans-comp1" class="font-bold text-indigo-700 border-b-2 border-indigo-200 focus:outline-none">
                                            <option value="">?</option>
                                            <option value=">">></option>
                                            <option value="<"><</option>
                                            <option value="=">=</option>
                                        </select>
                                        <span id="label-comp1-b" class="font-bold text-gray-600">?</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-bold text-sm mb-1">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded mr-1">C√¢u b2</span>
                                        ƒêi·ªÅn d·∫•u:
                                    </label>
                                    <div class="flex items-center gap-2 bg-white p-2 border rounded-lg">
                                        <span id="label-comp2-a" class="font-bold text-gray-600">?</span>
                                        <select id="ans-comp2" class="font-bold text-indigo-700 border-b-2 border-indigo-200 focus:outline-none">
                                            <option value="">?</option>
                                            <option value=">">></option>
                                            <option value="<"><</option>
                                            <option value="=">=</option>
                                        </select>
                                        <span id="label-comp2-b" class="font-bold text-gray-600">?</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3 mt-6">
                            <button onclick="nextQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i> B√†i m·ªõi
                            </button>
                            <button onclick="checkAnswer()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Ki·ªÉm tra
                            </button>
                        </div>

                        <!-- Feedback Area -->
                        <div id="feedback" class="hidden mt-3 text-center p-2 rounded-lg text-sm font-bold"></div>
                    </div>
                </div>

                <!-- Right Column: Step-by-step -->
                <div class="flex flex-col h-[600px] lg:h-[650px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-4 relative">
                    <!-- HEADER WITH BUTTON -->
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 shrink-0">
                        <div class="flex items-center gap-2 flex-grow">
                            <!-- CHANGED: Title updated -->
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide whitespace-nowrap">
                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>Tr√¨nh b√†y b√†i thi
                            </h3>
                            <!-- Button -->
                            <button onclick="showNextStep()" id="btn-show-step" 
                                class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition-all flex items-center gap-1 disabled:opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed ml-2">
                                <span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>
                        <span id="step-counter" class="text-xs font-bold text-gray-400 bg-gray-200 px-2 py-1 rounded ml-2">0/0</span>
                    </div>

                    <!-- Fixed Hint Area (G·ª£i √Ω/H∆∞·ªõng d·∫´n) -->
                    <div id="rule-area" class="hidden mb-3 bg-yellow-50 text-yellow-900 text-sm p-3 rounded-lg border-l-4 border-yellow-400 shadow-sm transition-all duration-300 shrink-0">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb mr-2 text-yellow-600 mt-1"></i>
                            <span id="rule-content" class="font-medium"></span>
                        </div>
                    </div>
                    
                    <!-- Scrollable Steps (Exam Presentation) -->
                    <div id="steps-container" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-inner border border-gray-100 scroll-smooth">
                        <div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center">
                            <i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i>
                            <span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Info -->
    <footer class="mt-8 text-center text-gray-500 text-xs w-full">
        <p>¬© Th·∫ßy Nguy·ªÖn Vi·ªát Ho√†ng - Tr∆∞·ªùng THCS Nguy·ªÖn An Kh∆∞∆°ng - daytoanthayhoang.github.io</p>
    </footer>

    <script>
        // --- Configuration & Utils ---
        const state = {
            streak: 0,
            correct: 0,
            wrong: 0,
            skipped: 0
        };

        let currentData = {
            numbers: [],
            comp1: {},
            comp2: {},
            allSteps: []
        };
        let isAnswered = false;
        let stepIndex = 0;
        let usedHint = false;

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // --- Core Logic ---

        function generateProblem() {
            // Determine Difficulty: 80% Basic, 20% Advanced
            const isAdvanced = Math.random() < 0.2;

            // --- Part A: Number Line ---
            let nums = [];
            if (!isAdvanced) {
                nums.push(0);
                nums.push(getRandomInt(-7, -1)); // Negative
                nums.push(getRandomInt(1, 7));   // Positive
                let n4;
                do {
                    n4 = getRandomInt(-7, 7);
                } while (nums.includes(n4));
                nums.push(n4);
            } else {
                nums = [0];
                let base = getRandomInt(2, 6);
                nums.push(base);
                nums.push(-base); 
                let n4, n5;
                do { n4 = getRandomInt(-8, 8); } while (nums.includes(n4));
                nums.push(n4);
                do { n5 = getRandomInt(-8, 8); } while (nums.includes(n5));
                nums.push(n5);
            }
            const displayNums = [...nums].sort(() => Math.random() - 0.5);
            const sortedNums = [...nums].sort((a, b) => a - b);

            // --- Part B: Comparison ---
            let c1, c2;
            
            // Pair 1: Different signs
            let a1 = getRandomInt(1, 20);
            let b1 = getRandomInt(-20, -1);
            c1 = { a: a1, b: b1, valA: a1, valB: b1, type: 'diff' }; 

            // Pair 2: Both Negative
            let a2 = getRandomInt(-30, -10);
            let b2 = getRandomInt(-30, -10);
            while (a2 === b2) b2 = getRandomInt(-30, -10);
            c2 = { a: a2, b: b2, valA: a2, valB: b2, type: 'neg' }; 

            if (Math.random() > 0.5) {
                const temp = c1.a; c1.a = c1.b; c1.b = temp;
                const tempV = c1.valA; c1.valA = c1.valB; c1.valB = tempV;
            }

            return {
                nums: { display: displayNums, sorted: sortedNums },
                comp1: c1,
                comp2: c2,
                allSteps: buildSteps(nums, sortedNums, c1, c2)
            };
        }

        function buildSteps(rawNums, sortedNums, c1, c2) {
            const steps = [];

            // --- Steps for A ---
            // Header for presentation
            steps.push({ 
                type: 'header', 
                text: 'C√¢u a', 
                hint: 'ƒê·∫ßu ti√™n, v·∫Ω tr·ª•c s·ªë n·∫±m ngang. ƒêi·ªÉm g·ªëc l√† s·ªë 0. Chi·ªÅu d∆∞∆°ng h∆∞·ªõng sang ph·∫£i.' 
            });

            // Canvas Step 1: Mode 1 (Sparse Label, Full Ticks)
            steps.push({ 
                type: 'canvas', 
                nums: sortedNums, 
                text: 'C√°ch 1: Chia v·∫°ch ƒë·∫ßy ƒë·ªß, ch·ªâ ghi s·ªë ƒë·ªÅ b√†i y√™u c·∫ßu', 
                mode: 'sparse',
                hint: 'Chia c√°c v·∫°ch nh·ªè ƒë·ªÅu nhau. Ch·ªâ vi·∫øt s·ªë d∆∞·ªõi c√°c v·∫°ch t∆∞∆°ng ·ª©ng v·ªõi c√°c s·ªë c·∫ßn t√¨m.'
            });

            // Canvas Step 2: Mode 2 (Full Label, Highlight)
            steps.push({ 
                type: 'canvas', 
                nums: sortedNums, 
                text: 'C√°ch 2: Ghi ƒë·ªß s·ªë, l√†m n·ªïi b·∫≠t s·ªë c·∫ßn t√¨m', 
                mode: 'dense',
                hint: 'Ho·∫∑c em c√≥ th·ªÉ vi·∫øt h·∫øt c√°c s·ªë ra, sau ƒë√≥ khoanh tr√≤n ho·∫∑c ƒë√°nh d·∫•u c√°c s·ªë ƒë·ªÅ b√†i y√™u c·∫ßu.'
            });

            // --- Steps for B ---
            steps.push({ 
                type: 'header', 
                text: 'C√¢u b', 
                hint: 'Quy t·∫Øc: S·ªë d∆∞∆°ng > s·ªë √¢m. Trong hai s·ªë √¢m, s·ªë n√†o c√≥ ph·∫ßn t·ª± nhi√™n l·ªõn h∆°n th√¨ nh·ªè h∆°n.' 
            });
            
            // Comp 1 Logic (Different Signs - Direct)
            let sign1 = c1.valA > c1.valB ? '>' : '<';
            // Explanation goes to HINT only
            let explain1 = "";
            if (c1.valA > 0) explain1 = `V√¨ ${c1.a} l√† s·ªë d∆∞∆°ng, ${c1.b} l√† s·ªë √¢m n√™n s·ªë d∆∞∆°ng lu√¥n l·ªõn h∆°n.`;
            else explain1 = `V√¨ ${c1.a} l√† s·ªë √¢m, ${c1.b} l√† s·ªë d∆∞∆°ng n√™n s·ªë √¢m lu√¥n nh·ªè h∆°n.`;

            steps.push({ 
                type: 'text', 
                text: `${c1.a} v√† ${c1.b}: <b>${c1.a} ${sign1} ${c1.b}</b>`, // UPDATED FORMAT
                hint: explain1 
            });

            // Comp 2 Logic (Negative vs Negative - Full logic)
            let sign2 = c2.valA > c2.valB ? '>' : '<';
            const posA = Math.abs(c2.valA);
            const posB = Math.abs(c2.valB);
            
            // Hint general logic
            let hint2 = `So s√°nh hai s·ªë √¢m: So s√°nh ph·∫ßn s·ªë t·ª± nhi√™n (b·ªè d·∫•u tr·ª´). S·ªë n√†o c√≥ ph·∫ßn t·ª± nhi√™n l·ªõn h∆°n th√¨ th·ª±c t·∫ø n√≥ nh·ªè h∆°n.`;

            if (c2.type === 'neg' || (c2.valA < 0 && c2.valB < 0)) {
                let logicStep = "";
                let resultStep = "";
                
                if (posA < posB) { // e.g., -18 vs -25. 18 < 25 => -18 > -25
                    logicStep = `V√¨ ${posA} < ${posB}`;
                    resultStep = `n√™n ${c2.valA} > ${c2.valB}`;
                } else { // e.g., -25 vs -18. 25 > 18 => -25 < -18
                    logicStep = `V√¨ ${posA} > ${posB}`;
                    resultStep = `n√™n ${c2.valA} < ${c2.valB}`;
                }

                // Show full presentation logic in Paper - Split into 2 steps for easier clicking
                steps.push({ 
                    type: 'text', 
                    text: `${c2.a} v√† ${c2.b}:<br>${logicStep}`, 
                    hint: hint2 
                });
                
                steps.push({ 
                    type: 'text', 
                    text: `${resultStep}`, 
                    hint: hint2 
                });
            } else {
                 steps.push({ 
                    type: 'text', 
                    text: `${c2.a} v√† ${c2.b}: ${c2.valA} ${sign2} ${c2.valB}`, // UPDATED FORMAT 
                    hint: "So s√°nh tr·ª±c ti·∫øp." 
                });
            }

            return steps;
        }

        // --- Drawing Helper (Updated Modes) ---
        function drawNumberLine(canvas, nums, mode) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            const centerY = h / 2;
            
            // Clear
            ctx.clearRect(0, 0, w, h);
            
            // Calculate Range to cover nice integer steps
            // We want to show a decent range like -8 to 8 usually
            let minRange = -8;
            let maxRange = 8;
            
            // Expand if nums are outside
            const minNum = Math.min(...nums);
            const maxNum = Math.max(...nums);
            if (minNum < minRange) minRange = minNum - 1;
            if (maxNum > maxRange) maxRange = maxNum + 1;

            const totalUnits = maxRange - minRange + 2; // + padding
            const unit = (w - 40) / totalUnits;
            const zeroX = (w/2) - ((minRange + maxRange)/2 * unit); // Center shift calculation roughly

            // Function to map value to X
            // To simplify: Let's just fix 0 at center w/2 IF range allows, otherwise shift
            // Actually simpler: 
            const rangeVal = Math.max(Math.abs(minNum), Math.abs(maxNum), 8) + 1;
            const unitWidth = (w - 40) / (rangeVal * 2);

            // Draw Main Line
            ctx.beginPath();
            ctx.moveTo(10, centerY);
            ctx.lineTo(w - 10, centerY);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Arrow
            ctx.beginPath();
            ctx.moveTo(w - 15, centerY - 5);
            ctx.lineTo(w - 5, centerY);
            ctx.lineTo(w - 15, centerY + 5);
            ctx.fillStyle = '#333';
            ctx.fill();

            // Loop integers from -rangeVal to +rangeVal
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            for (let i = -rangeVal; i <= rangeVal; i++) {
                const x = (w/2) + (i * unitWidth);
                
                // Check bounds (don't draw over arrow)
                if (x < 15 || x > w - 20) continue;

                const isTarget = nums.includes(i);
                const isZero = (i === 0);

                // DRAW TICK (Always draw ticks for both modes now per requirement)
                ctx.beginPath();
                ctx.moveTo(x, centerY - 4);
                ctx.lineTo(x, centerY + 4);
                ctx.strokeStyle = '#555'; // Standard tick color
                ctx.lineWidth = 1;
                ctx.stroke();

                // DRAW LABELS Logic
                if (mode === 'sparse') {
                    // Mode 1: Only label requested nums and 0
                    if (isTarget || isZero) {
                        ctx.fillStyle = isTarget ? '#ef4444' : '#333';
                        ctx.font = isTarget ? 'bold 14px Nunito' : '12px Nunito';
                        ctx.fillText(i, x, centerY + 10);
                        
                        // Highlight dot for target
                        if (isTarget) {
                            ctx.beginPath();
                            ctx.arc(x, centerY, 3, 0, 2*Math.PI);
                            ctx.fillStyle = '#ef4444';
                            ctx.fill();
                        }
                    }
                } else if (mode === 'dense') {
                    // Mode 2: Label ALL nums. Highlight target.
                    
                    // Draw text for everyone (skip if too crowded? assume fit for -8 to 8)
                    // If crowded, maybe skip odds? But requirement says "ghi ƒë·ªß h·∫øt s·ªë"
                    ctx.font = '11px Nunito';
                    ctx.fillStyle = '#777';
                    
                    if (isTarget) {
                        // Highlight Box or Big Dot
                        // Let's do a box for variety as requested "ƒë√≥ng khung √¥ vu√¥ng"
                        ctx.strokeStyle = '#ef4444';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x - 8, centerY + 8, 16, 16);
                        
                        ctx.fillStyle = '#ef4444';
                        ctx.font = 'bold 12px Nunito';
                    } else if (isZero) {
                         ctx.fillStyle = '#333';
                         ctx.font = 'bold 12px Nunito';
                    }
                    
                    ctx.fillText(i, x, centerY + 10);
                    
                    // Dot on line
                    if (isTarget) {
                         ctx.beginPath();
                         ctx.arc(x, centerY, 3, 0, 2*Math.PI);
                         ctx.fillStyle = '#ef4444';
                         ctx.fill();
                    }
                }
            }
        }

        // --- Main UI Functions ---

        function renderStats() {
            const streakEl = document.getElementById('stat-streak');
            streakEl.textContent = state.streak;
            if (state.streak > 2) {
                streakEl.innerHTML = `<i class="fas fa-fire"></i> ${state.streak}`;
                streakEl.classList.add('streak-fire');
            } else {
                streakEl.classList.remove('streak-fire');
            }
            document.getElementById('stat-correct').textContent = state.correct;
            document.getElementById('stat-wrong').textContent = state.wrong;
            document.getElementById('stat-skipped').textContent = state.skipped;
        }

        function nextQuestion() {
            if (!isAnswered && document.getElementById('q-nums-text').innerText !== 'Loading...') {
                state.skipped++;
                state.streak = 0;
                renderStats();
            }

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('rule-area').classList.add('hidden');
            
            // Reset Inputs
            ['ans-sort', 'ans-comp1', 'ans-comp2'].forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.disabled = false;
                el.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50', 'text-green-700', 'text-red-700');
            });

            isAnswered = false;
            stepIndex = 0;
            usedHint = false;
            
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = `<div class="text-gray-400 italic text-sm text-center mt-10 flex flex-col items-center"><i class="fas fa-pen-alt text-3xl mb-2 opacity-30"></i><span>B·∫•m "G·ª£i √Ω ti·∫øp" ƒë·ªÉ xem b√†i l√†m m·∫´u</span></div>`;
            
            const btnStep = document.getElementById('btn-show-step');
            btnStep.innerHTML = '<span>G·ª£i √Ω ti·∫øp</span> <i class="fas fa-arrow-right text-[10px]"></i>';
            btnStep.disabled = false;

            const data = generateProblem();
            currentData = data;

            // Update UI Question
            document.getElementById('q-nums-text').textContent = data.nums.display.join(' ; ');
            
            document.getElementById('q-comp1-text').textContent = `${data.comp1.a} v√† ${data.comp1.b}`;
            document.getElementById('label-comp1-a').textContent = data.comp1.a;
            document.getElementById('label-comp1-b').textContent = data.comp1.b;

            document.getElementById('q-comp2-text').textContent = `${data.comp2.a} v√† ${data.comp2.b}`;
            document.getElementById('label-comp2-a').textContent = data.comp2.a;
            document.getElementById('label-comp2-b').textContent = data.comp2.b;
            
            document.getElementById('step-counter').textContent = `0/${currentData.allSteps.length}`;
        }

        function showNextStep() {
            usedHint = true;
            
            const container = document.getElementById('steps-container');
            const ruleArea = document.getElementById('rule-area');
            const ruleContent = document.getElementById('rule-content');
            
            if (stepIndex === 0) container.innerHTML = '';

            if (stepIndex < currentData.allSteps.length) {
                const item = currentData.allSteps[stepIndex];
                
                // Show Hint (Always if exists)
                if (item.hint) {
                    ruleContent.innerHTML = item.hint; // Allow html in hint if needed
                    ruleArea.classList.remove('hidden');
                    ruleArea.classList.remove('animate-pulse');
                    void ruleArea.offsetWidth; 
                    ruleArea.classList.add('animate-pulse');
                }

                // Append Content to Exam Paper (If type implies content)
                let newElement = null;

                if (item.type === 'header') {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "mt-4 mb-2 text-xs font-bold text-gray-500 uppercase border-b border-gray-300 pb-1 flex items-center";
                    headerDiv.innerHTML = `<i class="fas fa-caret-right mr-1"></i> ${item.text}`;
                    container.appendChild(headerDiv);
                    newElement = headerDiv;
                } else if (item.type === 'canvas') {
                    const canvasContainer = document.createElement('div');
                    canvasContainer.className = "my-2 p-2 bg-white border rounded shadow-sm flex flex-col items-center w-full";
                    canvasContainer.innerHTML = `<span class="text-xs text-blue-600 font-bold mb-1 self-start">${item.text}</span>`;
                    
                    const canvas = document.createElement('canvas');
                    const containerWidth = container.clientWidth - 30;
                    canvas.width = Math.max(containerWidth, 280);
                    canvas.height = 70; // Slightly taller for labels
                    canvasContainer.appendChild(canvas);
                    container.appendChild(canvasContainer);
                    
                    drawNumberLine(canvas, item.nums, item.mode);
                    newElement = canvasContainer;
                } else if (item.type === 'text') {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-item bg-white p-2 rounded border-l-4 border-indigo-400 shadow-sm mb-2 text-sm md:text-base font-mono text-gray-800';
                    stepDiv.innerHTML = item.text;
                    container.appendChild(stepDiv);
                    newElement = stepDiv;
                }

                if (newElement) {
                    container.scrollTo({
                        top: container.scrollHeight,
                        behavior: 'smooth'
                    });
                }

                stepIndex++;
                document.getElementById('step-counter').textContent = `${stepIndex}/${currentData.allSteps.length}`;
            }

            if (stepIndex >= currentData.allSteps.length) {
                const btn = document.getElementById('btn-show-step');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>H·∫øt</span>';
            }
        }

        function checkAnswer() {
            if (isAnswered) return;
            
            const iSort = document.getElementById('ans-sort');
            const iComp1 = document.getElementById('ans-comp1');
            const iComp2 = document.getElementById('ans-comp2');
            
            let correctCount = 0;

            // 1. Check Sort
            const userSortStr = iSort.value.replace(/,/g, ' ').replace(/;/g, ' ').split(/\s+/).filter(s => s !== '').map(Number);
            const expectedSort = currentData.nums.sorted;
            
            let isSortCorrect = false;
            if (userSortStr.length === expectedSort.length) {
                isSortCorrect = userSortStr.every((val, index) => val === expectedSort[index]);
            }

            if (isSortCorrect) {
                correctCount++;
                iSort.classList.add('border-green-500', 'bg-green-50');
                iSort.classList.remove('border-gray-300');
            } else {
                iSort.classList.add('border-red-500', 'bg-red-50');
            }

            // 2. Check Comp 1
            const val1A = currentData.comp1.valA;
            const val1B = currentData.comp1.valB;
            const sign1 = val1A > val1B ? '>' : (val1A < val1B ? '<' : '=');
            
            if (iComp1.value === sign1) {
                correctCount++;
                iComp1.classList.add('text-green-700', 'bg-green-50');
                iComp1.classList.remove('text-indigo-700');
            } else {
                iComp1.classList.add('text-red-700', 'bg-red-50');
            }

            // 3. Check Comp 2
            const val2A = currentData.comp2.valA;
            const val2B = currentData.comp2.valB;
            const sign2 = val2A > val2B ? '>' : (val2A < val2B ? '<' : '=');
            
            if (iComp2.value === sign2) {
                correctCount++;
                iComp2.classList.add('text-green-700', 'bg-green-50');
                iComp2.classList.remove('text-indigo-700');
            } else {
                iComp2.classList.add('text-red-700', 'bg-red-50');
            }

            // Feedback Logic
            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800');

            if (correctCount === 3) {
                if (!usedHint) {
                    state.correct++;
                    state.streak++;
                    feedback.innerHTML = '<i class="fas fa-crown"></i> Xu·∫•t s·∫Øc! B·∫°n ƒë√∫ng c·∫£ 3 √Ω.';
                    feedback.classList.add('bg-green-100', 'text-green-800');
                } else {
                    feedback.innerHTML = '<i class="fas fa-check"></i> Ch√≠nh x√°c! (Kh√¥ng t√≠nh ƒëi·ªÉm v√¨ ƒë√£ xem g·ª£i √Ω)';
                    feedback.classList.add('bg-blue-100', 'text-blue-800');
                }
                
                renderStats();
                
                const reveal = setInterval(() => {
                    if(stepIndex < currentData.allSteps.length) showNextStep();
                    else clearInterval(reveal);
                }, 100);
                isAnswered = true;
            } else {
                state.wrong++;
                state.streak = 0;
                renderStats();

                let msg = "";
                if (!isSortCorrect) msg += "S·∫Øp x·∫øp ch∆∞a ƒë√∫ng. ";
                feedback.textContent = `B·∫°n ƒë√∫ng ${correctCount}/3 √Ω. ${msg}Ki·ªÉm tra l·∫°i nh√©!`;
                feedback.classList.add(correctCount === 0 ? 'bg-red-100' : 'bg-yellow-100', correctCount === 0 ? 'text-red-800' : 'text-yellow-800');
            }
        }

        window.onload = nextQuestion;

    </script>
</body>
</html>